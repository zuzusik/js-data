{"version":3,"file":"js-data.js","sources":["../src/utils.js","../src/Settable.js","../src/Component.js","../src/Query.js","../src/Relation.js","../src/Relation/BelongsTo.js","../src/Relation/HasMany.js","../src/Relation/HasOne.js","../src/relations.js","../src/decorators.js","../src/Record.js","../lib/mindex/_utils.js","../lib/mindex/index.js","../src/Collection.js","../src/Schema.js","../src/Mapper.js","../src/Container.js","../src/SimpleStore.js","../src/LinkedCollection.js","../src/DataStore.js","../src/index.js"],"sourcesContent":["/**\r\n * Utility methods used by JSData.\r\n *\r\n * @example\r\n * import { utils } from 'js-data';\r\n * console.log(utils.isString('foo')); // true\r\n *\r\n * @namespace utils\r\n * @type {Object}\r\n */\r\n\r\nconst DOMAIN = 'utils'\r\n\r\nconst INFINITY = 1 / 0\r\nconst MAX_INTEGER = 1.7976931348623157e308\r\nconst BOOL_TAG = '[object Boolean]'\r\nconst DATE_TAG = '[object Date]'\r\nconst FUNC_TAG = '[object Function]'\r\nconst NUMBER_TAG = '[object Number]'\r\nconst OBJECT_TAG = '[object Object]'\r\nconst REGEXP_TAG = '[object RegExp]'\r\nconst STRING_TAG = '[object String]'\r\nconst objToString = Object.prototype.toString\r\nconst PATH = /^(.+)\\.(.+)$/\r\n\r\nconst ERRORS = {\r\n  '400' () {\r\n    return `expected: ${arguments[0]}, found: ${\r\n      arguments[2] ? arguments[1] : typeof arguments[1]\r\n    }`\r\n  },\r\n  '404' () {\r\n    return `${arguments[0]} not found`\r\n  }\r\n}\r\n\r\nconst toInteger = function (value) {\r\n  if (!value) {\r\n    return 0\r\n  }\r\n  // Coerce to number\r\n  value = +value\r\n  if (value === INFINITY || value === -INFINITY) {\r\n    const sign = value < 0 ? -1 : 1\r\n    return sign * MAX_INTEGER\r\n  }\r\n  const remainder = value % 1\r\n  return value === value ? (remainder ? value - remainder : value) : 0 // eslint-disable-line\r\n}\r\n\r\nconst toStr = function (value) {\r\n  return objToString.call(value)\r\n}\r\n\r\nconst isPlainObject = function (value) {\r\n  return !!value && typeof value === 'object' && value.constructor === Object\r\n}\r\n\r\nconst mkdirP = function (object, path) {\r\n  if (!path) {\r\n    return object\r\n  }\r\n  const parts = path.split('.')\r\n  parts.forEach(function (key) {\r\n    if (!object[key]) {\r\n      object[key] = {}\r\n    }\r\n    object = object[key]\r\n  })\r\n  return object\r\n}\r\n\r\nconst utils = {\r\n  /**\r\n   * Reference to the Promise constructor used by JSData. Defaults to\r\n   * `window.Promise` or `global.Promise`.\r\n   *\r\n   * @example <caption>Make JSData use a different `Promise` constructor</caption>\r\n   * import Promise from 'bluebird';\r\n   * import { utils } from 'js-data';\r\n   * utils.Promise = Promise;\r\n   *\r\n   * @name utils.Promise\r\n   * @since 3.0.0\r\n   * @type {Function}\r\n   */\r\n  Promise: Promise,\r\n\r\n  /**\r\n   * Shallow copy properties that meet the following criteria from `src` to\r\n   * `dest`:\r\n   *\r\n   * - own enumerable\r\n   * - not a function\r\n   * - does not start with \"_\"\r\n   *\r\n   * @method utils._\r\n   * @param {object} dest Destination object.\r\n   * @param {object} src Source object.\r\n   * @private\r\n   * @since 3.0.0\r\n   */\r\n  _ (dest, src) {\r\n    utils.forOwn(src, function (value, key) {\r\n      if (\r\n        key &&\r\n        dest[key] === undefined &&\r\n        !utils.isFunction(value) &&\r\n        key.indexOf('_') !== 0\r\n      ) {\r\n        dest[key] = value\r\n      }\r\n    })\r\n  },\r\n\r\n  /**\r\n   * Recursively iterates over relations found in `opts.with`.\r\n   *\r\n   * @method utils._forRelation\r\n   * @param {object} opts Configuration options.\r\n   * @param {Relation} def Relation definition.\r\n   * @param {Function} fn Callback function.\r\n   * @param {*} [thisArg] Execution context for the callback function.\r\n   * @private\r\n   * @since 3.0.0\r\n   */\r\n  _forRelation (opts, def, fn, thisArg) {\r\n    const relationName = def.relation\r\n    let containedName = null\r\n    let index\r\n    opts || (opts = {})\r\n    opts.with || (opts.with = [])\r\n\r\n    if ((index = utils._getIndex(opts.with, relationName)) >= 0) {\r\n      containedName = relationName\r\n    } else if ((index = utils._getIndex(opts.with, def.localField)) >= 0) {\r\n      containedName = def.localField\r\n    }\r\n\r\n    if (opts.withAll) {\r\n      fn.call(thisArg, def, {})\r\n      return\r\n    } else if (!containedName) {\r\n      return\r\n    }\r\n    const optsCopy = {}\r\n    utils.fillIn(optsCopy, def.getRelation())\r\n    utils.fillIn(optsCopy, opts)\r\n    optsCopy.with = opts.with.slice()\r\n    optsCopy._activeWith = optsCopy.with.splice(index, 1)[0]\r\n    optsCopy.with.forEach(function (relation, i) {\r\n      if (\r\n        relation &&\r\n        relation.indexOf(containedName) === 0 &&\r\n        relation.length >= containedName.length &&\r\n        relation[containedName.length] === '.'\r\n      ) {\r\n        optsCopy.with[i] = relation.substr(containedName.length + 1)\r\n      } else {\r\n        optsCopy.with[i] = ''\r\n      }\r\n    })\r\n    fn.call(thisArg, def, optsCopy)\r\n  },\r\n\r\n  /**\r\n   * Find the index of a relation in the given list\r\n   *\r\n   * @method utils._getIndex\r\n   * @param {string[]} list List to search.\r\n   * @param {string} relation Relation to find.\r\n   * @private\r\n   * @returns {number}\r\n   */\r\n  _getIndex (list, relation) {\r\n    let index = -1\r\n    list.forEach(function (_relation, i) {\r\n      if (_relation === relation) {\r\n        index = i\r\n        return false\r\n      } else if (utils.isObject(_relation)) {\r\n        if (_relation.relation === relation) {\r\n          index = i\r\n          return false\r\n        }\r\n      }\r\n    })\r\n    return index\r\n  },\r\n\r\n  /**\r\n   * Define hidden (non-enumerable), writable properties on `target` from the\r\n   * provided `props`.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * function Cat () {}\r\n   * utils.addHiddenPropsToTarget(Cat.prototype, {\r\n   *   say () {\r\n   *     console.log('meow');\r\n   *   }\r\n   * });\r\n   * const cat = new Cat();\r\n   * cat.say(); // \"meow\"\r\n   *\r\n   * @method utils.addHiddenPropsToTarget\r\n   * @param {object} target That to which `props` should be added.\r\n   * @param {object} props Properties to be added to `target`.\r\n   * @since 3.0.0\r\n   */\r\n  addHiddenPropsToTarget (target, props) {\r\n    const map = {}\r\n    Object.keys(props).forEach(function (propName) {\r\n      const descriptor = Object.getOwnPropertyDescriptor(props, propName)\r\n\r\n      descriptor.enumerable = false\r\n      map[propName] = descriptor\r\n    })\r\n    Object.defineProperties(target, map)\r\n  },\r\n\r\n  /**\r\n   * Return whether the two objects are deeply different.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * utils.areDifferent({}, {}); // false\r\n   * utils.areDifferent({ a: 1 }, { a: 1 }); // false\r\n   * utils.areDifferent({ foo: 'bar' }, {}); // true\r\n   *\r\n   * @method utils.areDifferent\r\n   * @param {object} a Base object.\r\n   * @param {object} b Comparison object.\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {Function} [opts.equalsFn={@link utils.deepEqual}] Equality function.\r\n   * @param {array} [opts.ignore=[]] Array of strings or RegExp of fields to ignore.\r\n   * @returns {boolean} Whether the two objects are deeply different.\r\n   * @see utils.diffObjects\r\n   * @since 3.0.0\r\n   */\r\n  areDifferent (newObject, oldObject, opts) {\r\n    opts || (opts = {})\r\n    const diff = utils.diffObjects(newObject, oldObject, opts)\r\n    const diffCount =\r\n      Object.keys(diff.added).length +\r\n      Object.keys(diff.removed).length +\r\n      Object.keys(diff.changed).length\r\n    return diffCount > 0\r\n  },\r\n\r\n  /**\r\n   * Verified that the given constructor is being invoked via `new`, as opposed\r\n   * to just being called like a normal function.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * function Cat () {\r\n   *   utils.classCallCheck(this, Cat);\r\n   * }\r\n   * const cat = new Cat(); // this is ok\r\n   * Cat(); // this throws an error\r\n   *\r\n   * @method utils.classCallCheck\r\n   * @param {*} instance Instance that is being constructed.\r\n   * @param {Constructor} ctor Constructor function used to construct the\r\n   * instance.\r\n   * @since 3.0.0\r\n   * @throws {Error} Throws an error if the constructor is being improperly\r\n   * invoked.\r\n   */\r\n  classCallCheck (instance, ctor) {\r\n    if (!(instance instanceof ctor)) {\r\n      throw utils.err(`${ctor.name}`)(500, 'Cannot call a class as a function')\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Deep copy a value.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const a = { foo: { bar: 'baz' } };\r\n   * const b = utils.copy(a);\r\n   * a === b; // false\r\n   * utils.areDifferent(a, b); // false\r\n   *\r\n   * @param {*} from Value to deep copy.\r\n   * @param {*} [to] Destination object for the copy operation.\r\n   * @param {*} [stackFrom] For internal use.\r\n   * @param {*} [stackTo] For internal use.\r\n   * @param {string[]|RegExp[]} [blacklist] List of strings or RegExp of\r\n   * properties to skip.\r\n   * @param {boolean} [plain] Whether to make a plain copy (don't try to use\r\n   * original prototype).\r\n   * @returns {*} Deep copy of `from`.\r\n   * @since 3.0.0\r\n   */\r\n  copy (from, to, stackFrom, stackTo, blacklist, plain) {\r\n    if (!to) {\r\n      to = from\r\n      if (from) {\r\n        if (utils.isArray(from)) {\r\n          to = utils.copy(from, [], stackFrom, stackTo, blacklist, plain)\r\n        } else if (utils.isDate(from)) {\r\n          to = new Date(from.getTime())\r\n        } else if (utils.isRegExp(from)) {\r\n          to = new RegExp(from.source, from.toString().match(/[^/]*$/)[0])\r\n          to.lastIndex = from.lastIndex\r\n        } else if (utils.isObject(from)) {\r\n          if (plain) {\r\n            to = utils.copy(from, {}, stackFrom, stackTo, blacklist, plain)\r\n          } else {\r\n            to = utils.copy(\r\n              from,\r\n              Object.create(Object.getPrototypeOf(from)),\r\n              stackFrom,\r\n              stackTo,\r\n              blacklist,\r\n              plain\r\n            )\r\n          }\r\n        }\r\n      }\r\n    } else {\r\n      if (from === to) {\r\n        throw utils.err(`${DOMAIN}.copy`)(\r\n          500,\r\n          'Cannot copy! Source and destination are identical.'\r\n        )\r\n      }\r\n\r\n      stackFrom = stackFrom || []\r\n      stackTo = stackTo || []\r\n\r\n      if (utils.isObject(from)) {\r\n        const index = stackFrom.indexOf(from)\r\n        if (index !== -1) {\r\n          return stackTo[index]\r\n        }\r\n\r\n        stackFrom.push(from)\r\n        stackTo.push(to)\r\n      }\r\n\r\n      let result\r\n      if (utils.isArray(from)) {\r\n        let i\r\n        to.length = 0\r\n        for (i = 0; i < from.length; i++) {\r\n          result = utils.copy(\r\n            from[i],\r\n            null,\r\n            stackFrom,\r\n            stackTo,\r\n            blacklist,\r\n            plain\r\n          )\r\n          if (utils.isObject(from[i])) {\r\n            stackFrom.push(from[i])\r\n            stackTo.push(result)\r\n          }\r\n          to.push(result)\r\n        }\r\n      } else {\r\n        if (utils.isArray(to)) {\r\n          to.length = 0\r\n        } else {\r\n          utils.forOwn(to, function (value, key) {\r\n            delete to[key]\r\n          })\r\n        }\r\n        for (var key in from) {\r\n          if (Object.hasOwnProperty.call(from, key)) {\r\n            if (utils.isBlacklisted(key, blacklist)) {\r\n              continue\r\n            }\r\n            result = utils.copy(\r\n              from[key],\r\n              null,\r\n              stackFrom,\r\n              stackTo,\r\n              blacklist,\r\n              plain\r\n            )\r\n            if (utils.isObject(from[key])) {\r\n              stackFrom.push(from[key])\r\n              stackTo.push(result)\r\n            }\r\n            to[key] = result\r\n          }\r\n        }\r\n      }\r\n    }\r\n    return to\r\n  },\r\n\r\n  /**\r\n   * Recursively shallow fill in own enumerable properties from `source` to\r\n   * `dest`.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const a = { foo: { bar: 'baz' }, beep: 'boop' };\r\n   * const b = { beep: 'bip' };\r\n   * utils.deepFillIn(b, a);\r\n   * console.log(b); // {\"foo\":{\"bar\":\"baz\"},\"beep\":\"bip\"}\r\n   *\r\n   * @method utils.deepFillIn\r\n   * @param {object} dest The destination object.\r\n   * @param {object} source The source object.\r\n   * @see utils.fillIn\r\n   * @see utils.deepMixIn\r\n   * @since 3.0.0\r\n   */\r\n  deepFillIn (dest, source) {\r\n    if (source) {\r\n      utils.forOwn(source, function (value, key) {\r\n        const existing = dest[key]\r\n        if (isPlainObject(value) && isPlainObject(existing)) {\r\n          utils.deepFillIn(existing, value)\r\n        } else if (!Object.hasOwnProperty.call(dest, key) || dest[key] === undefined) {\r\n          dest[key] = value\r\n        }\r\n      })\r\n    }\r\n    return dest\r\n  },\r\n\r\n  /**\r\n   * Recursively shallow copy enumerable properties from `source` to `dest`.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const a = { foo: { bar: 'baz' }, beep: 'boop' };\r\n   * const b = { beep: 'bip' };\r\n   * utils.deepFillIn(b, a);\r\n   * console.log(b); // {\"foo\":{\"bar\":\"baz\"},\"beep\":\"boop\"}\r\n   *\r\n   * @method utils.deepMixIn\r\n   * @param {object} dest The destination object.\r\n   * @param {object} source The source object.\r\n   * @see utils.fillIn\r\n   * @see utils.deepFillIn\r\n   * @since 3.0.0\r\n   */\r\n  deepMixIn (dest, source) {\r\n    if (source) {\r\n      for (var key in source) {\r\n        const value = source[key]\r\n        const existing = dest[key]\r\n        if (isPlainObject(value) && isPlainObject(existing)) {\r\n          utils.deepMixIn(existing, value)\r\n        } else {\r\n          dest[key] = value\r\n        }\r\n      }\r\n    }\r\n    return dest\r\n  },\r\n\r\n  /**\r\n   * Return a diff of the base object to the comparison object.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const oldObject = { foo: 'bar', a: 1234 };\r\n   * const newObject = { beep: 'boop', a: 5678 };\r\n   * const diff = utils.diffObjects(oldObject, newObject);\r\n   * console.log(diff.added); // {\"beep\":\"boop\"}\r\n   * console.log(diff.changed); // {\"a\":5678}\r\n   * console.log(diff.removed); // {\"foo\":undefined}\r\n   *\r\n   * @method utils.diffObjects\r\n   * @param {object} newObject Comparison object.\r\n   * @param {object} oldObject Base object.\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {Function} [opts.equalsFn={@link utils.deepEqual}] Equality function.\r\n   * @param {array} [opts.ignore=[]] Array of strings or RegExp of fields to ignore.\r\n   * @returns {Object} The diff from the base object to the comparison object.\r\n   * @see utils.areDifferent\r\n   * @since 3.0.0\r\n   */\r\n  diffObjects (newObject, oldObject, opts) {\r\n    opts || (opts = {})\r\n    let equalsFn = opts.equalsFn\r\n    const blacklist = opts.ignore\r\n    const diff = {\r\n      added: {},\r\n      changed: {},\r\n      removed: {}\r\n    }\r\n    if (!utils.isFunction(equalsFn)) {\r\n      equalsFn = utils.deepEqual\r\n    }\r\n\r\n    const newKeys = Object.keys(newObject).filter(function (key) {\r\n      return !utils.isBlacklisted(key, blacklist)\r\n    })\r\n    const oldKeys = Object.keys(oldObject).filter(function (key) {\r\n      return !utils.isBlacklisted(key, blacklist)\r\n    })\r\n\r\n    // Check for properties that were added or changed\r\n    newKeys.forEach(function (key) {\r\n      const oldValue = oldObject[key]\r\n      const newValue = newObject[key]\r\n      if (equalsFn(oldValue, newValue)) {\r\n        return\r\n      }\r\n      if (oldValue === undefined) {\r\n        diff.added[key] = newValue\r\n      } else {\r\n        diff.changed[key] = newValue\r\n      }\r\n    })\r\n\r\n    // Check for properties that were removed\r\n    oldKeys.forEach(function (key) {\r\n      const oldValue = oldObject[key]\r\n      const newValue = newObject[key]\r\n      if (newValue === undefined && oldValue !== undefined) {\r\n        diff.removed[key] = undefined\r\n      }\r\n    })\r\n\r\n    return diff\r\n  },\r\n\r\n  /**\r\n   * Return whether the two values are equal according to the `==` operator.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * console.log(utils.equal(1,1)); // true\r\n   * console.log(utils.equal(1,'1')); // true\r\n   * console.log(utils.equal(93, 66)); // false\r\n   *\r\n   * @method utils.equal\r\n   * @param {*} a First value in the comparison.\r\n   * @param {*} b Second value in the comparison.\r\n   * @returns {boolean} Whether the two values are equal according to `==`.\r\n   * @since 3.0.0\r\n   */\r\n  equal (a, b) {\r\n    return a == b // eslint-disable-line\r\n  },\r\n\r\n  /**\r\n   * Produce a factory function for making Error objects with the provided\r\n   * metadata. Used throughout the various js-data components.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const errorFactory = utils.err('domain', 'target');\r\n   * const error400 = errorFactory(400, 'expected type', 'actual type');\r\n   * console.log(error400); // [Error: [domain:target] expected: expected type, found: string\r\nhttp://www.js-data.io/v3.0/docs/errors#400]\r\n   * @method utils.err\r\n   * @param {string} domain Namespace.\r\n   * @param {string} target Target.\r\n   * @returns {Function} Factory function.\r\n   * @since 3.0.0\r\n   */\r\n  err (domain, target) {\r\n    return function (code) {\r\n      const prefix = `[${domain}:${target}] `\r\n      let message = ERRORS[code].apply(\r\n        null,\r\n        Array.prototype.slice.call(arguments, 1)\r\n      )\r\n      message = `${prefix}${message}\r\nhttp://www.js-data.io/v3.0/docs/errors#${code}`\r\n      return new Error(message)\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Add eventing capabilities into the target object.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const user = { name: 'John' };\r\n   * utils.eventify(user);\r\n   * user.on('foo', () => console.log(arguments));\r\n   * user.emit('foo', 1, 'bar'); // should log to console values (1, \"bar\")\r\n   *\r\n   * @method utils.eventify\r\n   * @param {object} target Target object.\r\n   * @param {Function} [getter] Custom getter for retrieving the object's event\r\n   * listeners.\r\n   * @param {Function} [setter] Custom setter for setting the object's event\r\n   * listeners.\r\n   * @since 3.0.0\r\n   */\r\n  eventify (target, getter, setter) {\r\n    target = target || this\r\n    let _events = {}\r\n    if (!getter && !setter) {\r\n      getter = function () {\r\n        return _events\r\n      }\r\n      setter = function (value) {\r\n        _events = value\r\n      }\r\n    }\r\n    Object.defineProperties(target, {\r\n      emit: {\r\n        value (...args) {\r\n          const events = getter.call(this) || {}\r\n          const type = args.shift()\r\n          let listeners = events[type] || []\r\n          let i\r\n          for (i = 0; i < listeners.length; i++) {\r\n            listeners[i].f.apply(listeners[i].c, args)\r\n          }\r\n          listeners = events.all || []\r\n          args.unshift(type)\r\n          for (i = 0; i < listeners.length; i++) {\r\n            listeners[i].f.apply(listeners[i].c, args)\r\n          }\r\n        }\r\n      },\r\n      off: {\r\n        value (type, func) {\r\n          const events = getter.call(this)\r\n          const listeners = events[type]\r\n          if (!listeners) {\r\n            setter.call(this, {})\r\n          } else if (func) {\r\n            for (let i = 0; i < listeners.length; i++) {\r\n              if (listeners[i].f === func) {\r\n                listeners.splice(i, 1)\r\n                break\r\n              }\r\n            }\r\n          } else {\r\n            listeners.splice(0, listeners.length)\r\n          }\r\n        }\r\n      },\r\n      on: {\r\n        value (type, func, thisArg) {\r\n          if (!getter.call(this)) {\r\n            setter.call(this, {})\r\n          }\r\n          const events = getter.call(this)\r\n          events[type] = events[type] || []\r\n          events[type].push({\r\n            c: thisArg,\r\n            f: func\r\n          })\r\n        }\r\n      }\r\n    })\r\n  },\r\n\r\n  /**\r\n   * Used for sublcassing. Invoke this method in the context of a superclass to\r\n   * to produce a subclass based on `props` and `classProps`.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * function Animal () {}\r\n   * Animal.extend = utils.extend;\r\n   * const Cat = Animal.extend({\r\n   *   say () {\r\n   *     console.log('meow');\r\n   *   }\r\n   * });\r\n   * const cat = new Cat();\r\n   * cat instanceof Animal; // true\r\n   * cat instanceof Cat; // true\r\n   * cat.say(); // \"meow\"\r\n   *\r\n   * @method utils.extend\r\n   * @param {object} props Instance properties for the subclass.\r\n   * @param {object} [props.constructor] Provide a custom constructor function\r\n   * to use as the subclass.\r\n   * @param {object} props Static properties for the subclass.\r\n   * @returns {Constructor} A new subclass.\r\n   * @since 3.0.0\r\n   */\r\n  extend (props, classProps) {\r\n    const superClass = this\r\n    let subClass\r\n\r\n    props || (props = {})\r\n    classProps || (classProps = {})\r\n\r\n    if (Object.hasOwnProperty.call(props, 'constructor')) {\r\n      subClass = props.constructor\r\n      delete props.constructor\r\n    } else {\r\n      subClass = function (...args) {\r\n        utils.classCallCheck(this, subClass)\r\n        superClass.apply(this, args)\r\n      }\r\n    }\r\n\r\n    // Setup inheritance of instance members\r\n    subClass.prototype = Object.create(superClass && superClass.prototype, {\r\n      constructor: {\r\n        configurable: true,\r\n        enumerable: false,\r\n        value: subClass,\r\n        writable: true\r\n      }\r\n    })\r\n\r\n    const obj = Object\r\n    // Setup inheritance of static members\r\n    if (obj.setPrototypeOf) {\r\n      obj.setPrototypeOf(subClass, superClass)\r\n    } else if (classProps.strictEs6Class) {\r\n      subClass.__proto__ = superClass // eslint-disable-line\r\n    } else {\r\n      utils.forOwn(superClass, function (value, key) {\r\n        subClass[key] = value\r\n      })\r\n    }\r\n    if (!Object.hasOwnProperty.call(subClass, '__super__')) {\r\n      Object.defineProperty(subClass, '__super__', {\r\n        configurable: true,\r\n        value: superClass\r\n      })\r\n    }\r\n\r\n    utils.addHiddenPropsToTarget(subClass.prototype, props)\r\n    utils.fillIn(subClass, classProps)\r\n\r\n    return subClass\r\n  },\r\n\r\n  /**\r\n   * Shallow copy own enumerable properties from `src` to `dest` that are on\r\n   * `src` but are missing from `dest.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const a = { foo: 'bar', beep: 'boop' };\r\n   * const b = { beep: 'bip' };\r\n   * utils.fillIn(b, a);\r\n   * console.log(b); // {\"foo\":\"bar\",\"beep\":\"bip\"}\r\n   *\r\n   * @method utils.fillIn\r\n   * @param {object} dest The destination object.\r\n   * @param {object} source The source object.\r\n   * @see utils.deepFillIn\r\n   * @see utils.deepMixIn\r\n   * @since 3.0.0\r\n   */\r\n  fillIn (dest, src) {\r\n    utils.forOwn(src, function (value, key) {\r\n      if (!Object.hasOwnProperty.call(dest, key) || dest[key] === undefined) {\r\n        dest[key] = value\r\n      }\r\n    })\r\n  },\r\n\r\n  /**\r\n   * Find the last index of an item in an array according to the given checker function.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   *\r\n   * const john = { name: 'John', age: 20 };\r\n   * const sara = { name: 'Sara', age: 25 };\r\n   * const dan = { name: 'Dan', age: 20 };\r\n   * const users = [john, sara, dan];\r\n   *\r\n   * console.log(utils.findIndex(users, (user) => user.age === 25)); // 1\r\n   * console.log(utils.findIndex(users, (user) => user.age > 19)); // 2\r\n   * console.log(utils.findIndex(users, (user) => user.name === 'John')); // 0\r\n   * console.log(utils.findIndex(users, (user) => user.name === 'Jimmy')); // -1\r\n   *\r\n   * @method utils.findIndex\r\n   * @param {array} array The array to search.\r\n   * @param {Function} fn Checker function.\r\n   * @returns {number} Index if found or -1 if not found.\r\n   * @since 3.0.0\r\n   */\r\n  findIndex (array, fn) {\r\n    let index = -1\r\n    if (!array) {\r\n      return index\r\n    }\r\n    array.forEach(function (record, i) {\r\n      if (fn(record)) {\r\n        index = i\r\n        return false\r\n      }\r\n    })\r\n    return index\r\n  },\r\n\r\n  /**\r\n   * Recursively iterate over a {@link Mapper}'s relations according to\r\n   * `opts.with`.\r\n   *\r\n   * @method utils.forEachRelation\r\n   * @param {Mapper} mapper Mapper.\r\n   * @param {object} opts Configuration options.\r\n   * @param {Function} fn Callback function.\r\n   * @param {*} thisArg Execution context for the callback function.\r\n   * @since 3.0.0\r\n   */\r\n  forEachRelation (mapper, opts, fn, thisArg) {\r\n    const relationList = mapper.relationList || []\r\n    if (!relationList.length) {\r\n      return\r\n    }\r\n    relationList.forEach(function (def) {\r\n      utils._forRelation(opts, def, fn, thisArg)\r\n    })\r\n  },\r\n\r\n  /**\r\n   * Iterate over an object's own enumerable properties.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const a = { b: 1, c: 4 };\r\n   * let sum = 0;\r\n   * utils.forOwn(a, function (value, key) {\r\n   *   sum += value;\r\n   * });\r\n   * console.log(sum); // 5\r\n   *\r\n   * @method utils.forOwn\r\n   * @param {object} object The object whose properties are to be enumerated.\r\n   * @param {Function} fn Iteration function.\r\n   * @param {object} [thisArg] Content to which to bind `fn`.\r\n   * @since 3.0.0\r\n   */\r\n  forOwn (obj, fn, thisArg) {\r\n    const keys = Object.keys(obj)\r\n    const len = keys.length\r\n    let i\r\n    for (i = 0; i < len; i++) {\r\n      if (fn.call(thisArg, obj[keys[i]], keys[i], obj) === false) {\r\n        break\r\n      }\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Proxy for `JSON.parse`.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   *\r\n   * const a = utils.fromJson('{\"name\" : \"John\"}');\r\n   * console.log(a); // { name: 'John' }\r\n   *\r\n   * @method utils.fromJson\r\n   * @param {string} json JSON to parse.\r\n   * @returns {Object} Parsed object.\r\n   * @see utils.toJson\r\n   * @since 3.0.0\r\n   */\r\n  fromJson (json) {\r\n    return utils.isString(json) ? JSON.parse(json) : json\r\n  },\r\n\r\n  /**\r\n   * Retrieve the specified property from the given object. Supports retrieving\r\n   * nested properties.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const a = { foo: { bar: 'baz' }, beep: 'boop' };\r\n   * console.log(utils.get(a, 'beep')); // \"boop\"\r\n   * console.log(utils.get(a, 'foo.bar')); // \"baz\"\r\n   *\r\n   * @method utils.get\r\n   * @param {object} object Object from which to retrieve a property's value.\r\n   * @param {string} prop Property to retrieve.\r\n   * @returns {*} Value of the specified property.\r\n   * @see utils.set\r\n   * @since 3.0.0\r\n   */\r\n  get: function (object, prop) {\r\n    if (!prop) {\r\n      return\r\n    }\r\n    /* if prop is function, get the property by calling a function, passing an object as a parameter */\r\n    if (utils.isFunction(prop)) {\r\n      return prop(object)\r\n    }\r\n    const parts = prop.split('.')\r\n    const last = parts.pop()\r\n\r\n    while ((prop = parts.shift())) {\r\n      // eslint-disable-line\r\n      object = object[prop]\r\n      if (object == null) {\r\n        // eslint-disable-line\r\n        return\r\n      }\r\n    }\r\n\r\n    return object[last]\r\n  },\r\n\r\n  /**\r\n   * Return the superclass for the given instance or subclass. If an instance is\r\n   * provided, then finds the parent class of the instance's constructor.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * // using ES2015 classes\r\n   * class Foo {}\r\n   * class Bar extends Foo {}\r\n   * const barInstance = new Bar();\r\n   * let baseType = utils.getSuper(barInstance);\r\n   * console.log(Foo === baseType); // true\r\n   *\r\n   * // using Function constructor with utils.extend\r\n   * function Foo () {}\r\n   * Foo.extend = utils.extend;\r\n   * const Bar = Foo.extend();\r\n   * const barInstance = new Bar();\r\n   * let baseType = utils.getSuper(barInstance);\r\n   * console.log(Foo === baseType); // true\r\n   *\r\n   * @method utils.getSuper\r\n   * @param {Object|Function} instance Instance or constructor.\r\n   * @param {boolean} [isCtor=false] Whether `instance` is a constructor.\r\n   * @returns {Constructor} The superclass (grandparent constructor).\r\n   * @since 3.0.0\r\n   */\r\n  getSuper (instance, isCtor) {\r\n    const ctor = isCtor ? instance : instance.constructor\r\n    if (Object.hasOwnProperty.call(ctor, '__super__')) {\r\n      return ctor.__super__\r\n    }\r\n    return Object.getPrototypeOf(ctor) || ctor.__proto__ // eslint-disable-line\r\n  },\r\n\r\n  /**\r\n   * Return the intersection of two arrays.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const arrA = ['green', 'red', 'blue', 'red'];\r\n   * const arrB = ['green', 'yellow', 'red'];\r\n   * const intersected = utils.intersection(arrA, arrB);\r\n   *\r\n   * console.log(intersected); // ['green', 'red'])\r\n   *\r\n   * @method utils.intersection\r\n   * @param {array} array1 First array.\r\n   * @param {array} array2 Second array.\r\n   * @returns {Array} Array of elements common to both arrays.\r\n   * @since 3.0.0\r\n   */\r\n  intersection (array1, array2) {\r\n    if (!array1 || !array2) {\r\n      return []\r\n    }\r\n    array1 = Array.isArray(array1) ? array1 : [array1]\r\n    array2 = Array.isArray(array2) ? array2 : [array2]\r\n    const result = []\r\n    let item\r\n    let i\r\n    const len = array1.length\r\n    for (i = 0; i < len; i++) {\r\n      item = array1[i]\r\n      if (result.indexOf(item) !== -1) {\r\n        continue\r\n      }\r\n      if (array2.indexOf(item) !== -1) {\r\n        result.push(item)\r\n      }\r\n    }\r\n    return result\r\n  },\r\n\r\n  /**\r\n   * Proxy for `Array.isArray`.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const a = [1,2,3,4,5];\r\n   * const b = { foo: \"bar\" };\r\n   * console.log(utils.isArray(a)); // true\r\n   * console.log(utils.isArray(b)); // false\r\n   *\r\n   * @method utils.isArray\r\n   * @param {*} value The value to test.\r\n   * @returns {boolean} Whether the provided value is an array.\r\n   * @since 3.0.0\r\n   */\r\n  isArray: Array.isArray,\r\n\r\n  /**\r\n   * Return whether `prop` is matched by any string or regular expression in\r\n   * `blacklist`.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const blacklist = [/^\\$hashKey/g, /^_/g, 'id'];\r\n   * console.log(utils.isBlacklisted(\"$hashKey\", blacklist)); // true\r\n   * console.log(utils.isBlacklisted(\"id\", blacklist)); // true\r\n   * console.log(utils.isBlacklisted(\"_myProp\", blacklist)); // true\r\n   * console.log(utils.isBlacklisted(\"my_id\", blacklist)); // false\r\n   *\r\n   * @method utils.isBlacklisted\r\n   * @param {string} prop The name of a property to check.\r\n   * @param {array} blacklist Array of strings and regular expressions.\r\n   * @returns {boolean} Whether `prop` was matched.\r\n   * @since 3.0.0\r\n   */\r\n  isBlacklisted (prop, blacklist) {\r\n    if (!blacklist || !blacklist.length) {\r\n      return false\r\n    }\r\n    let matches\r\n    for (var i = 0; i < blacklist.length; i++) {\r\n      if (\r\n        (toStr(blacklist[i]) === REGEXP_TAG && blacklist[i].test(prop)) ||\r\n        blacklist[i] === prop\r\n      ) {\r\n        matches = prop\r\n        return !!matches\r\n      }\r\n    }\r\n    return !!matches\r\n  },\r\n\r\n  /**\r\n   * Return whether the provided value is a boolean.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const a = true;\r\n   * const b = { foo: \"bar\" };\r\n   * console.log(utils.isBoolean(a)); // true\r\n   * console.log(utils.isBoolean(b)); // false\r\n   *\r\n   * @method utils.isBoolean\r\n   * @param {*} value The value to test.\r\n   * @returns {boolean} Whether the provided value is a boolean.\r\n   * @since 3.0.0\r\n   */\r\n  isBoolean (value) {\r\n    return toStr(value) === BOOL_TAG\r\n  },\r\n\r\n  /**\r\n   * Return whether the provided value is a date.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const a = new Date();\r\n   * const b = { foo: \"bar\" };\r\n   * console.log(utils.isDate(a)); // true\r\n   * console.log(utils.isDate(b)); // false\r\n   *\r\n   * @method utils.isDate\r\n   * @param {*} value The value to test.\r\n   * @returns {Date} Whether the provided value is a date.\r\n   * @since 3.0.0\r\n   */\r\n  isDate (value) {\r\n    return value && typeof value === 'object' && toStr(value) === DATE_TAG\r\n  },\r\n\r\n  /**\r\n   * Return whether the provided value is a function.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const a = function () { console.log('foo bar'); };\r\n   * const b = { foo: \"bar\" };\r\n   * console.log(utils.isFunction(a)); // true\r\n   * console.log(utils.isFunction(b)); // false\r\n   *\r\n   * @method utils.isFunction\r\n   * @param {*} value The value to test.\r\n   * @returns {boolean} Whether the provided value is a function.\r\n   * @since 3.0.0\r\n   */\r\n  isFunction (value) {\r\n    return typeof value === 'function' || (value && toStr(value) === FUNC_TAG)\r\n  },\r\n\r\n  /**\r\n   * Return whether the provided value is an integer.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const a = 1;\r\n   * const b = 1.25;\r\n   * const c = '1';\r\n   * console.log(utils.isInteger(a)); // true\r\n   * console.log(utils.isInteger(b)); // false\r\n   * console.log(utils.isInteger(c)); // false\r\n   *\r\n   * @method utils.isInteger\r\n   * @param {*} value The value to test.\r\n   * @returns {boolean} Whether the provided value is an integer.\r\n   * @since 3.0.0\r\n   */\r\n  isInteger (value) {\r\n    return toStr(value) === NUMBER_TAG && value == toInteger(value) // eslint-disable-line\r\n  },\r\n\r\n  /**\r\n   * Return whether the provided value is `null`.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const a = null;\r\n   * const b = { foo: \"bar\" };\r\n   * console.log(utils.isNull(a)); // true\r\n   * console.log(utils.isNull(b)); // false\r\n   *\r\n   * @method utils.isNull\r\n   * @param {*} value The value to test.\r\n   * @returns {boolean} Whether the provided value is `null`.\r\n   * @since 3.0.0\r\n   */\r\n  isNull (value) {\r\n    return value === null\r\n  },\r\n\r\n  /**\r\n   * Return whether the provided value is a number.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const a = 1;\r\n   * const b = -1.25;\r\n   * const c = '1';\r\n   * console.log(utils.isNumber(a)); // true\r\n   * console.log(utils.isNumber(b)); // true\r\n   * console.log(utils.isNumber(c)); // false\r\n   *\r\n   * @method utils.isNumber\r\n   * @param {*} value The value to test.\r\n   * @returns {boolean} Whether the provided value is a number.\r\n   * @since 3.0.0\r\n   */\r\n  isNumber (value) {\r\n    const type = typeof value\r\n    return (\r\n      type === 'number' ||\r\n      (value && type === 'object' && toStr(value) === NUMBER_TAG)\r\n    )\r\n  },\r\n\r\n  /**\r\n   * Return whether the provided value is an object.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const a = { foo: \"bar\" };\r\n   * const b = 'foo bar';\r\n   * console.log(utils.isObject(a)); // true\r\n   * console.log(utils.isObject(b)); // false\r\n   *\r\n   * @method utils.isObject\r\n   * @param {*} value The value to test.\r\n   * @returns {boolean} Whether the provided value is an object.\r\n   * @since 3.0.0\r\n   */\r\n  isObject (value) {\r\n    return toStr(value) === OBJECT_TAG\r\n  },\r\n\r\n  /**\r\n   * Return whether the provided value is a regular expression.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const a = /^\\$.+$/ig;\r\n   * const b = new RegExp('^\\$.+$', 'ig');\r\n   * const c = { foo: \"bar\" };\r\n   * console.log(utils.isRegExp(a)); // true\r\n   * console.log(utils.isRegExp(b)); // true\r\n   * console.log(utils.isRegExp(c)); // false\r\n   *\r\n   * @method utils.isRegExp\r\n   * @param {*} value The value to test.\r\n   * @returns {boolean} Whether the provided value is a regular expression.\r\n   * @since 3.0.0\r\n   */\r\n  isRegExp (value) {\r\n    return toStr(value) === REGEXP_TAG\r\n  },\r\n\r\n  /**\r\n   * Return whether the provided value is a string or a number.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * console.log(utils.isSorN('')); // true\r\n   * console.log(utils.isSorN(-1.65)); // true\r\n   * console.log(utils.isSorN('my string')); // true\r\n   * console.log(utils.isSorN({})); // false\r\n   * console.log(utils.isSorN([1,2,4])); // false\r\n   *\r\n   * @method utils.isSorN\r\n   * @param {*} value The value to test.\r\n   * @returns {boolean} Whether the provided value is a string or a number.\r\n   * @since 3.0.0\r\n   */\r\n  isSorN (value) {\r\n    return utils.isString(value) || utils.isNumber(value)\r\n  },\r\n\r\n  /**\r\n   * Return whether the provided value is a string.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * console.log(utils.isString('')); // true\r\n   * console.log(utils.isString('my string')); // true\r\n   * console.log(utils.isString(100)); // false\r\n   * console.log(utils.isString([1,2,4])); // false\r\n   *\r\n   * @method utils.isString\r\n   * @param {*} value The value to test.\r\n   * @returns {boolean} Whether the provided value is a string.\r\n   * @since 3.0.0\r\n   */\r\n  isString (value) {\r\n    return (\r\n      typeof value === 'string' ||\r\n      (value && typeof value === 'object' && toStr(value) === STRING_TAG)\r\n    )\r\n  },\r\n\r\n  /**\r\n   * Return whether the provided value is a `undefined`.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const a = undefined;\r\n   * const b = { foo: \"bar\"};\r\n   * console.log(utils.isUndefined(a)); // true\r\n   * console.log(utils.isUndefined(b.baz)); // true\r\n   * console.log(utils.isUndefined(b)); // false\r\n   * console.log(utils.isUndefined(b.foo)); // false\r\n   *\r\n   * @method utils.isUndefined\r\n   * @param {*} value The value to test.\r\n   * @returns {boolean} Whether the provided value is a `undefined`.\r\n   * @since 3.0.0\r\n   */\r\n  isUndefined (value) {\r\n    return value === undefined\r\n  },\r\n\r\n  /**\r\n   * Mix in logging capabilities to the target.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const a = { foo: \"bar\"};\r\n   *\r\n   * // Add standard logging to an object\r\n   * utils.logify(a);\r\n   * a.log('info', 'test log info'); // output 'test log info' to console.\r\n   *\r\n   * // Toggle debug output of an object\r\n   * a.dbg('test debug output'); // does not output because debug is off.\r\n   * a.debug = true;\r\n   * a.dbg('test debug output'); // output 'test debug output' to console.\r\n   *\r\n   * @method utils.logify\r\n   * @param {*} target The target.\r\n   * @since 3.0.0\r\n   */\r\n  logify (target) {\r\n    utils.addHiddenPropsToTarget(target, {\r\n      dbg (...args) {\r\n        if (utils.isFunction(this.log)) {\r\n          this.log('debug', ...args)\r\n        }\r\n      },\r\n      log (level, ...args) {\r\n        if (level && !args.length) {\r\n          args.push(level)\r\n          level = 'debug'\r\n        }\r\n        if (level === 'debug' && !this.debug) {\r\n          return\r\n        }\r\n        const prefix = `${level.toUpperCase()}: (${this.name ||\r\n          this.constructor.name})`\r\n        if (utils.isFunction(console[level])) {\r\n          console[level](prefix, ...args)\r\n        } else {\r\n          console.log(prefix, ...args)\r\n        }\r\n      }\r\n    })\r\n  },\r\n\r\n  /**\r\n   * Adds the given record to the provided array only if it's not already in the\r\n   * array.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const colors = ['red', 'green', 'yellow'];\r\n   *\r\n   * console.log(colors.length); // 3\r\n   * utils.noDupeAdd(colors, 'red');\r\n   * console.log(colors.length); // 3, red already exists\r\n   *\r\n   * utils.noDupeAdd(colors, 'blue');\r\n   * console.log(colors.length); // 4, blue was added\r\n   *\r\n   * @method utils.noDupeAdd\r\n   * @param {array} array The array.\r\n   * @param {*} record The value to add.\r\n   * @param {Function} fn Callback function passed to {@link utils.findIndex}.\r\n   * @since 3.0.0\r\n   */\r\n  noDupeAdd (array, record, fn) {\r\n    if (!array) {\r\n      return\r\n    }\r\n    const index = this.findIndex(array, fn)\r\n    if (index < 0) {\r\n      array.push(record)\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Return a shallow copy of the provided object, minus the properties\r\n   * specified in `keys`.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const a = { name: 'John', $hashKey: 1214910 };\r\n   *\r\n   * let b = utils.omit(a, ['$hashKey']);\r\n   * console.log(b); // { name: 'John' }\r\n   *\r\n   * @method utils.omit\r\n   * @param {object} props The object to copy.\r\n   * @param {string[]} keys Array of strings, representing properties to skip.\r\n   * @returns {Object} Shallow copy of `props`, minus `keys`.\r\n   * @since 3.0.0\r\n   */\r\n  omit (props, keys) {\r\n    const _props = {}\r\n    utils.forOwn(props, function (value, key) {\r\n      if (keys.indexOf(key) === -1) {\r\n        _props[key] = value\r\n      }\r\n    })\r\n    return _props\r\n  },\r\n\r\n  /**\r\n   * Return a shallow copy of the provided object, but only include the\r\n   * properties specified in `keys`.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const a = { name: 'John', $hashKey: 1214910 };\r\n   *\r\n   * let b = utils.pick(a, ['$hashKey']);\r\n   * console.log(b); // { $hashKey: 1214910 }\r\n   *\r\n   * @method utils.pick\r\n   * @param {object} props The object to copy.\r\n   * @param {string[]} keys Array of strings, representing properties to keep.\r\n   * @returns {Object} Shallow copy of `props`, but only including `keys`.\r\n   * @since 3.0.0\r\n   */\r\n  pick (props, keys) {\r\n    return keys.reduce((map, key) => {\r\n      map[key] = props[key]\r\n      return map\r\n    }, {})\r\n  },\r\n\r\n  /**\r\n   * Return a plain copy of the given value.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   * const a = { name: 'John' };\r\n   * let b = utils.plainCopy(a);\r\n   * console.log(a === b); // false\r\n   *\r\n   * @method utils.plainCopy\r\n   * @param {*} value The value to copy.\r\n   * @returns {*} Plain copy of `value`.\r\n   * @see utils.copy\r\n   * @since 3.0.0\r\n   */\r\n  plainCopy (value) {\r\n    return utils.copy(value, undefined, undefined, undefined, undefined, true)\r\n  },\r\n\r\n  /**\r\n   * Shortcut for `utils.Promise.reject(value)`.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   *\r\n   * utils.reject(\"Testing static reject\").then(function (data) {\r\n   *   // not called\r\n   * }).catch(function (reason) {\r\n   *   console.log(reason); // \"Testing static reject\"\r\n   * });\r\n   *\r\n   * @method utils.reject\r\n   * @param {*} [value] Value with which to reject the Promise.\r\n   * @returns {Promise} Promise reject with `value`.\r\n   * @see utils.Promise\r\n   * @since 3.0.0\r\n   */\r\n  reject (value) {\r\n    return utils.Promise.reject(value)\r\n  },\r\n\r\n  /**\r\n   * Remove the last item found in array according to the given checker function.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   *\r\n   * const colors = ['red', 'green', 'yellow', 'red'];\r\n   * utils.remove(colors, (color) => color === 'red');\r\n   * console.log(colors); // ['red', 'green', 'yellow']\r\n   *\r\n   * @method utils.remove\r\n   * @param {array} array The array to search.\r\n   * @param {Function} fn Checker function.\r\n   */\r\n  remove (array, fn) {\r\n    if (!array || !array.length) {\r\n      return\r\n    }\r\n    const index = this.findIndex(array, fn)\r\n    if (index >= 0) {\r\n      array.splice(index, 1) // todo should this be recursive?\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Shortcut for `utils.Promise.resolve(value)`.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   *\r\n   * utils.resolve(\"Testing static resolve\").then(function (data) {\r\n   *   console.log(data); // \"Testing static resolve\"\r\n   * }).catch(function (reason) {\r\n   *   // not called\r\n   * });\r\n   *\r\n   * @param {*} [value] Value with which to resolve the Promise.\r\n   * @returns {Promise} Promise resolved with `value`.\r\n   * @see utils.Promise\r\n   * @since 3.0.0\r\n   */\r\n  resolve (value) {\r\n    return utils.Promise.resolve(value)\r\n  },\r\n\r\n  /**\r\n   * Set the value at the provided key or path.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   *\r\n   * const john = {\r\n   *   name: 'John',\r\n   *   age: 25,\r\n   *   parent: {\r\n   *     name: 'John's Mom',\r\n   *     age: 50\r\n   *   }\r\n   * };\r\n   * // set value by key\r\n   * utils.set(john, 'id', 98);\r\n   * console.log(john.id); // 98\r\n   *\r\n   * // set value by path\r\n   * utils.set(john, 'parent.id', 20);\r\n   * console.log(john.parent.id); // 20\r\n   *\r\n   * // set value by path/value map\r\n   * utils.set(john, {\r\n   *   'id': 1098,\r\n   *   'parent': { id: 1020 },\r\n   *   'parent.age': '55'\r\n   * });\r\n   * console.log(john.id); // 1098\r\n   * console.log(john.parent.id); // 1020\r\n   * console.log(john.parent.age); // 55\r\n   *\r\n   * @method utils.set\r\n   * @param {object} object The object on which to set a property.\r\n   * @param {(string|Object)} path The key or path to the property. Can also\r\n   * pass in an object of path/value pairs, which will all be set on the target\r\n   * object.\r\n   * @param {*} [value] The value to set.\r\n   */\r\n  set: function (object, path, value) {\r\n    if (utils.isObject(path)) {\r\n      utils.forOwn(path, function (value, _path) {\r\n        utils.set(object, _path, value)\r\n      })\r\n    } else {\r\n      const parts = PATH.exec(path)\r\n      if (parts) {\r\n        mkdirP(object, parts[1])[parts[2]] = value\r\n      } else {\r\n        object[path] = value\r\n      }\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Check whether the two provided objects are deeply equal.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   *\r\n   * const objA = {\r\n   *   name: 'John',\r\n   *   id: 27,\r\n   *   nested: {\r\n   *     item: 'item 1',\r\n   *     colors: ['red', 'green', 'blue']\r\n   *   }\r\n   * };\r\n   *\r\n   * const objB = {\r\n   *   name: 'John',\r\n   *   id: 27,\r\n   *   nested: {\r\n   *     item: 'item 1',\r\n   *     colors: ['red', 'green', 'blue']\r\n   *   }\r\n   * };\r\n   *\r\n   * console.log(utils.deepEqual(a,b)); // true\r\n   * objB.nested.colors.add('yellow'); // make a change to a nested object's array\r\n   * console.log(utils.deepEqual(a,b)); // false\r\n   *\r\n   * @method utils.deepEqual\r\n   * @param {object} a First object in the comparison.\r\n   * @param {object} b Second object in the comparison.\r\n   * @returns {boolean} Whether the two provided objects are deeply equal.\r\n   * @see utils.equal\r\n   * @since 3.0.0\r\n   */\r\n  deepEqual (a, b) {\r\n    if (a === b) {\r\n      return true\r\n    }\r\n    let _equal = true\r\n    if (utils.isArray(a) && utils.isArray(b)) {\r\n      if (a.length !== b.length) {\r\n        return false\r\n      }\r\n      for (let i = a.length; i--;) {\r\n        if (!utils.deepEqual(a[i], b[i])) {\r\n          // Exit loop early\r\n          return false\r\n        }\r\n      }\r\n    } else if (utils.isObject(a) && utils.isObject(b)) {\r\n      utils.forOwn(a, function (value, key) {\r\n        if (!(_equal = utils.deepEqual(value, b[key]))) {\r\n          // Exit loop early\r\n          return false\r\n        }\r\n      })\r\n      if (_equal) {\r\n        utils.forOwn(b, function (value, key) {\r\n          if (!(_equal = utils.deepEqual(value, a[key]))) {\r\n            // Exit loop early\r\n            return false\r\n          }\r\n        })\r\n      }\r\n    } else {\r\n      return false\r\n    }\r\n    return _equal\r\n  },\r\n\r\n  /**\r\n   * Proxy for `JSON.stringify`.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   *\r\n   * const a = { name: 'John' };\r\n   * let jsonVal = utils.toJson(a);\r\n   * console.log(jsonVal); // '{\"name\" : \"John\"}'\r\n   *\r\n   * @method utils.toJson\r\n   * @param {*} value Value to serialize to JSON.\r\n   * @returns {string} JSON string.\r\n   * @see utils.fromJson\r\n   * @since 3.0.0\r\n   */\r\n  toJson: JSON.stringify,\r\n\r\n  /**\r\n   * Unset the value at the provided key or path.\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   *\r\n   * const john = {\r\n   *   name: 'John',\r\n   *   age: 25,\r\n   *   parent: {\r\n   *     name: 'John's Mom',\r\n   *     age: 50\r\n   *   }\r\n   * };\r\n   *\r\n   * utils.unset(john, age);\r\n   * utils.unset(john, parent.age);\r\n   *\r\n   * console.log(john.age); // null\r\n   * console.log(john.parent.age); // null\r\n   *\r\n   * @method utils.unset\r\n   * @param {object} object The object from which to delete the property.\r\n   * @param {string} path The key or path to the property.\r\n   * @see utils.set\r\n   * @since 3.0.0\r\n   */\r\n  unset (object, path) {\r\n    const parts = path.split('.')\r\n    const last = parts.pop()\r\n\r\n    while ((path = parts.shift())) {\r\n      // eslint-disable-line\r\n      object = object[path]\r\n      if (object == null) {\r\n        // eslint-disable-line\r\n        return\r\n      }\r\n    }\r\n\r\n    object[last] = undefined\r\n  },\r\n\r\n  /**\r\n   * Check if in the browser and is Microsoft Edge\r\n   *\r\n   * @example\r\n   * import { utils } from 'js-data';\r\n   *\r\n   *\r\n   * utils.isEdge();\r\n   *\r\n   * @method utils.isEdge\r\n   * @since 3.0.0\r\n   */\r\n  getDefaultLocale () {\r\n    if (typeof navigator !== 'undefined' && navigator.userAgent.indexOf('Edge') > -1) {\r\n      return 'en'\r\n    }\r\n    return undefined\r\n  }\r\n}\r\n\r\nexport const safeSetProp = function (record, field, value) {\r\n  if (record && record._set) {\r\n    record._set(`props.${field}`, value)\r\n  } else {\r\n    utils.set(record, field, value)\r\n  }\r\n}\r\n\r\nexport const safeSetLink = function (record, field, value) {\r\n  if (record && record._set) {\r\n    record._set(`links.${field}`, value)\r\n  } else {\r\n    utils.set(record, field, value)\r\n  }\r\n}\r\n\r\nexport default utils\r\n","import utils from './utils'\r\n\r\n/**\r\n * A base class which gives instances private properties.\r\n *\r\n * Typically you won't instantiate this class directly, but you may find it\r\n * useful as an abstract class for your own components.\r\n *\r\n * See {@link Settable.extend} for an example of using {@link Settable} as a\r\n * base class.\r\n *\r\n *```javascript\r\n * import {Settable} from 'js-data'\r\n * ```\r\n *\r\n * @class Settable\r\n * @returns {Settable} A new {@link Settable} instance.\r\n * @since 3.0.0\r\n */\r\nexport default function Settable () {\r\n  const _props = {}\r\n  Object.defineProperties(this, {\r\n    /**\r\n     * Get a private property of this instance.\r\n     *\r\n     * __Don't use the method unless you know what you're doing.__\r\n     *\r\n     * @method Settable#_get\r\n     * @param {string} key The property to retrieve.\r\n     * @returns {*} The value of the property.\r\n     * @since 3.0.0\r\n     */\r\n    _get: { value (key) { return utils.get(_props, key) } },\r\n\r\n    /**\r\n     * Set a private property of this instance.\r\n     *\r\n     * __Don't use the method unless you know what you're doing.__\r\n     *\r\n     * @method __Don't use the method unless you know what you're doing.__#_set\r\n     * @param {(string|Object)} key The key or path to the property. Can also\r\n     * pass in an object of key/value pairs, which will all be set on the instance.\r\n     * @param {*} [value] The value to set.\r\n     * @since 3.0.0\r\n     */\r\n    _set: { value (key, value) { return utils.set(_props, key, value) } },\r\n\r\n    /**\r\n     * Unset a private property of this instance.\r\n     *\r\n     * __Don't use the method unless you know what you're doing.__\r\n     *\r\n     * @method __Don't use the method unless you know what you're doing.__#_unset\r\n     * @param {string} key The property to unset.\r\n     * @since 3.0.0\r\n     */\r\n    _unset: { value (key) { return utils.unset(_props, key) } }\r\n  })\r\n}\r\n\r\n/**\r\n * Create a subclass of this Settable:\r\n *\r\n * @example <caption>Settable.extend</caption>\r\n * const JSData = require('js-data');\r\n * const { Settable } = JSData;\r\n * console.log('Using JSData v' + JSData.version.full);\r\n *\r\n * // Extend the class using ES2015 class syntax.\r\n * class CustomSettableClass extends Settable {\r\n *   foo () { return 'bar'; }\r\n *   static beep () { return 'boop'; }\r\n * }\r\n * const customSettable = new CustomSettableClass();\r\n * console.log(customSettable.foo());\r\n * console.log(CustomSettableClass.beep());\r\n *\r\n * // Extend the class using alternate method.\r\n * const OtherSettableClass = Settable.extend({\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * });\r\n * const otherSettable = new OtherSettableClass();\r\n * console.log(otherSettable.foo());\r\n * console.log(OtherSettableClass.beep());\r\n *\r\n * // Extend the class, providing a custom constructor.\r\n * function AnotherSettableClass () {\r\n *   Settable.call(this);\r\n *   this.created_at = new Date().getTime();\r\n * }\r\n * Settable.extend({\r\n *   constructor: AnotherSettableClass,\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * })\r\n * const anotherSettable = new AnotherSettableClass();\r\n * console.log(anotherSettable.created_at);\r\n * console.log(anotherSettable.foo());\r\n * console.log(AnotherSettableClass.beep());\r\n *\r\n * @method Settable.extend\r\n * @param {object} [props={}] Properties to add to the prototype of the\r\n * subclass.\r\n * @param {object} [props.constructor] Provide a custom constructor function\r\n * to be used as the subclass itself.\r\n * @param {object} [classProps={}] Static properties to add to the subclass.\r\n * @returns {Constructor} Subclass of this Settable class.\r\n * @since 3.0.0\r\n */\r\nSettable.extend = utils.extend\r\n","import utils from './utils'\r\nimport Settable from './Settable'\r\n\r\n/**\r\n * The base class from which all JSData components inherit some basic\r\n * functionality.\r\n *\r\n * Typically you won't instantiate this class directly, but you may find it\r\n * useful as an abstract class for your own components.\r\n *\r\n * See {@link Component.extend} for an example of using {@link Component} as a\r\n * base class.\r\n *\r\n *```javascript\r\n * import {Component} from 'js-data'\r\n * ```\r\n *\r\n * @class Component\r\n * @param {object} [opts] Configuration options.\r\n * @param {boolean} [opts.debug=false] See {@link Component#debug}.\r\n * @returns {Component} A new {@link Component} instance.\r\n * @since 3.0.0\r\n */\r\nfunction Component (opts) {\r\n  Settable.call(this)\r\n  opts || (opts = {})\r\n\r\n  /**\r\n   * Whether to enable debug-level logs for this component. Anything that\r\n   * extends `Component` inherits this option and the corresponding logging\r\n   * functionality.\r\n   *\r\n   * @example <caption>Component#debug</caption>\r\n   * const JSData = require('js-data');\r\n   * const { Component } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const component = new Component();\r\n   * component.log('debug', 'some message'); // nothing gets logged\r\n   * // Display debug logs:\r\n   * component.debug = true;\r\n   * component.log('debug', 'other message'); // this DOES get logged\r\n   *\r\n   * @default false\r\n   * @name Component#debug\r\n   * @since 3.0.0\r\n   * @type {boolean}\r\n   */\r\n  this.debug = Object.hasOwnProperty.call(opts, 'debug') ? !!opts.debug : false\r\n\r\n  /**\r\n   * Event listeners attached to this Component. __Do not modify.__ Use\r\n   * {@link Component#on} and {@link Component#off} instead.\r\n   *\r\n   * @name Component#_listeners\r\n   * @private\r\n   * @instance\r\n   * @since 3.0.0\r\n   * @type {Object}\r\n   */\r\n  Object.defineProperty(this, '_listeners', { value: {}, writable: true })\r\n}\r\n\r\nexport default Settable.extend({\r\n  constructor: Component\r\n})\r\n\r\n/**\r\n * Create a subclass of this Component:\r\n *\r\n * @example <caption>Component.extend</caption>\r\n * const JSData = require('js-data');\r\n * const { Component } = JSData;\r\n * console.log('Using JSData v' + JSData.version.full);\r\n *\r\n * // Extend the class using ES2015 class syntax.\r\n * class CustomComponentClass extends Component {\r\n *   foo () { return 'bar'; }\r\n *   static beep () { return 'boop'; }\r\n * }\r\n * const customComponent = new CustomComponentClass();\r\n * console.log(customComponent.foo());\r\n * console.log(CustomComponentClass.beep());\r\n *\r\n * // Extend the class using alternate method.\r\n * const OtherComponentClass = Component.extend({\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * });\r\n * const otherComponent = new OtherComponentClass();\r\n * console.log(otherComponent.foo());\r\n * console.log(OtherComponentClass.beep());\r\n *\r\n * // Extend the class, providing a custom constructor.\r\n * function AnotherComponentClass () {\r\n *   Component.call(this);\r\n *   this.created_at = new Date().getTime();\r\n * }\r\n * Component.extend({\r\n *   constructor: AnotherComponentClass,\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * })\r\n * const anotherComponent = new AnotherComponentClass();\r\n * console.log(anotherComponent.created_at);\r\n * console.log(anotherComponent.foo());\r\n * console.log(AnotherComponentClass.beep());\r\n *\r\n * @method Component.extend\r\n * @param {object} [props={}] Properties to add to the prototype of the\r\n * subclass.\r\n * @param {object} [props.constructor] Provide a custom constructor function\r\n * to be used as the subclass itself.\r\n * @param {object} [classProps={}] Static properties to add to the subclass.\r\n * @returns {Constructor} Subclass of this Component class.\r\n * @since 3.0.0\r\n */\r\nComponent.extend = utils.extend\r\n\r\n/**\r\n * Log the provided values at the \"debug\" level. Debug-level logs are only\r\n * logged if {@link Component#debug} is `true`.\r\n *\r\n * `.dbg(...)` is shorthand for `.log('debug', ...)`.\r\n *\r\n * @method Component#dbg\r\n * @param {...*} [args] Values to log.\r\n * @since 3.0.0\r\n */\r\n/**\r\n * Log the provided values. By default sends values to `console[level]`.\r\n * Debug-level logs are only logged if {@link Component#debug} is `true`.\r\n *\r\n * Will attempt to use appropriate `console` methods if they are available.\r\n *\r\n * @method Component#log\r\n * @param {string} level Log level.\r\n * @param {...*} [args] Values to log.\r\n * @since 3.0.0\r\n */\r\nutils.logify(Component.prototype)\r\n\r\n/**\r\n * Register a new event listener on this Component.\r\n *\r\n * @example\r\n * // Listen for all \"afterCreate\" events in a DataStore\r\n * store.on('afterCreate', (mapperName, props, opts, result) => {\r\n *   console.log(mapperName); // \"post\"\r\n *   console.log(props.id); // undefined\r\n *   console.log(result.id); // 1234\r\n * });\r\n * store.create('post', { title: 'Modeling your data' }).then((post) => {\r\n *   console.log(post.id); // 1234\r\n * });\r\n *\r\n * @example\r\n * // Listen for the \"add\" event on a collection\r\n * collection.on('add', (records) => {\r\n *   console.log(records); // [...]\r\n * });\r\n *\r\n * @example\r\n * // Listen for \"change\" events on a record\r\n * post.on('change', (record, changes) => {\r\n *   console.log(changes); // { changed: { title: 'Modeling your data' } }\r\n * });\r\n * post.title = 'Modeling your data';\r\n *\r\n * @method Component#on\r\n * @param {string} event Name of event to subsribe to.\r\n * @param {Function} listener Listener function to handle the event.\r\n * @param {*} [ctx] Optional content in which to invoke the listener.\r\n * @since 3.0.0\r\n */\r\n/**\r\n * Remove an event listener from this Component. If no listener is provided,\r\n * then all listeners for the specified event will be removed. If no event is\r\n * specified then all listeners for all events will be removed.\r\n *\r\n * @example\r\n * // Remove a particular listener for a particular event\r\n * collection.off('add', handler);\r\n *\r\n * @example\r\n * // Remove all listeners for a particular event\r\n * record.off('change');\r\n *\r\n * @example\r\n * // Remove all listeners to all events\r\n * store.off();\r\n *\r\n * @method Component#off\r\n * @param {string} [event] Name of event to unsubsribe to.\r\n * @param {Function} [listener] Listener to remove.\r\n * @since 3.0.0\r\n */\r\n/**\r\n * Trigger an event on this Component.\r\n *\r\n * @example <caption>Component#emit</caption>\r\n * // import { Collection, DataStore } from 'js-data';\r\n * const JSData = require('js-data');\r\n * const { Collection, DataStore } = JSData;\r\n *\r\n * const collection = new Collection();\r\n * collection.on('foo', function (msg) {\r\n *   console.log(msg);\r\n * });\r\n * collection.emit('foo', 'bar');\r\n *\r\n * const store = new DataStore();\r\n * store.on('beep', function (msg) {\r\n *   console.log(msg);\r\n * });\r\n * store.emit('beep', 'boop');\r\n *\r\n * @method Component#emit\r\n * @param {string} event Name of event to emit.\r\n * @param {...*} [args] Arguments to pass to any listeners.\r\n * @since 3.0.0\r\n */\r\nutils.eventify(\r\n  Component.prototype,\r\n  function () {\r\n    return this._listeners\r\n  },\r\n  function (value) {\r\n    this._listeners = value\r\n  }\r\n)\r\n","import utils from './utils'\r\nimport Component from './Component'\r\n\r\nconst DOMAIN = 'Query'\r\nconst INDEX_ERR = 'Index inaccessible after first operation'\r\n\r\n// Reserved words used by JSData's Query Syntax\r\nconst reserved = {\r\n  limit: '',\r\n  offset: '',\r\n  orderBy: '',\r\n  skip: '',\r\n  sort: '',\r\n  where: ''\r\n}\r\n\r\n// Used by our JavaScript implementation of the LIKE operator\r\nconst escapeRegExp = /([.*+?^=!:${}()|[\\]/\\\\])/g\r\nconst percentRegExp = /%/g\r\nconst underscoreRegExp = /_/g\r\nconst escape = function (pattern) {\r\n  return pattern.replace(escapeRegExp, '\\\\$1')\r\n}\r\n\r\n/**\r\n * A class used by the {@link Collection} class to build queries to be executed\r\n * against the collection's data. An instance of `Query` is returned by\r\n * {@link Collection#query}. Query instances are typically short-lived, and you\r\n * shouldn't have to create them yourself. Just use {@link Collection#query}.\r\n *\r\n * ```javascript\r\n * import { Query } from 'js-data';\r\n * ```\r\n *\r\n * @example <caption>Query intro</caption>\r\n * const JSData = require('js-data');\r\n * const { DataStore } = JSData;\r\n * console.log('Using JSData v' + JSData.version.full);\r\n *\r\n * const store = new DataStore();\r\n * store.defineMapper('post');\r\n * const posts = [\r\n *   { author: 'John', age: 30, status: 'published', id: 1 },\r\n *   { author: 'Sally', age: 31, status: 'draft', id: 2 },\r\n *   { author: 'Mike', age: 32, status: 'draft', id: 3 },\r\n *   { author: 'Adam', age: 33, status: 'deleted', id: 4 },\r\n *   { author: 'Adam', age: 33, status: 'draft', id: 5 }\r\n * ]\r\n * store.add('post', posts);\r\n * const drafts = store.query('post').filter({ status: 'draft' }).limit(2).run();\r\n * console.log(drafts);\r\n *\r\n * @class Query\r\n * @extends Component\r\n * @param {Collection} collection The collection on which this query operates.\r\n * @since 3.0.0\r\n */\r\nfunction Query (collection) {\r\n  utils.classCallCheck(this, Query)\r\n\r\n  /**\r\n   * The {@link Collection} on which this query operates.\r\n   *\r\n   * @name Query#collection\r\n   * @since 3.0.0\r\n   * @type {Collection}\r\n   */\r\n  this.collection = collection\r\n\r\n  /**\r\n   * The current data result of this query.\r\n   *\r\n   * @name Query#data\r\n   * @since 3.0.0\r\n   * @type {Array}\r\n   */\r\n  this.data = null\r\n}\r\n\r\nexport default Component.extend({\r\n  constructor: Query,\r\n\r\n  _applyWhereFromObject (where) {\r\n    const fields = []\r\n    const ops = []\r\n    const predicates = []\r\n    utils.forOwn(where, (clause, field) => {\r\n      if (!utils.isObject(clause)) {\r\n        clause = {\r\n          '==': clause\r\n        }\r\n      }\r\n      utils.forOwn(clause, (expr, op) => {\r\n        fields.push(field)\r\n        ops.push(op)\r\n        predicates.push(expr)\r\n      })\r\n    })\r\n    return {\r\n      fields,\r\n      ops,\r\n      predicates\r\n    }\r\n  },\r\n\r\n  _applyWhereFromArray (where) {\r\n    const groups = []\r\n    where.forEach((_where, i) => {\r\n      if (utils.isString(_where)) {\r\n        return\r\n      }\r\n      const prev = where[i - 1]\r\n      const parser = utils.isArray(_where) ? this._applyWhereFromArray : this._applyWhereFromObject\r\n      const group = parser.call(this, _where)\r\n      if (prev === 'or') {\r\n        group.isOr = true\r\n      }\r\n      groups.push(group)\r\n    })\r\n    groups.isArray = true\r\n    return groups\r\n  },\r\n\r\n  _testObjectGroup (keep, first, group, item) {\r\n    let i\r\n    const fields = group.fields\r\n    const ops = group.ops\r\n    const predicates = group.predicates\r\n    const len = ops.length\r\n    for (i = 0; i < len; i++) {\r\n      let op = ops[i]\r\n      const isOr = op.charAt(0) === '|'\r\n      op = isOr ? op.substr(1) : op\r\n      const expr = this.evaluate(utils.get(item, fields[i]), op, predicates[i])\r\n      if (expr !== undefined) {\r\n        keep = first ? expr : (isOr ? keep || expr : keep && expr)\r\n      }\r\n      first = false\r\n    }\r\n    return { keep, first }\r\n  },\r\n\r\n  _testArrayGroup (keep, first, groups, item) {\r\n    let i\r\n    const len = groups.length\r\n    for (i = 0; i < len; i++) {\r\n      const group = groups[i]\r\n      const parser = group.isArray ? this._testArrayGroup : this._testObjectGroup\r\n      const result = parser.call(this, true, true, group, item)\r\n      if (groups[i - 1]) {\r\n        if (group.isOr) {\r\n          keep = keep || result.keep\r\n        } else {\r\n          keep = keep && result.keep\r\n        }\r\n      } else {\r\n        keep = result.keep\r\n      }\r\n      first = result.first\r\n    }\r\n    return { keep, first }\r\n  },\r\n\r\n  /**\r\n   * Find all entities between two boundaries.\r\n   *\r\n   * @example <caption>Get the users ages 18 to 30.</caption>\r\n   * const JSData = require('js-data');\r\n   * const { DataStore } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new DataStore();\r\n   * store.defineMapper('user');\r\n   * const users = [\r\n   *   { name: 'Peter', age: 25, id: 1 },\r\n   *   { name: 'Jim', age: 19, id: 2 },\r\n   *   { name: 'Mike', age: 17, id: 3 },\r\n   *   { name: 'Alan', age: 29, id: 4 },\r\n   *   { name: 'Katie', age: 33, id: 5 }\r\n   * ];\r\n   * store.add('user', users)\r\n   * const filteredUsers = store\r\n   *   .query('user')\r\n   *   .between(18, 30, { index: 'age' })\r\n   *   .run();\r\n   * console.log(filteredUsers);\r\n   *\r\n   * @example <caption>Same as above.</caption>\r\n   * const JSData = require('js-data');\r\n   * const { DataStore } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new DataStore();\r\n   * store.defineMapper('user');\r\n   * const users = [\r\n   *   { name: 'Peter', age: 25, id: 1 },\r\n   *   { name: 'Jim', age: 19, id: 2 },\r\n   *   { name: 'Mike', age: 17, id: 3 },\r\n   *   { name: 'Alan', age: 29, id: 4 },\r\n   *   { name: 'Katie', age: 33, id: 5 }\r\n   * ];\r\n   * store.add('user', users)\r\n   * const filteredUsers = store\r\n   *   .query('user')\r\n   *   .between([18], [30], { index: 'age' })\r\n   *   .run();\r\n   * console.log(filteredUsers);\r\n   *\r\n   * @method Query#between\r\n   * @param {array} leftKeys Keys defining the left boundary.\r\n   * @param {array} rightKeys Keys defining the right boundary.\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {string} [opts.index] Name of the secondary index to use in the\r\n   * query. If no index is specified, the main index is used.\r\n   * @param {boolean} [opts.leftInclusive=true] Whether to include entities\r\n   * on the left boundary.\r\n   * @param {boolean} [opts.rightInclusive=false] Whether to include entities\r\n   * on the left boundary.\r\n   * @param {boolean} [opts.limit] Limit the result to a certain number.\r\n   * @param {boolean} [opts.offset] The number of resulting entities to skip.\r\n   * @returns {Query} A reference to itself for chaining.\r\n   * @since 3.0.0\r\n   */\r\n  between (leftKeys, rightKeys, opts) {\r\n    opts || (opts = {})\r\n    if (this.data) {\r\n      throw utils.err(`${DOMAIN}#between`)(500, 'Cannot access index')\r\n    }\r\n    this.data = this.collection.getIndex(opts.index).between(leftKeys, rightKeys, opts)\r\n    return this\r\n  },\r\n\r\n  /**\r\n   * The comparison function used by the {@link Query} class.\r\n   *\r\n   * @method Query#compare\r\n   * @param {array} orderBy An orderBy clause used for sorting and sub-sorting.\r\n   * @param {number} index The index of the current orderBy clause being used.\r\n   * @param {*} a The first item in the comparison.\r\n   * @param {*} b The second item in the comparison.\r\n   * @returns {number} -1 if `b` should preceed `a`. 0 if `a` and `b` are equal.\r\n   * 1 if `a` should preceed `b`.\r\n   * @since 3.0.0\r\n   */\r\n  compare (orderBy, index, a, b, locale) {\r\n    const def = orderBy[index]\r\n    let cA = utils.get(a, def[0])\r\n    let cB = utils.get(b, def[0])\r\n    if (cA && utils.isString(cA)) {\r\n      cA = cA.toUpperCase()\r\n    }\r\n    if (cB && utils.isString(cB)) {\r\n      cB = cB.toUpperCase()\r\n    }\r\n    if (a === undefined) {\r\n      a = null\r\n    }\r\n    if (b === undefined) {\r\n      b = null\r\n    }\r\n    if (def[1].toUpperCase() === 'DESC') {\r\n      const temp = cB\r\n      cB = cA\r\n      cA = temp\r\n    }\r\n    /* Fix: compare by using collator */\r\n    let isNumeric = false\r\n    if (utils.isNumber(cA) || utils.isNumber(cB)) {\r\n      isNumeric = true\r\n    }\r\n    const collator = new Intl.Collator(locale, {\r\n      sensitivity: 'accent',\r\n      numeric: isNumeric\r\n    })\r\n    var n = collator.compare(cA, cB)\r\n    if (n === -1 || n === 1) {\r\n      return n\r\n    } else {\r\n      if (index < orderBy.length - 1) {\r\n        return this.compare(orderBy, index + 1, a, b, locale)\r\n      } else {\r\n        return 0\r\n      }\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Predicate evaluation function used by the {@link Query} class.\r\n   *\r\n   * @method Query#evaluate\r\n   * @param {*} value The value to evaluate.\r\n   * @param {string} op The operator to use in this evaluation.\r\n   * @param {*} predicate The predicate to use in this evaluation.\r\n   * @returns {boolean} Whether the value passed the evaluation or not.\r\n   * @since 3.0.0\r\n   */\r\n  evaluate (value, op, predicate) {\r\n    const ops = this.constructor.ops\r\n    if (ops[op]) {\r\n      return ops[op](value, predicate)\r\n    }\r\n    if (op.indexOf('like') === 0) {\r\n      return this.like(predicate, op.substr(4)).exec(value) !== null\r\n    } else if (op.indexOf('notLike') === 0) {\r\n      return this.like(predicate, op.substr(7)).exec(value) === null\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Find the record or records that match the provided query or are accepted by\r\n   * the provided filter function.\r\n   *\r\n   * @example <caption>Get the draft posts by authors younger than 30</caption>\r\n   * const JSData = require('js-data');\r\n   * const { DataStore } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new DataStore();\r\n   * store.defineMapper('post')\r\n   * const posts = [\r\n   *   { author: 'John', age: 30, status: 'published', id: 1 },\r\n   *   { author: 'Sally', age: 31, status: 'published', id: 2 },\r\n   *   { author: 'Mike', age: 32, status: 'draft', id: 3 },\r\n   *   { author: 'Adam', age: 33, status: 'deleted', id: 4 },\r\n   *   { author: 'Adam', age: 33, status: 'published', id: 5 }\r\n   *   { author: 'Peter', age: 25, status: 'deleted', id: 6 },\r\n   *   { author: 'Sally', age: 21, status: 'draft', id: 7 },\r\n   *   { author: 'Jim', age: 27, status: 'draft', id: 8 },\r\n   *   { author: 'Jim', age: 27, status: 'published', id: 9 },\r\n   *   { author: 'Jason', age: 55, status: 'published', id: 10 }\r\n   * ];\r\n   * store.add('post', posts);\r\n   * const results = store\r\n   *   .query('post')\r\n   *   .filter({\r\n   *     where: {\r\n   *       status: {\r\n   *         '==': 'draft'\r\n   *       },\r\n   *       age: {\r\n   *         '<': 30\r\n   *       }\r\n   *     }\r\n   *   })\r\n   *   .run();\r\n   * console.log(results);\r\n   *\r\n   * @example <caption>Use a custom filter function</caption>\r\n   * const posts = query\r\n   *   .filter(function (post) {\r\n   *     return post.isReady();\r\n   *   })\r\n   *   .run();\r\n   *\r\n   * @method Query#filter\r\n   * @param {(Object|Function)} [queryOrFn={}] Selection query or filter\r\n   * function.\r\n   * @param {Function} [thisArg] Context to which to bind `queryOrFn` if\r\n   * `queryOrFn` is a function.\r\n   * @returns {Query} A reference to itself for chaining.\r\n   * @since 3.0.0\r\n   */\r\n  filter (query, thisArg) {\r\n    /**\r\n     * Selection query as defined by JSData's [Query Syntax][querysyntax].\r\n     *\r\n     * [querysyntax]: http://www.js-data.io/v3.0/docs/query-syntax\r\n     *\r\n     * @example <caption>Empty \"findAll\" query</caption>\r\n     * const JSData = require('js-data');\r\n     * const { DataStore } = JSData;\r\n     * console.log('Using JSData v' + JSData.version.full);\r\n     *\r\n     * const store = new DataStore();\r\n     * store.defineMapper('post')\r\n     * store.findAll('post').then((posts) => {\r\n     *   console.log(posts); // [...]\r\n     * });\r\n     *\r\n     * @example <caption>Empty \"filter\" query</caption>\r\n     * const JSData = require('js-data');\r\n     * const { DataStore } = JSData;\r\n     * console.log('Using JSData v' + JSData.version.full);\r\n     *\r\n     * const store = new DataStore();\r\n     * store.defineMapper('post');\r\n     * const posts = store.filter('post');\r\n     * console.log(posts); // [...]\r\n     *\r\n     * @example <caption>Complex \"filter\" query</caption>\r\n     * const JSData = require('js-data');\r\n     * const { DataStore } = JSData;\r\n     * console.log('Using JSData v' + JSData.version.full);\r\n     *\r\n     * const store = new DataStore();\r\n     * const PAGE_SIZE = 2;\r\n     * let currentPage = 3;\r\n     *\r\n     * store.defineMapper('post');\r\n     * const posts = [\r\n     *   { author: 'John', age: 30, status: 'published', id: 1 },\r\n     *   { author: 'Sally', age: 31, status: 'published', id: 2 },\r\n     *   { author: 'Mike', age: 32, status: 'draft', id: 3 },\r\n     *   { author: 'Adam', age: 33, status: 'deleted', id: 4 },\r\n     *   { author: 'Adam', age: 33, status: 'published', id: 5 }\r\n     *   { author: 'Peter', age: 25, status: 'deleted', id: 6 },\r\n     *   { author: 'Sally', age: 21, status: 'draft', id: 7 },\r\n     *   { author: 'Jim', age: 27, status: 'draft', id: 8 },\r\n     *   { author: 'Jim', age: 27, status: 'published', id: 9 },\r\n     *   { author: 'Jason', age: 55, status: 'published', id: 10 }\r\n     * ];\r\n     * store.add('post', posts);\r\n     * // Retrieve a filtered page of blog posts\r\n     * // Would typically replace filter with findAll\r\n     * const results = store.filter('post', {\r\n     *   where: {\r\n     *     status: {\r\n     *       // WHERE status = 'published'\r\n     *       '==': 'published'\r\n     *     },\r\n     *     author: {\r\n     *       // AND author IN ('bob', 'alice')\r\n     *       'in': ['bob', 'alice'],\r\n     *       // OR author IN ('karen')\r\n     *       '|in': ['karen']\r\n     *     }\r\n     *   },\r\n     *   orderBy: [\r\n     *     // ORDER BY date_published DESC,\r\n     *     ['date_published', 'DESC'],\r\n     *     // ORDER BY title ASC\r\n     *     ['title', 'ASC']\r\n     *   ],\r\n     *   // LIMIT 2\r\n     *   limit: PAGE_SIZE,\r\n     *   // SKIP 4\r\n     *   offset: PAGE_SIZE * (currentPage - 1)\r\n     * });\r\n     * console.log(results);\r\n     *\r\n     * @namespace query\r\n     * @property {number} [limit] See {@link query.limit}.\r\n     * @property {number} [offset] See {@link query.offset}.\r\n     * @property {string|Array[]} [orderBy] See {@link query.orderBy}.\r\n     * @property {number} [skip] Alias for {@link query.offset}.\r\n     * @property {string|Array[]} [sort] Alias for {@link query.orderBy}.\r\n     * @property {Object} [where] See {@link query.where}.\r\n     * @property {String} [locale] See {@link query.locale}.\r\n     * @since 3.0.0\r\n     * @tutorial [\"http://www.js-data.io/v3.0/docs/query-syntax\",\"JSData's Query Syntax\"]\r\n     */\r\n    query || (query = {})\r\n    this.getData()\r\n    if (utils.isObject(query)) {\r\n      let where = {}\r\n\r\n      /**\r\n       * Filtering criteria. Records that do not meet this criteria will be exluded\r\n       * from the result.\r\n       *\r\n       * @example <caption>Return posts where author is at least 32 years old</caption>\r\n       * const JSData = require('js-data');\r\n       * const { DataStore } = JSData;\r\n       * console.log('Using JSData v' + JSData.version.full);\r\n       *\r\n       * const store = new DataStore();\r\n       * store.defineMapper('post')\r\n       * const posts = [\r\n       *   { author: 'John', age: 30, id: 5 },\r\n       *   { author: 'Sally', age: 31, id: 6 },\r\n       *   { author: 'Mike', age: 32, id: 7 },\r\n       *   { author: 'Adam', age: 33, id: 8 },\r\n       *   { author: 'Adam', age: 33, id: 9 }\r\n       * ];\r\n       * store.add('post', posts);\r\n       * const results = store.filter('post', {\r\n       *   where: {\r\n       *     age: {\r\n       *       '>=': 30\r\n       *     }\r\n       *   }\r\n       * });\r\n       * console.log(results);\r\n       *\r\n       * @name query.where\r\n       * @type {Object}\r\n       * @see http://www.js-data.io/v3.0/docs/query-syntax\r\n       * @since 3.0.0\r\n       */\r\n      if (utils.isObject(query.where) || utils.isArray(query.where)) {\r\n        where = query.where\r\n      }\r\n      utils.forOwn(query, function (value, key) {\r\n        if (!(key in reserved) && !(key in where)) {\r\n          where[key] = {\r\n            '==': value\r\n          }\r\n        }\r\n      })\r\n      let groups\r\n\r\n      // Apply filter for each field\r\n      if (utils.isObject(where) && Object.keys(where).length !== 0) {\r\n        groups = this._applyWhereFromArray([where])\r\n      } else if (utils.isArray(where)) {\r\n        groups = this._applyWhereFromArray(where)\r\n      }\r\n\r\n      if (groups) {\r\n        this.data = this.data.filter((item, i) => this._testArrayGroup(true, true, groups, item).keep)\r\n      }\r\n\r\n      // Sort\r\n      let orderBy = query.orderBy || query.sort\r\n\r\n      if (utils.isString(orderBy)) {\r\n        orderBy = [\r\n          [orderBy, 'ASC']\r\n        ]\r\n      }\r\n      if (!utils.isArray(orderBy)) {\r\n        orderBy = null\r\n      }\r\n\r\n      /**\r\n       * Determines how records should be ordered in the result.\r\n       *\r\n       * @example <caption>Order posts by `author` then by `id` descending </caption>\r\n       * const JSData = require('js-data');\r\n       * const { DataStore } = JSData;\r\n       * console.log('Using JSData v' + JSData.version.full);\r\n       *\r\n       * const store = new DataStore();\r\n       * store.defineMapper('post')\r\n       * const posts = [\r\n       *   { author: 'John', age: 30, id: 5 },\r\n       *   { author: 'Sally', age: 31, id: 6 },\r\n       *   { author: 'Mike', age: 32, id: 7 },\r\n       *   { author: 'Adam', age: 33, id: 8 },\r\n       *   { author: 'Adam', age: 33, id: 9 }\r\n       * ];\r\n       * store.add('post', posts);\r\n       * const results = store.filter('post', {\r\n       *     orderBy:[['author','ASC'],['id','DESC']]\r\n       * });\r\n       * console.log(results);\r\n       *\r\n       * @name query.orderBy\r\n       * @type {string|Array[]}\r\n       * @see http://www.js-data.io/v3.0/docs/query-syntax\r\n       * @since 3.0.0\r\n       */\r\n      if (orderBy) {\r\n        const index = 0\r\n        orderBy.forEach(function (def, i) {\r\n          if (utils.isString(def)) {\r\n            orderBy[i] = [def, 'ASC']\r\n          }\r\n        })\r\n        // if microsoft edge, force set locale, otherwise other browser seems to work fine /Wick\r\n        if (!utils.isString(query.locale)) {\r\n          query.locale = utils.getDefaultLocale()\r\n        }\r\n        this.data.sort((a, b) => this.compare(orderBy, index, a, b, query.locale))\r\n      }\r\n\r\n      /**\r\n       * Number of records to skip.\r\n       *\r\n       * @example <caption>Retrieve the first \"page\" of blog posts using findAll</caption>\r\n       * const JSData = require('js-data');\r\n       * const { DataStore } = JSData;\r\n       * console.log('Using JSData v' + JSData.version.full);\r\n       *\r\n       * const store = new DataStore();\r\n       * store.defineMapper('post');\r\n       * const PAGE_SIZE = 10;\r\n       * let currentPage = 1;\r\n       * store.findAll('post', {\r\n       *   offset: PAGE_SIZE * (currentPage 1)\r\n       *   limit: PAGE_SIZE\r\n       * });\r\n       *\r\n       * @example <caption>Retrieve the last \"page\" of blog posts using filter</caption>\r\n       * const JSData = require('js-data');\r\n       * const { DataStore } = JSData;\r\n       * console.log('Using JSData v' + JSData.version.full);\r\n       *\r\n       * const store = new DataStore();\r\n       *\r\n       * const PAGE_SIZE = 5;\r\n       * let currentPage = 2;\r\n       * store.defineMapper('post');\r\n       * const posts = [\r\n       *   { author: 'John', age: 30, id: 1 },\r\n       *   { author: 'Sally', age: 31, id: 2 },\r\n       *   { author: 'Mike', age: 32, id: 3 },\r\n       *   { author: 'Adam', age: 33, id: 4 },\r\n       *   { author: 'Adam', age: 33, id: 5 },\r\n       *   { author: 'Peter', age: 25, id: 6 },\r\n       *   { author: 'Sally', age: 21, id: 7 },\r\n       *   { author: 'Jim', age: 27, id: 8 },\r\n       *   { author: 'Jim', age: 27, id: 9 },\r\n       *   { author: 'Jason', age: 55, id: 10 }\r\n       * ];\r\n       * store.add('post', posts);\r\n       * const results = store.filter('post', {\r\n       *   offset: PAGE_SIZE * (currentPage 1)\r\n       *   limit: PAGE_SIZE\r\n       * });\r\n       * console.log(results)\r\n       *\r\n       * @name query.offset\r\n       * @type {number}\r\n       * @see http://www.js-data.io/v3.0/docs/query-syntax\r\n       * @since 3.0.0\r\n       */\r\n      if (utils.isNumber(query.skip)) {\r\n        this.skip(query.skip)\r\n      } else if (utils.isNumber(query.offset)) {\r\n        this.skip(query.offset)\r\n      }\r\n\r\n      /**\r\n       * Maximum number of records to retrieve.\r\n       *\r\n       * @example <caption>Retrieve the first \"page\" of blog posts using findAll</caption>\r\n       * const JSData = require('js-data');\r\n       * const { DataStore } = JSData;\r\n       * console.log('Using JSData v' + JSData.version.full);\r\n       *\r\n       * const store = new DataStore();\r\n       * store.defineMapper('post');\r\n       *\r\n       * const PAGE_SIZE = 10\r\n       * let currentPage = 1\r\n       * store.findAll('post', {\r\n       *   offset: PAGE_SIZE * (currentPage 1)\r\n       *   limit: PAGE_SIZE\r\n       * });\r\n       *\r\n       * @example <caption>Retrieve the last \"page\" of blog posts using filter</caption>\r\n       * const JSData = require('js-data');\r\n       * const { DataStore } = JSData;\r\n       * console.log('Using JSData v' + JSData.version.full);\r\n       *\r\n       * const store = new DataStore();\r\n       *\r\n       * const PAGE_SIZE = 5\r\n       * let currentPage = 2\r\n       * store.defineMapper('post')\r\n       * const posts = [\r\n       *   { author: 'John', age: 30, id: 1 },\r\n       *   { author: 'Sally', age: 31, id: 2 },\r\n       *   { author: 'Mike', age: 32, id: 3 },\r\n       *   { author: 'Adam', age: 33, id: 4 },\r\n       *   { author: 'Adam', age: 33, id: 5 },\r\n       *   { author: 'Peter', age: 25, id: 6 },\r\n       *   { author: 'Sally', age: 21, id: 7 },\r\n       *   { author: 'Jim', age: 27, id: 8 },\r\n       *   { author: 'Jim', age: 27, id: 9 },\r\n       *   { author: 'Jason', age: 55, id: 10 }\r\n       * ];\r\n       * store.add('post', posts);\r\n       * const results = store.filter('post', {\r\n       *   offset: PAGE_SIZE * (currentPage 1)\r\n       *   limit: PAGE_SIZE\r\n       * });\r\n       * console.log(results)\r\n       *\r\n       * @name query.limit\r\n       * @type {number}\r\n       * @see http://www.js-data.io/v3.0/docs/query-syntax\r\n       * @since 3.0.0\r\n       */\r\n      if (utils.isNumber(query.limit)) {\r\n        this.limit(query.limit)\r\n      }\r\n    } else if (utils.isFunction(query)) {\r\n      this.data = this.data.filter(query, thisArg)\r\n    }\r\n    return this\r\n  },\r\n\r\n  /**\r\n   * Iterate over all entities.\r\n   *\r\n   * @method Query#forEach\r\n   * @param {Function} forEachFn Iteration function.\r\n   * @param {*} [thisArg] Context to which to bind `forEachFn`.\r\n   * @returns {Query} A reference to itself for chaining.\r\n   * @since 3.0.0\r\n   */\r\n  forEach (forEachFn, thisArg) {\r\n    this.getData().forEach(forEachFn, thisArg)\r\n    return this\r\n  },\r\n\r\n  /**\r\n   * Find the entity or entities that match the provided key.\r\n   *\r\n   * @example <caption>Get the entity whose primary key is 25.</caption>\r\n   * const entities = query.get(25).run();\r\n   *\r\n   * @example <caption>Same as above.</caption>\r\n   * const entities = query.get([25]).run();\r\n   *\r\n   * @example <caption>Get all users who are active and have the \"admin\" role.</caption>\r\n   * const activeAdmins = query.get(['active', 'admin'], {\r\n   *   index: 'activityAndRoles'\r\n   * }).run();\r\n   *\r\n   * @example <caption>Get all entities that match a certain weather condition.</caption>\r\n   * const niceDays = query.get(['sunny', 'humid', 'calm'], {\r\n   *   index: 'weatherConditions'\r\n   * }).run();\r\n   *\r\n   * @method Query#get\r\n   * @param {array} keyList Key(s) defining the entity to retrieve. If\r\n   * `keyList` is not an array (i.e. for a single-value key), it will be\r\n   * wrapped in an array.\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {string} [opts.string] Name of the secondary index to use in the\r\n   * query. If no index is specified, the main index is used.\r\n   * @returns {Query} A reference to itself for chaining.\r\n   * @since 3.0.0\r\n   */\r\n  get (keyList, opts) {\r\n    keyList || (keyList = [])\r\n    opts || (opts = {})\r\n    if (this.data) {\r\n      throw utils.err(`${DOMAIN}#get`)(500, INDEX_ERR)\r\n    }\r\n    if (keyList && !utils.isArray(keyList)) {\r\n      keyList = [keyList]\r\n    }\r\n    if (!keyList.length) {\r\n      this.getData()\r\n      return this\r\n    }\r\n    this.data = this.collection.getIndex(opts.index).get(keyList)\r\n    return this\r\n  },\r\n\r\n  /**\r\n   * Find the entity or entities that match the provided keyLists.\r\n   *\r\n   * @example <caption>Get the posts where \"status\" is \"draft\" or \"inReview\".</caption>\r\n   * const posts = query.getAll('draft', 'inReview', { index: 'status' }).run();\r\n   *\r\n   * @example <caption>Same as above.</caption>\r\n   * const posts = query.getAll(['draft'], ['inReview'], { index: 'status' }).run();\r\n   *\r\n   * @method Query#getAll\r\n   * @param {...Array} [keyList] Provide one or more keyLists, and all\r\n   * entities matching each keyList will be retrieved. If no keyLists are\r\n   * provided, all entities will be returned.\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {string} [opts.index] Name of the secondary index to use in the\r\n   * query. If no index is specified, the main index is used.\r\n   * @returns {Query} A reference to itself for chaining.\r\n   * @since 3.0.0\r\n   */\r\n  getAll (...args) {\r\n    let opts = {}\r\n    if (this.data) {\r\n      throw utils.err(`${DOMAIN}#getAll`)(500, INDEX_ERR)\r\n    }\r\n    if (!args.length || (args.length === 1 && utils.isObject(args[0]))) {\r\n      this.getData()\r\n      return this\r\n    } else if (args.length && utils.isObject(args[args.length - 1])) {\r\n      opts = args[args.length - 1]\r\n      args.pop()\r\n    }\r\n    const collection = this.collection\r\n    const index = collection.getIndex(opts.index)\r\n    this.data = []\r\n    args.forEach((keyList) => {\r\n      this.data = this.data.concat(index.get(keyList))\r\n    })\r\n    return this\r\n  },\r\n\r\n  /**\r\n   * Return the current data result of this query.\r\n   *\r\n   * @method Query#getData\r\n   * @returns {Array} The data in this query.\r\n   * @since 3.0.0\r\n   */\r\n  getData () {\r\n    if (!this.data) {\r\n      this.data = this.collection.index.getAll()\r\n    }\r\n    return this.data\r\n  },\r\n\r\n  /**\r\n   * Implementation used by the `like` operator. Takes a pattern and flags and\r\n   * returns a `RegExp` instance that can test strings.\r\n   *\r\n   * @method Query#like\r\n   * @param {string} pattern Testing pattern.\r\n   * @param {string} flags Flags for the regular expression.\r\n   * @returns {RegExp} Regular expression for testing strings.\r\n   * @since 3.0.0\r\n   */\r\n  like (pattern, flags) {\r\n    return new RegExp(`^${(escape(pattern).replace(percentRegExp, '.*').replace(underscoreRegExp, '.'))}$`, flags)\r\n  },\r\n\r\n  /**\r\n   * Limit the result.\r\n   *\r\n   * @example <caption>Get only the first 2 posts.</caption>\r\n   * const store = new JSData.DataStore();\r\n   * store.defineMapper('post');\r\n   * const posts = [\r\n   *   { author: 'John', age: 30, status: 'published', id: 1 },\r\n   *   { author: 'Sally', age: 31, status: 'draft', id: 2 },\r\n   *   { author: 'Mike', age: 32, status: 'draft', id: 3 },\r\n   *   { author: 'Adam', age: 33, status: 'deleted', id: 4 },\r\n   *   { author: 'Adam', age: 33, status: 'draft', id: 5 }\r\n   * ];\r\n   * store.add('post', posts);\r\n   * const results = store.query('post').limit(2).run();\r\n   * console.log(results);\r\n   *\r\n   * @method Query#limit\r\n   * @param {number} num The maximum number of entities to keep in the result.\r\n   * @returns {Query} A reference to itself for chaining.\r\n   * @since 3.0.0\r\n   */\r\n  limit (num) {\r\n    if (!utils.isNumber(num)) {\r\n      throw utils.err(`${DOMAIN}#limit`, 'num')(400, 'number', num)\r\n    }\r\n    const data = this.getData()\r\n    this.data = data.slice(0, Math.min(data.length, num))\r\n    return this\r\n  },\r\n\r\n  /**\r\n   * Apply a mapping function to the result data.\r\n   *\r\n   * @example\r\n   * const JSData = require('js-data');\r\n   * const { DataStore } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new DataStore();\r\n   * store.defineMapper('user');\r\n   * const users = [\r\n   *   { name: 'Peter', age: 25, id: 1 },\r\n   *   { name: 'Jim', age: 19, id: 2 },\r\n   *   { name: 'Mike', age: 17, id: 3 },\r\n   *   { name: 'Alan', age: 29, id: 4 },\r\n   *   { name: 'Katie', age: 33, id: 5 }\r\n   * ];\r\n   * store.add('user', users);\r\n   * const ages = store\r\n   *   .query('user')\r\n   *   .map(function (user) {\r\n   *     return user.age;\r\n   *   })\r\n   *   .run();\r\n   * console.log(ages);\r\n   *\r\n   * @method Query#map\r\n   * @param {Function} mapFn Mapping function.\r\n   * @param {*} [thisArg] Context to which to bind `mapFn`.\r\n   * @returns {Query} A reference to itself for chaining.\r\n   * @since 3.0.0\r\n   */\r\n  map (mapFn, thisArg) {\r\n    this.data = this.getData().map(mapFn, thisArg)\r\n    return this\r\n  },\r\n\r\n  /**\r\n   * Return the result of calling the specified function on each item in this\r\n   * collection's main index.\r\n   *\r\n   * @example\r\n   * const stringAges = UserCollection.query().mapCall('toString').run();\r\n   *\r\n   * @method Query#mapCall\r\n   * @param {string} funcName Name of function to call\r\n   * @parama {...*} [args] Remaining arguments to be passed to the function.\r\n   * @returns {Query} A reference to itself for chaining.\r\n   * @since 3.0.0\r\n   */\r\n  mapCall (funcName, ...args) {\r\n    this.data = this.getData().map(function (item) {\r\n      return item[funcName](...args)\r\n    })\r\n    return this\r\n  },\r\n\r\n  /**\r\n   * Complete the execution of the query and return the resulting data.\r\n   *\r\n   * @method Query#run\r\n   * @returns {Array} The result of executing this query.\r\n   * @since 3.0.0\r\n   */\r\n  run () {\r\n    const data = this.data\r\n    this.data = null\r\n    return data\r\n  },\r\n\r\n  /**\r\n   * Skip a number of results.\r\n   *\r\n   * @example <caption>Get all but the first 2 posts.</caption>\r\n   * const JSData = require('js-data');\r\n   * const { DataStore } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new DataStore();\r\n   * store.defineMapper('post');\r\n   * const posts = [\r\n   *   { author: 'John', age: 30, status: 'published', id: 1 },\r\n   *   { author: 'Sally', age: 31, status: 'draft', id: 2 },\r\n   *   { author: 'Mike', age: 32, status: 'draft', id: 3 },\r\n   *   { author: 'Adam', age: 33, status: 'deleted', id: 4 },\r\n   *   { author: 'Adam', age: 33, status: 'draft', id: 5 }\r\n   * ];\r\n   * store.add('post', posts);\r\n   * const results = store.query('post').skip(2).run();\r\n   * console.log(results);\r\n   *\r\n   * @method Query#skip\r\n   * @param {number} num The number of entities to skip.\r\n   * @returns {Query} A reference to itself for chaining.\r\n   * @since 3.0.0\r\n   */\r\n  skip (num) {\r\n    if (!utils.isNumber(num)) {\r\n      throw utils.err(`${DOMAIN}#skip`, 'num')(400, 'number', num)\r\n    }\r\n    const data = this.getData()\r\n    if (num < data.length) {\r\n      this.data = data.slice(num)\r\n    } else {\r\n      this.data = []\r\n    }\r\n    return this\r\n  }\r\n}, {\r\n  /**\r\n   * The filtering operators supported by {@link Query#filter}, and which are\r\n   * implemented by adapters (for the most part).\r\n   *\r\n   * @example <caption>Variant 1</caption>\r\n   * const JSData = require('js-data');\r\n   * const { DataStore } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new DataStore();\r\n   * store.defineMapper('post');\r\n   * const posts = [\r\n   *   { author: 'John', age: 30, status: 'published', id: 1 },\r\n   *   { author: 'Sally', age: 31, status: 'published', id: 2 },\r\n   *   { author: 'Mike', age: 32, status: 'published', id: 3 },\r\n   *   { author: 'Adam', age: 33, status: 'deleted', id: 4 },\r\n   *   { author: 'Adam', age: 33, status: 'published', id: 5 }\r\n   * ];\r\n   * store.add('post', posts);\r\n   * const publishedPosts = store.filter('post', {\r\n   *   status: 'published',\r\n   *   limit: 2\r\n   * });\r\n   * console.log(publishedPosts);\r\n   *\r\n   *\r\n   * @example <caption>Variant 2</caption>\r\n   * const JSData = require('js-data');\r\n   * const { DataStore } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new DataStore();\r\n   * store.defineMapper('post')\r\n   * const posts = [\r\n   *   { author: 'John', age: 30, status: 'published', id: 1 },\r\n   *   { author: 'Sally', age: 31, status: 'published', id: 2 },\r\n   *   { author: 'Mike', age: 32, status: 'published', id: 3 },\r\n   *   { author: 'Adam', age: 33, status: 'deleted', id: 4 },\r\n   *   { author: 'Adam', age: 33, status: 'published', id: 5 }\r\n   * ];\r\n   * store.add('post', posts);\r\n   * const publishedPosts = store.filter('post', {\r\n   *   where: {\r\n   *     status: {\r\n   *       '==': 'published'\r\n   *     }\r\n   *   },\r\n   *   limit: 2\r\n   * });\r\n   * console.log(publishedPosts);\r\n   *\r\n   * @example <caption>Variant 3</caption>\r\n   * const JSData = require('js-data');\r\n   * const { DataStore } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new DataStore();\r\n   * store.defineMapper('post');\r\n   * const posts = [\r\n   *   { author: 'John', age: 30, status: 'published', id: 1 },\r\n   *   { author: 'Sally', age: 31, status: 'published', id: 2 },\r\n   *   { author: 'Mike', age: 32, status: 'published', id: 3 },\r\n   *   { author: 'Adam', age: 33, status: 'deleted', id: 4 },\r\n   *   { author: 'Adam', age: 33, status: 'published', id: 5 }\r\n   * ];\r\n   * store.add('post', posts);\r\n   * const publishedPosts = store\r\n   *   .query('post')\r\n   *   .filter({ status: 'published' })\r\n   *   .limit(2)\r\n   *   .run();\r\n   * console.log(publishedPosts);\r\n   *\r\n   * @example <caption>Variant 4</caption>\r\n   * const JSData = require('js-data');\r\n   * const { DataStore } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new DataStore();\r\n   * store.defineMapper('post');\r\n   * const posts = [\r\n   *   { author: 'John', age: 30, status: 'published', id: 1 },\r\n   *   { author: 'Sally', age: 31, status: 'published', id: 2 },\r\n   *   { author: 'Mike', age: 32, status: 'published', id: 3 },\r\n   *   { author: 'Adam', age: 33, status: 'deleted', id: 4 },\r\n   *   { author: 'Adam', age: 33, status: 'published', id: 5 }\r\n   * ];\r\n   * store.add('post', posts);\r\n   * const publishedPosts = store\r\n   *   .query('post')\r\n   *   .filter({\r\n   *     where: {\r\n   *       status: {\r\n   *         '==': 'published'\r\n   *       }\r\n   *     }\r\n   *   })\r\n   *   .limit(2)\r\n   *   .run();\r\n   * console.log(publishedPosts);\r\n   *\r\n   * @example <caption>Multiple operators</caption>\r\n   * const JSData = require('js-data');\r\n   * const { DataStore } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new DataStore();\r\n   * store.defineMapper('post');\r\n   * const posts = [\r\n   *   { author: 'John', age: 30, status: 'published', id: 1 },\r\n   *   { author: 'Sally', age: 31, status: 'published', id: 2 },\r\n   *   { author: 'Mike', age: 32, status: 'published', id: 3 },\r\n   *   { author: 'Adam', age: 33, status: 'deleted', id: 4 },\r\n   *   { author: 'Adam', age: 33, status: 'published', id: 5 }\r\n   * ];\r\n   * store.add('post', posts);\r\n   *\r\n   * const myPublishedPosts = store.filter('post', {\r\n   *   where: {\r\n   *     status: {\r\n   *       '==': 'published'\r\n   *     },\r\n   *     user_id: {\r\n   *       '==': currentUser.id\r\n   *     }\r\n   *   }\r\n   * });\r\n   *\r\n   * console.log(myPublishedPosts);\r\n   *\r\n   * @name Query.ops\r\n   * @property {Function} == Equality operator.\r\n   * @property {Function} != Inequality operator.\r\n   * @property {Function} > Greater than operator.\r\n   * @property {Function} >= Greater than (inclusive) operator.\r\n   * @property {Function} < Less than operator.\r\n   * @property {Function} <= Less than (inclusive) operator.\r\n   * @property {Function} isectEmpty Operator that asserts that the intersection\r\n   * between two arrays is empty.\r\n   * @property {Function} isectNotEmpty Operator that asserts that the\r\n   * intersection between two arrays is __not__ empty.\r\n   * @property {Function} in Operator that asserts whether a value is in an\r\n   * array.\r\n   * @property {Function} notIn Operator that asserts whether a value is __not__\r\n   * in an array.\r\n   * @property {Function} contains Operator that asserts whether an array\r\n   * contains a value.\r\n   * @property {Function} notContains Operator that asserts whether an array\r\n   * does __not__ contain a value.\r\n   * @since 3.0.0\r\n   * @type {Object}\r\n   */\r\n  ops: {\r\n    '=': function (value, predicate) {\r\n      return value == predicate // eslint-disable-line\r\n    },\r\n    '==': function (value, predicate) {\r\n      return value == predicate // eslint-disable-line\r\n    },\r\n    '===': function (value, predicate) {\r\n      return value === predicate\r\n    },\r\n    '!=': function (value, predicate) {\r\n      return value != predicate // eslint-disable-line\r\n    },\r\n    '!==': function (value, predicate) {\r\n      return value !== predicate\r\n    },\r\n    '>': function (value, predicate) {\r\n      return value > predicate\r\n    },\r\n    '>=': function (value, predicate) {\r\n      return value >= predicate\r\n    },\r\n    '<': function (value, predicate) {\r\n      return value < predicate\r\n    },\r\n    '<=': function (value, predicate) {\r\n      return value <= predicate\r\n    },\r\n    isectEmpty: function (value, predicate) {\r\n      return !utils.intersection((value || []), (predicate || [])).length\r\n    },\r\n    isectNotEmpty: function (value, predicate) {\r\n      return utils.intersection((value || []), (predicate || [])).length\r\n    },\r\n    in: function (value, predicate) {\r\n      return predicate.indexOf(value) !== -1\r\n    },\r\n    notIn: function (value, predicate) {\r\n      return predicate.indexOf(value) === -1\r\n    },\r\n    contains: function (value, predicate) {\r\n      return (value || []).indexOf(predicate) !== -1\r\n    },\r\n    notContains: function (value, predicate) {\r\n      return (value || []).indexOf(predicate) === -1\r\n    }\r\n  }\r\n})\r\n\r\n/**\r\n * Create a subclass of this Query:\r\n * @example <caption>Query.extend</caption>\r\n * const JSData = require('js-data');\r\n * const { Query } = JSData;\r\n * console.log('Using JSData v' + JSData.version.full);\r\n *\r\n * // Extend the class using ES2015 class syntax.\r\n * class CustomQueryClass extends Query {\r\n *   foo () { return 'bar'; }\r\n *   static beep () { return 'boop'; }\r\n * }\r\n * const customQuery = new CustomQueryClass();\r\n * console.log(customQuery.foo());\r\n * console.log(CustomQueryClass.beep());\r\n *\r\n * // Extend the class using alternate method.\r\n * const OtherQueryClass = Query.extend({\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * });\r\n * const otherQuery = new OtherQueryClass();\r\n * console.log(otherQuery.foo());\r\n * console.log(OtherQueryClass.beep());\r\n *\r\n * // Extend the class, providing a custom constructor.\r\n * function AnotherQueryClass (collection) {\r\n *   Query.call(this, collection);\r\n *   this.created_at = new Date().getTime();\r\n * }\r\n * Query.extend({\r\n *   constructor: AnotherQueryClass,\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * });\r\n * const anotherQuery = new AnotherQueryClass();\r\n * console.log(anotherQuery.created_at);\r\n * console.log(anotherQuery.foo());\r\n * console.log(AnotherQueryClass.beep());\r\n *\r\n * @method Query.extend\r\n * @param {object} [props={}] Properties to add to the prototype of the\r\n * subclass.\r\n * @param {object} [props.constructor] Provide a custom constructor function\r\n * to be used as the subclass itself.\r\n * @param {object} [classProps={}] Static properties to add to the subclass.\r\n * @returns {Constructor} Subclass of this Query class.\r\n * @since 3.0.0\r\n */\r\n","import utils from './utils'\r\n\r\n// TODO: remove this when the rest of the project is cleaned\r\nexport const belongsToType = 'belongsTo'\r\nexport const hasManyType = 'hasMany'\r\nexport const hasOneType = 'hasOne'\r\n\r\nconst DOMAIN = 'Relation'\r\n\r\nexport function Relation (relatedMapper, options = {}) {\r\n  utils.classCallCheck(this, Relation)\r\n\r\n  options.type = this.constructor.TYPE_NAME\r\n  this.validateOptions(relatedMapper, options)\r\n\r\n  if (typeof relatedMapper === 'object') {\r\n    Object.defineProperty(this, 'relatedMapper', { value: relatedMapper })\r\n  }\r\n\r\n  Object.defineProperty(this, 'inverse', { writable: true })\r\n  utils.fillIn(this, options)\r\n}\r\n\r\nRelation.extend = utils.extend\r\n\r\nutils.addHiddenPropsToTarget(Relation.prototype, {\r\n  get canAutoAddLinks () {\r\n    return this.add === undefined || !!this.add\r\n  },\r\n\r\n  get relatedCollection () {\r\n    return this.mapper.datastore.getCollection(this.relation)\r\n  },\r\n\r\n  validateOptions (related, opts) {\r\n    const DOMAIN_ERR = `new ${DOMAIN}`\r\n\r\n    const localField = opts.localField\r\n    if (!localField) {\r\n      throw utils.err(DOMAIN_ERR, 'opts.localField')(400, 'string', localField)\r\n    }\r\n\r\n    const foreignKey = opts.foreignKey = opts.foreignKey || opts.localKey\r\n    if (!foreignKey && (opts.type === belongsToType || opts.type === hasOneType)) {\r\n      throw utils.err(DOMAIN_ERR, 'opts.foreignKey')(400, 'string', foreignKey)\r\n    }\r\n\r\n    if (utils.isString(related)) {\r\n      opts.relation = related\r\n      if (!utils.isFunction(opts.getRelation)) {\r\n        throw utils.err(DOMAIN_ERR, 'opts.getRelation')(400, 'function', opts.getRelation)\r\n      }\r\n    } else if (related) {\r\n      opts.relation = related.name\r\n    } else {\r\n      throw utils.err(DOMAIN_ERR, 'related')(400, 'Mapper or string', related)\r\n    }\r\n  },\r\n\r\n  assignTo (mapper) {\r\n    this.name = mapper.name\r\n    Object.defineProperty(this, 'mapper', { value: mapper })\r\n\r\n    mapper.relationList || Object.defineProperty(mapper, 'relationList', { value: [] })\r\n    mapper.relationFields || Object.defineProperty(mapper, 'relationFields', { value: [] })\r\n    mapper.relationList.push(this)\r\n    mapper.relationFields.push(this.localField)\r\n  },\r\n\r\n  canFindLinkFor () {\r\n    return !!(this.foreignKey || this.localKey)\r\n  },\r\n\r\n  getRelation () {\r\n    return this.relatedMapper\r\n  },\r\n\r\n  getForeignKey (record) {\r\n    return utils.get(record, this.mapper.idAttribute)\r\n  },\r\n\r\n  setForeignKey (record, relatedRecord) {\r\n    if (!record || !relatedRecord) {\r\n      return\r\n    }\r\n\r\n    this._setForeignKey(record, relatedRecord)\r\n  },\r\n\r\n  _setForeignKey (record, relatedRecords) {\r\n    const idAttribute = this.mapper.idAttribute\r\n\r\n    if (!utils.isArray(relatedRecords)) {\r\n      relatedRecords = [relatedRecords]\r\n    }\r\n\r\n    relatedRecords.forEach((relatedRecord) => {\r\n      utils.set(relatedRecord, this.foreignKey, utils.get(record, idAttribute))\r\n    })\r\n  },\r\n\r\n  getLocalField (record) {\r\n    return utils.get(record, this.localField)\r\n  },\r\n\r\n  setLocalField (record, relatedData) {\r\n    return utils.set(record, this.localField, relatedData)\r\n  },\r\n\r\n  getInverse (mapper) {\r\n    if (!this.inverse) {\r\n      this.findInverseRelation(mapper)\r\n    }\r\n\r\n    return this.inverse\r\n  },\r\n\r\n  findInverseRelation (mapper) {\r\n    this.getRelation().relationList.forEach((def) => {\r\n      if (def.getRelation() === mapper && this.isInversedTo(def) && this !== def) {\r\n        this.inverse = def\r\n        return true\r\n      }\r\n    })\r\n  },\r\n\r\n  isInversedTo (def) {\r\n    return !def.foreignKey || def.foreignKey === this.foreignKey\r\n  },\r\n\r\n  addLinkedRecords (records) {\r\n    const datastore = this.mapper.datastore\r\n\r\n    records.forEach((record) => {\r\n      let relatedData = this.getLocalField(record)\r\n\r\n      if (utils.isFunction(this.add)) {\r\n        relatedData = this.add(datastore, this, record)\r\n      } else if (relatedData) {\r\n        relatedData = this.linkRecord(record, relatedData)\r\n      }\r\n\r\n      const isEmptyLinks = !relatedData || (utils.isArray(relatedData) && !relatedData.length)\r\n\r\n      if (isEmptyLinks && this.canFindLinkFor(record)) {\r\n        relatedData = this.findExistingLinksFor(record)\r\n      }\r\n\r\n      if (relatedData) {\r\n        this.setLocalField(record, relatedData)\r\n      }\r\n    })\r\n  },\r\n\r\n  removeLinkedRecords (relatedMapper, records) {\r\n    const localField = this.localField\r\n    records.forEach((record) => {\r\n      utils.set(record, localField, undefined)\r\n    })\r\n  },\r\n\r\n  linkRecord (record, relatedRecord) {\r\n    const relatedId = utils.get(relatedRecord, this.mapper.idAttribute)\r\n\r\n    if (relatedId === undefined) {\r\n      const unsaved = this.relatedCollection.unsaved()\r\n      if (unsaved.indexOf(relatedRecord) === -1) {\r\n        if (this.canAutoAddLinks) {\r\n          relatedRecord = this.relatedCollection.add(relatedRecord)\r\n        }\r\n      }\r\n    } else {\r\n      if (relatedRecord !== this.relatedCollection.get(relatedId)) {\r\n        this.setForeignKey(record, relatedRecord)\r\n\r\n        if (this.canAutoAddLinks) {\r\n          relatedRecord = this.relatedCollection.add(relatedRecord)\r\n        }\r\n      }\r\n    }\r\n\r\n    return relatedRecord\r\n  },\r\n\r\n  // e.g. user hasMany post via \"foreignKey\", so find all posts of user\r\n  findExistingLinksByForeignKey (id) {\r\n    if (id === undefined || id === null) {\r\n      return\r\n    }\r\n    return this.relatedCollection.filter({\r\n      [this.foreignKey]: id\r\n    })\r\n  },\r\n\r\n  ensureLinkedDataHasProperType (props, opts) {\r\n    const relatedMapper = this.getRelation()\r\n    const relationData = this.getLocalField(props)\r\n\r\n    if (utils.isArray(relationData) && (!relationData.length || relatedMapper.is(relationData[0]))) {\r\n      return\r\n    }\r\n\r\n    if (relationData && !relatedMapper.is(relationData)) {\r\n      utils.set(props, this.localField, relatedMapper.createRecord(relationData, opts))\r\n    }\r\n  },\r\n\r\n  isRequiresParentId () {\r\n    return false\r\n  },\r\n\r\n  isRequiresChildId () {\r\n    return false\r\n  },\r\n\r\n  createChildRecord (props, relationData, opts) {\r\n    this.setForeignKey(props, relationData)\r\n\r\n    return this.createLinked(relationData, opts).then((result) => {\r\n      this.setLocalField(props, result)\r\n    })\r\n  },\r\n\r\n  createLinked (props, opts) {\r\n    const create = utils.isArray(props) ? 'createMany' : 'create'\r\n\r\n    return this.getRelation()[create](props, opts)\r\n  }\r\n})\r\n","import utils from '../utils'\r\nimport { Relation } from '../Relation'\r\n\r\nexport const BelongsToRelation = Relation.extend({\r\n  getForeignKey (record) {\r\n    return utils.get(record, this.foreignKey)\r\n  },\r\n\r\n  _setForeignKey (record, relatedRecord) {\r\n    utils.set(record, this.foreignKey, utils.get(relatedRecord, this.getRelation().idAttribute))\r\n  },\r\n\r\n  findExistingLinksFor (record) {\r\n    // console.log('\\tBelongsTo#findExistingLinksFor', record)\r\n    if (!record) {\r\n      return\r\n    }\r\n    const relatedId = utils.get(record, this.foreignKey)\r\n    if (relatedId !== undefined && relatedId !== null) {\r\n      return this.relatedCollection.get(relatedId)\r\n    }\r\n  },\r\n\r\n  isRequiresParentId () {\r\n    return true\r\n  },\r\n\r\n  createParentRecord (props, opts) {\r\n    const relationData = this.getLocalField(props)\r\n\r\n    return this.createLinked(relationData, opts).then((record) => {\r\n      this.setForeignKey(props, record)\r\n    })\r\n  },\r\n\r\n  createChildRecord () {\r\n    throw new Error('\"BelongsTo\" relation does not support child creation as it cannot have children.')\r\n  }\r\n}, {\r\n  TYPE_NAME: 'belongsTo'\r\n})\r\n","import utils from '../utils'\r\nimport { Relation } from '../Relation'\r\n\r\nexport const HasManyRelation = Relation.extend({\r\n  validateOptions (related, opts) {\r\n    Relation.prototype.validateOptions.call(this, related, opts)\r\n\r\n    const { localKeys, foreignKeys, foreignKey } = opts\r\n\r\n    if (!foreignKey && !localKeys && !foreignKeys) {\r\n      throw utils.err('new Relation', 'opts.<foreignKey|localKeys|foreignKeys>')(400, 'string', foreignKey)\r\n    }\r\n  },\r\n\r\n  canFindLinkFor (record) {\r\n    const hasForeignKeys = this.foreignKey || this.foreignKeys\r\n    return !!(hasForeignKeys || (this.localKeys && utils.get(record, this.localKeys)))\r\n  },\r\n\r\n  linkRecord (record, relatedRecords) {\r\n    const relatedCollection = this.relatedCollection\r\n    const canAutoAddLinks = this.canAutoAddLinks\r\n    const foreignKey = this.foreignKey\r\n    const unsaved = this.relatedCollection.unsaved()\r\n\r\n    return relatedRecords.map((relatedRecord) => {\r\n      const relatedId = relatedCollection.recordId(relatedRecord)\r\n\r\n      if ((relatedId === undefined && unsaved.indexOf(relatedRecord) === -1) || relatedRecord !== relatedCollection.get(relatedId)) {\r\n        if (foreignKey) {\r\n          // TODO: slow, could be optimized? But user loses hook\r\n          this.setForeignKey(record, relatedRecord)\r\n        }\r\n        if (canAutoAddLinks) {\r\n          relatedRecord = relatedCollection.add(relatedRecord)\r\n        }\r\n      }\r\n\r\n      return relatedRecord\r\n    })\r\n  },\r\n\r\n  findExistingLinksFor (record) {\r\n    const id = utils.get(record, this.mapper.idAttribute)\r\n    const ids = this.localKeys ? utils.get(record, this.localKeys) : null\r\n    let records\r\n\r\n    if (id !== undefined && this.foreignKey) {\r\n      records = this.findExistingLinksByForeignKey(id)\r\n    } else if (this.localKeys && ids) {\r\n      records = this.findExistingLinksByLocalKeys(ids)\r\n    } else if (id !== undefined && this.foreignKeys) {\r\n      records = this.findExistingLinksByForeignKeys(id)\r\n    }\r\n\r\n    if (records && records.length) {\r\n      return records\r\n    }\r\n  },\r\n\r\n  // e.g. user hasMany group via \"foreignKeys\", so find all users of a group\r\n  findExistingLinksByLocalKeys (ids) {\r\n    return this.relatedCollection.filter({\r\n      where: {\r\n        [this.relatedCollection.mapper.idAttribute]: {\r\n          in: ids\r\n        }\r\n      }\r\n    })\r\n  },\r\n\r\n  // e.g. group hasMany user via \"localKeys\", so find all groups that own a user\r\n  findExistingLinksByForeignKeys (id) {\r\n    return this.relatedCollection.filter({\r\n      where: {\r\n        [this.foreignKeys]: {\r\n          contains: id\r\n        }\r\n      }\r\n    })\r\n  },\r\n\r\n  isRequiresParentId () {\r\n    return !!this.localKeys && this.localKeys.length > 0\r\n  },\r\n\r\n  isRequiresChildId () {\r\n    return !!this.foreignKey\r\n  },\r\n\r\n  createParentRecord (props, opts) {\r\n    const relationData = this.getLocalField(props)\r\n    const foreignIdField = this.getRelation().idAttribute\r\n\r\n    return this.createLinked(relationData, opts).then((records) => {\r\n      utils.set(props, this.localKeys, records.map((record) => utils.get(record, foreignIdField)))\r\n    })\r\n  },\r\n\r\n  createLinked (props, opts) {\r\n    return this.getRelation().createMany(props, opts)\r\n  }\r\n}, {\r\n  TYPE_NAME: 'hasMany'\r\n})\r\n","import utils from '../utils'\r\nimport { Relation } from '../Relation'\r\n\r\nexport const HasOneRelation = Relation.extend({\r\n  findExistingLinksFor (relatedMapper, record) {\r\n    const recordId = utils.get(record, relatedMapper.idAttribute)\r\n    const records = this.findExistingLinksByForeignKey(recordId)\r\n\r\n    if (records && records.length) {\r\n      return records[0]\r\n    }\r\n  },\r\n\r\n  isRequiresChildId () {\r\n    return true\r\n  }\r\n}, {\r\n  TYPE_NAME: 'hasOne'\r\n})\r\n","import { Relation } from './Relation'\r\nimport { BelongsToRelation } from './Relation/BelongsTo'\r\nimport { HasManyRelation } from './Relation/HasMany'\r\nimport { HasOneRelation } from './Relation/HasOne'\r\n\r\n[BelongsToRelation, HasManyRelation, HasOneRelation].forEach(RelationType => {\r\n  Relation[RelationType.TYPE_NAME] = (related, options) => new RelationType(related, options)\r\n})\r\n\r\nexport { belongsToType, hasManyType, hasOneType, Relation } from './Relation'\r\n","import { Relation } from './relations'\r\n\r\nexport { belongsToType, hasManyType, hasOneType } from './relations'\r\n/**\r\n * BelongsTo relation decorator. You probably won't use this directly.\r\n *\r\n * @name module:js-data.belongsTo\r\n * @method\r\n * @param {Mapper} related The relation the target belongs to.\r\n * @param {object} opts Configuration options.\r\n * @param {string} opts.foreignKey The field that holds the primary key of the\r\n * related record.\r\n * @param {string} opts.localField The field that holds a reference to the\r\n * related record object.\r\n * @returns {Function} Invocation function, which accepts the target as the only\r\n * parameter.\r\n */\r\nexport const belongsTo = function (related, opts) {\r\n  return function (mapper) {\r\n    Relation.belongsTo(related, opts).assignTo(mapper)\r\n  }\r\n}\r\n\r\n/**\r\n * HasMany relation decorator. You probably won't use this directly.\r\n *\r\n * @name module:js-data.hasMany\r\n * @method\r\n * @param {Mapper} related The relation of which the target has many.\r\n * @param {object} opts Configuration options.\r\n * @param {string} [opts.foreignKey] The field that holds the primary key of the\r\n * related record.\r\n * @param {string} opts.localField The field that holds a reference to the\r\n * related record object.\r\n * @returns {Function} Invocation function, which accepts the target as the only\r\n * parameter.\r\n */\r\nexport const hasMany = function (related, opts) {\r\n  return function (mapper) {\r\n    Relation.hasMany(related, opts).assignTo(mapper)\r\n  }\r\n}\r\n\r\n/**\r\n * HasOne relation decorator. You probably won't use this directly.\r\n *\r\n * @name module:js-data.hasOne\r\n * @method\r\n * @param {Mapper} related The relation of which the target has one.\r\n * @param {object} opts Configuration options.\r\n * @param {string} [opts.foreignKey] The field that holds the primary key of the\r\n * related record.\r\n * @param {string} opts.localField The field that holds a reference to the\r\n * related record object.\r\n * @returns {Function} Invocation function, which accepts the target as the only\r\n * parameter.\r\n */\r\nexport const hasOne = function (related, opts) {\r\n  return function (mapper) {\r\n    Relation.hasOne(related, opts).assignTo(mapper)\r\n  }\r\n}\r\n","import utils, { safeSetLink } from './utils'\r\nimport Component from './Component'\r\nimport Settable from './Settable'\r\nimport {\r\n  hasManyType,\r\n  hasOneType\r\n} from './decorators'\r\n\r\nconst DOMAIN = 'Record'\r\n\r\nconst superMethod = function (mapper, name) {\r\n  const store = mapper.datastore\r\n  if (store && store[name]) {\r\n    return function (...args) {\r\n      return store[name](mapper.name, ...args)\r\n    }\r\n  }\r\n  return mapper[name].bind(mapper)\r\n}\r\n\r\n// Cache these strings\r\nconst creatingPath = 'creating'\r\nconst noValidatePath = 'noValidate'\r\nconst keepChangeHistoryPath = 'keepChangeHistory'\r\nconst previousPath = 'previous'\r\n\r\n/**\r\n * js-data's Record class. An instance of `Record` corresponds to an in-memory\r\n * representation of a single row or document in a database, Firebase,\r\n * localstorage, etc. Basically, a `Record` instance represents whatever kind of\r\n * entity in your persistence layer that has a primary key.\r\n *\r\n * ```javascript\r\n * import {Record} from 'js-data'\r\n * ```\r\n *\r\n * @example <caption>Record#constructor</caption>\r\n * const JSData = require('js-data');\r\n * const { Record } = JSData;\r\n * console.log('Using JSData v' + JSData.version.full);\r\n *\r\n * // Instantiate a plain record\r\n * let record = new Record();\r\n * console.log('record: ' + JSON.stringify(record));\r\n *\r\n * // You can supply properties on instantiation\r\n * record = new Record({ name: 'John' });\r\n * console.log('record: ' + JSON.stringify(record));\r\n *\r\n * @example <caption>Record#constructor2</caption>\r\n * const JSData = require('js-data');\r\n * const { Mapper } = JSData;\r\n * console.log('Using JSData v' + JSData.version.full);\r\n *\r\n * // Instantiate a record that's associated with a Mapper:\r\n * const UserMapper = new Mapper({ name: 'user' });\r\n * const User = UserMapper.recordClass;\r\n * const user = UserMapper.createRecord({ name: 'John' });\r\n * const user2 = new User({ name: 'Sally' });\r\n * console.log('user: ' + JSON.stringify(user));\r\n * console.log('user2: ' + JSON.stringify(user2));\r\n *\r\n * @example <caption>Record#constructor3</caption>\r\n * const JSData = require('js-data');\r\n * const { Container } = JSData;\r\n * console.log('Using JSData v' + JSData.version.full);\r\n *\r\n * const store = new Container();\r\n * store.defineMapper('user');\r\n *\r\n * // Instantiate a record that's associated with a store's Mapper\r\n * const user = store.createRecord('user', { name: 'John' });\r\n * console.log('user: ' + JSON.stringify(user));\r\n *\r\n * @example <caption>Record#constructor4</caption>\r\n * const JSData = require('js-data');\r\n * const { Container } = JSData;\r\n * console.log('Using JSData v' + JSData.version.full);\r\n *\r\n * const store = new Container();\r\n * store.defineMapper('user', {\r\n *   schema: {\r\n *     properties: {\r\n *       name: { type: 'string' }\r\n *     }\r\n *   }\r\n * });\r\n *\r\n * // Validate on instantiation\r\n * const user = store.createRecord('user', { name: 1234 });\r\n * console.log('user: ' + JSON.stringify(user));\r\n *\r\n * @example <caption>Record#constructor5</caption>\r\n * const JSData = require('js-data');\r\n * const { Container } = JSData;\r\n * console.log('Using JSData v' + JSData.version.full);\r\n *\r\n * const store = new Container();\r\n * store.defineMapper('user', {\r\n *   schema: {\r\n *     properties: {\r\n *       name: { type: 'string' }\r\n *     }\r\n *   }\r\n * });\r\n *\r\n * // Skip validation on instantiation\r\n * const user = store.createRecord('user', { name: 1234 }, { noValidate: true });\r\n * console.log('user: ' + JSON.stringify(user));\r\n * console.log('user.isValid(): ' + user.isValid());\r\n *\r\n * @class Record\r\n * @extends Component\r\n * @param {object} [props] The initial properties of the new Record instance.\r\n * @param {object} [opts] Configuration options.\r\n * @param {boolean} [opts.noValidate=false] Whether to skip validation on the\r\n * initial properties.\r\n * @param {boolean} [opts.validateOnSet=true] Whether to enable setter\r\n * validation on properties after the Record has been initialized.\r\n * @since 3.0.0\r\n */\r\nfunction Record (props, opts) {\r\n  utils.classCallCheck(this, Record)\r\n  Settable.call(this)\r\n  props || (props = {})\r\n  opts || (opts = {})\r\n  const _set = this._set\r\n  const mapper = this.constructor.mapper\r\n\r\n  _set(creatingPath, true)\r\n  _set(noValidatePath, !!opts.noValidate)\r\n  _set(keepChangeHistoryPath, opts.keepChangeHistory === undefined ? (mapper ? mapper.keepChangeHistory : true) : opts.keepChangeHistory)\r\n\r\n  // Set the idAttribute value first, if it exists.\r\n  const id = mapper ? utils.get(props, mapper.idAttribute) : undefined\r\n  if (id !== undefined) {\r\n    utils.set(this, mapper.idAttribute, id)\r\n  }\r\n\r\n  utils.fillIn(this, props)\r\n  _set(creatingPath, false)\r\n  if (opts.validateOnSet !== undefined) {\r\n    _set(noValidatePath, !opts.validateOnSet)\r\n  } else if (mapper && mapper.validateOnSet !== undefined) {\r\n    _set(noValidatePath, !mapper.validateOnSet)\r\n  } else {\r\n    _set(noValidatePath, false)\r\n  }\r\n  _set(previousPath, mapper ? mapper.toJSON(props) : utils.plainCopy(props))\r\n}\r\n\r\nexport default Component.extend({\r\n  constructor: Record,\r\n\r\n  /**\r\n   * Returns the {@link Mapper} paired with this record's class, if any.\r\n   *\r\n   * @method Record#_mapper\r\n   * @returns {Mapper} The {@link Mapper} paired with this record's class, if any.\r\n   * @since 3.0.0\r\n   */\r\n  _mapper () {\r\n    const mapper = this.constructor.mapper\r\n    if (!mapper) {\r\n      throw utils.err(`${DOMAIN}#_mapper`, '')(404, 'mapper')\r\n    }\r\n    return mapper\r\n  },\r\n\r\n  /**\r\n   * Lifecycle hook.\r\n   *\r\n   * @method Record#afterLoadRelations\r\n   * @param {string[]} relations The `relations` argument passed to {@link Record#loadRelations}.\r\n   * @param {object} opts The `opts` argument passed to {@link Record#loadRelations}.\r\n   * @since 3.0.0\r\n   */\r\n  afterLoadRelations () {},\r\n\r\n  /**\r\n   * Lifecycle hook.\r\n   *\r\n   * @method Record#beforeLoadRelations\r\n   * @param {string[]} relations The `relations` argument passed to {@link Record#loadRelations}.\r\n   * @param {object} opts The `opts` argument passed to {@link Record#loadRelations}.\r\n   * @since 3.0.0\r\n   */\r\n  beforeLoadRelations () {},\r\n\r\n  /**\r\n   * Return the change history of this record since it was instantiated or\r\n   * {@link Record#commit} was called.\r\n   *\r\n   * @method Record#changeHistory\r\n   * @since 3.0.0\r\n   */\r\n  changeHistory () {\r\n    return (this._get('history') || []).slice()\r\n  },\r\n\r\n  /**\r\n   * Return changes to this record since it was instantiated or\r\n   * {@link Record#commit} was called.\r\n   *\r\n   * @example <caption>Record#changes</caption>\r\n   * const JSData = require('js-data');\r\n   * const { Container } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new Container();\r\n   * store.defineMapper('user');\r\n   * const user = store.createRecord('user');\r\n   * console.log('user changes: ' + JSON.stringify(user.changes()));\r\n   * user.name = 'John';\r\n   * console.log('user changes: ' + JSON.stringify(user.changes()));\r\n   *\r\n   * @method Record#changes\r\n   * @param [opts] Configuration options.\r\n   * @param {Function} [opts.equalsFn={@link utils.deepEqual}] Equality function.\r\n   * @param {array} [opts.ignore=[]] Array of strings or RegExp of fields to ignore.\r\n   * @returns {Object} Object describing the changes to this record since it was\r\n   * instantiated or its {@link Record#commit} method was last called.\r\n   * @since 3.0.0\r\n   */\r\n  changes (opts) {\r\n    opts || (opts = {})\r\n    return utils.diffObjects(typeof this.toJSON === 'function' ? this.toJSON(opts) : this, this._get('previous'), opts)\r\n  },\r\n\r\n  /**\r\n   * Make the record's current in-memory state it's only state, with any\r\n   * previous property values being set to current values.\r\n   *\r\n   * @example <caption>Record#commit</caption>\r\n   * const JSData = require('js-data');\r\n   * const { Container } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new Container();\r\n   * store.defineMapper('user');\r\n   * const user = store.createRecord('user');\r\n   * console.log('user hasChanges: ' + user.hasChanges());\r\n   * user.name = 'John';\r\n   * console.log('user hasChanges: ' + user.hasChanges());\r\n   * user.commit();\r\n   * console.log('user hasChanges: ' + user.hasChanges());\r\n   *\r\n   * @method Record#commit\r\n   * @param {object} [opts] Configuration options. Passed to {@link Record#toJSON}.\r\n   * @since 3.0.0\r\n   */\r\n  commit (opts) {\r\n    this._set('changed') // unset\r\n    this._set('changing', false)\r\n    this._set('history', []) // clear history\r\n    this._set('previous', this.toJSON(opts))\r\n  },\r\n\r\n  /**\r\n   * Call {@link Mapper#destroy} using this record's primary key.\r\n   *\r\n   * @example\r\n   * import { Container } from 'js-data';\r\n   * import { RethinkDBAdapter } from 'js-data-rethinkdb';\r\n   *\r\n   * const store = new Container();\r\n   * store.registerAdapter('rethink', new RethinkDBAdapter(), { default: true });\r\n   * store.defineMapper('user');\r\n   * store.find('user', 1234).then((user) => {\r\n   *   console.log(user.id); // 1234\r\n   *\r\n   *   // Destroy this user from the database\r\n   *   return user.destroy();\r\n   * });\r\n   *\r\n   * @method Record#destroy\r\n   * @param {object} [opts] Configuration options passed to {@link Mapper#destroy}.\r\n   * @returns {Promise} The result of calling {@link Mapper#destroy} with the\r\n   * primary key of this record.\r\n   * @since 3.0.0\r\n   */\r\n  destroy (opts) {\r\n    opts || (opts = {})\r\n    const mapper = this._mapper()\r\n    return superMethod(mapper, 'destroy')(utils.get(this, mapper.idAttribute), opts)\r\n  },\r\n\r\n  /**\r\n   * Return the value at the given path for this instance.\r\n   *\r\n   * @example <caption>Record#get</caption>\r\n   * const JSData = require('js-data');\r\n   * const { Container } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   * const store = new Container();\r\n   * store.defineMapper('user');\r\n   *\r\n   * const user = store.createRecord('user', { name: 'Bob' });\r\n   * console.log('user.get(\"name\"): ' + user.get('name'));\r\n   *\r\n   * @method Record#get\r\n   * @param {string} key Path of value to retrieve.\r\n   * @returns {*} Value at path.\r\n   * @since 3.0.0\r\n   */\r\n  'get' (key) {\r\n    return utils.get(this, key)\r\n  },\r\n\r\n  /**\r\n   * Return whether this record has changed since it was instantiated or\r\n   * {@link Record#commit} was called.\r\n   *\r\n   * @example <caption>Record#hasChanges</caption>\r\n   * const JSData = require('js-data');\r\n   * const { Container } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   * const store = new Container();\r\n   * store.defineMapper('user');\r\n   * const user = store.createRecord('user');\r\n   * console.log('user hasChanges: ' + user.hasChanges());\r\n   * user.name = 'John';\r\n   * console.log('user hasChanges: ' + user.hasChanges());\r\n   * user.commit();\r\n   * console.log('user hasChanges: ' + user.hasChanges());\r\n   *\r\n   * @method Record#hasChanges\r\n   * @param [opts] Configuration options.\r\n   * @param {Function} [opts.equalsFn={@link utils.deepEqual}] Equality function.\r\n   * @param {array} [opts.ignore=[]] Array of strings or RegExp of fields to ignore.\r\n   * @returns {boolean} Return whether the record has changed since it was\r\n   * instantiated or since its {@link Record#commit} method was called.\r\n   * @since 3.0.0\r\n   */\r\n  hasChanges (opts) {\r\n    const quickHasChanges = !!(this._get('changed') || []).length\r\n    return quickHasChanges || utils.areDifferent(typeof this.toJSON === 'function' ? this.toJSON(opts) : this, this._get('previous'), opts)\r\n  },\r\n\r\n  /**\r\n   * Return whether the record is unsaved. Records that have primary keys are\r\n   * considered \"saved\". Records without primary keys are considered \"unsaved\".\r\n   *\r\n   * @example <caption>Record#isNew</caption>\r\n   * const JSData = require('js-data');\r\n   * const { Container } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   * const store = new Container();\r\n   * store.defineMapper('user');\r\n   * const user = store.createRecord('user', {\r\n   *   id: 1234\r\n   * });\r\n   * const user2 = store.createRecord('user');\r\n   * console.log('user isNew: ' + user.isNew()); // false\r\n   * console.log('user2 isNew: ' + user2.isNew()); // true\r\n   *\r\n   * @method Record#isNew\r\n   * @returns {boolean} Whether the record is unsaved.\r\n   * @since 3.0.0\r\n   */\r\n  isNew (opts) {\r\n    return utils.get(this, this._mapper().idAttribute) === undefined\r\n  },\r\n\r\n  /**\r\n   * Return whether the record in its current state passes validation.\r\n   *\r\n   * @example <caption>Record#isValid</caption>\r\n   * const JSData = require('js-data');\r\n   * const { Container } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   * const store = new Container();\r\n   * store.defineMapper('user', {\r\n   *   schema: {\r\n   *     properties: {\r\n   *       name: { type: 'string' }\r\n   *     }\r\n   *   }\r\n   * });\r\n   * const user = store.createRecord('user', {\r\n   *   name: 1234\r\n   * }, {\r\n   *   noValidate: true // this allows us to put the record into an invalid state\r\n   * });\r\n   * console.log('user isValid: ' + user.isValid());\r\n   * user.name = 'John';\r\n   * console.log('user isValid: ' + user.isValid());\r\n   *\r\n   * @method Record#isValid\r\n   * @param {object} [opts] Configuration options. Passed to {@link Mapper#validate}.\r\n   * @returns {boolean} Whether the record in its current state passes\r\n   * validation.\r\n   * @since 3.0.0\r\n   */\r\n  isValid (opts) {\r\n    return !this._mapper().validate(this, opts)\r\n  },\r\n\r\n  removeInverseRelation (currentParent, id, inverseDef, idAttribute) {\r\n    if (inverseDef.type === hasOneType) {\r\n      safeSetLink(currentParent, inverseDef.localField, undefined)\r\n    } else if (inverseDef.type === hasManyType) {\r\n      // e.g. remove comment from otherPost.comments\r\n      const children = utils.get(currentParent, inverseDef.localField)\r\n      if (id === undefined) {\r\n        utils.remove(children, (child) => child === this)\r\n      } else {\r\n        utils.remove(children, (child) => child === this || id === utils.get(child, idAttribute))\r\n      }\r\n    }\r\n  },\r\n\r\n  setupInverseRelation (record, id, inverseDef, idAttribute) {\r\n    // Update (set) inverse relation\r\n    if (inverseDef.type === hasOneType) {\r\n      // e.g. someUser.profile = profile\r\n      safeSetLink(record, inverseDef.localField, this)\r\n    } else if (inverseDef.type === hasManyType) {\r\n      // e.g. add comment to somePost.comments\r\n      const children = utils.get(record, inverseDef.localField)\r\n      if (id === undefined) {\r\n        utils.noDupeAdd(children, this, (child) => child === this)\r\n      } else {\r\n        utils.noDupeAdd(children, this, (child) => child === this || id === utils.get(child, idAttribute))\r\n      }\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Lazy load relations of this record, to be attached to the record once their\r\n   * loaded.\r\n   *\r\n   * @example\r\n   * import { Container } from 'js-data';\r\n   * import { RethinkDBAdapter } from 'js-data-rethinkdb';\r\n   *\r\n   * const store = new Container();\r\n   * store.registerAdapter('rethink', new RethinkDBAdapter(), { default: true });\r\n   * store.defineMapper('user', {\r\n   *   relations: {\r\n   *     hasMany: {\r\n   *       post: {\r\n   *         localField: 'posts',\r\n   *         foreignKey: 'user_id'\r\n   *       }\r\n   *     }\r\n   *   }\r\n   * });\r\n   * store.defineMapper('post', {\r\n   *   relations: {\r\n   *     belongsTo: {\r\n   *       user: {\r\n   *         localField: 'user',\r\n   *         foreignKey: 'user_id'\r\n   *       }\r\n   *     }\r\n   *   }\r\n   * });\r\n   * store.find('user', 1234).then((user) => {\r\n   *   console.log(user.id); // 1234\r\n   *\r\n   *   // Load the user's post relations\r\n   *   return user.loadRelations(['post']);\r\n   * }).then((user) => {\r\n   *   console.log(user.posts); // [{...}, {...}, ...]\r\n   * });\r\n   *\r\n   * @method Record#loadRelations\r\n   * @param {string[]} [relations] List of relations to load. Can use localField\r\n   * names or Mapper names to pick relations.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {Promise} Resolves with the record, with the loaded relations now\r\n   * attached.\r\n   * @since 3.0.0\r\n   */\r\n  loadRelations (relations, opts) {\r\n    let op\r\n    const mapper = this._mapper()\r\n\r\n    // Default values for arguments\r\n    relations || (relations = [])\r\n    if (utils.isString(relations)) {\r\n      relations = [relations]\r\n    }\r\n    opts || (opts = {})\r\n    opts.with = relations\r\n\r\n    // Fill in \"opts\" with the Model's configuration\r\n    utils._(opts, mapper)\r\n    opts.adapter = mapper.getAdapterName(opts)\r\n\r\n    // beforeLoadRelations lifecycle hook\r\n    op = opts.op = 'beforeLoadRelations'\r\n    return utils.resolve(this[op](relations, opts)).then(() => {\r\n      // Now delegate to the adapter\r\n      op = opts.op = 'loadRelations'\r\n      mapper.dbg(op, this, relations, opts)\r\n      const tasks = []\r\n      let task\r\n      utils.forEachRelation(mapper, opts, (def, optsCopy) => {\r\n        const relatedMapper = def.getRelation()\r\n        optsCopy.raw = false\r\n        if (utils.isFunction(def.load)) {\r\n          task = def.load(mapper, def, this, opts)\r\n        } else if (def.type === 'hasMany' || def.type === 'hasOne') {\r\n          if (def.foreignKey) {\r\n            task = superMethod(relatedMapper, 'findAll')({\r\n              [def.foreignKey]: utils.get(this, mapper.idAttribute)\r\n            }, optsCopy).then(function (relatedData) {\r\n              if (def.type === 'hasOne') {\r\n                return relatedData.length ? relatedData[0] : undefined\r\n              }\r\n              return relatedData\r\n            })\r\n          } else if (def.localKeys) {\r\n            task = superMethod(relatedMapper, 'findAll')({\r\n              where: {\r\n                [relatedMapper.idAttribute]: {\r\n                  in: utils.get(this, def.localKeys)\r\n                }\r\n              }\r\n            })\r\n          } else if (def.foreignKeys) {\r\n            task = superMethod(relatedMapper, 'findAll')({\r\n              where: {\r\n                [def.foreignKeys]: {\r\n                  contains: utils.get(this, mapper.idAttribute)\r\n                }\r\n              }\r\n            }, opts)\r\n          }\r\n        } else if (def.type === 'belongsTo') {\r\n          const key = utils.get(this, def.foreignKey)\r\n          if (utils.isSorN(key)) {\r\n            task = superMethod(relatedMapper, 'find')(key, optsCopy)\r\n          }\r\n        }\r\n        if (task) {\r\n          task = task.then((relatedData) => {\r\n            def.setLocalField(this, relatedData)\r\n          })\r\n          tasks.push(task)\r\n        }\r\n      })\r\n      return Promise.all(tasks)\r\n    }).then(() => {\r\n      // afterLoadRelations lifecycle hook\r\n      op = opts.op = 'afterLoadRelations'\r\n      return utils.resolve(this[op](relations, opts)).then(() => this)\r\n    })\r\n  },\r\n\r\n  /**\r\n   * Return the properties with which this record was instantiated.\r\n   *\r\n   * @example <caption>Record#previous</caption>\r\n   * const JSData = require('js-data');\r\n   * const { Container } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   * const store = new Container();\r\n   * store.defineMapper('user');\r\n   * const user = store.createRecord('user', {\r\n   *   name: 'William'\r\n   * });\r\n   * console.log('user previous: ' + JSON.stringify(user.previous()));\r\n   * user.name = 'Bob';\r\n   * console.log('user previous: ' + JSON.stringify(user.previous()));\r\n   * user.commit();\r\n   * console.log('user previous: ' + JSON.stringify(user.previous()));\r\n   *\r\n   * @method Record#previous\r\n   * @param {string} [key] If specified, return just the initial value of the\r\n   * given key.\r\n   * @returns {Object} The initial properties of this record.\r\n   * @since 3.0.0\r\n   */\r\n  previous (key) {\r\n    if (key) {\r\n      return this._get(`previous.${key}`)\r\n    }\r\n    return this._get('previous')\r\n  },\r\n\r\n  /**\r\n   * Revert changes to this record back to the properties it had when it was\r\n   * instantiated.\r\n   *\r\n   * @example <caption>Record#revert</caption>\r\n   * const JSData = require('js-data');\r\n   * const { Container } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   * const store = new Container();\r\n   * store.defineMapper('user');\r\n   * const user = store.createRecord('user', {\r\n   *   name: 'William'\r\n   * });\r\n   * console.log('user: ' + JSON.stringify(user));\r\n   * user.name = 'Bob';\r\n   * console.log('user: ' + JSON.stringify(user));\r\n   * user.revert();\r\n   * console.log('user: ' + JSON.stringify(user));\r\n   *\r\n   * @method Record#revert\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {string[]} [opts.preserve] Array of strings or Regular Expressions\r\n   * denoting properties that should not be reverted.\r\n   * @since 3.0.0\r\n   */\r\n  revert (opts) {\r\n    const previous = this._get('previous')\r\n    opts || (opts = {})\r\n    opts.preserve || (opts.preserve = [])\r\n    utils.forOwn(this, (value, key) => {\r\n      if (key !== this._mapper().idAttribute && !Object.hasOwnProperty.call(previous, key) && Object.hasOwnProperty.call(this, key) && opts.preserve.indexOf(key) === -1) {\r\n        delete this[key]\r\n      }\r\n    })\r\n    utils.forOwn(previous, (value, key) => {\r\n      if (opts.preserve.indexOf(key) === -1) {\r\n        this[key] = value\r\n      }\r\n    })\r\n    this.commit()\r\n  },\r\n\r\n  /**\r\n   * Delegates to {@link Mapper#create} or {@link Mapper#update}.\r\n   *\r\n   * @example\r\n   * import { Container } from 'js-data';\r\n   * import { RethinkDBAdapter } from 'js-data-rethinkdb';\r\n   *\r\n   * const store = new Container();\r\n   * store.registerAdapter('rethink', new RethinkDBAdapter(), { default: true });\r\n   * store.defineMapper('session');\r\n   * const session = store.createRecord('session', { topic: 'Node.js' });\r\n   *\r\n   * // Create a new record in the database\r\n   * session.save().then(() => {\r\n   *   console.log(session.id); // 1234\r\n   *\r\n   *   session.skill_level = 'beginner';\r\n   *\r\n   *   // Update the record in the database\r\n   *   return session.save();\r\n   * });\r\n   *\r\n   * @method Record#save\r\n   * @param {object} [opts] Configuration options. See {@link Mapper#create} and\r\n   * {@link Mapper#update}.\r\n   * @param {boolean} [opts.changesOnly] Equality function. Default uses `===`.\r\n   * @param {Function} [opts.equalsFn] Passed to {@link Record#changes} when\r\n   * `opts.changesOnly` is `true`.\r\n   * @param {array} [opts.ignore] Passed to {@link Record#changes} when\r\n   * `opts.changesOnly` is `true`.\r\n   * @returns {Promise} The result of calling {@link Mapper#create} or\r\n   * {@link Mapper#update}.\r\n   * @since 3.0.0\r\n   */\r\n  save (opts) {\r\n    opts || (opts = {})\r\n    const mapper = this._mapper()\r\n    const id = utils.get(this, mapper.idAttribute)\r\n    let props = this\r\n\r\n    const postProcess = (result) => {\r\n      const record = opts.raw ? result.data : result\r\n      if (record) {\r\n        utils.deepMixIn(this, record)\r\n        this.commit()\r\n      }\r\n      return result\r\n    }\r\n\r\n    if (id === undefined) {\r\n      return superMethod(mapper, 'create')(props, opts).then(postProcess)\r\n    }\r\n    if (opts.changesOnly) {\r\n      const changes = this.changes(opts)\r\n      props = {}\r\n      utils.fillIn(props, changes.added)\r\n      utils.fillIn(props, changes.changed)\r\n    }\r\n    return superMethod(mapper, 'update')(id, props, opts).then(postProcess)\r\n  },\r\n\r\n  /**\r\n   * Set the value for a given key, or the values for the given keys if \"key\" is\r\n   * an object. Triggers change events on those properties that have `track: true`\r\n   * in {@link Mapper#schema}.\r\n   *\r\n   * @example <caption>Record#set</caption>\r\n   * const JSData = require('js-data');\r\n   * const { Container } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   * const store = new Container();\r\n   * store.defineMapper('user');\r\n   *\r\n   * const user = store.createRecord('user');\r\n   * console.log('user: ' + JSON.stringify(user));\r\n   *\r\n   * user.set('name', 'Bob');\r\n   * console.log('user: ' + JSON.stringify(user));\r\n   *\r\n   * user.set({ age: 30, role: 'admin' });\r\n   * console.log('user: ' + JSON.stringify(user));\r\n   *\r\n   * @fires Record#change\r\n   * @method Record#set\r\n   * @param {(string|Object)} key Key to set or hash of key-value pairs to set.\r\n   * @param {*} [value] Value to set for the given key.\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {boolean} [opts.silent=false] Whether to trigger change events.\r\n   * @since 3.0.0\r\n   */\r\n  'set' (key, value, opts) {\r\n    if (utils.isObject(key)) {\r\n      opts = value\r\n    }\r\n    opts || (opts = {})\r\n    if (opts.silent) {\r\n      this._set('silent', true)\r\n    }\r\n    utils.set(this, key, value)\r\n    if (!this._get('eventId')) {\r\n      this._set('silent') // unset\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Return a plain object representation of this record. If the class from\r\n   * which this record was created has a Mapper, then {@link Mapper#toJSON} will\r\n   * be called with this record instead.\r\n   *\r\n   * @example <caption>Record#toJSON</caption>\r\n   * const JSData = require('js-data');\r\n   * const { Container } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   * const store = new Container();\r\n   * store.defineMapper('user', {\r\n   *   schema: {\r\n   *     properties: {\r\n   *       name: { type: 'string' }\r\n   *     }\r\n   *   }\r\n   * });\r\n   *\r\n   * const user = store.createRecord('user', {\r\n   *   name: 'John',\r\n   *   $$hashKey: '1234'\r\n   * });\r\n   * console.log('user: ' + JSON.stringify(user.toJSON()));\r\n   *\r\n   * @method Record#toJSON\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {string[]} [opts.with] Array of relation names or relation fields\r\n   * to include in the representation. Only available as an option if the class\r\n   * from which this record was created has a Mapper and this record resides in\r\n   * an instance of {@link DataStore}.\r\n   * @returns {Object} Plain object representation of this record.\r\n   * @since 3.0.0\r\n   */\r\n  toJSON (opts) {\r\n    const mapper = this.constructor.mapper\r\n    if (mapper) {\r\n      return mapper.toJSON(this, opts)\r\n    } else {\r\n      const json = {}\r\n      utils.forOwn(this, (prop, key) => {\r\n        json[key] = utils.plainCopy(prop)\r\n      })\r\n      return json\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Unset the value for a given key. Triggers change events on those properties\r\n   * that have `track: true` in {@link Mapper#schema}.\r\n   *\r\n   * @example <caption>Record#unset</caption>\r\n   * const JSData = require('js-data');\r\n   * const { Container } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   * const store = new Container();\r\n   * store.defineMapper('user');\r\n   *\r\n   * const user = store.createRecord('user', {\r\n   *   name: 'John'\r\n   * });\r\n   * console.log('user: ' + JSON.stringify(user));\r\n   *\r\n   * user.unset('name');\r\n   * console.log('user: ' + JSON.stringify(user));\r\n   *\r\n   * @method Record#unset\r\n   * @param {string} key Key to unset.\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {boolean} [opts.silent=false] Whether to trigger change events.\r\n   * @since 3.0.0\r\n   */\r\n  unset (key, opts) {\r\n    this.set(key, undefined, opts)\r\n  },\r\n\r\n  /**\r\n   * Validate this record based on its current properties.\r\n   *\r\n   * @example <caption>Record#validate</caption>\r\n   * const JSData = require('js-data');\r\n   * const { Container } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   * const store = new Container();\r\n   * store.defineMapper('user', {\r\n   *   schema: {\r\n   *     properties: {\r\n   *       name: { type: 'string' }\r\n   *     }\r\n   *   }\r\n   * });\r\n   * const user = store.createRecord('user', {\r\n   *   name: 1234\r\n   * }, {\r\n   *   noValidate: true // this allows us to put the record into an invalid state\r\n   * });\r\n   * console.log('user validation: ' + JSON.stringify(user.validate()));\r\n   * user.name = 'John';\r\n   * console.log('user validation: ' + user.validate());\r\n   *\r\n   * @method Record#validate\r\n   * @param {object} [opts] Configuration options. Passed to {@link Mapper#validate}.\r\n   * @returns {*} Array of errors or `undefined` if no errors.\r\n   * @since 3.0.0\r\n   */\r\n  validate (opts) {\r\n    return this._mapper().validate(this, opts)\r\n  }\r\n}, {\r\n  creatingPath,\r\n  noValidatePath,\r\n  keepChangeHistoryPath,\r\n  previousPath\r\n})\r\n\r\n/**\r\n * Allow records to emit events.\r\n *\r\n * An record's registered listeners are stored in the record's private data.\r\n */\r\nutils.eventify(\r\n  Record.prototype,\r\n  function () {\r\n    return this._get('events')\r\n  },\r\n  function (value) {\r\n    this._set('events', value)\r\n  }\r\n)\r\n\r\n/**\r\n * Fired when a record changes. Only works for records that have tracked fields.\r\n * See {@link Record~changeListener} on how to listen for this event.\r\n *\r\n * @event Record#change\r\n * @see Record~changeListener\r\n */\r\n\r\n/**\r\n * Callback signature for the {@link Record#event:change} event.\r\n *\r\n * @example\r\n * function onChange (record, changes) {\r\n *   // do something\r\n * }\r\n * record.on('change', onChange);\r\n *\r\n * @callback Record~changeListener\r\n * @param {Record} The Record that changed.\r\n * @param {object} The changes.\r\n * @see Record#event:change\r\n * @since 3.0.0\r\n */\r\n\r\n/**\r\n * Create a subclass of this Record:\r\n * @example <caption>Record.extend</caption>\r\n * const JSData = require('js-data');\r\n * const { Record } = JSData;\r\n * console.log('Using JSData v' + JSData.version.full);\r\n *\r\n * // Extend the class using ES2015 class syntax.\r\n * class CustomRecordClass extends Record {\r\n *   foo () { return 'bar'; }\r\n *   static beep () { return 'boop'; }\r\n * }\r\n * const customRecord = new CustomRecordClass();\r\n * console.log(customRecord.foo());\r\n * console.log(CustomRecordClass.beep());\r\n *\r\n * // Extend the class using alternate method.\r\n * const OtherRecordClass = Record.extend({\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * });\r\n * const otherRecord = new OtherRecordClass();\r\n * console.log(otherRecord.foo());\r\n * console.log(OtherRecordClass.beep());\r\n *\r\n * // Extend the class, providing a custom constructor.\r\n * function AnotherRecordClass () {\r\n *   Record.call(this);\r\n *   this.created_at = new Date().getTime();\r\n * }\r\n * Record.extend({\r\n *   constructor: AnotherRecordClass,\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * });\r\n * const anotherRecord = new AnotherRecordClass();\r\n * console.log(anotherRecord.created_at);\r\n * console.log(anotherRecord.foo());\r\n * console.log(AnotherRecordClass.beep());\r\n *\r\n * @method Record.extend\r\n * @param {object} [props={}] Properties to add to the prototype of the\r\n * subclass.\r\n * @param {object} [props.constructor] Provide a custom constructor function\r\n * to be used as the subclass itself.\r\n * @param {object} [classProps={}] Static properties to add to the subclass.\r\n * @returns {Constructor} Subclass of this Record class.\r\n * @since 3.0.0\r\n */\r\n","export function sort (a, b, hashCode) {\r\n  // Short-circuit comparison if a and b are strictly equal\r\n  // This is absolutely necessary for indexed objects that\r\n  // don't have the idAttribute field\r\n  if (a === b) {\r\n    return 0\r\n  }\r\n  if (hashCode) {\r\n    a = hashCode(a)\r\n    b = hashCode(b)\r\n  }\r\n  if ((a === null && b === null) || (a === undefined && b === undefined)) {\r\n    return -1\r\n  }\r\n\r\n  if (a === null || a === undefined) {\r\n    return -1\r\n  }\r\n\r\n  if (b === null || b === undefined) {\r\n    return 1\r\n  }\r\n\r\n  if (a < b) {\r\n    return -1\r\n  }\r\n\r\n  if (a > b) {\r\n    return 1\r\n  }\r\n\r\n  return 0\r\n}\r\n\r\nexport function insertAt (array, index, value) {\r\n  array.splice(index, 0, value)\r\n  return array\r\n}\r\n\r\nexport function removeAt (array, index) {\r\n  array.splice(index, 1)\r\n  return array\r\n}\r\n\r\nexport function binarySearch (array, value, field) {\r\n  let lo = 0\r\n  let hi = array.length\r\n  let compared\r\n  let mid\r\n\r\n  while (lo < hi) {\r\n    mid = ((lo + hi) / 2) | 0\r\n    compared = sort(value, array[mid], field)\r\n    if (compared === 0) {\r\n      return {\r\n        found: true,\r\n        index: mid\r\n      }\r\n    } else if (compared < 0) {\r\n      hi = mid\r\n    } else {\r\n      lo = mid + 1\r\n    }\r\n  }\r\n\r\n  return {\r\n    found: false,\r\n    index: hi\r\n  }\r\n}\r\n","// Copyright (c) 2015, InternalFX.\r\n\r\n// Permission to use, copy, modify, and/or distribute this software for any purpose with or\r\n// without fee is hereby granted, provided that the above copyright notice and this permission\r\n// notice appear in all copies.\r\n\r\n// THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO\r\n// THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT\r\n// SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR\r\n// ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION\r\n// OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE\r\n// USE OR PERFORMANCE OF THIS SOFTWARE.\r\n\r\n// Modifications\r\n// Copyright 2015-2016 Jason Dobry\r\n//\r\n// Summary of modifications:\r\n// Reworked dependencies so as to re-use code already in js-data\r\n// Removed unused code\r\nimport utils from '../../src/utils'\r\nimport { binarySearch, insertAt, removeAt } from './_utils'\r\n\r\nexport default function Index (fieldList, opts) {\r\n  utils.classCallCheck(this, Index)\r\n  fieldList || (fieldList = [])\r\n\r\n  if (!utils.isArray(fieldList)) {\r\n    throw new Error('fieldList must be an array.')\r\n  }\r\n\r\n  opts || (opts = {})\r\n  this.fieldList = fieldList\r\n  this.fieldGetter = opts.fieldGetter\r\n  this.hashCode = opts.hashCode\r\n  this.isIndex = true\r\n  this.keys = []\r\n  this.values = []\r\n}\r\n\r\nutils.addHiddenPropsToTarget(Index.prototype, {\r\n  'set' (keyList, value) {\r\n    if (!utils.isArray(keyList)) {\r\n      keyList = [keyList]\r\n    }\r\n\r\n    const key = keyList.shift() || undefined\r\n    const pos = binarySearch(this.keys, key)\r\n\r\n    if (keyList.length === 0) {\r\n      if (pos.found) {\r\n        const dataLocation = binarySearch(this.values[pos.index], value, this.hashCode)\r\n        if (!dataLocation.found) {\r\n          insertAt(this.values[pos.index], dataLocation.index, value)\r\n        }\r\n      } else {\r\n        insertAt(this.keys, pos.index, key)\r\n        insertAt(this.values, pos.index, [value])\r\n      }\r\n    } else {\r\n      if (pos.found) {\r\n        this.values[pos.index].set(keyList, value)\r\n      } else {\r\n        insertAt(this.keys, pos.index, key)\r\n        const newIndex = new Index([], { hashCode: this.hashCode })\r\n        newIndex.set(keyList, value)\r\n        insertAt(this.values, pos.index, newIndex)\r\n      }\r\n    }\r\n  },\r\n\r\n  'get' (keyList) {\r\n    if (!utils.isArray(keyList)) {\r\n      keyList = [keyList]\r\n    }\r\n\r\n    const key = keyList.shift() || undefined\r\n    const pos = binarySearch(this.keys, key)\r\n\r\n    if (keyList.length === 0) {\r\n      if (pos.found) {\r\n        if (this.values[pos.index].isIndex) {\r\n          return this.values[pos.index].getAll()\r\n        } else {\r\n          return this.values[pos.index].slice()\r\n        }\r\n      } else {\r\n        return []\r\n      }\r\n    } else {\r\n      if (pos.found) {\r\n        return this.values[pos.index].get(keyList)\r\n      } else {\r\n        return []\r\n      }\r\n    }\r\n  },\r\n\r\n  getAll (opts) {\r\n    opts || (opts = {})\r\n    let results = []\r\n    const values = this.values\r\n    if (opts.order === 'desc') {\r\n      for (let i = values.length - 1; i >= 0; i--) {\r\n        const value = values[i]\r\n        if (value.isIndex) {\r\n          results = results.concat(value.getAll(opts))\r\n        } else {\r\n          results = results.concat(value)\r\n        }\r\n      }\r\n    } else {\r\n      for (let i = 0; i < values.length; i++) {\r\n        const value = values[i]\r\n        if (value.isIndex) {\r\n          results = results.concat(value.getAll(opts))\r\n        } else {\r\n          results = results.concat(value)\r\n        }\r\n      }\r\n    }\r\n    return results\r\n  },\r\n\r\n  visitAll (cb, thisArg) {\r\n    this.values.forEach(function (value) {\r\n      if (value.isIndex) {\r\n        value.visitAll(cb, thisArg)\r\n      } else {\r\n        value.forEach(cb, thisArg)\r\n      }\r\n    })\r\n  },\r\n\r\n  between (leftKeys, rightKeys, opts) {\r\n    opts || (opts = {})\r\n    if (!utils.isArray(leftKeys)) {\r\n      leftKeys = [leftKeys]\r\n    }\r\n    if (!utils.isArray(rightKeys)) {\r\n      rightKeys = [rightKeys]\r\n    }\r\n    utils.fillIn(opts, {\r\n      leftInclusive: true,\r\n      rightInclusive: false,\r\n      limit: undefined,\r\n      offset: 0\r\n    })\r\n\r\n    const results = this._between(leftKeys, rightKeys, opts)\r\n\r\n    if (opts.limit) {\r\n      return results.slice(opts.offset, opts.limit + opts.offset)\r\n    } else {\r\n      return results.slice(opts.offset)\r\n    }\r\n  },\r\n\r\n  _between (leftKeys, rightKeys, opts) {\r\n    let results = []\r\n\r\n    const leftKey = leftKeys.shift()\r\n    const rightKey = rightKeys.shift()\r\n\r\n    let pos\r\n\r\n    if (leftKey !== undefined) {\r\n      pos = binarySearch(this.keys, leftKey)\r\n    } else {\r\n      pos = {\r\n        found: false,\r\n        index: 0\r\n      }\r\n    }\r\n\r\n    if (leftKeys.length === 0) {\r\n      if (pos.found && opts.leftInclusive === false) {\r\n        pos.index += 1\r\n      }\r\n\r\n      for (let i = pos.index; i < this.keys.length; i += 1) {\r\n        if (rightKey !== undefined) {\r\n          if (opts.rightInclusive) {\r\n            if (this.keys[i] > rightKey) { break }\r\n          } else {\r\n            if (this.keys[i] >= rightKey) { break }\r\n          }\r\n        }\r\n\r\n        if (this.values[i].isIndex) {\r\n          results = results.concat(this.values[i].getAll())\r\n        } else {\r\n          results = results.concat(this.values[i])\r\n        }\r\n\r\n        if (opts.limit) {\r\n          if (results.length >= (opts.limit + opts.offset)) {\r\n            break\r\n          }\r\n        }\r\n      }\r\n    } else {\r\n      for (let i = pos.index; i < this.keys.length; i += 1) {\r\n        const currKey = this.keys[i]\r\n        if (currKey > rightKey) { break }\r\n\r\n        if (this.values[i].isIndex) {\r\n          if (currKey === leftKey) {\r\n            results = results.concat(this.values[i]._between(utils.copy(leftKeys), rightKeys.map(function () { return undefined }), opts))\r\n          } else if (currKey === rightKey) {\r\n            results = results.concat(this.values[i]._between(leftKeys.map(function () { return undefined }), utils.copy(rightKeys), opts))\r\n          } else {\r\n            results = results.concat(this.values[i].getAll())\r\n          }\r\n        } else {\r\n          results = results.concat(this.values[i])\r\n        }\r\n\r\n        if (opts.limit) {\r\n          if (results.length >= (opts.limit + opts.offset)) {\r\n            break\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    if (opts.limit) {\r\n      return results.slice(0, opts.limit + opts.offset)\r\n    } else {\r\n      return results\r\n    }\r\n  },\r\n\r\n  peek () {\r\n    if (this.values.length) {\r\n      if (this.values[0].isIndex) {\r\n        return this.values[0].peek()\r\n      } else {\r\n        return this.values[0]\r\n      }\r\n    }\r\n    return []\r\n  },\r\n\r\n  clear () {\r\n    this.keys = []\r\n    this.values = []\r\n  },\r\n\r\n  insertRecord (data) {\r\n    const keyList = this.fieldList.map(function (field) {\r\n      if (utils.isFunction(field)) {\r\n        return field(data) || undefined\r\n      } else {\r\n        return data[field] || undefined\r\n      }\r\n    })\r\n    this.set(keyList, data)\r\n  },\r\n\r\n  removeRecord (data) {\r\n    let removed\r\n    const isUnique = this.hashCode(data) !== undefined\r\n    this.values.forEach((value, i) => {\r\n      if (value.isIndex) {\r\n        if (value.removeRecord(data)) {\r\n          if (value.keys.length === 0) {\r\n            removeAt(this.keys, i)\r\n            removeAt(this.values, i)\r\n          }\r\n          removed = true\r\n          return false\r\n        }\r\n      } else {\r\n        let dataLocation = {}\r\n        if (this.keys[i] === undefined || !isUnique) {\r\n          for (let j = value.length - 1; j >= 0; j--) {\r\n            if (value[j] === data) {\r\n              dataLocation = {\r\n                found: true,\r\n                index: j\r\n              }\r\n              break\r\n            }\r\n          }\r\n        } else if (isUnique) {\r\n          dataLocation = binarySearch(value, data, this.hashCode)\r\n        }\r\n        if (dataLocation.found) {\r\n          removeAt(value, dataLocation.index)\r\n          if (value.length === 0) {\r\n            removeAt(this.keys, i)\r\n            removeAt(this.values, i)\r\n          }\r\n          removed = true\r\n          return false\r\n        }\r\n      }\r\n    })\r\n    return removed ? data : undefined\r\n  },\r\n\r\n  updateRecord (data) {\r\n    const removed = this.removeRecord(data)\r\n    if (removed !== undefined) {\r\n      this.insertRecord(data)\r\n    }\r\n  }\r\n})\r\n","import utils from './utils'\r\nimport Component from './Component'\r\nimport Query from './Query'\r\nimport Record from './Record'\r\nimport Index from '../lib/mindex/index'\r\n\r\nconst { noValidatePath } = Record\r\n\r\nconst DOMAIN = 'Collection'\r\n\r\nconst COLLECTION_DEFAULTS = {\r\n  /**\r\n   * Whether to call {@link Record#commit} on records that are added to the\r\n   * collection and already exist in the collection.\r\n   *\r\n   * @name Collection#commitOnMerge\r\n   * @type {boolean}\r\n   * @default true\r\n   */\r\n  commitOnMerge: true,\r\n\r\n  /**\r\n   * Whether record events should bubble up and be emitted by the collection.\r\n   *\r\n   * @name Collection#emitRecordEvents\r\n   * @type {boolean}\r\n   * @default true\r\n   */\r\n  emitRecordEvents: true,\r\n\r\n  /**\r\n   * Field to be used as the unique identifier for records in this collection.\r\n   * Defaults to `\"id\"` unless {@link Collection#mapper} is set, in which case\r\n   * this will default to {@link Mapper#idAttribute}.\r\n   *\r\n   * @name Collection#idAttribute\r\n   * @type {string}\r\n   * @default \"id\"\r\n   */\r\n  idAttribute: 'id',\r\n\r\n  /**\r\n   * What to do when inserting a record into this Collection that shares a\r\n   * primary key with a record already in this Collection.\r\n   *\r\n   * Possible values:\r\n   * merge\r\n   * replace\r\n   * skip\r\n   *\r\n   * Merge:\r\n   *\r\n   * Recursively shallow copy properties from the new record onto the existing\r\n   * record.\r\n   *\r\n   * Replace:\r\n   *\r\n   * Shallow copy top-level properties from the new record onto the existing\r\n   * record. Any top-level own properties of the existing record that are _not_\r\n   * on the new record will be removed.\r\n   *\r\n   * Skip:\r\n   *\r\n   * Ignore new record, keep existing record.\r\n   *\r\n   * @name Collection#onConflict\r\n   * @type {string}\r\n   * @default \"merge\"\r\n   */\r\n  onConflict: 'merge'\r\n}\r\n\r\n/**\r\n * An ordered set of {@link Record} instances.\r\n *\r\n * @example <caption>Collection#constructor</caption>\r\n * // import { Collection, Record } from 'js-data';\r\n * const JSData = require('js-data');\r\n * const {Collection, Record} = JSData;\r\n * console.log('Using JSData v' + JSData.version.full);\r\n *\r\n * const user1 = new Record({ id: 1 });\r\n * const user2 = new Record({ id: 2 });\r\n * const UserCollection = new Collection([user1, user2]);\r\n * console.log(UserCollection.get(1) === user1);\r\n *\r\n * @class Collection\r\n * @extends Component\r\n * @param {array} [records] Initial set of records to insert into the\r\n * collection.\r\n * @param {object} [opts] Configuration options.\r\n * @param {string} [opts.commitOnMerge] See {@link Collection#commitOnMerge}.\r\n * @param {string} [opts.idAttribute] See {@link Collection#idAttribute}.\r\n * @param {string} [opts.onConflict=\"merge\"] See {@link Collection#onConflict}.\r\n * @param {string} [opts.mapper] See {@link Collection#mapper}.\r\n * @since 3.0.0\r\n */\r\nfunction Collection (records, opts) {\r\n  utils.classCallCheck(this, Collection)\r\n  Component.call(this, opts)\r\n\r\n  if (records && !utils.isArray(records)) {\r\n    opts = records\r\n    records = []\r\n  }\r\n  if (utils.isString(opts)) {\r\n    opts = { idAttribute: opts }\r\n  }\r\n\r\n  // Default values for arguments\r\n  records || (records = [])\r\n  opts || (opts = {})\r\n\r\n  Object.defineProperties(this, {\r\n    /**\r\n     * Default Mapper for this collection. Optional. If a Mapper is provided, then\r\n     * the collection will use the {@link Mapper#idAttribute} setting, and will\r\n     * wrap records in {@link Mapper#recordClass}.\r\n     *\r\n     * @example <caption>Collection#mapper</caption>\r\n     * const JSData = require('js-data');\r\n     * const {Collection, Mapper} = JSData;\r\n     * console.log('Using JSData v' + JSData.version.full);\r\n     *\r\n     * class MyMapperClass extends Mapper {\r\n     *   foo () { return 'bar'; }\r\n     * }\r\n     * const myMapper = new MyMapperClass({ name: 'myMapper' });\r\n     * const collection = new Collection(null, { mapper: myMapper });\r\n     *\r\n     * @name Collection#mapper\r\n     * @type {Mapper}\r\n     * @default null\r\n     * @since 3.0.0\r\n     */\r\n    mapper: {\r\n      value: undefined,\r\n      writable: true\r\n    },\r\n    // Query class used by this collection\r\n    queryClass: {\r\n      value: undefined,\r\n      writable: true\r\n    }\r\n  })\r\n\r\n  // Apply user-provided configuration\r\n  utils.fillIn(this, opts)\r\n  // Fill in any missing options with the defaults\r\n  utils.fillIn(this, utils.copy(COLLECTION_DEFAULTS))\r\n\r\n  if (!this.queryClass) {\r\n    this.queryClass = Query\r\n  }\r\n\r\n  const idAttribute = this.recordId()\r\n\r\n  Object.defineProperties(this, {\r\n    /**\r\n     * The main index, which uses @{link Collection#recordId} as the key.\r\n     *\r\n     * @name Collection#index\r\n     * @type {Index}\r\n     */\r\n    index: {\r\n      value: new Index([idAttribute], {\r\n        hashCode (obj) {\r\n          return utils.get(obj, idAttribute)\r\n        }\r\n      })\r\n    },\r\n\r\n    /**\r\n     * Object that holds the secondary indexes of this collection.\r\n     *\r\n     * @name Collection#indexes\r\n     * @type {Object.<string, Index>}\r\n     */\r\n    indexes: {\r\n      value: {}\r\n    }\r\n  })\r\n\r\n  // Insert initial data into the collection\r\n  if (utils.isObject(records) || (utils.isArray(records) && records.length)) {\r\n    this.add(records)\r\n  }\r\n}\r\n\r\nexport default Component.extend({\r\n  constructor: Collection,\r\n\r\n  /**\r\n   * Used to bind to events emitted by records in this Collection.\r\n   *\r\n   * @method Collection#_onRecordEvent\r\n   * @since 3.0.0\r\n   * @private\r\n   * @param {...*} [arg] Args passed to {@link Collection#emit}.\r\n   */\r\n  _onRecordEvent (...args) {\r\n    if (this.emitRecordEvents) {\r\n      this.emit(...args)\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Insert the provided record or records.\r\n   *\r\n   * If a record is already in the collection then the provided record will\r\n   * either merge with or replace the existing record based on the value of the\r\n   * `onConflict` option.\r\n   *\r\n   * The collection's secondary indexes will be updated as each record is\r\n   * visited.\r\n   *\r\n   * @method Collection#add\r\n   * @since 3.0.0\r\n   * @param {(Object|Object[]|Record|Record[])} data The record or records to insert.\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {boolean} [opts.commitOnMerge=true] See {@link Collection#commitOnMerge}.\r\n   * @param {boolean} [opts.noValidate] See {@link Record#noValidate}.\r\n   * @param {string} [opts.onConflict] See {@link Collection#onConflict}.\r\n   * @returns {(Object|Object[]|Record|Record[])} The added record or records.\r\n   */\r\n  add (records, opts) {\r\n    // Default values for arguments\r\n    opts || (opts = {})\r\n\r\n    // Fill in \"opts\" with the Collection's configuration\r\n    utils._(opts, this)\r\n    records = this.beforeAdd(records, opts) || records\r\n\r\n    // Track whether just one record or an array of records is being inserted\r\n    let singular = false\r\n    const idAttribute = this.recordId()\r\n    if (!utils.isArray(records)) {\r\n      if (utils.isObject(records)) {\r\n        records = [records]\r\n        singular = true\r\n      } else {\r\n        throw utils.err(`${DOMAIN}#add`, 'records')(\r\n          400,\r\n          'object or array',\r\n          records\r\n        )\r\n      }\r\n    }\r\n\r\n    // Map the provided records to existing records.\r\n    // New records will be inserted. If any records map to existing records,\r\n    // they will be merged into the existing records according to the onConflict\r\n    // option.\r\n    records = records.map(record => {\r\n      const id = this.recordId(record)\r\n      // Grab existing record if there is one\r\n      const existing = id === undefined ? id : this.get(id)\r\n      // If the currently visited record is just a reference to an existing\r\n      // record, then there is nothing to be done. Exit early.\r\n      if (record === existing) {\r\n        return existing\r\n      }\r\n\r\n      if (existing) {\r\n        // Here, the currently visited record corresponds to a record already\r\n        // in the collection, so we need to merge them\r\n        const onConflict = opts.onConflict || this.onConflict\r\n        if (\r\n          onConflict !== 'merge' &&\r\n          onConflict !== 'replace' &&\r\n          onConflict !== 'skip'\r\n        ) {\r\n          throw utils.err(`${DOMAIN}#add`, 'opts.onConflict')(\r\n            400,\r\n            'one of (merge, replace, skip)',\r\n            onConflict,\r\n            true\r\n          )\r\n        }\r\n        const existingNoValidate = existing._get(noValidatePath)\r\n        if (opts.noValidate) {\r\n          // Disable validation\r\n          existing._set(noValidatePath, true)\r\n        }\r\n        if (onConflict === 'merge') {\r\n          utils.deepMixIn(existing, record)\r\n        } else if (onConflict === 'replace') {\r\n          utils.forOwn(existing, (value, key) => {\r\n            if (key !== idAttribute && record[key] === undefined) {\r\n              existing[key] = undefined\r\n            }\r\n          })\r\n          existing.set(record)\r\n        } // else if(onConflict === 'skip'){ do nothing }\r\n\r\n        if (opts.noValidate) {\r\n          // Restore previous `noValidate` value\r\n          existing._set(noValidatePath, existingNoValidate)\r\n        }\r\n        record = existing\r\n        if (opts.commitOnMerge && utils.isFunction(record.commit)) {\r\n          record.commit()\r\n        }\r\n        // Update all indexes in the collection\r\n        this.updateIndexes(record)\r\n      } else {\r\n        // Here, the currently visted record does not correspond to any record\r\n        // in the collection, so (optionally) instantiate this record and insert\r\n        // it into the collection\r\n        record = this.mapper ? this.mapper.createRecord(record, opts) : record\r\n        this.index.insertRecord(record)\r\n        utils.forOwn(this.indexes, function (index, name) {\r\n          index.insertRecord(record)\r\n        })\r\n        if (record && utils.isFunction(record.on)) {\r\n          record.on('all', this._onRecordEvent, this)\r\n        }\r\n      }\r\n      return record\r\n    })\r\n    // Finally, return the inserted data\r\n    const result = singular ? records[0] : records\r\n    if (!opts.silent) {\r\n      this.emit('add', result)\r\n    }\r\n    return this.afterAdd(records, opts, result) || result\r\n  },\r\n\r\n  /**\r\n   * Lifecycle hook called by {@link Collection#add}. If this method returns a\r\n   * value then {@link Collection#add} will return that same value.\r\n   *\r\n   * @method Collection#method\r\n   * @since 3.0.0\r\n   * @param {(Object|Object[]|Record|Record[])} result The record or records\r\n   * that were added to this Collection by {@link Collection#add}.\r\n   * @param {object} opts The `opts` argument passed to {@link Collection#add}.\r\n   */\r\n  afterAdd () {},\r\n\r\n  /**\r\n   * Lifecycle hook called by {@link Collection#remove}. If this method returns\r\n   * a value then {@link Collection#remove} will return that same value.\r\n   *\r\n   * @method Collection#afterRemove\r\n   * @since 3.0.0\r\n   * @param {(string|number)} id The `id` argument passed to {@link Collection#remove}.\r\n   * @param {object} opts The `opts` argument passed to {@link Collection#remove}.\r\n   * @param {object} record The result that will be returned by {@link Collection#remove}.\r\n   */\r\n  afterRemove () {},\r\n\r\n  /**\r\n   * Lifecycle hook called by {@link Collection#removeAll}. If this method\r\n   * returns a value then {@link Collection#removeAll} will return that same\r\n   * value.\r\n   *\r\n   * @method Collection#afterRemoveAll\r\n   * @since 3.0.0\r\n   * @param {object} query The `query` argument passed to {@link Collection#removeAll}.\r\n   * @param {object} opts The `opts` argument passed to {@link Collection#removeAll}.\r\n   * @param {object} records The result that will be returned by {@link Collection#removeAll}.\r\n   */\r\n  afterRemoveAll () {},\r\n\r\n  /**\r\n   * Lifecycle hook called by {@link Collection#add}. If this method returns a\r\n   * value then the `records` argument in {@link Collection#add} will be\r\n   * re-assigned to the returned value.\r\n   *\r\n   * @method Collection#beforeAdd\r\n   * @since 3.0.0\r\n   * @param {(Object|Object[]|Record|Record[])} records The `records` argument passed to {@link Collection#add}.\r\n   * @param {object} opts The `opts` argument passed to {@link Collection#add}.\r\n   */\r\n  beforeAdd () {},\r\n\r\n  /**\r\n   * Lifecycle hook called by {@link Collection#remove}.\r\n   *\r\n   * @method Collection#beforeRemove\r\n   * @since 3.0.0\r\n   * @param {(string|number)} id The `id` argument passed to {@link Collection#remove}.\r\n   * @param {object} opts The `opts` argument passed to {@link Collection#remove}.\r\n   */\r\n  beforeRemove () {},\r\n\r\n  /**\r\n   * Lifecycle hook called by {@link Collection#removeAll}.\r\n   *\r\n   * @method Collection#beforeRemoveAll\r\n   * @since 3.0.0\r\n   * @param {object} query The `query` argument passed to {@link Collection#removeAll}.\r\n   * @param {object} opts The `opts` argument passed to {@link Collection#removeAll}.\r\n   */\r\n  beforeRemoveAll () {},\r\n\r\n  /**\r\n   * Find all records between two boundaries.\r\n   *\r\n   * Shortcut for `collection.query().between(18, 30, { index: 'age' }).run()`\r\n   *\r\n   * @example\r\n   * // Get all users ages 18 to 30\r\n   * const users = collection.between(18, 30, { index: 'age' });\r\n   *\r\n   * @example\r\n   * // Same as above\r\n   * const users = collection.between([18], [30], { index: 'age' });\r\n   *\r\n   * @method Collection#between\r\n   * @since 3.0.0\r\n   * @param {array} leftKeys Keys defining the left boundary.\r\n   * @param {array} rightKeys Keys defining the right boundary.\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {string} [opts.index] Name of the secondary index to use in the\r\n   * query. If no index is specified, the main index is used.\r\n   * @param {boolean} [opts.leftInclusive=true] Whether to include records\r\n   * on the left boundary.\r\n   * @param {boolean} [opts.rightInclusive=false] Whether to include records\r\n   * on the left boundary.\r\n   * @param {boolean} [opts.limit] Limit the result to a certain number.\r\n   * @param {boolean} [opts.offset] The number of resulting records to skip.\r\n   * @returns {Object[]|Record[]} The result.\r\n   */\r\n  between (leftKeys, rightKeys, opts) {\r\n    return this.query()\r\n      .between(leftKeys, rightKeys, opts)\r\n      .run()\r\n  },\r\n\r\n  /**\r\n   * Create a new secondary index on the contents of the collection.\r\n   *\r\n   * @example\r\n   * // Index users by age\r\n   * collection.createIndex('age');\r\n   *\r\n   * @example\r\n   * // Index users by status and role\r\n   * collection.createIndex('statusAndRole', ['status', 'role']);\r\n   *\r\n   * @method Collection#createIndex\r\n   * @since 3.0.0\r\n   * @param {string} name The name of the new secondary index.\r\n   * @param {string[]} [fieldList] Array of field names to use as the key or\r\n   * compound key of the new secondary index. If no fieldList is provided, then\r\n   * the name will also be the field that is used to index the collection.\r\n   */\r\n  createIndex (name, fieldList, opts) {\r\n    if (utils.isString(name) && fieldList === undefined) {\r\n      fieldList = [name]\r\n    }\r\n    opts || (opts = {})\r\n    opts.hashCode || (opts.hashCode = obj => this.recordId(obj))\r\n    const index = (this.indexes[name] = new Index(fieldList, opts))\r\n    this.index.visitAll(index.insertRecord, index)\r\n  },\r\n\r\n  /**\r\n   * Find the record or records that match the provided query or pass the\r\n   * provided filter function.\r\n   *\r\n   * Shortcut for `collection.query().filter(queryOrFn[, thisArg]).run()`\r\n   *\r\n   * @example <caption>Collection#filter</caption>\r\n   * const JSData = require('js-data');\r\n   * const { Collection } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const collection = new Collection([\r\n   *   { id: 1, status: 'draft', created_at_timestamp: new Date().getTime() }\r\n   * ]);\r\n   *\r\n   * // Get the draft posts created less than three months ago\r\n   * let posts = collection.filter({\r\n   *   where: {\r\n   *     status: {\r\n   *       '==': 'draft'\r\n   *     },\r\n   *     created_at_timestamp: {\r\n   *       '>=': (new Date().getTime() - (1000 \\* 60 \\* 60 \\* 24 \\* 30 \\* 3)) // 3 months ago\r\n   *     }\r\n   *   }\r\n   * });\r\n   * console.log(posts);\r\n   *\r\n   * // Use a custom filter function\r\n   * posts = collection.filter((post) => post.id % 2 === 0);\r\n   *\r\n   * @method Collection#filter\r\n   * @param {(Object|Function)} [queryOrFn={}] Selection query or filter\r\n   * function.\r\n   * @param {object} [thisArg] Context to which to bind `queryOrFn` if\r\n   * `queryOrFn` is a function.\r\n   * @returns {Array} The result.\r\n   * @see query\r\n   * @since 3.0.0\r\n   */\r\n  filter (query, thisArg) {\r\n    return this.query()\r\n      .filter(query, thisArg)\r\n      .run()\r\n  },\r\n\r\n  /**\r\n   * Iterate over all records.\r\n   *\r\n   * @example\r\n   * collection.forEach(function (record) {\r\n   *   // do something\r\n   * });\r\n   *\r\n   * @method Collection#forEach\r\n   * @since 3.0.0\r\n   * @param {Function} forEachFn Iteration function.\r\n   * @param {*} [thisArg] Context to which to bind `forEachFn`.\r\n   * @returns {Array} The result.\r\n   */\r\n  forEach (cb, thisArg) {\r\n    this.index.visitAll(cb, thisArg)\r\n  },\r\n\r\n  /**\r\n   * Get the record with the given id.\r\n   *\r\n   * @method Collection#get\r\n   * @since 3.0.0\r\n   * @param {(string|number)} id The primary key of the record to get.\r\n   * @returns {(Object|Record)} The record with the given id.\r\n   */\r\n  get (id) {\r\n    const instances =\r\n      id === undefined\r\n        ? []\r\n        : this.query()\r\n          .get(id)\r\n          .run()\r\n    return instances.length ? instances[0] : undefined\r\n  },\r\n\r\n  /**\r\n   * Find the record or records that match the provided keyLists.\r\n   *\r\n   * Shortcut for `collection.query().getAll(keyList1, keyList2, ...).run()`\r\n   *\r\n   * @example\r\n   * // Get the posts where \"status\" is \"draft\" or \"inReview\"\r\n   * const posts = collection.getAll('draft', 'inReview', { index: 'status' });\r\n   *\r\n   * @example\r\n   * // Same as above\r\n   * const posts = collection.getAll(['draft'], ['inReview'], { index: 'status' });\r\n   *\r\n   * @method Collection#getAll\r\n   * @since 3.0.0\r\n   * @param {...Array} [keyList] Provide one or more keyLists, and all\r\n   * records matching each keyList will be retrieved. If no keyLists are\r\n   * provided, all records will be returned.\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {string} [opts.index] Name of the secondary index to use in the\r\n   * query. If no index is specified, the main index is used.\r\n   * @returns {Array} The result.\r\n   */\r\n  getAll (...args) {\r\n    return this.query()\r\n      .getAll(...args)\r\n      .run()\r\n  },\r\n\r\n  /**\r\n   * Return the index with the given name. If no name is provided, return the\r\n   * main index. Throws an error if the specified index does not exist.\r\n   *\r\n   * @method Collection#getIndex\r\n   * @since 3.0.0\r\n   * @param {string} [name] The name of the index to retrieve.\r\n   */\r\n  getIndex (name) {\r\n    const index = name ? this.indexes[name] : this.index\r\n    if (!index) {\r\n      throw utils.err(`${DOMAIN}#getIndex`, name)(404, 'index')\r\n    }\r\n    return index\r\n  },\r\n\r\n  /**\r\n   * Limit the result.\r\n   *\r\n   * Shortcut for `collection.query().limit(maximumNumber).run()`\r\n   *\r\n   * @example\r\n   * const posts = collection.limit(10);\r\n   *\r\n   * @method Collection#limit\r\n   * @since 3.0.0\r\n   * @param {number} num The maximum number of records to keep in the result.\r\n   * @returns {Array} The result.\r\n   */\r\n  limit (num) {\r\n    return this.query()\r\n      .limit(num)\r\n      .run()\r\n  },\r\n\r\n  /**\r\n   * Apply a mapping function to all records.\r\n   *\r\n   * @example\r\n   * const names = collection.map((user) => user.name);\r\n   *\r\n   * @method Collection#map\r\n   * @since 3.0.0\r\n   * @param {Function} mapFn Mapping function.\r\n   * @param {*} [thisArg] Context to which to bind `mapFn`.\r\n   * @returns {Array} The result of the mapping.\r\n   */\r\n  map (cb, thisArg) {\r\n    const data = []\r\n    this.index.visitAll(function (value) {\r\n      data.push(cb.call(thisArg, value))\r\n    })\r\n    return data\r\n  },\r\n\r\n  /**\r\n   * Return the result of calling the specified function on each record in this\r\n   * collection's main index.\r\n   *\r\n   * @method Collection#mapCall\r\n   * @since 3.0.0\r\n   * @param {string} funcName Name of function to call\r\n   * @parama {...*} [args] Remaining arguments to be passed to the function.\r\n   * @returns {Array} The result.\r\n   */\r\n  mapCall (funcName, ...args) {\r\n    const data = []\r\n    this.index.visitAll(function (record) {\r\n      data.push(record[funcName](...args))\r\n    })\r\n    return data\r\n  },\r\n\r\n  /**\r\n   * Return all \"unsaved\" (not uniquely identifiable) records in this colleciton.\r\n   *\r\n   * @method Collection#prune\r\n   * @param {object} [opts] Configuration options, passed to {@link Collection#removeAll}.\r\n   * @since 3.0.0\r\n   * @returns {Array} The removed records, if any.\r\n   */\r\n  prune (opts) {\r\n    return this.removeAll(this.unsaved(), opts)\r\n  },\r\n\r\n  /**\r\n   * Create a new query to be executed against the contents of the collection.\r\n   * The result will be all or a subset of the contents of the collection.\r\n   *\r\n   * @example\r\n   * // Grab page 2 of users between ages 18 and 30\r\n   * collection.query()\r\n   *   .between(18, 30, { index: 'age' }) // between ages 18 and 30\r\n   *   .skip(10) // second page\r\n   *   .limit(10) // page size\r\n   *   .run();\r\n   *\r\n   * @method Collection#query\r\n   * @since 3.0.0\r\n   * @returns {Query} New query object.\r\n   */\r\n  query () {\r\n    const Ctor = this.queryClass\r\n    return new Ctor(this)\r\n  },\r\n\r\n  /**\r\n   * Return the primary key of the given, or if no record is provided, return the\r\n   * name of the field that holds the primary key of records in this Collection.\r\n   *\r\n   * @method Collection#recordId\r\n   * @since 3.0.0\r\n   * @param {(Object|Record)} [record] The record whose primary key is to be\r\n   * returned.\r\n   * @returns {(string|number)} Primary key or name of field that holds primary\r\n   * key.\r\n   */\r\n  recordId (record) {\r\n    if (record) {\r\n      return utils.get(record, this.recordId())\r\n    }\r\n    return this.mapper ? this.mapper.idAttribute : this.idAttribute\r\n  },\r\n\r\n  /**\r\n   * Reduce the data in the collection to a single value and return the result.\r\n   *\r\n   * @example\r\n   * const totalVotes = collection.reduce((prev, record) => {\r\n   *   return prev + record.upVotes + record.downVotes;\r\n   * }, 0);\r\n   *\r\n   * @method Collection#reduce\r\n   * @since 3.0.0\r\n   * @param {Function} cb Reduction callback.\r\n   * @param {*} initialValue Initial value of the reduction.\r\n   * @returns {*} The result.\r\n   */\r\n  reduce (cb, initialValue) {\r\n    const data = this.getAll()\r\n    return data.reduce(cb, initialValue)\r\n  },\r\n\r\n  /**\r\n   * Remove the record with the given id from this Collection.\r\n   *\r\n   * @method Collection#remove\r\n   * @since 3.0.0\r\n   * @param {(string|number|object|Record)} idOrRecord The primary key of the\r\n   * record to be removed, or a reference to the record that is to be removed.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {Object|Record} The removed record, if any.\r\n   */\r\n  remove (idOrRecord, opts) {\r\n    // Default values for arguments\r\n    opts || (opts = {})\r\n    this.beforeRemove(idOrRecord, opts)\r\n    let record = utils.isSorN(idOrRecord) ? this.get(idOrRecord) : idOrRecord\r\n\r\n    // The record is in the collection, remove it\r\n    if (utils.isObject(record)) {\r\n      record = this.index.removeRecord(record)\r\n      if (record) {\r\n        utils.forOwn(this.indexes, function (index, name) {\r\n          index.removeRecord(record)\r\n        })\r\n        if (utils.isFunction(record.off)) {\r\n          record.off('all', this._onRecordEvent, this)\r\n        }\r\n        if (!opts.silent) {\r\n          this.emit('remove', record)\r\n        }\r\n      }\r\n    }\r\n    return this.afterRemove(idOrRecord, opts, record) || record\r\n  },\r\n\r\n  /**\r\n   * Remove from this collection the given records or the records selected by\r\n   * the given \"query\".\r\n   *\r\n   * @method Collection#removeAll\r\n   * @since 3.0.0\r\n   * @param {Object|Object[]|Record[]} [queryOrRecords={}] Records to be removed or selection query. See {@link query}.\r\n   * @param {object} [queryOrRecords.where] See {@link query.where}.\r\n   * @param {number} [queryOrRecords.offset] See {@link query.offset}.\r\n   * @param {number} [queryOrRecords.limit] See {@link query.limit}.\r\n   * @param {string|Array[]} [queryOrRecords.orderBy] See {@link query.orderBy}.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(Object[]|Record[])} The removed records, if any.\r\n   */\r\n  removeAll (queryOrRecords, opts) {\r\n    // Default values for arguments\r\n    opts || (opts = {})\r\n    this.beforeRemoveAll(queryOrRecords, opts)\r\n    let records = utils.isArray(queryOrRecords)\r\n      ? queryOrRecords.slice()\r\n      : this.filter(queryOrRecords)\r\n\r\n    // Remove each selected record from the collection\r\n    const optsCopy = utils.plainCopy(opts)\r\n    optsCopy.silent = true\r\n    records = records\r\n      .map(record => this.remove(record, optsCopy))\r\n      .filter(record => record)\r\n    if (!opts.silent) {\r\n      this.emit('remove', records)\r\n    }\r\n    return this.afterRemoveAll(queryOrRecords, opts, records) || records\r\n  },\r\n\r\n  /**\r\n   * Skip a number of results.\r\n   *\r\n   * Shortcut for `collection.query().skip(numberToSkip).run()`\r\n   *\r\n   * @example\r\n   * const posts = collection.skip(10);\r\n   *\r\n   * @method Collection#skip\r\n   * @since 3.0.0\r\n   * @param {number} num The number of records to skip.\r\n   * @returns {Array} The result.\r\n   */\r\n  skip (num) {\r\n    return this.query()\r\n      .skip(num)\r\n      .run()\r\n  },\r\n\r\n  /**\r\n   * Return the plain JSON representation of all items in this collection.\r\n   * Assumes records in this collection have a toJSON method.\r\n   *\r\n   * @method Collection#toJSON\r\n   * @since 3.0.0\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {string[]} [opts.with] Array of relation names or relation fields\r\n   * to include in the representation.\r\n   * @returns {Array} The records.\r\n   */\r\n  toJSON (opts) {\r\n    return this.mapCall('toJSON', opts)\r\n  },\r\n\r\n  /**\r\n   * Return all \"unsaved\" (not uniquely identifiable) records in this colleciton.\r\n   *\r\n   * @method Collection#unsaved\r\n   * @since 3.0.0\r\n   * @returns {Array} The unsaved records, if any.\r\n   */\r\n  unsaved (opts) {\r\n    return this.index.get()\r\n  },\r\n\r\n  /**\r\n   * Update a record's position in a single index of this collection. See\r\n   * {@link Collection#updateIndexes} to update a record's position in all\r\n   * indexes at once.\r\n   *\r\n   * @method Collection#updateIndex\r\n   * @since 3.0.0\r\n   * @param {object} record The record to update.\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {string} [opts.index] The index in which to update the record's\r\n   * position. If you don't specify an index then the record will be updated\r\n   * in the main index.\r\n   */\r\n  updateIndex (record, opts) {\r\n    opts || (opts = {})\r\n    this.getIndex(opts.index).updateRecord(record)\r\n  },\r\n\r\n  /**\r\n   * Updates all indexes in this collection for the provided record. Has no\r\n   * effect if the record is not in the collection.\r\n   *\r\n   * @method Collection#updateIndexes\r\n   * @since 3.0.0\r\n   * @param {object} record TODO\r\n   */\r\n  updateIndexes (record) {\r\n    this.index.updateRecord(record)\r\n    utils.forOwn(this.indexes, function (index, name) {\r\n      index.updateRecord(record)\r\n    })\r\n  }\r\n})\r\n\r\n/**\r\n * Fired when a record changes. Only works for records that have tracked changes.\r\n * See {@link Collection~changeListener} on how to listen for this event.\r\n *\r\n * @event Collection#change\r\n * @see Collection~changeListener\r\n */\r\n\r\n/**\r\n * Callback signature for the {@link Collection#event:change} event.\r\n *\r\n * @example\r\n * function onChange (record, changes) {\r\n *   // do something\r\n * }\r\n * collection.on('change', onChange);\r\n *\r\n * @callback Collection~changeListener\r\n * @param {Record} The Record that changed.\r\n * @param {object} The changes.\r\n * @see Collection#event:change\r\n * @since 3.0.0\r\n */\r\n\r\n/**\r\n * Fired when one or more records are added to the Collection. See\r\n * {@link Collection~addListener} on how to listen for this event.\r\n *\r\n * @event Collection#add\r\n * @see Collection~addListener\r\n * @see Collection#event:add\r\n * @see Collection#add\r\n */\r\n\r\n/**\r\n * Callback signature for the {@link Collection#event:add} event.\r\n *\r\n * @example\r\n * function onAdd (recordOrRecords) {\r\n *   // do something\r\n * }\r\n * collection.on('add', onAdd);\r\n *\r\n * @callback Collection~addListener\r\n * @param {Record|Record[]} The Record or Records that were added.\r\n * @see Collection#event:add\r\n * @see Collection#add\r\n * @since 3.0.0\r\n */\r\n\r\n/**\r\n * Fired when one or more records are removed from the Collection. See\r\n * {@link Collection~removeListener} for how to listen for this event.\r\n *\r\n * @event Collection#remove\r\n * @see Collection~removeListener\r\n * @see Collection#event:remove\r\n * @see Collection#remove\r\n * @see Collection#removeAll\r\n */\r\n\r\n/**\r\n * Callback signature for the {@link Collection#event:remove} event.\r\n *\r\n * @example\r\n * function onRemove (recordsOrRecords) {\r\n *   // do something\r\n * }\r\n * collection.on('remove', onRemove);\r\n *\r\n * @callback Collection~removeListener\r\n * @param {Record|Record[]} Record or Records that were removed.\r\n * @see Collection#event:remove\r\n * @see Collection#remove\r\n * @see Collection#removeAll\r\n * @since 3.0.0\r\n */\r\n\r\n/**\r\n * Create a subclass of this Collection:\r\n * @example <caption>Collection.extend</caption>\r\n * const JSData = require('js-data');\r\n * const { Collection } = JSData;\r\n * console.log('Using JSData v' + JSData.version.full);\r\n *\r\n * // Extend the class using ES2015 class syntax.\r\n * class CustomCollectionClass extends Collection {\r\n *   foo () { return 'bar'; }\r\n *   static beep () { return 'boop'; }\r\n * }\r\n * const customCollection = new CustomCollectionClass();\r\n * console.log(customCollection.foo());\r\n * console.log(CustomCollectionClass.beep());\r\n *\r\n * // Extend the class using alternate method.\r\n * const OtherCollectionClass = Collection.extend({\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * });\r\n * const otherCollection = new OtherCollectionClass();\r\n * console.log(otherCollection.foo());\r\n * console.log(OtherCollectionClass.beep());\r\n *\r\n * // Extend the class, providing a custom constructor.\r\n * function AnotherCollectionClass () {\r\n *   Collection.call(this);\r\n *   this.created_at = new Date().getTime();\r\n * }\r\n * Collection.extend({\r\n *   constructor: AnotherCollectionClass,\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * });\r\n * const anotherCollection = new AnotherCollectionClass();\r\n * console.log(anotherCollection.created_at);\r\n * console.log(anotherCollection.foo());\r\n * console.log(AnotherCollectionClass.beep());\r\n *\r\n * @method Collection.extend\r\n * @param {object} [props={}] Properties to add to the prototype of the\r\n * subclass.\r\n * @param {object} [props.constructor] Provide a custom constructor function\r\n * to be used as the subclass itself.\r\n * @param {object} [classProps={}] Static properties to add to the subclass.\r\n * @returns {Constructor} Subclass of this Collection class.\r\n * @since 3.0.0\r\n */\r\n","import utils from './utils'\r\nimport Component from './Component'\r\n\r\nconst DOMAIN = 'Schema'\r\n\r\n/**\r\n * A function map for each of the seven primitive JSON types defined by the core specification.\r\n * Each function will check a given value and return true or false if the value is an instance of that type.\r\n * ```\r\n *   types.integer(1) // returns true\r\n *   types.string({}) // returns false\r\n * ```\r\n * http://json-schema.org/latest/json-schema-core.html#anchor8\r\n * @name Schema.types\r\n * @type {object}\r\n */\r\nconst types = {\r\n  array: utils.isArray,\r\n  boolean: utils.isBoolean,\r\n  integer: utils.isInteger,\r\n  null: utils.isNull,\r\n  number: utils.isNumber,\r\n  object: utils.isObject,\r\n  string: utils.isString\r\n}\r\n\r\n/**\r\n * @ignore\r\n */\r\nconst segmentToString = function (segment, prev) {\r\n  let str = ''\r\n  if (segment) {\r\n    if (utils.isNumber(segment)) {\r\n      str += `[${segment}]`\r\n    } else if (prev) {\r\n      str += `.${segment}`\r\n    } else {\r\n      str += `${segment}`\r\n    }\r\n  }\r\n  return str\r\n}\r\n\r\n/**\r\n * @ignore\r\n */\r\nconst makePath = function (opts) {\r\n  opts || (opts = {})\r\n  let path = ''\r\n  const segments = opts.path || []\r\n  segments.forEach(function (segment) {\r\n    path += segmentToString(segment, path)\r\n  })\r\n  path += segmentToString(opts.prop, path)\r\n  return path\r\n}\r\n\r\n/**\r\n * @ignore\r\n */\r\nconst makeError = function (actual, expected, opts) {\r\n  return {\r\n    expected,\r\n    actual: '' + actual,\r\n    path: makePath(opts)\r\n  }\r\n}\r\n\r\n/**\r\n * @ignore\r\n */\r\nconst addError = function (actual, expected, opts, errors) {\r\n  errors.push(makeError(actual, expected, opts))\r\n}\r\n\r\n/**\r\n * @ignore\r\n */\r\nconst maxLengthCommon = function (keyword, value, schema, opts) {\r\n  const max = schema[keyword]\r\n  if (value.length > max) {\r\n    return makeError(value.length, `length no more than ${max}`, opts)\r\n  }\r\n}\r\n\r\n/**\r\n * @ignore\r\n */\r\nconst minLengthCommon = function (keyword, value, schema, opts) {\r\n  const min = schema[keyword]\r\n  if (value.length < min) {\r\n    return makeError(value.length, `length no less than ${min}`, opts)\r\n  }\r\n}\r\n\r\n/**\r\n * A map of all object member validation functions for each keyword defined in the JSON Schema.\r\n * @name Schema.validationKeywords\r\n * @type {object}\r\n */\r\nconst validationKeywords = {\r\n  /**\r\n   * Validates the provided value against all schemas defined in the Schemas `allOf` keyword.\r\n   * The instance is valid against if and only if it is valid against all the schemas declared in the Schema's value.\r\n   *\r\n   * The value of this keyword MUST be an array. This array MUST have at least one element.\r\n   * Each element of this array MUST be a valid JSON Schema.\r\n   *\r\n   * see http://json-schema.org/latest/json-schema-validation.html#anchor82\r\n   *\r\n   * @name Schema.validationKeywords.allOf\r\n   * @method\r\n   * @param {*} value Value to be validated.\r\n   * @param {object} schema Schema containing the `allOf` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  allOf (value, schema, opts) {\r\n    let allErrors = []\r\n    schema.allOf.forEach(function (_schema) {\r\n      allErrors = allErrors.concat(validate(value, _schema, opts) || [])\r\n    })\r\n    return allErrors.length ? allErrors : undefined\r\n  },\r\n\r\n  /**\r\n   * Validates the provided value against all schemas defined in the Schemas `anyOf` keyword.\r\n   * The instance is valid against this keyword if and only if it is valid against\r\n   * at least one of the schemas in this keyword's value.\r\n   *\r\n   * The value of this keyword MUST be an array. This array MUST have at least one element.\r\n   * Each element of this array MUST be an object, and each object MUST be a valid JSON Schema.\r\n   * see http://json-schema.org/latest/json-schema-validation.html#anchor85\r\n   *\r\n   * @name Schema.validationKeywords.anyOf\r\n   * @method\r\n   * @param {*} value Value to be validated.\r\n   * @param {object} schema Schema containing the `anyOf` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  anyOf (value, schema, opts) {\r\n    let validated = false\r\n    let allErrors = []\r\n    schema.anyOf.forEach(function (_schema) {\r\n      const errors = validate(value, _schema, opts)\r\n      if (errors) {\r\n        allErrors = allErrors.concat(errors)\r\n      } else {\r\n        validated = true\r\n      }\r\n    })\r\n    return validated ? undefined : allErrors\r\n  },\r\n\r\n  /**\r\n   * http://json-schema.org/latest/json-schema-validation.html#anchor70\r\n   *\r\n   * @name Schema.validationKeywords.dependencies\r\n   * @method\r\n   * @param {*} value TODO\r\n   * @param {object} schema TODO\r\n   * @param {object} opts TODO\r\n   */\r\n  dependencies (value, schema, opts) {\r\n    // TODO\r\n  },\r\n\r\n  /**\r\n   * Validates the provided value against an array of possible values defined by the Schema's `enum` keyword\r\n   * Validation succeeds if the value is deeply equal to one of the values in the array.\r\n   * see http://json-schema.org/latest/json-schema-validation.html#anchor76\r\n   *\r\n   * @name Schema.validationKeywords.enum\r\n   * @method\r\n   * @param {*} value Value to validate\r\n   * @param {object} schema Schema containing the `enum` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  enum (value, schema, opts) {\r\n    const possibleValues = schema.enum\r\n    if (utils.findIndex(possibleValues, (item) => utils.deepEqual(item, value)) === -1) {\r\n      return makeError(value, `one of (${possibleValues.join(', ')})`, opts)\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Validates each of the provided array values against a schema or an array of schemas defined by the Schema's `items` keyword\r\n   * see http://json-schema.org/latest/json-schema-validation.html#anchor37 for validation rules.\r\n   *\r\n   * @name Schema.validationKeywords.items\r\n   * @method\r\n   * @param {*} value Array to be validated.\r\n   * @param {object} schema Schema containing the items keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  items (value, schema, opts) {\r\n    opts || (opts = {})\r\n    // TODO: additionalItems\r\n    let items = schema.items\r\n    let errors = []\r\n    const checkingTuple = utils.isArray(items)\r\n    const length = value.length\r\n    for (var prop = 0; prop < length; prop++) {\r\n      if (checkingTuple) {\r\n        // Validating a tuple, instead of just checking each item against the\r\n        // same schema\r\n        items = schema.items[prop]\r\n      }\r\n      opts.prop = prop\r\n      errors = errors.concat(validate(value[prop], items, opts) || [])\r\n    }\r\n    return errors.length ? errors : undefined\r\n  },\r\n\r\n  /**\r\n   * Validates the provided number against a maximum value defined by the Schema's `maximum` keyword\r\n   * Validation succeeds if the value is a number, and is less than, or equal to, the value of this keyword.\r\n   * http://json-schema.org/latest/json-schema-validation.html#anchor17\r\n   *\r\n   * @name Schema.validationKeywords.maximum\r\n   * @method\r\n   * @param {*} value Number to validate against the keyword.\r\n   * @param {object} schema Schema containing the `maximum` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  maximum (value, schema, opts) {\r\n    // Must be a number\r\n    const maximum = schema.maximum\r\n    // Must be a boolean\r\n    // Depends on maximum\r\n    // default: false\r\n    const exclusiveMaximum = schema.exclusiveMaximum\r\n    if (typeof value === typeof maximum && !(exclusiveMaximum ? maximum > value : maximum >= value)) {\r\n      return exclusiveMaximum\r\n        ? makeError(value, `no more than nor equal to ${maximum}`, opts)\r\n        : makeError(value, `no more than ${maximum}`, opts)\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Validates the length of the provided array against a maximum value defined by the Schema's `maxItems` keyword.\r\n   * Validation succeeds if the length of the array is less than, or equal to the value of this keyword.\r\n   * see http://json-schema.org/latest/json-schema-validation.html#anchor42\r\n   *\r\n   * @name Schema.validationKeywords.maxItems\r\n   * @method\r\n   * @param {*} value Array to be validated.\r\n   * @param {object} schema Schema containing the `maxItems` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  maxItems (value, schema, opts) {\r\n    if (utils.isArray(value)) {\r\n      return maxLengthCommon('maxItems', value, schema, opts)\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Validates the length of the provided string against a maximum value defined in the Schema's `maxLength` keyword.\r\n   * Validation succeeds if the length of the string is less than, or equal to the value of this keyword.\r\n   * see http://json-schema.org/latest/json-schema-validation.html#anchor26\r\n   *\r\n   * @name Schema.validationKeywords.maxLength\r\n   * @method\r\n   * @param {*} value String to be validated.\r\n   * @param {object} schema Schema containing the `maxLength` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  maxLength (value, schema, opts) {\r\n    return maxLengthCommon('maxLength', value, schema, opts)\r\n  },\r\n\r\n  /**\r\n   * Validates the count of the provided object's properties against a maximum value defined in the Schema's `maxProperties` keyword.\r\n   * Validation succeeds if the object's property count is less than, or equal to the value of this keyword.\r\n   * see http://json-schema.org/latest/json-schema-validation.html#anchor54\r\n   *\r\n   * @name Schema.validationKeywords.maxProperties\r\n   * @method\r\n   * @param {*} value Object to be validated.\r\n   * @param {object} schema Schema containing the `maxProperties` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  maxProperties (value, schema, opts) {\r\n    // validate only objects\r\n    if (!utils.isObject(value)) return\r\n    const maxProperties = schema.maxProperties\r\n    const length = Object.keys(value).length\r\n    if (length > maxProperties) {\r\n      return makeError(length, `no more than ${maxProperties} properties`, opts)\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Validates the provided value against a minimum value defined by the Schema's `minimum` keyword\r\n   * Validation succeeds if the value is a number and is greater than, or equal to, the value of this keyword.\r\n   * http://json-schema.org/latest/json-schema-validation.html#anchor21\r\n   *\r\n   * @name Schema.validationKeywords.minimum\r\n   * @method\r\n   * @param {*} value Number to validate against the keyword.\r\n   * @param {object} schema Schema containing the `minimum` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  minimum (value, schema, opts) {\r\n    // Must be a number\r\n    const minimum = schema.minimum\r\n    // Must be a boolean\r\n    // Depends on minimum\r\n    // default: false\r\n    const exclusiveMinimum = schema.exclusiveMinimum\r\n    if (typeof value === typeof minimum && !(exclusiveMinimum ? value > minimum : value >= minimum)) {\r\n      return exclusiveMinimum\r\n        ? makeError(value, `no less than nor equal to ${minimum}`, opts)\r\n        : makeError(value, `no less than ${minimum}`, opts)\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Validates the length of the provided array against a minimum value defined by the Schema's `minItems` keyword.\r\n   * Validation succeeds if the length of the array is greater than, or equal to the value of this keyword.\r\n   * see http://json-schema.org/latest/json-schema-validation.html#anchor45\r\n   *\r\n   * @name Schema.validationKeywords.minItems\r\n   * @method\r\n   * @param {*} value Array to be validated.\r\n   * @param {object} schema Schema containing the `minItems` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  minItems (value, schema, opts) {\r\n    if (utils.isArray(value)) {\r\n      return minLengthCommon('minItems', value, schema, opts)\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Validates the length of the provided string against a minimum value defined in the Schema's `minLength` keyword.\r\n   * Validation succeeds if the length of the string is greater than, or equal to the value of this keyword.\r\n   * see http://json-schema.org/latest/json-schema-validation.html#anchor29\r\n   *\r\n   * @name Schema.validationKeywords.minLength\r\n   * @method\r\n   * @param {*} value String to be validated.\r\n   * @param {object} schema Schema containing the `minLength` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  minLength (value, schema, opts) {\r\n    return minLengthCommon('minLength', value, schema, opts)\r\n  },\r\n\r\n  /**\r\n   * Validates the count of the provided object's properties against a minimum value defined in the Schema's `minProperties` keyword.\r\n   * Validation succeeds if the object's property count is greater than, or equal to the value of this keyword.\r\n   * see http://json-schema.org/latest/json-schema-validation.html#anchor57\r\n   *\r\n   * @name Schema.validationKeywords.minProperties\r\n   * @method\r\n   * @param {*} value Object to be validated.\r\n   * @param {object} schema Schema containing the `minProperties` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  minProperties (value, schema, opts) {\r\n    // validate only objects\r\n    if (!utils.isObject(value)) return\r\n    const minProperties = schema.minProperties\r\n    const length = Object.keys(value).length\r\n    if (length < minProperties) {\r\n      return makeError(length, `no more than ${minProperties} properties`, opts)\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Validates the provided number is a multiple of the number defined in the Schema's `multipleOf` keyword.\r\n   * Validation succeeds if the number can be divided equally into the value of this keyword.\r\n   * see http://json-schema.org/latest/json-schema-validation.html#anchor14\r\n   *\r\n   * @name Schema.validationKeywords.multipleOf\r\n   * @method\r\n   * @param {*} value Number to be validated.\r\n   * @param {object} schema Schema containing the `multipleOf` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  multipleOf (value, schema, opts) {\r\n    const multipleOf = schema.multipleOf\r\n    if (utils.isNumber(value)) {\r\n      if ((value / multipleOf) % 1 !== 0) {\r\n        return makeError(value, `multipleOf ${multipleOf}`, opts)\r\n      }\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Validates the provided value is not valid with any of the schemas defined in the Schema's `not` keyword.\r\n   * An instance is valid against this keyword if and only if it is NOT valid against the schemas in this keyword's value.\r\n   *\r\n   * see http://json-schema.org/latest/json-schema-validation.html#anchor91\r\n   * @name Schema.validationKeywords.not\r\n   * @method\r\n   * @param {*} value to be checked.\r\n   * @param {object} schema Schema containing the not keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  not (value, schema, opts) {\r\n    if (!validate(value, schema.not, opts)) {\r\n      // TODO: better messaging\r\n      return makeError('succeeded', 'should have failed', opts)\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Validates the provided value is valid with one and only one of the schemas defined in the Schema's `oneOf` keyword.\r\n   * An instance is valid against this keyword if and only if it is valid against a single schemas in this keyword's value.\r\n   *\r\n   * see http://json-schema.org/latest/json-schema-validation.html#anchor88\r\n   * @name Schema.validationKeywords.oneOf\r\n   * @method\r\n   * @param {*} value to be checked.\r\n   * @param {object} schema Schema containing the `oneOf` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  oneOf (value, schema, opts) {\r\n    let validated = false\r\n    let allErrors = []\r\n    schema.oneOf.forEach(function (_schema) {\r\n      const errors = validate(value, _schema, opts)\r\n      if (errors) {\r\n        allErrors = allErrors.concat(errors)\r\n      } else if (validated) {\r\n        allErrors = [makeError('valid against more than one', 'valid against only one', opts)]\r\n        validated = false\r\n        return false\r\n      } else {\r\n        validated = true\r\n      }\r\n    })\r\n    return validated ? undefined : allErrors\r\n  },\r\n\r\n  /**\r\n   * Validates the provided string matches a pattern defined in the Schema's `pattern` keyword.\r\n   * Validation succeeds if the string is a match of the regex value of this keyword.\r\n   *\r\n   * see http://json-schema.org/latest/json-schema-validation.html#anchor33\r\n   * @name Schema.validationKeywords.pattern\r\n   * @method\r\n   * @param {*} value String to be validated.\r\n   * @param {object} schema Schema containing the `pattern` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  pattern (value, schema, opts) {\r\n    const pattern = schema.pattern\r\n    if (utils.isString(value) && !value.match(pattern)) {\r\n      return makeError(value, pattern, opts)\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Validates the provided object's properties against a map of values defined in the Schema's `properties` keyword.\r\n   * Validation succeeds if the object's property are valid with each of the schema's in the provided map.\r\n   * Validation also depends on the additionalProperties and or patternProperties.\r\n   *\r\n   * see http://json-schema.org/latest/json-schema-validation.html#anchor64 for more info.\r\n   *\r\n   * @name Schema.validationKeywords.properties\r\n   * @method\r\n   * @param {*} value Object to be validated.\r\n   * @param {object} schema Schema containing the `properties` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  properties (value, schema, opts) {\r\n    opts || (opts = {})\r\n\r\n    if (utils.isArray(value)) {\r\n      return\r\n    }\r\n\r\n    // Can be a boolean or an object\r\n    // Technically the default is an \"empty schema\", but here \"true\" is\r\n    // functionally the same\r\n    const additionalProperties = schema.additionalProperties === undefined ? true : schema.additionalProperties\r\n    const validated = []\r\n    // \"p\": The property set from \"properties\".\r\n    // Default is an object\r\n    const properties = schema.properties || {}\r\n    // \"pp\": The property set from \"patternProperties\".\r\n    // Default is an object\r\n    const patternProperties = schema.patternProperties || {}\r\n    let errors = []\r\n\r\n    utils.forOwn(properties, function (_schema, prop) {\r\n      opts.prop = prop\r\n      errors = errors.concat(validate(value[prop], _schema, opts) || [])\r\n      validated.push(prop)\r\n    })\r\n\r\n    const toValidate = utils.omit(value, validated)\r\n    utils.forOwn(patternProperties, function (_schema, pattern) {\r\n      utils.forOwn(toValidate, function (undef, prop) {\r\n        if (prop.match(pattern)) {\r\n          opts.prop = prop\r\n          errors = errors.concat(validate(value[prop], _schema, opts) || [])\r\n          validated.push(prop)\r\n        }\r\n      })\r\n    })\r\n    const keys = Object.keys(utils.omit(value, validated))\r\n    // If \"s\" is not empty, validation fails\r\n    if (additionalProperties === false) {\r\n      if (keys.length) {\r\n        const origProp = opts.prop\r\n        opts.prop = ''\r\n        addError(`extra fields: ${keys.join(', ')}`, 'no extra fields', opts, errors)\r\n        opts.prop = origProp\r\n      }\r\n    } else if (utils.isObject(additionalProperties)) {\r\n      // Otherwise, validate according to provided schema\r\n      keys.forEach(function (prop) {\r\n        opts.prop = prop\r\n        errors = errors.concat(validate(value[prop], additionalProperties, opts) || [])\r\n      })\r\n    }\r\n    return errors.length ? errors : undefined\r\n  },\r\n\r\n  /**\r\n   * Validates the provided object's has all properties listed in the Schema's `properties` keyword array.\r\n   * Validation succeeds if the object contains all properties provided in the array value of this keyword.\r\n   * see http://json-schema.org/latest/json-schema-validation.html#anchor61\r\n   *\r\n   * @name Schema.validationKeywords.required\r\n   * @method\r\n   * @param {*} value Object to be validated.\r\n   * @param {object} schema Schema containing the `required` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  required (value, schema, opts) {\r\n    opts || (opts = {})\r\n    const required = schema.required\r\n    const errors = []\r\n    if (!opts.existingOnly) {\r\n      required.forEach(function (prop) {\r\n        if (utils.get(value, prop) === undefined) {\r\n          const prevProp = opts.prop\r\n          opts.prop = prop\r\n          addError(undefined, 'a value', opts, errors)\r\n          opts.prop = prevProp\r\n        }\r\n      })\r\n    }\r\n    return errors.length ? errors : undefined\r\n  },\r\n\r\n  /**\r\n   * Validates the provided value's type is equal to the type, or array of types, defined in the Schema's `type` keyword.\r\n   * see http://json-schema.org/latest/json-schema-validation.html#anchor79\r\n   *\r\n   * @name Schema.validationKeywords.type\r\n   * @method\r\n   * @param {*} value Value to be validated.\r\n   * @param {object} schema Schema containing the `type` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  type (value, schema, opts) {\r\n    let type = schema.type\r\n    let validType\r\n    // Can be one of several types\r\n    if (utils.isString(type)) {\r\n      type = [type]\r\n    }\r\n    // Try to match the value against an expected type\r\n    type.forEach(function (_type) {\r\n      // TODO: throw an error if type is not defined\r\n      if (types[_type](value, schema, opts)) {\r\n        // Matched a type\r\n        validType = _type\r\n        return false\r\n      }\r\n    })\r\n    // Value did not match any expected type\r\n    if (!validType) {\r\n      return makeError(value !== undefined && value !== null ? typeof value : '' + value, `one of (${type.join(', ')})`, opts)\r\n    }\r\n    // Run keyword validators for matched type\r\n    // http://json-schema.org/latest/json-schema-validation.html#anchor12\r\n    const validator = typeGroupValidators[validType]\r\n    if (validator) {\r\n      return validator(value, schema, opts)\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Validates the provided array values are unique.\r\n   * Validation succeeds if the items in the array are unique, but only if the value of this keyword is true\r\n   * see http://json-schema.org/latest/json-schema-validation.html#anchor49\r\n   *\r\n   * @name Schema.validationKeywords.uniqueItems\r\n   * @method\r\n   * @param {*} value Array to be validated.\r\n   * @param {object} schema Schema containing the `uniqueItems` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  uniqueItems (value, schema, opts) {\r\n    if (value && value.length && schema.uniqueItems) {\r\n      const length = value.length\r\n      let item, i, j\r\n      // Check n - 1 items\r\n      for (i = length - 1; i > 0; i--) {\r\n        item = value[i]\r\n        // Only compare against unchecked items\r\n        for (j = i - 1; j >= 0; j--) {\r\n          // Found a duplicate\r\n          if (utils.deepEqual(item, value[j])) {\r\n            return makeError(item, 'no duplicates', opts)\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * @ignore\r\n */\r\nconst runOps = function (ops, value, schema, opts) {\r\n  let errors = []\r\n  ops.forEach(function (op) {\r\n    if (schema[op] !== undefined) {\r\n      errors = errors.concat(validationKeywords[op](value, schema, opts) || [])\r\n    }\r\n  })\r\n  return errors.length ? errors : undefined\r\n}\r\n\r\n/**\r\n * Validation keywords validated for any type:\r\n *\r\n * - `enum`\r\n * - `type`\r\n * - `allOf`\r\n * - `anyOf`\r\n * - `oneOf`\r\n * - `not`\r\n *\r\n * @name Schema.ANY_OPS\r\n * @type {string[]}\r\n */\r\nconst ANY_OPS = ['enum', 'type', 'allOf', 'anyOf', 'oneOf', 'not']\r\n\r\n/**\r\n * Validation keywords validated for array types:\r\n *\r\n * - `items`\r\n * - `maxItems`\r\n * - `minItems`\r\n * - `uniqueItems`\r\n *\r\n * @name Schema.ARRAY_OPS\r\n * @type {string[]}\r\n */\r\nconst ARRAY_OPS = ['items', 'maxItems', 'minItems', 'uniqueItems']\r\n\r\n/**\r\n * Validation keywords validated for numeric (number and integer) types:\r\n *\r\n * - `multipleOf`\r\n * - `maximum`\r\n * - `minimum`\r\n *\r\n * @name Schema.NUMERIC_OPS\r\n * @type {string[]}\r\n */\r\nconst NUMERIC_OPS = ['multipleOf', 'maximum', 'minimum']\r\n\r\n/**\r\n * Validation keywords validated for object types:\r\n *\r\n * - `maxProperties`\r\n * - `minProperties`\r\n * - `required`\r\n * - `properties`\r\n * - `dependencies`\r\n *\r\n * @name Schema.OBJECT_OPS\r\n * @type {string[]}\r\n */\r\nconst OBJECT_OPS = ['maxProperties', 'minProperties', 'required', 'properties', 'dependencies']\r\n\r\n/**\r\n * Validation keywords validated for string types:\r\n *\r\n * - `maxLength`\r\n * - `minLength`\r\n * - `pattern`\r\n *\r\n * @name Schema.STRING_OPS\r\n * @type {string[]}\r\n */\r\nconst STRING_OPS = ['maxLength', 'minLength', 'pattern']\r\n\r\n/**\r\n * http://json-schema.org/latest/json-schema-validation.html#anchor75\r\n * @ignore\r\n */\r\nconst validateAny = function (value, schema, opts) {\r\n  return runOps(ANY_OPS, value, schema, opts)\r\n}\r\n\r\n/**\r\n * Validates the provided value against a given Schema according to the http://json-schema.org/ v4 specification.\r\n *\r\n * @name Schema.validate\r\n * @method\r\n * @param {*} value Value to be validated.\r\n * @param {object} schema Valid Schema according to the http://json-schema.org/ v4 specification.\r\n * @param {object} [opts] Configuration options.\r\n * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n */\r\nconst validate = function (value, schema, opts) {\r\n  let errors = []\r\n  opts || (opts = {})\r\n  opts.ctx || (opts.ctx = { value, schema })\r\n  let shouldPop\r\n  const prevProp = opts.prop\r\n  if (schema === undefined) {\r\n    return\r\n  }\r\n  if (!utils.isObject(schema)) {\r\n    throw utils.err(`${DOMAIN}#validate`)(500, `Invalid schema at path: \"${opts.path}\"`)\r\n  }\r\n  if (opts.path === undefined) {\r\n    opts.path = []\r\n  }\r\n  // Track our location as we recurse\r\n  if (opts.prop !== undefined) {\r\n    shouldPop = true\r\n    opts.path.push(opts.prop)\r\n    opts.prop = undefined\r\n  }\r\n  // Validate against parent schema\r\n  if (schema.extends) {\r\n    // opts.path = path\r\n    // opts.prop = prop\r\n    if (utils.isFunction(schema.extends.validate)) {\r\n      errors = errors.concat(schema.extends.validate(value, opts) || [])\r\n    } else {\r\n      errors = errors.concat(validate(value, schema.extends, opts) || [])\r\n    }\r\n  }\r\n  if (value === undefined) {\r\n    // Check if property is required\r\n    if (schema.required === true && !opts.existingOnly) {\r\n      addError(value, 'a value', opts, errors)\r\n    }\r\n    if (shouldPop) {\r\n      opts.path.pop()\r\n      opts.prop = prevProp\r\n    }\r\n    return errors.length ? errors : undefined\r\n  }\r\n\r\n  errors = errors.concat(validateAny(value, schema, opts) || [])\r\n  if (shouldPop) {\r\n    opts.path.pop()\r\n    opts.prop = prevProp\r\n  }\r\n  return errors.length ? errors : undefined\r\n}\r\n\r\n// These strings are cached for optimal performance of the change detection\r\n// boolean - Whether a Record is changing in the current execution frame\r\nconst changingPath = 'changing'\r\n// string[] - Properties that have changed in the current execution frame\r\nconst changedPath = 'changed'\r\n// Object[] - History of change records\r\nconst changeHistoryPath = 'history'\r\n// boolean - Whether a Record is currently being instantiated\r\nconst creatingPath = 'creating'\r\n// number - The setTimeout change event id of a Record, if any\r\nconst eventIdPath = 'eventId'\r\n// boolean - Whether to skip validation for a Record's currently changing property\r\nconst noValidatePath = 'noValidate'\r\n// boolean - Whether to preserve Change History for a Record\r\nconst keepChangeHistoryPath = 'keepChangeHistory'\r\n// boolean - Whether to skip change notification for a Record's currently\r\n// changing property\r\nconst silentPath = 'silent'\r\nconst validationFailureMsg = 'validation failed'\r\n\r\n/**\r\n * A map of validation functions grouped by type.\r\n *\r\n * @name Schema.typeGroupValidators\r\n * @type {object}\r\n */\r\nconst typeGroupValidators = {\r\n  /**\r\n   * Validates the provided value against the schema using all of the validation keywords specific to instances of an array.\r\n   * The validation keywords for the type `array` are:\r\n   *```\r\n   * ['items', 'maxItems', 'minItems', 'uniqueItems']\r\n   *```\r\n   * see http://json-schema.org/latest/json-schema-validation.html#anchor25\r\n   *\r\n   * @name Schema.typeGroupValidators.array\r\n   * @method\r\n   * @param {*} value Array to be validated.\r\n   * @param {object} schema Schema containing at least one array keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  array: function (value, schema, opts) {\r\n    return runOps(ARRAY_OPS, value, schema, opts)\r\n  },\r\n\r\n  /**\r\n   * Validates the provided value against the schema using all of the validation keywords specific to instances of an integer.\r\n   * The validation keywords for the type `integer` are:\r\n   *```\r\n   * ['multipleOf', 'maximum', 'minimum']\r\n   *```\r\n   * @name Schema.typeGroupValidators.integer\r\n   * @method\r\n   * @param {*} value Number to be validated.\r\n   * @param {object} schema Schema containing at least one `integer` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  integer: function (value, schema, opts) {\r\n    // Additional validations for numerics are the same\r\n    return typeGroupValidators.numeric(value, schema, opts)\r\n  },\r\n\r\n  /**\r\n   * Validates the provided value against the schema using all of the validation keywords specific to instances of an number.\r\n   * The validation keywords for the type `number` are:\r\n   *```\r\n   * ['multipleOf', 'maximum', 'minimum']\r\n   *```\r\n   * @name Schema.typeGroupValidators.number\r\n   * @method\r\n   * @param {*} value Number to be validated.\r\n   * @param {object} schema Schema containing at least one `number` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  number: function (value, schema, opts) {\r\n    // Additional validations for numerics are the same\r\n    return typeGroupValidators.numeric(value, schema, opts)\r\n  },\r\n\r\n  /**\r\n   * Validates the provided value against the schema using all of the validation keywords specific to instances of a number or integer.\r\n   * The validation keywords for the type `numeric` are:\r\n   *```\r\n   * ['multipleOf', 'maximum', 'minimum']\r\n   *```\r\n   * See http://json-schema.org/latest/json-schema-validation.html#anchor13.\r\n   *\r\n   * @name Schema.typeGroupValidators.numeric\r\n   * @method\r\n   * @param {*} value Number to be validated.\r\n   * @param {object} schema Schema containing at least one `numeric` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  numeric: function (value, schema, opts) {\r\n    return runOps(NUMERIC_OPS, value, schema, opts)\r\n  },\r\n\r\n  /**\r\n   * Validates the provided value against the schema using all of the validation keywords specific to instances of an object.\r\n   * The validation keywords for the type `object` are:\r\n   *```\r\n   * ['maxProperties', 'minProperties', 'required', 'properties', 'dependencies']\r\n   *```\r\n   * See http://json-schema.org/latest/json-schema-validation.html#anchor53.\r\n   *\r\n   * @name Schema.typeGroupValidators.object\r\n   * @method\r\n   * @param {*} value Object to be validated.\r\n   * @param {object} schema Schema containing at least one `object` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  object: function (value, schema, opts) {\r\n    return runOps(OBJECT_OPS, value, schema, opts)\r\n  },\r\n\r\n  /**\r\n   * Validates the provided value against the schema using all of the validation keywords specific to instances of an string.\r\n   * The validation keywords for the type `string` are:\r\n   *```\r\n   * ['maxLength', 'minLength', 'pattern']\r\n   *```\r\n   * See http://json-schema.org/latest/json-schema-validation.html#anchor25.\r\n   *\r\n   * @name Schema.typeGroupValidators.string\r\n   * @method\r\n   * @param {*} value String to be validated.\r\n   * @param {object} schema Schema containing at least one `string` keyword.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  string: function (value, schema, opts) {\r\n    return runOps(STRING_OPS, value, schema, opts)\r\n  }\r\n}\r\n\r\n/**\r\n * js-data's Schema class.\r\n *\r\n * @example <caption>Schema#constructor</caption>\r\n * const JSData = require('js-data');\r\n * const { Schema } = JSData;\r\n * console.log('Using JSData v' + JSData.version.full);\r\n *\r\n * const PostSchema = new Schema({\r\n *   type: 'object',\r\n *   properties: {\r\n *     title: { type: 'string' }\r\n *   }\r\n * });\r\n * PostSchema.validate({ title: 1234 });\r\n *\r\n * @class Schema\r\n * @extends Component\r\n * @param {object} definition Schema definition according to json-schema.org\r\n */\r\nfunction Schema (definition) {\r\n  definition || (definition = {})\r\n  // TODO: schema validation\r\n  utils.fillIn(this, definition)\r\n\r\n  if (this.type === 'object') {\r\n    this.properties = this.properties || {}\r\n    utils.forOwn(this.properties, (_definition, prop) => {\r\n      if (!(_definition instanceof Schema)) {\r\n        this.properties[prop] = new Schema(_definition)\r\n      }\r\n    })\r\n  } else if (this.type === 'array' && this.items && !(this.items instanceof Schema)) {\r\n    this.items = new Schema(this.items)\r\n  }\r\n  if (this.extends && !(this.extends instanceof Schema)) {\r\n    this.extends = new Schema(this.extends)\r\n  }\r\n  ['allOf', 'anyOf', 'oneOf'].forEach((validationKeyword) => {\r\n    if (this[validationKeyword]) {\r\n      this[validationKeyword].forEach((_definition, i) => {\r\n        if (!(_definition instanceof Schema)) {\r\n          this[validationKeyword][i] = new Schema(_definition)\r\n        }\r\n      })\r\n    }\r\n  })\r\n}\r\n\r\nexport default Component.extend({\r\n  constructor: Schema,\r\n\r\n  /**\r\n   * This adds ES5 getters/setters to the target based on the \"properties\" in\r\n   * this Schema, which makes possible change tracking and validation on\r\n   * property assignment.\r\n   *\r\n   * @name Schema#apply\r\n   * @method\r\n   * @param {object} target The prototype to which to apply this schema.\r\n   */\r\n  apply (target, opts) {\r\n    opts || (opts = {})\r\n    opts.getter || (opts.getter = '_get')\r\n    opts.setter || (opts.setter = '_set')\r\n    opts.unsetter || (opts.unsetter = '_unset')\r\n    opts.track || (opts.track = this.track)\r\n    const properties = this.properties || {}\r\n    utils.forOwn(properties, (schema, prop) => {\r\n      Object.defineProperty(\r\n        target,\r\n        prop,\r\n        this.makeDescriptor(prop, schema, opts)\r\n      )\r\n    })\r\n  },\r\n\r\n  /**\r\n   * Apply default values to the target object for missing values.\r\n   *\r\n   * @name Schema#applyDefaults\r\n   * @method\r\n   * @param {object} target The target to which to apply values for missing values.\r\n   */\r\n  applyDefaults (target) {\r\n    if (!target) {\r\n      return\r\n    }\r\n    const properties = this.properties || {}\r\n    const hasSet = utils.isFunction(target.set) || utils.isFunction(target._set)\r\n    utils.forOwn(properties, function (schema, prop) {\r\n      if (Object.hasOwnProperty.call(schema, 'default') && utils.get(target, prop) === undefined) {\r\n        if (hasSet) {\r\n          target.set(prop, utils.plainCopy(schema.default), { silent: true })\r\n        } else {\r\n          utils.set(target, prop, utils.plainCopy(schema.default))\r\n        }\r\n      }\r\n      if (schema.type === 'object' && schema.properties) {\r\n        if (hasSet) {\r\n          const orig = target._get('noValidate')\r\n          target._set('noValidate', true)\r\n          utils.set(target, prop, utils.get(target, prop) || {}, { silent: true })\r\n          target._set('noValidate', orig)\r\n        } else {\r\n          utils.set(target, prop, utils.get(target, prop) || {})\r\n        }\r\n        schema.applyDefaults(utils.get(target, prop))\r\n      }\r\n    })\r\n  },\r\n\r\n  /**\r\n   * Assemble a property descriptor for tracking and validating changes to\r\n   * a property according to the given schema. This method is called when\r\n   * {@link Mapper#applySchema} is set to `true`.\r\n   *\r\n   * @name Schema#makeDescriptor\r\n   * @method\r\n   * @param {string} prop The property name.\r\n   * @param {(Schema|object)} schema The schema for the property.\r\n   * @param {object} [opts] Optional configuration.\r\n   * @param {function} [opts.getter] Custom getter function.\r\n   * @param {function} [opts.setter] Custom setter function.\r\n   * @param {function} [opts.track] Whether to track changes.\r\n   * @returns {object} A property descriptor for the given schema.\r\n   */\r\n  makeDescriptor (prop, schema, opts) {\r\n    const descriptor = {\r\n      // Better to allow configurability, but at the user's own risk\r\n      configurable: true,\r\n      // These properties are enumerable by default, but regardless of their\r\n      // enumerability, they won't be \"own\" properties of individual records\r\n      enumerable: schema.enumerable === undefined ? true : !!schema.enumerable\r\n    }\r\n    // Cache a few strings for optimal performance\r\n    const keyPath = `props.${prop}`\r\n    const previousPath = `previous.${prop}`\r\n    const getter = opts.getter\r\n    const setter = opts.setter\r\n    const unsetter = opts.unsetter\r\n    const track = utils.isBoolean(opts.track) ? opts.track : schema.track\r\n\r\n    descriptor.get = function () {\r\n      return this._get(keyPath)\r\n    }\r\n\r\n    if (utils.isFunction(schema.get)) {\r\n      const originalGet = descriptor.get\r\n      descriptor.get = function () {\r\n        return schema.get.call(this, originalGet)\r\n      }\r\n    }\r\n\r\n    descriptor.set = function (value) {\r\n      // These are accessed a lot\r\n      const _get = this[getter]\r\n      const _set = this[setter]\r\n      const _unset = this[unsetter]\r\n      // Optionally check that the new value passes validation\r\n      if (!_get(noValidatePath)) {\r\n        const errors = schema.validate(value, { path: [prop] })\r\n        if (errors) {\r\n          // Immediately throw an error, preventing the record from getting into\r\n          // an invalid state\r\n          const error = new Error(validationFailureMsg)\r\n          error.errors = errors\r\n          throw error\r\n        }\r\n      }\r\n      // TODO: Make it so tracking can be turned on for all properties instead of\r\n      // only per-property\r\n      if (track && !_get(creatingPath)) {\r\n        // previous is versioned on database commit\r\n        // props are versioned on set()\r\n        const previous = _get(previousPath)\r\n        const current = _get(keyPath)\r\n        let changing = _get(changingPath)\r\n        let changed = _get(changedPath)\r\n\r\n        if (!changing) {\r\n          // Track properties that are changing in the current event loop\r\n          changed = []\r\n        }\r\n\r\n        // Add changing properties to this array once at most\r\n        const index = changed.indexOf(prop)\r\n        if (current !== value && index === -1) {\r\n          changed.push(prop)\r\n        }\r\n        if (previous === value) {\r\n          if (index >= 0) {\r\n            changed.splice(index, 1)\r\n          }\r\n        }\r\n        // No changes in current event loop\r\n        if (!changed.length) {\r\n          changing = false\r\n          _unset(changingPath)\r\n          _unset(changedPath)\r\n          // Cancel pending change event\r\n          if (_get(eventIdPath)) {\r\n            clearTimeout(_get(eventIdPath))\r\n            _unset(eventIdPath)\r\n          }\r\n        }\r\n        // Changes detected in current event loop\r\n        if (!changing && changed.length) {\r\n          _set(changedPath, changed)\r\n          _set(changingPath, true)\r\n          // Saving the timeout id allows us to batch all changes in the same\r\n          // event loop into a single \"change\"\r\n          // TODO: Optimize\r\n          _set(eventIdPath, setTimeout(() => {\r\n            // Previous event loop where changes were gathered has ended, so\r\n            // notify any listeners of those changes and prepare for any new\r\n            // changes\r\n            _unset(changedPath)\r\n            _unset(eventIdPath)\r\n            _unset(changingPath)\r\n            // TODO: Optimize\r\n            if (!_get(silentPath)) {\r\n              let i\r\n              for (i = 0; i < changed.length; i++) {\r\n                this.emit('change:' + changed[i], this, utils.get(this, changed[i]))\r\n              }\r\n\r\n              const changes = utils.diffObjects({ [prop]: value }, { [prop]: current })\r\n\r\n              if (_get(keepChangeHistoryPath)) {\r\n                const changeRecord = utils.plainCopy(changes)\r\n                changeRecord.timestamp = new Date().getTime()\r\n                let changeHistory = _get(changeHistoryPath)\r\n                !changeHistory && _set(changeHistoryPath, (changeHistory = []))\r\n                changeHistory.push(changeRecord)\r\n              }\r\n              this.emit('change', this, changes)\r\n            }\r\n            _unset(silentPath)\r\n          }, 0))\r\n        }\r\n      }\r\n      _set(keyPath, value)\r\n      return value\r\n    }\r\n\r\n    if (utils.isFunction(schema.set)) {\r\n      const originalSet = descriptor.set\r\n      descriptor.set = function (value) {\r\n        return schema.set.call(this, value, originalSet)\r\n      }\r\n    }\r\n\r\n    return descriptor\r\n  },\r\n\r\n  /**\r\n   * Create a copy of the given value that contains only the properties defined\r\n   * in this schema.\r\n   *\r\n   * @name Schema#pick\r\n   * @method\r\n   * @param {*} value The value to copy.\r\n   * @returns {*} The copy.\r\n   */\r\n  pick (value) {\r\n    if (value === undefined) {\r\n      return\r\n    }\r\n    if (this.type === 'object') {\r\n      const copy = {}\r\n      const properties = this.properties\r\n      if (properties) {\r\n        utils.forOwn(properties, (_definition, prop) => {\r\n          copy[prop] = _definition.pick(value[prop])\r\n        })\r\n      }\r\n      if (this.extends) {\r\n        utils.fillIn(copy, this.extends.pick(value))\r\n      }\r\n      // Conditionally copy properties not defined in \"properties\"\r\n      if (this.additionalProperties) {\r\n        for (var key in value) {\r\n          if (!properties[key]) {\r\n            copy[key] = utils.plainCopy(value[key])\r\n          }\r\n        }\r\n      }\r\n      return copy\r\n    } else if (this.type === 'array') {\r\n      return value.map((item) => {\r\n        const _copy = this.items ? this.items.pick(item) : {}\r\n        if (this.extends) {\r\n          utils.fillIn(_copy, this.extends.pick(item))\r\n        }\r\n        return _copy\r\n      })\r\n    }\r\n    return utils.plainCopy(value)\r\n  },\r\n\r\n  /**\r\n   * Validate the provided value against this schema.\r\n   *\r\n   * @name Schema#validate\r\n   * @method\r\n   * @param {*} value Value to validate.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(array|undefined)} Array of errors or `undefined` if valid.\r\n   */\r\n  validate (value, opts) {\r\n    return validate(value, this, opts)\r\n  }\r\n}, {\r\n  ANY_OPS,\r\n  ARRAY_OPS,\r\n  NUMERIC_OPS,\r\n  OBJECT_OPS,\r\n  STRING_OPS,\r\n  typeGroupValidators,\r\n  types,\r\n  validate,\r\n  validationKeywords\r\n})\r\n\r\n/**\r\n * Create a subclass of this Schema:\r\n * @example <caption>Schema.extend</caption>\r\n * const JSData = require('js-data');\r\n * const { Schema } = JSData;\r\n * console.log('Using JSData v' + JSData.version.full);\r\n *\r\n * // Extend the class using ES2015 class syntax.\r\n * class CustomSchemaClass extends Schema {\r\n *   foo () { return 'bar'; }\r\n *   static beep () { return 'boop'; }\r\n * }\r\n * const customSchema = new CustomSchemaClass();\r\n * console.log(customSchema.foo());\r\n * console.log(CustomSchemaClass.beep());\r\n *\r\n * // Extend the class using alternate method.\r\n * const OtherSchemaClass = Schema.extend({\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * });\r\n * const otherSchema = new OtherSchemaClass();\r\n * console.log(otherSchema.foo());\r\n * console.log(OtherSchemaClass.beep());\r\n *\r\n * // Extend the class, providing a custom constructor.\r\n * function AnotherSchemaClass () {\r\n *   Schema.call(this);\r\n *   this.created_at = new Date().getTime();\r\n * }\r\n * Schema.extend({\r\n *   constructor: AnotherSchemaClass,\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * });\r\n * const anotherSchema = new AnotherSchemaClass();\r\n * console.log(anotherSchema.created_at);\r\n * console.log(anotherSchema.foo());\r\n * console.log(AnotherSchemaClass.beep());\r\n *\r\n * @method Schema.extend\r\n * @param {object} [props={}] Properties to add to the prototype of the\r\n * subclass.\r\n * @param {object} [props.constructor] Provide a custom constructor function\r\n * to be used as the subclass itself.\r\n * @param {object} [classProps={}] Static properties to add to the subclass.\r\n * @returns {Constructor} Subclass of this Schema class.\r\n * @since 3.0.0\r\n */\r\n","import utils from './utils'\r\nimport Component from './Component'\r\nimport Record from './Record'\r\nimport Schema from './Schema'\r\nimport { Relation } from './relations'\r\nimport {\r\n  belongsTo,\r\n  belongsToType,\r\n  hasMany,\r\n  hasManyType,\r\n  hasOne,\r\n  hasOneType\r\n} from './decorators'\r\n\r\nconst DOMAIN = 'Mapper'\r\nconst applyDefaultsHooks = [\r\n  'beforeCreate',\r\n  'beforeCreateMany'\r\n]\r\nconst validatingHooks = [\r\n  'beforeCreate',\r\n  'beforeCreateMany',\r\n  'beforeUpdate',\r\n  'beforeUpdateAll',\r\n  'beforeUpdateMany'\r\n]\r\nconst makeNotify = function (num) {\r\n  return function (...args) {\r\n    const opts = args[args.length - num]\r\n    const op = opts.op\r\n    this.dbg(op, ...args)\r\n\r\n    if (applyDefaultsHooks.indexOf(op) !== -1 && opts.applyDefaults !== false) {\r\n      const schema = this.getSchema()\r\n      if (schema && schema.applyDefaults) {\r\n        let toProcess = args[0]\r\n        if (!utils.isArray(toProcess)) {\r\n          toProcess = [toProcess]\r\n        }\r\n        toProcess.forEach((record) => {\r\n          schema.applyDefaults(record)\r\n        })\r\n      }\r\n    }\r\n\r\n    // Automatic validation\r\n    if (validatingHooks.indexOf(op) !== -1 && !opts.noValidate) {\r\n      // Save current value of option\r\n      const originalExistingOnly = opts.existingOnly\r\n\r\n      // For updates, ignore required fields if they aren't present\r\n      if (op.indexOf('beforeUpdate') === 0 && opts.existingOnly === undefined) {\r\n        opts.existingOnly = true\r\n      }\r\n      const errors = this.validate(args[op === 'beforeUpdate' ? 1 : 0], utils.pick(opts, ['existingOnly']))\r\n\r\n      // Restore option\r\n      opts.existingOnly = originalExistingOnly\r\n\r\n      // Abort lifecycle due to validation errors\r\n      if (errors) {\r\n        const err = new Error('validation failed')\r\n        err.errors = errors\r\n        return utils.reject(err)\r\n      }\r\n    }\r\n\r\n    // Emit lifecycle event\r\n    if (opts.notify || (opts.notify === undefined && this.notify)) {\r\n      setTimeout(() => {\r\n        this.emit(op, ...args)\r\n      })\r\n    }\r\n  }\r\n}\r\n\r\n// These are the default implementations of all of the lifecycle hooks\r\nconst notify = makeNotify(1)\r\nconst notify2 = makeNotify(2)\r\n\r\n// This object provides meta information used by Mapper#crud to actually\r\n// execute each lifecycle method\r\nconst LIFECYCLE_METHODS = {\r\n  count: {\r\n    defaults: [{}, {}],\r\n    skip: true,\r\n    types: []\r\n  },\r\n  destroy: {\r\n    defaults: [{}, {}],\r\n    skip: true,\r\n    types: []\r\n  },\r\n  destroyAll: {\r\n    defaults: [{}, {}],\r\n    skip: true,\r\n    types: []\r\n  },\r\n  find: {\r\n    defaults: [undefined, {}],\r\n    types: []\r\n  },\r\n  findAll: {\r\n    defaults: [{}, {}],\r\n    types: []\r\n  },\r\n  sum: {\r\n    defaults: [undefined, {}, {}],\r\n    skip: true,\r\n    types: []\r\n  },\r\n  update: {\r\n    adapterArgs (mapper, id, props, opts) {\r\n      return [id, mapper.toJSON(props, opts), opts]\r\n    },\r\n    beforeAssign: 1,\r\n    defaults: [undefined, {}, {}],\r\n    types: []\r\n  },\r\n  updateAll: {\r\n    adapterArgs (mapper, props, query, opts) {\r\n      return [mapper.toJSON(props, opts), query, opts]\r\n    },\r\n    beforeAssign: 0,\r\n    defaults: [{}, {}, {}],\r\n    types: []\r\n  },\r\n  updateMany: {\r\n    adapterArgs (mapper, records, opts) {\r\n      return [records.map((record) => mapper.toJSON(record, opts)), opts]\r\n    },\r\n    beforeAssign: 0,\r\n    defaults: [[], {}],\r\n    types: []\r\n  }\r\n}\r\n\r\nconst MAPPER_DEFAULTS = {\r\n  /**\r\n   * Hash of registered adapters. Don't modify directly. Use\r\n   * {@link Mapper#registerAdapter} instead.\r\n   *\r\n   * @default {}\r\n   * @name Mapper#_adapters\r\n   * @since 3.0.0\r\n   * @tutorial [\"http://www.js-data.io/v3.0/docs/connecting-to-a-data-source\",\"Connecting to a data source\"]\r\n   */\r\n  _adapters: {},\r\n\r\n  /**\r\n   * Whether {@link Mapper#beforeCreate} and {@link Mapper#beforeCreateMany}\r\n   * should automatically receive default values according to the Mapper's schema.\r\n   *\r\n   * @default true\r\n   * @name Mapper#applyDefaults\r\n   * @since 3.0.0\r\n   * @type {boolean}\r\n   */\r\n  applyDefaults: true,\r\n\r\n  /**\r\n   * Whether to augment {@link Mapper#recordClass} with ES5 getters and setters\r\n   * according to the properties defined in {@link Mapper#schema}. This makes\r\n   * possible validation and change tracking on individual properties\r\n   * when using the dot (e.g. `user.name = \"Bob\"`) operator to modify a\r\n   * property, and is `true` by default.\r\n   *\r\n   * @default true\r\n   * @name Mapper#applySchema\r\n   * @since 3.0.0\r\n   * @type {boolean}\r\n   */\r\n  applySchema: true,\r\n\r\n  /**\r\n   * The name of the registered adapter that this Mapper should used by default.\r\n   *\r\n   * @default \"http\"\r\n   * @name Mapper#defaultAdapter\r\n   * @since 3.0.0\r\n   * @tutorial [\"http://www.js-data.io/v3.0/docs/connecting-to-a-data-source\",\"Connecting to a data source\"]\r\n   * @type {string}\r\n   */\r\n  defaultAdapter: 'http',\r\n\r\n  /**\r\n   * The field used as the unique identifier on records handled by this Mapper.\r\n   *\r\n   * @default id\r\n   * @name Mapper#idAttribute\r\n   * @since 3.0.0\r\n   * @type {string}\r\n   */\r\n  idAttribute: 'id',\r\n\r\n  /**\r\n   * Whether records created from this mapper keep changeHistory on property changes.\r\n   *\r\n   * @default true\r\n   * @name Mapper#keepChangeHistory\r\n   * @since 3.0.0\r\n   * @type {boolean}\r\n   */\r\n  keepChangeHistory: true,\r\n\r\n  /**\r\n   * Whether this Mapper should emit operational events.\r\n   *\r\n   * @default true\r\n   * @name Mapper#notify\r\n   * @since 3.0.0\r\n   * @type {boolean}\r\n   */\r\n  notify: true,\r\n\r\n  /**\r\n   * Whether to skip validation when the Record instances are created.\r\n   *\r\n   * @default false\r\n   * @name Mapper#noValidate\r\n   * @since 3.0.0\r\n   * @type {boolean}\r\n   */\r\n  noValidate: false,\r\n\r\n  /**\r\n   * Whether {@link Mapper#create}, {@link Mapper#createMany},\r\n   * {@link Mapper#update}, {@link Mapper#updateAll}, {@link Mapper#updateMany},\r\n   * {@link Mapper#find}, {@link Mapper#findAll}, {@link Mapper#destroy},\r\n   * {@link Mapper#destroyAll}, {@link Mapper#count}, and {@link Mapper#sum}\r\n   * should return a raw result object that contains both the instance data\r\n   * returned by the adapter _and_ metadata about the operation.\r\n   *\r\n   * The default is to NOT return the result object, and instead return just the\r\n   * instance data.\r\n   *\r\n   * @default false\r\n   * @name Mapper#raw\r\n   * @since 3.0.0\r\n   * @type {boolean}\r\n   */\r\n  raw: false,\r\n\r\n  /**\r\n   * Whether records created from this mapper automatically validate their properties\r\n   * when their properties are modified.\r\n   *\r\n   * @default true\r\n   * @name Mapper#validateOnSet\r\n   * @since 3.0.0\r\n   * @type {boolean}\r\n   */\r\n  validateOnSet: true\r\n}\r\n\r\n/**\r\n * The core of JSData's [ORM/ODM][orm] implementation. Given a minimum amout of\r\n * meta information about a resource, a Mapper can perform generic CRUD\r\n * operations against that resource. Apart from its configuration, a Mapper is\r\n * stateless. The particulars of various persistence layers have been abstracted\r\n * into adapters, which a Mapper uses to perform its operations.\r\n *\r\n * The term \"Mapper\" comes from the [Data Mapper Pattern][pattern] described in\r\n * Martin Fowler's [Patterns of Enterprise Application Architecture][book]. A\r\n * Data Mapper moves data between [in-memory object instances][record] and a\r\n * relational or document-based database. JSData's Mapper can work with any\r\n * persistence layer you can write an adapter for.\r\n *\r\n * _(\"Model\" is a heavily overloaded term and is avoided in this documentation\r\n * to prevent confusion.)_\r\n *\r\n * [orm]: https://en.wikipedia.org/wiki/Object-relational_mapping\r\n *\r\n * @example\r\n * [pattern]: https://en.wikipedia.org/wiki/Data_mapper_pattern\r\n * [book]: http://martinfowler.com/books/eaa.html\r\n * [record]: Record.html\r\n * // Import and instantiate\r\n * import { Mapper } from 'js-data';\r\n * const UserMapper = new Mapper({ name: 'user' });\r\n *\r\n * @example\r\n * // Define a Mapper using the Container component\r\n * import { Container } from 'js-data';\r\n * const store = new Container();\r\n * store.defineMapper('user');\r\n *\r\n * @class Mapper\r\n * @extends Component\r\n * @param {object} opts Configuration options.\r\n * @param {boolean} [opts.applySchema=true] See {@link Mapper#applySchema}.\r\n * @param {boolean} [opts.debug=false] See {@link Component#debug}.\r\n * @param {string} [opts.defaultAdapter=http] See {@link Mapper#defaultAdapter}.\r\n * @param {string} [opts.idAttribute=id] See {@link Mapper#idAttribute}.\r\n * @param {object} [opts.methods] See {@link Mapper#methods}.\r\n * @param {string} opts.name See {@link Mapper#name}.\r\n * @param {boolean} [opts.notify] See {@link Mapper#notify}.\r\n * @param {boolean} [opts.raw=false] See {@link Mapper#raw}.\r\n * @param {Function|boolean} [opts.recordClass] See {@link Mapper#recordClass}.\r\n * @param {Object|Schema} [opts.schema] See {@link Mapper#schema}.\r\n * @returns {Mapper} A new {@link Mapper} instance.\r\n * @see http://www.js-data.io/v3.0/docs/components-of-jsdata#mapper\r\n * @since 3.0.0\r\n * @tutorial [\"http://www.js-data.io/v3.0/docs/components-of-jsdata#mapper\",\"Components of JSData: Mapper\"]\r\n * @tutorial [\"http://www.js-data.io/v3.0/docs/modeling-your-data\",\"Modeling your data\"]\r\n */\r\nfunction Mapper (opts) {\r\n  utils.classCallCheck(this, Mapper)\r\n  Component.call(this)\r\n  opts || (opts = {})\r\n\r\n  // Prepare certain properties to be non-enumerable\r\n  Object.defineProperties(this, {\r\n    _adapters: {\r\n      value: undefined,\r\n      writable: true\r\n    },\r\n\r\n    /**\r\n     * The {@link Container} that holds this Mapper. __Do not modify.__\r\n     *\r\n     * @name Mapper#lifecycleMethods\r\n     * @since 3.0.0\r\n     * @type {Object}\r\n     */\r\n    datastore: {\r\n      value: undefined,\r\n      writable: true\r\n    },\r\n\r\n    /**\r\n     * The meta information describing this Mapper's available lifecycle\r\n     * methods. __Do not modify.__\r\n     *\r\n     * @name Mapper#lifecycleMethods\r\n     * @since 3.0.0\r\n     * @type {Object}\r\n     */\r\n    lifecycleMethods: {\r\n      value: LIFECYCLE_METHODS\r\n    },\r\n\r\n    /**\r\n     * Set to `false` to force the Mapper to work with POJO objects only.\r\n     *\r\n     * @example\r\n     * // Use POJOs only.\r\n     * import { Mapper, Record } from 'js-data';\r\n     * const UserMapper = new Mapper({ recordClass: false });\r\n     * UserMapper.recordClass // false;\r\n     * const user = UserMapper.createRecord();\r\n     * user instanceof Record; // false\r\n     *\r\n     * @example\r\n     * // Set to a custom class to have records wrapped in your custom class.\r\n     * import { Mapper, Record } from 'js-data';\r\n     *  // Custom class\r\n     * class User {\r\n     *   constructor (props = {}) {\r\n     *     for (var key in props) {\r\n     *       if (props.hasOwnProperty(key)) {\r\n     *         this[key] = props[key];\r\n     *       }\r\n     *     }\r\n     *   }\r\n     * }\r\n     * const UserMapper = new Mapper({ recordClass: User });\r\n     * UserMapper.recordClass; // function User() {}\r\n     * const user = UserMapper.createRecord();\r\n     * user instanceof Record; // false\r\n     * user instanceof User; // true\r\n     *\r\n     *\r\n     * @example\r\n     * // Extend the {@link Record} class.\r\n     * import { Mapper, Record } from 'js-data';\r\n     *  // Custom class\r\n     * class User extends Record {\r\n     *   constructor () {\r\n     *     super(props);\r\n     *   }\r\n     * }\r\n     * const UserMapper = new Mapper({ recordClass: User });\r\n     * UserMapper.recordClass; // function User() {}\r\n     * const user = UserMapper.createRecord();\r\n     * user instanceof Record; // true\r\n     * user instanceof User; // true\r\n     *\r\n     * @name Mapper#recordClass\r\n     * @default {@link Record}\r\n     * @see Record\r\n     * @since 3.0.0\r\n     */\r\n    recordClass: {\r\n      value: undefined,\r\n      writable: true\r\n    },\r\n\r\n    /**\r\n     * This Mapper's {@link Schema}.\r\n     *\r\n     * @example <caption>Mapper#schema</caption>\r\n     * const JSData = require('js-data');\r\n     * const { Mapper } = JSData;\r\n     * console.log('Using JSData v' + JSData.version.full);\r\n     *\r\n     * const UserMapper = new Mapper({\r\n     *   name: 'user',\r\n     *   schema: {\r\n     *     properties: {\r\n     *       id: { type: 'number' },\r\n     *       first: { type: 'string', track: true },\r\n     *       last: { type: 'string', track: true },\r\n     *       role: { type: 'string', track: true, required: true },\r\n     *       age: { type: 'integer', track: true },\r\n     *       is_active: { type: 'number' }\r\n     *     }\r\n     *   }\r\n     * });\r\n     * const user = UserMapper.createRecord({\r\n     *   id: 1,\r\n     *   name: 'John',\r\n     *   role: 'admin'\r\n     * });\r\n     * user.on('change', function (user, changes) {\r\n     *   console.log(changes);\r\n     * });\r\n     * user.on('change:role', function (user, value) {\r\n     *   console.log('change:role - ' + value);\r\n     * });\r\n     * user.role = 'owner';\r\n     *\r\n     * @name Mapper#schema\r\n     * @see Schema\r\n     * @since 3.0.0\r\n     * @type {Schema}\r\n     */\r\n    schema: {\r\n      value: undefined,\r\n      writable: true\r\n    }\r\n  })\r\n\r\n  // Apply user-provided configuration\r\n  utils.fillIn(this, opts)\r\n  // Fill in any missing options with the defaults\r\n  utils.fillIn(this, utils.copy(MAPPER_DEFAULTS))\r\n\r\n  /**\r\n   * The name for this Mapper. This is the minimum amount of meta information\r\n   * required for a Mapper to be able to execute CRUD operations for a\r\n   * Resource.\r\n   *\r\n   * @name Mapper#name\r\n   * @since 3.0.0\r\n   * @type {string}\r\n   */\r\n  if (!this.name) {\r\n    throw utils.err(`new ${DOMAIN}`, 'opts.name')(400, 'string', this.name)\r\n  }\r\n\r\n  // Setup schema, with an empty default schema if necessary\r\n  if (this.schema) {\r\n    this.schema.type || (this.schema.type = 'object')\r\n    if (!(this.schema instanceof Schema)) {\r\n      this.schema = new Schema(this.schema || { type: 'object' })\r\n    }\r\n  }\r\n\r\n  // Create a subclass of Record that's tied to this Mapper\r\n  if (this.recordClass === undefined) {\r\n    const superClass = Record\r\n    this.recordClass = superClass.extend({\r\n      constructor: (function Record () {\r\n        var subClass = function Record (props, opts) {\r\n          utils.classCallCheck(this, subClass)\r\n          superClass.call(this, props, opts)\r\n        }\r\n        return subClass\r\n      })()\r\n    })\r\n  }\r\n\r\n  if (this.recordClass) {\r\n    this.recordClass.mapper = this\r\n\r\n    /**\r\n     * Functions that should be added to the prototype of {@link Mapper#recordClass}.\r\n     *\r\n     * @name Mapper#methods\r\n     * @since 3.0.0\r\n     * @type {Object}\r\n     */\r\n    if (utils.isObject(this.methods)) {\r\n      utils.addHiddenPropsToTarget(this.recordClass.prototype, this.methods)\r\n    }\r\n\r\n    // We can only apply the schema to the prototype of this.recordClass if the\r\n    // class extends Record\r\n    if (Object.isPrototypeOf.call(Record, this.recordClass) && this.schema && this.schema.apply && this.applySchema) {\r\n      this.schema.apply(this.recordClass.prototype)\r\n    }\r\n  }\r\n}\r\n\r\nexport default Component.extend({\r\n  constructor: Mapper,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#count}. If this method\r\n   * returns a promise then {@link Mapper#count} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#afterCount\r\n   * @param {object} query The `query` argument passed to {@link Mapper#count}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#count}.\r\n   * @param {*} result The result, if any.\r\n   * @since 3.0.0\r\n   */\r\n  afterCount: notify2,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#create}. If this method\r\n   * returns a promise then {@link Mapper#create} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#afterCreate\r\n   * @param {object} props The `props` argument passed to {@link Mapper#create}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#create}.\r\n   * @param {*} result The result, if any.\r\n   * @since 3.0.0\r\n   */\r\n  afterCreate: notify2,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#createMany}. If this method\r\n   * returns a promise then {@link Mapper#createMany} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#afterCreateMany\r\n   * @param {array} records The `records` argument passed to {@link Mapper#createMany}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#createMany}.\r\n   * @param {*} result The result, if any.\r\n   * @since 3.0.0\r\n   */\r\n  afterCreateMany: notify2,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#destroy}. If this method\r\n   * returns a promise then {@link Mapper#destroy} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#afterDestroy\r\n   * @param {(string|number)} id The `id` argument passed to {@link Mapper#destroy}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#destroy}.\r\n   * @param {*} result The result, if any.\r\n   * @since 3.0.0\r\n   */\r\n  afterDestroy: notify2,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#destroyAll}. If this method\r\n   * returns a promise then {@link Mapper#destroyAll} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#afterDestroyAll\r\n   * @param {*} data The `data` returned by the adapter.\r\n   * @param {query} query The `query` argument passed to {@link Mapper#destroyAll}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#destroyAll}.\r\n   * @param {*} result The result, if any.\r\n   * @since 3.0.0\r\n   */\r\n  afterDestroyAll: notify2,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#find}. If this method\r\n   * returns a promise then {@link Mapper#find} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#afterFind\r\n   * @param {(string|number)} id The `id` argument passed to {@link Mapper#find}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#find}.\r\n   * @param {*} result The result, if any.\r\n   * @since 3.0.0\r\n   */\r\n  afterFind: notify2,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#findAll}. If this method\r\n   * returns a promise then {@link Mapper#findAll} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#afterFindAll\r\n   * @param {object} query The `query` argument passed to {@link Mapper#findAll}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#findAll}.\r\n   * @param {*} result The result, if any.\r\n   * @since 3.0.0\r\n   */\r\n  afterFindAll: notify2,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#sum}. If this method\r\n   * returns a promise then {@link Mapper#sum} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#afterSum\r\n   * @param {object} query The `query` argument passed to {@link Mapper#sum}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#sum}.\r\n   * @param {*} result The result, if any.\r\n   * @since 3.0.0\r\n   */\r\n  afterSum: notify2,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#update}. If this method\r\n   * returns a promise then {@link Mapper#update} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#afterUpdate\r\n   * @param {(string|number)} id The `id` argument passed to {@link Mapper#update}.\r\n   * @param {props} props The `props` argument passed to {@link Mapper#update}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#update}.\r\n   * @param {*} result The result, if any.\r\n   * @since 3.0.0\r\n   */\r\n  afterUpdate: notify2,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#updateAll}. If this method\r\n   * returns a promise then {@link Mapper#updateAll} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#afterUpdateAll\r\n   * @param {object} props The `props` argument passed to {@link Mapper#updateAll}.\r\n   * @param {object} query The `query` argument passed to {@link Mapper#updateAll}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#updateAll}.\r\n   * @param {*} result The result, if any.\r\n   * @since 3.0.0\r\n   */\r\n  afterUpdateAll: notify2,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#updateMany}. If this method\r\n   * returns a promise then {@link Mapper#updateMany} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#afterUpdateMany\r\n   * @param {array} records The `records` argument passed to {@link Mapper#updateMany}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#updateMany}.\r\n   * @param {*} result The result, if any.\r\n   * @since 3.0.0\r\n   */\r\n  afterUpdateMany: notify2,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#create}. If this method\r\n   * returns a promise then {@link Mapper#create} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#beforeCreate\r\n   * @param {object} props The `props` argument passed to {@link Mapper#create}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#create}.\r\n   * @since 3.0.0\r\n   */\r\n  beforeCreate: notify,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#createMany}. If this method\r\n   * returns a promise then {@link Mapper#createMany} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#beforeCreateMany\r\n   * @param {array} records The `records` argument passed to {@link Mapper#createMany}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#createMany}.\r\n   * @since 3.0.0\r\n   */\r\n  beforeCreateMany: notify,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#count}. If this method\r\n   * returns a promise then {@link Mapper#count} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#beforeCount\r\n   * @param {object} query The `query` argument passed to {@link Mapper#count}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#count}.\r\n   * @since 3.0.0\r\n   */\r\n  beforeCount: notify,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#destroy}. If this method\r\n   * returns a promise then {@link Mapper#destroy} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#beforeDestroy\r\n   * @param {(string|number)} id The `id` argument passed to {@link Mapper#destroy}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#destroy}.\r\n   * @since 3.0.0\r\n   */\r\n  beforeDestroy: notify,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#destroyAll}. If this method\r\n   * returns a promise then {@link Mapper#destroyAll} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#beforeDestroyAll\r\n   * @param {query} query The `query` argument passed to {@link Mapper#destroyAll}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#destroyAll}.\r\n   * @since 3.0.0\r\n   */\r\n  beforeDestroyAll: notify,\r\n\r\n  /**\r\n   * Mappers lifecycle hook called by {@link Mapper#find}. If this method\r\n   * returns a promise then {@link Mapper#find} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#beforeFind\r\n   * @param {(string|number)} id The `id` argument passed to {@link Mapper#find}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#find}.\r\n   * @since 3.0.0\r\n   */\r\n  beforeFind: notify,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#findAll}. If this method\r\n   * returns a promise then {@link Mapper#findAll} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#beforeFindAll\r\n   * @param {object} query The `query` argument passed to {@link Mapper#findAll}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#findAll}.\r\n   * @since 3.0.0\r\n   */\r\n  beforeFindAll: notify,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#sum}. If this method\r\n   * returns a promise then {@link Mapper#sum} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#beforeSum\r\n   * @param {string} field The `field` argument passed to {@link Mapper#sum}.\r\n   * @param {object} query The `query` argument passed to {@link Mapper#sum}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#sum}.\r\n   * @since 3.0.0\r\n   */\r\n  beforeSum: notify,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#update}. If this method\r\n   * returns a promise then {@link Mapper#update} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#beforeUpdate\r\n   * @param {(string|number)} id The `id` argument passed to {@link Mapper#update}.\r\n   * @param {props} props The `props` argument passed to {@link Mapper#update}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#update}.\r\n   * @since 3.0.0\r\n   */\r\n  beforeUpdate: notify,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#updateAll}. If this method\r\n   * returns a promise then {@link Mapper#updateAll} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#beforeUpdateAll\r\n   * @param {object} props The `props` argument passed to {@link Mapper#updateAll}.\r\n   * @param {object} query The `query` argument passed to {@link Mapper#updateAll}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#updateAll}.\r\n   * @since 3.0.0\r\n   */\r\n  beforeUpdateAll: notify,\r\n\r\n  /**\r\n   * Mapper lifecycle hook called by {@link Mapper#updateMany}. If this method\r\n   * returns a promise then {@link Mapper#updateMany} will wait for the promise\r\n   * to resolve before continuing.\r\n   *\r\n   * @method Mapper#beforeUpdateMany\r\n   * @param {array} records The `records` argument passed to {@link Mapper#updateMany}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#updateMany}.\r\n   * @since 3.0.0\r\n   */\r\n  beforeUpdateMany: notify,\r\n\r\n  /**\r\n   * This method is called at the end of most lifecycle methods. It does the\r\n   * following:\r\n   *\r\n   * 1. If `opts.raw` is `true`, add this Mapper's configuration to the `opts`\r\n   * argument as metadata for the operation.\r\n   * 2. Wrap the result data appropriately using {@link Mapper#wrap}, which\r\n   * calls {@link Mapper#createRecord}.\r\n   *\r\n   * @method Mapper#_end\r\n   * @private\r\n   * @since 3.0.0\r\n   */\r\n  _end (result, opts, skip) {\r\n    if (opts.raw) {\r\n      utils._(result, opts)\r\n    }\r\n    if (skip) {\r\n      return result\r\n    }\r\n    let _data = opts.raw ? result.data : result\r\n    if (_data && utils.isFunction(this.wrap)) {\r\n      _data = this.wrap(_data, opts)\r\n      if (opts.raw) {\r\n        result.data = _data\r\n      } else {\r\n        result = _data\r\n      }\r\n    }\r\n    return result\r\n  },\r\n\r\n  /**\r\n   * Define a belongsTo relationship. Only useful if you're managing your\r\n   * Mappers manually and not using a Container or DataStore component.\r\n   *\r\n   * @example\r\n   * PostMapper.belongsTo(UserMapper, {\r\n   *   // post.user_id points to user.id\r\n   *   foreignKey: 'user_id'\r\n   *   // user records will be attached to post records at \"post.user\"\r\n   *   localField: 'user'\r\n   * });\r\n   *\r\n   * CommentMapper.belongsTo(UserMapper, {\r\n   *   // comment.user_id points to user.id\r\n   *   foreignKey: 'user_id'\r\n   *   // user records will be attached to comment records at \"comment.user\"\r\n   *   localField: 'user'\r\n   * });\r\n   * CommentMapper.belongsTo(PostMapper, {\r\n   *   // comment.post_id points to post.id\r\n   *   foreignKey: 'post_id'\r\n   *   // post records will be attached to comment records at \"comment.post\"\r\n   *   localField: 'post'\r\n   * });\r\n   *\r\n   * @method Mapper#belongsTo\r\n   * @see http://www.js-data.io/v3.0/docs/relations\r\n   * @since 3.0.0\r\n   */\r\n  belongsTo (relatedMapper, opts) {\r\n    return belongsTo(relatedMapper, opts)(this)\r\n  },\r\n\r\n  /**\r\n   * Select records according to the `query` argument and return the count.\r\n   *\r\n   * {@link Mapper#beforeCount} will be called before calling the adapter.\r\n   * {@link Mapper#afterCount} will be called after calling the adapter.\r\n   *\r\n   * @example\r\n   * // Get the number of published blog posts\r\n   * PostMapper.count({ status: 'published' }).then((numPublished) => {\r\n   *   console.log(numPublished); // e.g. 45\r\n   * });\r\n   *\r\n   * @method Mapper#count\r\n   * @param {object} [query={}] Selection query. See {@link query}.\r\n   * @param {object} [query.where] See {@link query.where}.\r\n   * @param {number} [query.offset] See {@link query.offset}.\r\n   * @param {number} [query.limit] See {@link query.limit}.\r\n   * @param {string|Array[]} [query.orderBy] See {@link query.orderBy}.\r\n   * @param {object} [opts] Configuration options. Refer to the `count` method\r\n   * of whatever adapter you're using for more configuration options.\r\n   * @param {boolean} [opts.adapter={@link Mapper#defaultAdapter}] Name of the\r\n   * adapter to use.\r\n   * @param {boolean} [opts.notify={@link Mapper#notify}] See {@link Mapper#notify}.\r\n   * @param {boolean} [opts.raw={@link Mapper#raw}] See {@link Mapper#raw}.\r\n   * @returns {Promise} Resolves with the count of the selected records.\r\n   * @since 3.0.0\r\n   */\r\n  count (query, opts) {\r\n    return this.crud('count', query, opts)\r\n  },\r\n\r\n  /**\r\n   * Fired during {@link Mapper#create}. See\r\n   * {@link Mapper~beforeCreateListener} for how to listen for this event.\r\n   *\r\n   * @event Mapper#beforeCreate\r\n   * @see Mapper~beforeCreateListener\r\n   * @see Mapper#create\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Mapper#event:beforeCreate} event.\r\n   *\r\n   * @example\r\n   * function onBeforeCreate (props, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeCreate', onBeforeCreate);\r\n   *\r\n   * @callback Mapper~beforeCreateListener\r\n   * @param {object} props The `props` argument passed to {@link Mapper#beforeCreate}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#beforeCreate}.\r\n   * @see Mapper#event:beforeCreate\r\n   * @see Mapper#create\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link Mapper#create}. See\r\n   * {@link Mapper~afterCreateListener} for how to listen for this event.\r\n   *\r\n   * @event Mapper#afterCreate\r\n   * @see Mapper~afterCreateListener\r\n   * @see Mapper#create\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Mapper#event:afterCreate} event.\r\n   *\r\n   * @example\r\n   * function onAfterCreate (props, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterCreate', onAfterCreate);\r\n   *\r\n   * @callback Mapper~afterCreateListener\r\n   * @param {object} props The `props` argument passed to {@link Mapper#afterCreate}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#afterCreate}.\r\n   * @param {object} result The `result` argument passed to {@link Mapper#afterCreate}.\r\n   * @see Mapper#event:afterCreate\r\n   * @see Mapper#create\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Create and save a new the record using the provided `props`.\r\n   *\r\n   * {@link Mapper#beforeCreate} will be called before calling the adapter.\r\n   * {@link Mapper#afterCreate} will be called after calling the adapter.\r\n   *\r\n   * @example\r\n   * // Create and save a new blog post\r\n   * PostMapper.create({\r\n   *   title: 'Modeling your data',\r\n   *   status: 'draft'\r\n   * }).then((post) => {\r\n   *   console.log(post); // { id: 1234, status: 'draft', ... }\r\n   * });\r\n   *\r\n   * @fires Mapper#beforeCreate\r\n   * @fires Mapper#afterCreate\r\n   * @method Mapper#create\r\n   * @param {object} props The properties for the new record.\r\n   * @param {object} [opts] Configuration options. Refer to the `create` method\r\n   * of whatever adapter you're using for more configuration options.\r\n   * @param {boolean} [opts.adapter={@link Mapper#defaultAdapter}] Name of the\r\n   * adapter to use.\r\n   * @param {boolean} [opts.noValidate={@link Mapper#noValidate}] See {@link Mapper#noValidate}.\r\n   * @param {boolean} [opts.notify={@link Mapper#notify}] See {@link Mapper#notify}.\r\n   * @param {boolean} [opts.raw={@link Mapper#raw}] See {@link Mapper#raw}.\r\n   * @param {string[]} [opts.with=[]] Relations to create in a cascading\r\n   * create if `props` contains nested relations. NOT performed in a\r\n   * transaction. Each nested create will result in another {@link Mapper#create}\r\n   * or {@link Mapper#createMany} call.\r\n   * @param {string[]} [opts.pass=[]] Relations to send to the adapter as part\r\n   * of the payload. Normally relations are not sent.\r\n   * @returns {Promise} Resolves with the created record.\r\n   * @since 3.0.0\r\n   */\r\n  create (props, opts) {\r\n    // Default values for arguments\r\n    props || (props = {})\r\n    opts || (opts = {})\r\n    const originalRecord = props\r\n    let parentRelationMap = {}\r\n    let adapterResponse = {}\r\n\r\n    // Fill in \"opts\" with the Mapper's configuration\r\n    utils._(opts, this)\r\n    opts.adapter = this.getAdapterName(opts)\r\n\r\n    opts.op = 'beforeCreate'\r\n    return this._runHook(opts.op, props, opts).then((props) => {\r\n      opts.with || (opts.with = [])\r\n      return this._createParentRecordIfRequired(props, opts)\r\n    }).then((relationMap) => {\r\n      parentRelationMap = relationMap\r\n    }).then(() => {\r\n      opts.op = 'create'\r\n      return this._invokeAdapterMethod(opts.op, props, opts)\r\n    }).then((result) => {\r\n      adapterResponse = result\r\n    }).then(() => {\r\n      const createdProps = opts.raw ? adapterResponse.data : adapterResponse\r\n\r\n      return this._createOrAssignChildRecordIfRequired(createdProps, {\r\n        opts,\r\n        parentRelationMap,\r\n        originalProps: props\r\n      })\r\n    }).then((createdProps) => {\r\n      return this._commitChanges(originalRecord, createdProps)\r\n    }).then((record) => {\r\n      if (opts.raw) {\r\n        adapterResponse.data = record\r\n      } else {\r\n        adapterResponse = record\r\n      }\r\n      const result = this._end(adapterResponse, opts)\r\n      opts.op = 'afterCreate'\r\n      return this._runHook(opts.op, props, opts, result)\r\n    })\r\n  },\r\n\r\n  _commitChanges (recordOrRecords, newValues) {\r\n    if (utils.isArray(recordOrRecords)) {\r\n      return recordOrRecords.map((record, i) => this._commitChanges(record, newValues[i]))\r\n    }\r\n\r\n    utils.set(recordOrRecords, newValues, { silent: true })\r\n\r\n    if (utils.isFunction(recordOrRecords.commit)) {\r\n      recordOrRecords.commit()\r\n    }\r\n\r\n    return recordOrRecords\r\n  },\r\n\r\n  /**\r\n   * Use {@link Mapper#createRecord} instead.\r\n   * @deprecated\r\n   * @method Mapper#createInstance\r\n   * @param {Object|Array} props See {@link Mapper#createRecord}.\r\n   * @param {object} [opts] See {@link Mapper#createRecord}.\r\n   * @returns {Object|Array} See {@link Mapper#createRecord}.\r\n   * @see Mapper#createRecord\r\n   * @since 3.0.0\r\n   */\r\n  createInstance (props, opts) {\r\n    return this.createRecord(props, opts)\r\n  },\r\n\r\n  /**\r\n   * Creates parent record for relation types like BelongsTo or HasMany with localKeys\r\n   * in order to satisfy foreignKey dependency (so called child records).\r\n   * @param {object} props See {@link Mapper#create}.\r\n   * @param {object} opts See {@link Mapper#create}.\r\n   * @returns {Object} cached parent records map\r\n   * @see Mapper#create\r\n   * @since 3.0.0\r\n   */\r\n  _createParentRecordIfRequired (props, opts) {\r\n    const tasks = []\r\n    const relations = []\r\n\r\n    utils.forEachRelation(this, opts, (def, optsCopy) => {\r\n      if (!def.isRequiresParentId() || !def.getLocalField(props)) {\r\n        return\r\n      }\r\n\r\n      optsCopy.raw = false\r\n      relations.push(def)\r\n      tasks.push(def.createParentRecord(props, optsCopy))\r\n    })\r\n\r\n    return utils.Promise.all(tasks).then(records => {\r\n      return relations.reduce((map, relation, index) => {\r\n        relation.setLocalField(map, records[index])\r\n        return map\r\n      }, {})\r\n    })\r\n  },\r\n\r\n  /**\r\n   * Creates child record for relation types like HasOne or HasMany with foreignKey\r\n   * in order to satisfy foreignKey dependency (so called parent records).\r\n   * @param {object} props See {@link Mapper#create}.\r\n   * @param {object} context contains collected information.\r\n   * @param {object} context.opts See {@link Mapper#create}.\r\n   * @param {object} context.parentRelationMap contains parent records map\r\n   * @param {object} context.originalProps contains data passed into {@link Mapper#create} method\r\n   * @return {Promise} updated props\r\n   * @see Mapper#create\r\n   * @since 3.0.0\r\n   */\r\n  _createOrAssignChildRecordIfRequired (props, context) {\r\n    const tasks = []\r\n\r\n    utils.forEachRelation(this, context.opts, (def, optsCopy) => {\r\n      const relationData = def.getLocalField(context.originalProps)\r\n\r\n      if (!relationData) {\r\n        return\r\n      }\r\n\r\n      optsCopy.raw = false\r\n      // Create hasMany and hasOne after the main create because we needed\r\n      // a generated id to attach to these items\r\n      if (def.isRequiresChildId()) {\r\n        tasks.push(def.createChildRecord(props, relationData, optsCopy))\r\n      } else if (def.isRequiresParentId()) {\r\n        const parent = def.getLocalField(context.parentRelationMap)\r\n\r\n        if (parent) {\r\n          def.setLocalField(props, parent)\r\n        }\r\n      }\r\n    })\r\n\r\n    return utils.Promise.all(tasks)\r\n      .then(() => props)\r\n  },\r\n\r\n  /**\r\n   * Fired during {@link Mapper#createMany}. See\r\n   * {@link Mapper~beforeCreateManyListener} for how to listen for this event.\r\n   *\r\n   * @event Mapper#beforeCreateMany\r\n   * @see Mapper~beforeCreateManyListener\r\n   * @see Mapper#createMany\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Mapper#event:beforeCreateMany} event.\r\n   *\r\n   * @example\r\n   * function onBeforeCreateMany (records, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeCreateMany', onBeforeCreateMany);\r\n   *\r\n   * @callback Mapper~beforeCreateManyListener\r\n   * @param {object} records The `records` argument received by {@link Mapper#beforeCreateMany}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeCreateMany}.\r\n   * @see Mapper#event:beforeCreateMany\r\n   * @see Mapper#createMany\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link Mapper#createMany}. See\r\n   * {@link Mapper~afterCreateManyListener} for how to listen for this event.\r\n   *\r\n   * @event Mapper#afterCreateMany\r\n   * @see Mapper~afterCreateManyListener\r\n   * @see Mapper#createMany\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Mapper#event:afterCreateMany} event.\r\n   *\r\n   * @example\r\n   * function onAfterCreateMany (records, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterCreateMany', onAfterCreateMany);\r\n   *\r\n   * @callback Mapper~afterCreateManyListener\r\n   * @param {object} records The `records` argument received by {@link Mapper#afterCreateMany}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterCreateMany}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterCreateMany}.\r\n   * @see Mapper#event:afterCreateMany\r\n   * @see Mapper#createMany\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Given an array of records, batch create them via an adapter.\r\n   *\r\n   * {@link Mapper#beforeCreateMany} will be called before calling the adapter.\r\n   * {@link Mapper#afterCreateMany} will be called after calling the adapter.\r\n   *\r\n   * @example\r\n   * // Create and save several new blog posts\r\n   * PostMapper.createMany([{\r\n   *   title: 'Modeling your data',\r\n   *   status: 'draft'\r\n   * }, {\r\n   *   title: 'Reading data',\r\n   *   status: 'draft'\r\n   * }]).then((posts) => {\r\n   *   console.log(posts[0]); // { id: 1234, status: 'draft', ... }\r\n   *   console.log(posts[1]); // { id: 1235, status: 'draft', ... }\r\n   * });\r\n   *\r\n   * @fires Mapper#beforeCreate\r\n   * @fires Mapper#afterCreate\r\n   * @method Mapper#createMany\r\n   * @param {Record[]} records Array of records to be created in one batch.\r\n   * @param {object} [opts] Configuration options. Refer to the `createMany`\r\n   * method of whatever adapter you're using for more configuration options.\r\n   * @param {boolean} [opts.adapter={@link Mapper#defaultAdapter}] Name of the\r\n   * adapter to use.\r\n   * @param {boolean} [opts.noValidate={@link Mapper#noValidate}] See {@link Mapper#noValidate}.\r\n   * @param {boolean} [opts.notify={@link Mapper#notify}] See {@link Mapper#notify}.\r\n   * @param {boolean} [opts.raw={@link Mapper#raw}] See {@link Mapper#raw}.\r\n   * @param {string[]} [opts.with=[]] Relations to create in a cascading\r\n   * create if `records` contains nested relations. NOT performed in a\r\n   * transaction. Each nested create will result in another {@link Mapper#createMany}\r\n   * call.\r\n   * @param {string[]} [opts.pass=[]] Relations to send to the adapter as part\r\n   * of the payload. Normally relations are not sent.\r\n   * @returns {Promise} Resolves with the created records.\r\n   * @since 3.0.0\r\n   * @tutorial [\"http://www.js-data.io/v3.0/docs/saving-data\",\"Saving data\"]\r\n   */\r\n  createMany (records, opts) {\r\n    // Default values for arguments\r\n    records || (records = [])\r\n    opts || (opts = {})\r\n    const originalRecords = records\r\n    let adapterResponse\r\n\r\n    // Fill in \"opts\" with the Mapper's configuration\r\n    utils._(opts, this)\r\n    opts.adapter = this.getAdapterName(opts)\r\n\r\n    // beforeCreateMany lifecycle hook\r\n    opts.op = 'beforeCreateMany'\r\n    return this._runHook(opts.op, records, opts).then((records) => {\r\n      // Deep pre-create belongsTo relations\r\n      const belongsToRelationData = {}\r\n      opts.with || (opts.with = [])\r\n      let tasks = []\r\n      utils.forEachRelation(this, opts, (def, optsCopy) => {\r\n        const relationData = records\r\n          .map((record) => def.getLocalField(record))\r\n          .filter(Boolean)\r\n        if (def.type === belongsToType && relationData.length === records.length) {\r\n          // Create belongsTo relation first because we need a generated id to\r\n          // attach to the child\r\n          optsCopy.raw = false\r\n          tasks.push(def.createLinked(relationData, optsCopy).then((relatedRecords) => {\r\n            records.forEach((record, i) => def.setForeignKey(record, relatedRecords[i]))\r\n          }).then((relatedRecords) => {\r\n            def.setLocalField(belongsToRelationData, relatedRecords)\r\n          }))\r\n        }\r\n      })\r\n      return utils.Promise.all(tasks).then(() => {\r\n        opts.op = 'createMany'\r\n        return this._invokeAdapterMethod(opts.op, records, opts)\r\n      }).then((result) => {\r\n        adapterResponse = result\r\n      }).then(() => {\r\n        const createdRecordsData = opts.raw ? adapterResponse.data : adapterResponse\r\n\r\n        // Deep post-create hasOne relations\r\n        tasks = []\r\n        utils.forEachRelation(this, opts, (def, optsCopy) => {\r\n          const relationData = records\r\n            .map((record) => def.getLocalField(record))\r\n            .filter(Boolean)\r\n          if (relationData.length !== records.length) {\r\n            return\r\n          }\r\n\r\n          optsCopy.raw = false\r\n          const belongsToData = def.getLocalField(belongsToRelationData)\r\n          let task\r\n          // Create hasMany and hasOne after the main create because we needed\r\n          // a generated id to attach to these items\r\n          if (def.type === hasManyType) {\r\n            // Not supported\r\n            this.log('warn', 'deep createMany of hasMany type not supported!')\r\n          } else if (def.type === hasOneType) {\r\n            createdRecordsData.forEach((createdRecordData, i) => {\r\n              def.setForeignKey(createdRecordData, relationData[i])\r\n            })\r\n            task = def.getRelation().createMany(relationData, optsCopy).then((relatedData) => {\r\n              createdRecordsData.forEach((createdRecordData, i) => {\r\n                def.setLocalField(createdRecordData, relatedData[i])\r\n              })\r\n            })\r\n          } else if (def.type === belongsToType && belongsToData && belongsToData.length === createdRecordsData.length) {\r\n            createdRecordsData.forEach((createdRecordData, i) => {\r\n              def.setLocalField(createdRecordData, belongsToData[i])\r\n            })\r\n          }\r\n          if (task) {\r\n            tasks.push(task)\r\n          }\r\n        })\r\n        return utils.Promise.all(tasks).then(() => {\r\n          return this._commitChanges(originalRecords, createdRecordsData)\r\n        })\r\n      })\r\n    }).then((records) => {\r\n      if (opts.raw) {\r\n        adapterResponse.data = records\r\n      } else {\r\n        adapterResponse = records\r\n      }\r\n      const result = this._end(adapterResponse, opts)\r\n      opts.op = 'afterCreateMany'\r\n      return this._runHook(opts.op, records, opts, result)\r\n    })\r\n  },\r\n\r\n  /**\r\n   * Create an unsaved, uncached instance of this Mapper's\r\n   * {@link Mapper#recordClass}.\r\n   *\r\n   * Returns `props` if `props` is already an instance of\r\n   * {@link Mapper#recordClass}.\r\n   *\r\n   * __Note:__ This method does __not__ interact with any adapter, and does\r\n   * __not__ save any data. It only creates new objects in memory.\r\n   *\r\n   * @example\r\n   * // Create empty unsaved record instance\r\n   * const post = PostMapper.createRecord();\r\n   *\r\n   * @example\r\n   * // Create an unsaved record instance with inital properties\r\n   * const post = PostMapper.createRecord({\r\n   *   title: 'Modeling your data',\r\n   *   status: 'draft'\r\n   * });\r\n   *\r\n   * @example\r\n   * // Create a record instance that corresponds to a saved record\r\n   * const post = PostMapper.createRecord({\r\n   *   // JSData thinks this record has been saved if it has a primary key\r\n   *   id: 1234,\r\n   *   title: 'Modeling your data',\r\n   *   status: 'draft'\r\n   * });\r\n   *\r\n   * @example\r\n   * // Create record instances from an array\r\n   * const posts = PostMapper.createRecord([{\r\n   *   title: 'Modeling your data',\r\n   *   status: 'draft'\r\n   * }, {\r\n   *   title: 'Reading data',\r\n   *   status: 'draft'\r\n   * }]);\r\n   *\r\n   * @example\r\n   * // Records are validated by default\r\n   * import { Mapper } from 'js-data';\r\n   * const PostMapper = new Mapper({\r\n   *   name: 'post',\r\n   *   schema: { properties: { title: { type: 'string' } } }\r\n   * });\r\n   * try {\r\n   *   const post = PostMapper.createRecord({\r\n   *     title: 1234,\r\n   *   });\r\n   * } catch (err) {\r\n   *   console.log(err.errors); // [{ expected: 'one of (string)', actual: 'number', path: 'title' }]\r\n   * }\r\n   *\r\n   * @example\r\n   * // Skip validation\r\n   * import { Mapper } from 'js-data';\r\n   * const PostMapper = new Mapper({\r\n   *   name: 'post',\r\n   *   schema: { properties: { title: { type: 'string' } } }\r\n   * });\r\n   * const post = PostMapper.createRecord({\r\n   *   title: 1234,\r\n   * }, { noValidate: true });\r\n   * console.log(post.isValid()); // false\r\n   *\r\n   * @method Mapper#createRecord\r\n   * @param {Object|Object[]} props The properties for the Record instance or an\r\n   * array of property objects for the Record instances.\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {boolean} [opts.noValidate={@link Mapper#noValidate}] See {@link Mapper#noValidate}.\r\n   * @returns {Record|Record[]} The Record instance or Record instances.\r\n   * @since 3.0.0\r\n   */\r\n  createRecord (props, opts) {\r\n    props || (props = {})\r\n    if (utils.isArray(props)) {\r\n      return props.map((_props) => this.createRecord(_props, opts))\r\n    }\r\n    if (!utils.isObject(props)) {\r\n      throw utils.err(`${DOMAIN}#createRecord`, 'props')(400, 'array or object', props)\r\n    }\r\n\r\n    if (this.relationList) {\r\n      this.relationList.forEach(function (def) {\r\n        def.ensureLinkedDataHasProperType(props, opts)\r\n      })\r\n    }\r\n    const RecordCtor = this.recordClass\r\n\r\n    return (!RecordCtor || props instanceof RecordCtor) ? props : new RecordCtor(props, opts)\r\n  },\r\n\r\n  /**\r\n   * Lifecycle invocation method. You probably won't call this method directly.\r\n   *\r\n   * @method Mapper#crud\r\n   * @param {string} method Name of the lifecycle method to invoke.\r\n   * @param {...*} args Arguments to pass to the lifecycle method.\r\n   * @returns {Promise}\r\n   * @since 3.0.0\r\n   */\r\n  crud (method, ...args) {\r\n    const config = this.lifecycleMethods[method]\r\n    if (!config) {\r\n      throw utils.err(`${DOMAIN}#crud`, method)(404, 'method')\r\n    }\r\n\r\n    const upper = `${method.charAt(0).toUpperCase()}${method.substr(1)}`\r\n    const before = `before${upper}`\r\n    const after = `after${upper}`\r\n\r\n    let op\r\n\r\n    // Default values for arguments\r\n    config.defaults.forEach((value, i) => {\r\n      if (args[i] === undefined) {\r\n        args[i] = utils.copy(value)\r\n      }\r\n    })\r\n\r\n    const opts = args[args.length - 1]\r\n\r\n    // Fill in \"opts\" with the Mapper's configuration\r\n    utils._(opts, this)\r\n    const adapter = opts.adapter = this.getAdapterName(opts)\r\n\r\n    // before lifecycle hook\r\n    op = opts.op = before\r\n    return utils.resolve(this[op](...args)).then((_value) => {\r\n      if (args[config.beforeAssign] !== undefined) {\r\n        // Allow for re-assignment from lifecycle hook\r\n        args[config.beforeAssign] = _value === undefined ? args[config.beforeAssign] : _value\r\n      }\r\n      // Now delegate to the adapter\r\n      op = opts.op = method\r\n      args = config.adapterArgs ? config.adapterArgs(this, ...args) : args\r\n      this.dbg(op, ...args)\r\n      return utils.resolve(this.getAdapter(adapter)[op](this, ...args))\r\n    }).then((result) => {\r\n      // force noValidate on find/findAll\r\n      const noValidate = /find/.test(op) || opts.noValidate\r\n      const _opts = Object.assign({}, opts, { noValidate })\r\n\r\n      result = this._end(result, _opts, !!config.skip)\r\n      args.push(result)\r\n      // after lifecycle hook\r\n      op = opts.op = after\r\n      return utils.resolve(this[op](...args)).then((_result) => {\r\n        // Allow for re-assignment from lifecycle hook\r\n        return _result === undefined ? result : _result\r\n      })\r\n    })\r\n  },\r\n\r\n  /**\r\n   * Fired during {@link Mapper#destroy}. See\r\n   * {@link Mapper~beforeDestroyListener} for how to listen for this event.\r\n   *\r\n   * @event Mapper#beforeDestroy\r\n   * @see Mapper~beforeDestroyListener\r\n   * @see Mapper#destroy\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Mapper#event:beforeDestroy} event.\r\n   *\r\n   * @example\r\n   * function onBeforeDestroy (id, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeDestroy', onBeforeDestroy);\r\n   *\r\n   * @callback Mapper~beforeDestroyListener\r\n   * @param {string|number} id The `id` argument passed to {@link Mapper#beforeDestroy}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#beforeDestroy}.\r\n   * @see Mapper#event:beforeDestroy\r\n   * @see Mapper#destroy\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link Mapper#destroy}. See\r\n   * {@link Mapper~afterDestroyListener} for how to listen for this event.\r\n   *\r\n   * @event Mapper#afterDestroy\r\n   * @see Mapper~afterDestroyListener\r\n   * @see Mapper#destroy\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Mapper#event:afterDestroy} event.\r\n   *\r\n   * @example\r\n   * function onAfterDestroy (id, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterDestroy', onAfterDestroy);\r\n   *\r\n   * @callback Mapper~afterDestroyListener\r\n   * @param {string|number} id The `id` argument passed to {@link Mapper#afterDestroy}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#afterDestroy}.\r\n   * @param {object} result The `result` argument passed to {@link Mapper#afterDestroy}.\r\n   * @see Mapper#event:afterDestroy\r\n   * @see Mapper#destroy\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Using an adapter, destroy the record with the given primary key.\r\n   *\r\n   * {@link Mapper#beforeDestroy} will be called before destroying the record.\r\n   * {@link Mapper#afterDestroy} will be called after destroying the record.\r\n   *\r\n   * @example\r\n   * // Destroy a specific blog post\r\n   * PostMapper.destroy(1234).then(() => {\r\n   *   // Blog post #1234 has been destroyed\r\n   * });\r\n   *\r\n   * @example\r\n   * // Get full response\r\n   * PostMapper.destroy(1234, { raw: true }).then((result) => {\r\n   *   console.log(result.deleted); e.g. 1\r\n   *   console.log(...); // etc., more metadata can be found on the result\r\n   * });\r\n   *\r\n   * @fires Mapper#beforeDestroy\r\n   * @fires Mapper#afterDestroy\r\n   * @method Mapper#destroy\r\n   * @param {(string|number)} id The primary key of the record to destroy.\r\n   * @param {object} [opts] Configuration options. Refer to the `destroy` method\r\n   * of whatever adapter you're using for more configuration options.\r\n   * @param {boolean} [opts.adapter={@link Mapper#defaultAdapter}] Name of the\r\n   * adapter to use.\r\n   * @param {boolean} [opts.notify={@link Mapper#notify}] See {@link Mapper#notify}.\r\n   * @param {boolean} [opts.raw={@link Mapper#raw}] See {@link Mapper#raw}.\r\n   * @returns {Promise} Resolves when the record has been destroyed. Resolves\r\n   * even if no record was found to be destroyed.\r\n   * @since 3.0.0\r\n   * @tutorial [\"http://www.js-data.io/v3.0/docs/saving-data\",\"Saving data\"]\r\n   */\r\n  destroy (id, opts) {\r\n    return this.crud('destroy', id, opts)\r\n  },\r\n\r\n  /**\r\n   * Fired during {@link Mapper#destroyAll}. See\r\n   * {@link Mapper~beforeDestroyAllListener} for how to listen for this event.\r\n   *\r\n   * @event Mapper#beforeDestroyAll\r\n   * @see Mapper~beforeDestroyAllListener\r\n   * @see Mapper#destroyAll\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Mapper#event:beforeDestroyAll} event.\r\n   *\r\n   * @example\r\n   * function onBeforeDestroyAll (query, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeDestroyAll', onBeforeDestroyAll);\r\n   *\r\n   * @callback Mapper~beforeDestroyAllListener\r\n   * @param {object} query The `query` argument passed to {@link Mapper#beforeDestroyAll}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#beforeDestroyAll}.\r\n   * @see Mapper#event:beforeDestroyAll\r\n   * @see Mapper#destroyAll\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link Mapper#destroyAll}. See\r\n   * {@link Mapper~afterDestroyAllListener} for how to listen for this event.\r\n   *\r\n   * @event Mapper#afterDestroyAll\r\n   * @see Mapper~afterDestroyAllListener\r\n   * @see Mapper#destroyAll\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Mapper#event:afterDestroyAll} event.\r\n   *\r\n   * @example\r\n   * function onAfterDestroyAll (query, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterDestroyAll', onAfterDestroyAll);\r\n   *\r\n   * @callback Mapper~afterDestroyAllListener\r\n   * @param {object} query The `query` argument passed to {@link Mapper#afterDestroyAll}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#afterDestroyAll}.\r\n   * @param {object} result The `result` argument passed to {@link Mapper#afterDestroyAll}.\r\n   * @see Mapper#event:afterDestroyAll\r\n   * @see Mapper#destroyAll\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Destroy the records selected by `query` via an adapter. If no `query` is\r\n   * provided then all records will be destroyed.\r\n   *\r\n   * {@link Mapper#beforeDestroyAll} will be called before destroying the records.\r\n   * {@link Mapper#afterDestroyAll} will be called after destroying the records.\r\n   *\r\n   * @example\r\n   * // Destroy all blog posts\r\n   * PostMapper.destroyAll().then(() => {\r\n   *   // All blog posts have been destroyed\r\n   * });\r\n   *\r\n   * @example\r\n   * // Destroy all \"draft\" blog posts\r\n   * PostMapper.destroyAll({ status: 'draft' }).then(() => {\r\n   *   // All \"draft\" blog posts have been destroyed\r\n   * });\r\n   *\r\n   * @example\r\n   * // Get full response\r\n   * const query = null;\r\n   * const options = { raw: true };\r\n   * PostMapper.destroyAll(query, options).then((result) => {\r\n   *   console.log(result.deleted); e.g. 14\r\n   *   console.log(...); // etc., more metadata can be found on the result\r\n   * });\r\n   *\r\n   * @fires Mapper#beforeDestroyAll\r\n   * @fires Mapper#afterDestroyAll\r\n   * @method Mapper#destroyAll\r\n   * @param {object} [query={}] Selection query. See {@link query}.\r\n   * @param {object} [query.where] See {@link query.where}.\r\n   * @param {number} [query.offset] See {@link query.offset}.\r\n   * @param {number} [query.limit] See {@link query.limit}.\r\n   * @param {string|Array[]} [query.orderBy] See {@link query.orderBy}.\r\n   * @param {object} [opts] Configuration options. Refer to the `destroyAll`\r\n   * method of whatever adapter you're using for more configuration options.\r\n   * @param {boolean} [opts.adapter={@link Mapper#defaultAdapter}] Name of the\r\n   * adapter to use.\r\n   * @param {boolean} [opts.notify={@link Mapper#notify}] See {@link Mapper#notify}.\r\n   * @param {boolean} [opts.raw={@link Mapper#raw}] See {@link Mapper#raw}.\r\n   * @returns {Promise} Resolves when the records have been destroyed. Resolves\r\n   * even if no records were found to be destroyed.\r\n   * @see query\r\n   * @since 3.0.0\r\n   * @tutorial [\"http://www.js-data.io/v3.0/docs/saving-data\",\"Saving data\"]\r\n   */\r\n  destroyAll (query, opts) {\r\n    return this.crud('destroyAll', query, opts)\r\n  },\r\n\r\n  /**\r\n   * Fired during {@link Mapper#find}. See\r\n   * {@link Mapper~beforeFindListener} for how to listen for this event.\r\n   *\r\n   * @event Mapper#beforeFind\r\n   * @see Mapper~beforeFindListener\r\n   * @see Mapper#find\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Mapper#event:beforeFind} event.\r\n   *\r\n   * @example\r\n   * function onBeforeFind (id, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeFind', onBeforeFind);\r\n   *\r\n   * @callback Mapper~beforeFindListener\r\n   * @param {string|number} id The `id` argument passed to {@link Mapper#beforeFind}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#beforeFind}.\r\n   * @see Mapper#event:beforeFind\r\n   * @see Mapper#find\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link Mapper#find}. See\r\n   * {@link Mapper~afterFindListener} for how to listen for this event.\r\n   *\r\n   * @event Mapper#afterFind\r\n   * @see Mapper~afterFindListener\r\n   * @see Mapper#find\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Mapper#event:afterFind} event.\r\n   *\r\n   * @example\r\n   * function onAfterFind (id, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterFind', onAfterFind);\r\n   *\r\n   * @callback Mapper~afterFindListener\r\n   * @param {string|number} id The `id` argument passed to {@link Mapper#afterFind}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#afterFind}.\r\n   * @param {object} result The `result` argument passed to {@link Mapper#afterFind}.\r\n   * @see Mapper#event:afterFind\r\n   * @see Mapper#find\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Retrieve via an adapter the record with the given primary key.\r\n   *\r\n   * {@link Mapper#beforeFind} will be called before calling the adapter.\r\n   * {@link Mapper#afterFind} will be called after calling the adapter.\r\n   *\r\n   * @example\r\n   * PostMapper.find(1).then((post) => {\r\n   *   console.log(post); // { id: 1, ...}\r\n   * });\r\n   *\r\n   * @example\r\n   * // Get full response\r\n   * PostMapper.find(1, { raw: true }).then((result) => {\r\n   *   console.log(result.data); // { id: 1, ...}\r\n   *   console.log(result.found); // 1\r\n   *   console.log(...); // etc., more metadata can be found on the result\r\n   * });\r\n   *\r\n   * @fires Mapper#beforeFind\r\n   * @fires Mapper#afterFind\r\n   * @method Mapper#find\r\n   * @param {(string|number)} id The primary key of the record to retrieve.\r\n   * @param {object} [opts] Configuration options. Refer to the `find` method\r\n   * of whatever adapter you're using for more configuration options.\r\n   * @param {boolean} [opts.adapter={@link Mapper#defaultAdapter}] Name of the\r\n   * adapter to use.\r\n   * @param {boolean} [opts.notify={@link Mapper#notify}] See {@link Mapper#notify}.\r\n   * @param {boolean} [opts.raw={@link Mapper#raw}] See {@link Mapper#raw}.\r\n   * @param {string[]} [opts.with=[]] Relations to eager load in the request.\r\n   * @returns {Promise} Resolves with the found record. Resolves with\r\n   * `undefined` if no record was found.\r\n   * @see http://www.js-data.io/v3.0/docs/reading-data\r\n   * @since 3.0.0\r\n   * @tutorial [\"http://www.js-data.io/v3.0/docs/reading-data\",\"Reading data\"]\r\n   */\r\n  find (id, opts) {\r\n    return this.crud('find', id, opts)\r\n  },\r\n\r\n  /**\r\n   * Fired during {@link Mapper#findAll}. See\r\n   * {@link Mapper~beforeFindAllListener} for how to listen for this event.\r\n   *\r\n   * @event Mapper#beforeFindAll\r\n   * @see Mapper~beforeFindAllListener\r\n   * @see Mapper#findAll\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Mapper#event:beforeFindAll} event.\r\n   *\r\n   * @example\r\n   * function onBeforeFindAll (query, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeFindAll', onBeforeFindAll);\r\n   *\r\n   * @callback Mapper~beforeFindAllListener\r\n   * @param {object} query The `query` argument passed to {@link Mapper#beforeFindAll}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#beforeFindAll}.\r\n   * @see Mapper#event:beforeFindAll\r\n   * @see Mapper#findAll\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link Mapper#findAll}. See\r\n   * {@link Mapper~afterFindAllListener} for how to listen for this event.\r\n   *\r\n   * @event Mapper#afterFindAll\r\n   * @see Mapper~afterFindAllListener\r\n   * @see Mapper#findAll\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Mapper#event:afterFindAll} event.\r\n   *\r\n   * @example\r\n   * function onAfterFindAll (query, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterFindAll', onAfterFindAll);\r\n   *\r\n   * @callback Mapper~afterFindAllListener\r\n   * @param {object} query The `query` argument passed to {@link Mapper#afterFindAll}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#afterFindAll}.\r\n   * @param {object} result The `result` argument passed to {@link Mapper#afterFindAll}.\r\n   * @see Mapper#event:afterFindAll\r\n   * @see Mapper#findAll\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Using the `query` argument, select records to retrieve via an adapter.\r\n   *\r\n   * {@link Mapper#beforeFindAll} will be called before calling the adapter.\r\n   * {@link Mapper#afterFindAll} will be called after calling the adapter.\r\n   *\r\n   * @example\r\n   * // Find all \"published\" blog posts\r\n   * PostMapper.findAll({ status: 'published' }).then((posts) => {\r\n   *   console.log(posts); // [{ id: 1, status: 'published', ...}, ...]\r\n   * });\r\n   *\r\n   * @example\r\n   * // Get full response\r\n   * PostMapper.findAll({ status: 'published' }, { raw: true }).then((result) => {\r\n   *   console.log(result.data); // [{ id: 1, status: 'published', ...}, ...]\r\n   *   console.log(result.found); // e.g. 13\r\n   *   console.log(...); // etc., more metadata can be found on the result\r\n   * });\r\n   *\r\n   * @fires Mapper#beforeFindAll\r\n   * @fires Mapper#afterFindAll\r\n   * @method Mapper#findAll\r\n   * @param {object} [query={}] Selection query. See {@link query}.\r\n   * @param {object} [query.where] See {@link query.where}.\r\n   * @param {number} [query.offset] See {@link query.offset}.\r\n   * @param {number} [query.limit] See {@link query.limit}.\r\n   * @param {string|Array[]} [query.orderBy] See {@link query.orderBy}.\r\n   * @param {object} [opts] Configuration options. Refer to the `findAll` method\r\n   * of whatever adapter you're using for more configuration options.\r\n   * @param {boolean} [opts.adapter={@link Mapper#defaultAdapter}] Name of the\r\n   * adapter to use.\r\n   * @param {boolean} [opts.notify={@link Mapper#notify}] See {@link Mapper#notify}.\r\n   * @param {boolean} [opts.raw={@link Mapper#raw}] See {@link Mapper#raw}.\r\n   * @param {string[]} [opts.with=[]] Relations to eager load in the request.\r\n   * @returns {Promise} Resolves with the found records, if any.\r\n   * @see query\r\n   * @since 3.0.0\r\n   * @tutorial [\"http://www.js-data.io/v3.0/docs/reading-data\",\"Reading data\"]\r\n   */\r\n  findAll (query, opts) {\r\n    return this.crud('findAll', query, opts)\r\n  },\r\n\r\n  /**\r\n   * Return the registered adapter with the given name or the default adapter if\r\n   * no name is provided.\r\n   *\r\n   * @method Mapper#getAdapter\r\n   * @param {string} [name] The name of the adapter to retrieve.\r\n   * @returns {Adapter} The adapter.\r\n   * @since 3.0.0\r\n   * @tutorial [\"http://www.js-data.io/v3.0/docs/connecting-to-a-data-source\",\"Connecting to a data source\"]\r\n   */\r\n  getAdapter (name) {\r\n    this.dbg('getAdapter', 'name:', name)\r\n    const adapter = this.getAdapterName(name)\r\n    if (!adapter) {\r\n      throw utils.err(`${DOMAIN}#getAdapter`, 'name')(400, 'string', name)\r\n    }\r\n    return this.getAdapters()[adapter]\r\n  },\r\n\r\n  /**\r\n   * Return the name of a registered adapter based on the given name or options,\r\n   * or the name of the default adapter if no name provided.\r\n   *\r\n   * @method Mapper#getAdapterName\r\n   * @param {(Object|string)} [opts] The name of an adapter or options, if any.\r\n   * @returns {string} The name of the adapter.\r\n   * @since 3.0.0\r\n   * @tutorial [\"http://www.js-data.io/v3.0/docs/connecting-to-a-data-source\",\"Connecting to a data source\"]\r\n   */\r\n  getAdapterName (opts) {\r\n    opts || (opts = {})\r\n    if (utils.isString(opts)) {\r\n      opts = { adapter: opts }\r\n    }\r\n    return opts.adapter || opts.defaultAdapter\r\n  },\r\n\r\n  /**\r\n   * Get the object of registered adapters for this Mapper.\r\n   *\r\n   * @method Mapper#getAdapters\r\n   * @returns {Object} {@link Mapper#_adapters}\r\n   * @since 3.0.0\r\n   * @tutorial [\"http://www.js-data.io/v3.0/docs/connecting-to-a-data-source\",\"Connecting to a data source\"]\r\n   */\r\n  getAdapters () {\r\n    return this._adapters\r\n  },\r\n\r\n  /**\r\n   * Returns this Mapper's {@link Schema}.\r\n   *\r\n   * @method Mapper#getSchema\r\n   * @returns {Schema} This Mapper's {@link Schema}.\r\n   * @see Mapper#schema\r\n   * @since 3.0.0\r\n   */\r\n  getSchema () {\r\n    return this.schema\r\n  },\r\n\r\n  /**\r\n   * Defines a hasMany relationship. Only useful if you're managing your\r\n   * Mappers manually and not using a Container or DataStore component.\r\n   *\r\n   * @example\r\n   * UserMapper.hasMany(PostMapper, {\r\n   *   // post.user_id points to user.id\r\n   *   foreignKey: 'user_id'\r\n   *   // post records will be attached to user records at \"user.posts\"\r\n   *   localField: 'posts'\r\n   * });\r\n   *\r\n   * @method Mapper#hasMany\r\n   * @see http://www.js-data.io/v3.0/docs/relations\r\n   * @since 3.0.0\r\n   */\r\n  hasMany (relatedMapper, opts) {\r\n    return hasMany(relatedMapper, opts)(this)\r\n  },\r\n\r\n  /**\r\n   * Defines a hasOne relationship. Only useful if you're managing your Mappers\r\n   * manually and not using a {@link Container} or {@link DataStore} component.\r\n   *\r\n   * @example\r\n   * UserMapper.hasOne(ProfileMapper, {\r\n   *   // profile.user_id points to user.id\r\n   *   foreignKey: 'user_id'\r\n   *   // profile records will be attached to user records at \"user.profile\"\r\n   *   localField: 'profile'\r\n   * });\r\n   *\r\n   * @method Mapper#hasOne\r\n   * @see http://www.js-data.io/v3.0/docs/relations\r\n   * @since 3.0.0\r\n   */\r\n  hasOne (relatedMapper, opts) {\r\n    return hasOne(relatedMapper, opts)(this)\r\n  },\r\n\r\n  /**\r\n   * Return whether `record` is an instance of this Mapper's recordClass.\r\n   *\r\n   * @example\r\n   * const post = PostMapper.createRecord();\r\n   *\r\n   * console.log(PostMapper.is(post)); // true\r\n   * // Equivalent to what's above\r\n   * console.log(post instanceof PostMapper.recordClass); // true\r\n   *\r\n   * @method Mapper#is\r\n   * @param {Object|Record} record The record to check.\r\n   * @returns {boolean} Whether `record` is an instance of this Mapper's\r\n   * {@link Mapper#recordClass}.\r\n   * @since 3.0.0\r\n   */\r\n  is (record) {\r\n    const recordClass = this.recordClass\r\n    return recordClass ? record instanceof recordClass : false\r\n  },\r\n\r\n  /**\r\n   * Register an adapter on this Mapper under the given name.\r\n   *\r\n   * @method Mapper#registerAdapter\r\n   * @param {string} name The name of the adapter to register.\r\n   * @param {Adapter} adapter The adapter to register.\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {boolean} [opts.default=false] Whether to make the adapter the\r\n   * default adapter for this Mapper.\r\n   * @since 3.0.0\r\n   * @tutorial [\"http://www.js-data.io/v3.0/docs/connecting-to-a-data-source\",\"Connecting to a data source\"]\r\n   */\r\n  registerAdapter (name, adapter, opts) {\r\n    opts || (opts = {})\r\n    this.getAdapters()[name] = adapter\r\n    // Optionally make it the default adapter for the target.\r\n    if (opts === true || opts.default) {\r\n      this.defaultAdapter = name\r\n    }\r\n  },\r\n\r\n  _runHook (hookName, ...hookArgs) {\r\n    const defaultValueIndex = hookName.indexOf('after') === 0 ? hookArgs.length - 1 : 0\r\n\r\n    return utils.resolve(this[hookName](...hookArgs))\r\n      .then((overridenResult) => overridenResult === undefined ? hookArgs[defaultValueIndex] : overridenResult)\r\n  },\r\n\r\n  _invokeAdapterMethod (method, propsOrRecords, opts) {\r\n    const conversionOptions = { with: opts.pass || [] }\r\n    let object\r\n\r\n    this.dbg(opts.op, propsOrRecords, opts)\r\n\r\n    if (utils.isArray(propsOrRecords)) {\r\n      object = propsOrRecords.map(record => this.toJSON(record, conversionOptions))\r\n    } else {\r\n      object = this.toJSON(propsOrRecords, conversionOptions)\r\n    }\r\n\r\n    return this.getAdapter(opts.adapter)[method](this, object, opts)\r\n  },\r\n\r\n  /**\r\n   * Select records according to the `query` argument, and aggregate the sum\r\n   * value of the property specified by `field`.\r\n   *\r\n   * {@link Mapper#beforeSum} will be called before calling the adapter.\r\n   * {@link Mapper#afterSum} will be called after calling the adapter.\r\n   *\r\n   * @example\r\n   * PurchaseOrderMapper.sum('amount', { status: 'paid' }).then((amountPaid) => {\r\n   *   console.log(amountPaid); // e.g. 451125.34\r\n   * });\r\n   *\r\n   * @method Mapper#sum\r\n   * @param {string} field The field to sum.\r\n   * @param {object} [query={}] Selection query. See {@link query}.\r\n   * @param {object} [query.where] See {@link query.where}.\r\n   * @param {number} [query.offset] See {@link query.offset}.\r\n   * @param {number} [query.limit] See {@link query.limit}.\r\n   * @param {string|Array[]} [query.orderBy] See {@link query.orderBy}.\r\n   * @param {object} [opts] Configuration options. Refer to the `sum` method\r\n   * of whatever adapter you're using for more configuration options.\r\n   * @param {boolean} [opts.adapter={@link Mapper#defaultAdapter}] Name of the\r\n   * adapter to use.\r\n   * @param {boolean} [opts.notify={@link Mapper#notify}] See {@link Mapper#notify}.\r\n   * @param {boolean} [opts.raw={@link Mapper#raw}] See {@link Mapper#raw}.\r\n   * @returns {Promise} Resolves with the aggregated sum.\r\n   * @since 3.0.0\r\n   */\r\n  sum (field, query, opts) {\r\n    return this.crud('sum', field, query, opts)\r\n  },\r\n\r\n  /**\r\n   * Return a plain object representation of the given record. Relations can\r\n   * be optionally be included. Non-schema properties can be excluded.\r\n   *\r\n   * @example\r\n   * import { Mapper, Schema } from 'js-data';\r\n   * const PersonMapper = new Mapper({\r\n   *   name: 'person',\r\n   *   schema: {\r\n   *     properties: {\r\n   *       name: { type: 'string' },\r\n   *       id: { type: 'string' }\r\n   *     }\r\n   *   }\r\n   * });\r\n   * const person = PersonMapper.createRecord({ id: 1, name: 'John', foo: 'bar' });\r\n   * // \"foo\" is stripped by toJSON()\r\n   * console.log(PersonMapper.toJSON(person)); // {\"id\":1,\"name\":\"John\"}\r\n   *\r\n   * const PersonRelaxedMapper = new Mapper({\r\n   *   name: 'personRelaxed',\r\n   *   schema: {\r\n   *     properties: {\r\n   *       name: { type: 'string' },\r\n   *       id: { type: 'string' }\r\n   *     },\r\n   *     additionalProperties: true\r\n   *   }\r\n   * });\r\n   * const person2 = PersonRelaxedMapper.createRecord({ id: 1, name: 'John', foo: 'bar' });\r\n   * // \"foo\" is not stripped by toJSON\r\n   * console.log(PersonRelaxedMapper.toJSON(person2)); // {\"id\":1,\"name\":\"John\",\"foo\":\"bar\"}\r\n   *\r\n   * @method Mapper#toJSON\r\n   * @param {Record|Record[]} records Record or records from which to create a\r\n   * POJO representation.\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {string[]} [opts.with] Array of relation names or relation fields\r\n   * to include in the POJO representation.\r\n   * @param {boolean} [opts.withAll] Whether to simply include all relations in\r\n   * the representation. Overrides `opts.with`.\r\n   * @returns {Object|Object[]} POJO representation of the record or records.\r\n   * @since 3.0.0\r\n   */\r\n  toJSON (records, opts) {\r\n    let record\r\n    opts || (opts = {})\r\n    if (utils.isArray(records)) {\r\n      return records.map((record) => this.toJSON(record, opts))\r\n    } else {\r\n      record = records\r\n    }\r\n    const relationFields = (this ? this.relationFields : []) || []\r\n    let json = {}\r\n\r\n    // Copy properties defined in the schema\r\n    if (this && this.schema) {\r\n      json = this.schema.pick(record)\r\n    } else {\r\n      for (var key in record) {\r\n        if (relationFields.indexOf(key) === -1) {\r\n          json[key] = utils.plainCopy(record[key])\r\n        }\r\n      }\r\n    }\r\n\r\n    // The user wants to include relations in the resulting plain object representation\r\n    if (this && opts.withAll) {\r\n      opts.with = relationFields.slice()\r\n    }\r\n    if (this && opts.with) {\r\n      if (utils.isString(opts.with)) {\r\n        opts.with = [opts.with]\r\n      }\r\n      utils.forEachRelation(this, opts, (def, optsCopy) => {\r\n        const relationData = def.getLocalField(record)\r\n        if (relationData) {\r\n          // The actual recursion\r\n          if (utils.isArray(relationData)) {\r\n            def.setLocalField(json, relationData.map((item) => {\r\n              return def.getRelation().toJSON(item, optsCopy)\r\n            }))\r\n          } else {\r\n            def.setLocalField(json, def.getRelation().toJSON(relationData, optsCopy))\r\n          }\r\n        }\r\n      })\r\n    }\r\n    return json\r\n  },\r\n\r\n  /**\r\n   * Fired during {@link Mapper#update}. See\r\n   * {@link Mapper~beforeUpdateListener} for how to listen for this event.\r\n   *\r\n   * @event Mapper#beforeUpdate\r\n   * @see Mapper~beforeUpdateListener\r\n   * @see Mapper#update\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Mapper#event:beforeUpdate} event.\r\n   *\r\n   * @example\r\n   * function onBeforeUpdate (id, props, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeUpdate', onBeforeUpdate);\r\n   *\r\n   * @callback Mapper~beforeUpdateListener\r\n   * @param {string|number} id The `id` argument passed to {@link Mapper#beforeUpdate}.\r\n   * @param {object} props The `props` argument passed to {@link Mapper#beforeUpdate}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#beforeUpdate}.\r\n   * @see Mapper#event:beforeUpdate\r\n   * @see Mapper#update\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link Mapper#update}. See\r\n   * {@link Mapper~afterUpdateListener} for how to listen for this event.\r\n   *\r\n   * @event Mapper#afterUpdate\r\n   * @see Mapper~afterUpdateListener\r\n   * @see Mapper#update\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Mapper#event:afterUpdate} event.\r\n   *\r\n   * @example\r\n   * function onAfterUpdate (id, props, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterUpdate', onAfterUpdate);\r\n   *\r\n   * @callback Mapper~afterUpdateListener\r\n   * @param {string|number} id The `id` argument passed to {@link Mapper#afterUpdate}.\r\n   * @param {object} props The `props` argument passed to {@link Mapper#afterUpdate}.\r\n   * @param {object} opts The `opts` argument passed to {@link Mapper#afterUpdate}.\r\n   * @param {object} result The `result` argument passed to {@link Mapper#afterUpdate}.\r\n   * @see Mapper#event:afterUpdate\r\n   * @see Mapper#update\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Using an adapter, update the record with the primary key specified by the\r\n   * `id` argument.\r\n   *\r\n   * {@link Mapper#beforeUpdate} will be called before updating the record.\r\n   * {@link Mapper#afterUpdate} will be called after updating the record.\r\n   *\r\n   * @example\r\n   * // Update a specific post\r\n   * PostMapper.update(1234, {\r\n   *   status: 'published',\r\n   *   published_at: new Date()\r\n   * }).then((post) => {\r\n   *   console.log(post); // { id: 1234, status: 'published', ... }\r\n   * });\r\n   *\r\n   * @fires Mapper#beforeUpdate\r\n   * @fires Mapper#afterUpdate\r\n   * @method Mapper#update\r\n   * @param {(string|number)} id The primary key of the record to update.\r\n   * @param {object} props The update to apply to the record.\r\n   * @param {object} [opts] Configuration options. Refer to the `update` method\r\n   * of whatever adapter you're using for more configuration options.\r\n   * @param {boolean} [opts.adapter={@link Mapper#defaultAdapter}] Name of the\r\n   * adapter to use.\r\n   * @param {boolean} [opts.notify={@link Mapper#notify}] See {@link Mapper#notify}.\r\n   * @param {boolean} [opts.noValidate={@link Mapper#noValidate}] See {@link Mapper#noValidate}.\r\n   * @param {boolean} [opts.raw={@link Mapper#raw}] See {@link Mapper#raw}.\r\n   * transaction.\r\n   * @returns {Promise} Resolves with the updated record. Rejects if the record\r\n   * could not be found.\r\n   * @since 3.0.0\r\n   * @tutorial [\"http://www.js-data.io/v3.0/docs/saving-data\",\"Saving data\"]\r\n   */\r\n  update (id, props, opts) {\r\n    return this.crud('update', id, props, opts)\r\n  },\r\n\r\n  /**\r\n   * Fired during {@link Mapper#updateAll}. See\r\n   * {@link Mapper~beforeUpdateAllListener} for how to listen for this event.\r\n   *\r\n   * @event Mapper#beforeUpdateAll\r\n   * @see Mapper~beforeUpdateAllListener\r\n   * @see Mapper#updateAll\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Mapper#event:beforeUpdateAll} event.\r\n   *\r\n   * @example\r\n   * function onBeforeUpdateAll (props, query, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeUpdateAll', onBeforeUpdateAll);\r\n   *\r\n   * @callback Mapper~beforeUpdateAllListener\r\n   * @param {object} props The `props` argument received by {@link Mapper#beforeUpdateAll}.\r\n   * @param {object} query The `query` argument received by {@link Mapper#beforeUpdateAll}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeUpdateAll}.\r\n   * @see Mapper#event:beforeUpdateAll\r\n   * @see Mapper#updateAll\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link Mapper#updateAll}. See\r\n   * {@link Mapper~afterUpdateAllListener} for how to listen for this event.\r\n   *\r\n   * @event Mapper#afterUpdateAll\r\n   * @see Mapper~afterUpdateAllListener\r\n   * @see Mapper#updateAll\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Mapper#event:afterUpdateAll} event.\r\n   *\r\n   * @example\r\n   * function onAfterUpdateAll (props, query, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterUpdateAll', onAfterUpdateAll);\r\n   *\r\n   * @callback Mapper~afterUpdateAllListener\r\n   * @param {object} props The `props` argument received by {@link Mapper#afterUpdateAll}.\r\n   * @param {object} query The `query` argument received by {@link Mapper#afterUpdateAll}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterUpdateAll}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterUpdateAll}.\r\n   * @see Mapper#event:afterUpdateAll\r\n   * @see Mapper#updateAll\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Using the `query` argument, perform the a single updated to the selected\r\n   * records.\r\n   *\r\n   * {@link Mapper#beforeUpdateAll} will be called before making the update.\r\n   * {@link Mapper#afterUpdateAll} will be called after making the update.\r\n   *\r\n   * @example\r\n   * // Turn all of John's blog posts into drafts.\r\n   * const update = { status: draft: published_at: null };\r\n   * const query = { userId: 1234 };\r\n   * PostMapper.updateAll(update, query).then((posts) => {\r\n   *   console.log(posts); // [...]\r\n   * });\r\n   *\r\n   * @fires Mapper#beforeUpdateAll\r\n   * @fires Mapper#afterUpdateAll\r\n   * @method Mapper#updateAll\r\n   * @param {object} props Update to apply to selected records.\r\n   * @param {object} [query={}] Selection query. See {@link query}.\r\n   * @param {object} [query.where] See {@link query.where}.\r\n   * @param {number} [query.offset] See {@link query.offset}.\r\n   * @param {number} [query.limit] See {@link query.limit}.\r\n   * @param {string|Array[]} [query.orderBy] See {@link query.orderBy}.\r\n   * @param {object} [opts] Configuration options. Refer to the `updateAll`\r\n   * method of whatever adapter you're using for more configuration options.\r\n   * @param {boolean} [opts.adapter={@link Mapper#defaultAdapter}] Name of the\r\n   * adapter to use.\r\n   * @param {boolean} [opts.notify={@link Mapper#notify}] See {@link Mapper#notify}.\r\n   * @param {boolean} [opts.noValidate={@link Mapper#noValidate}] See {@link Mapper#noValidate}.\r\n   * @param {boolean} [opts.raw={@link Mapper#raw}] See {@link Mapper#raw}.\r\n   * @returns {Promise} Resolves with the update records, if any.\r\n   * @see query\r\n   * @since 3.0.0\r\n   * @tutorial [\"http://www.js-data.io/v3.0/docs/saving-data\",\"Saving data\"]\r\n   */\r\n  updateAll (props, query, opts) {\r\n    return this.crud('updateAll', props, query, opts)\r\n  },\r\n\r\n  /**\r\n   * Fired during {@link Mapper#updateMany}. See\r\n   * {@link Mapper~beforeUpdateManyListener} for how to listen for this event.\r\n   *\r\n   * @event Mapper#beforeUpdateMany\r\n   * @see Mapper~beforeUpdateManyListener\r\n   * @see Mapper#updateMany\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Mapper#event:beforeUpdateMany} event.\r\n   *\r\n   * @example\r\n   * function onBeforeUpdateMany (records, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeUpdateMany', onBeforeUpdateMany);\r\n   *\r\n   * @callback Mapper~beforeUpdateManyListener\r\n   * @param {object} records The `records` argument received by {@link Mapper#beforeUpdateMany}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeUpdateMany}.\r\n   * @see Mapper#event:beforeUpdateMany\r\n   * @see Mapper#updateMany\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link Mapper#updateMany}. See\r\n   * {@link Mapper~afterUpdateManyListener} for how to listen for this event.\r\n   *\r\n   * @event Mapper#afterUpdateMany\r\n   * @see Mapper~afterUpdateManyListener\r\n   * @see Mapper#updateMany\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Mapper#event:afterUpdateMany} event.\r\n   *\r\n   * @example\r\n   * function onAfterUpdateMany (records, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterUpdateMany', onAfterUpdateMany);\r\n   *\r\n   * @callback Mapper~afterUpdateManyListener\r\n   * @param {object} records The `records` argument received by {@link Mapper#afterUpdateMany}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterUpdateMany}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterUpdateMany}.\r\n   * @see Mapper#event:afterUpdateMany\r\n   * @see Mapper#updateMany\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Given an array of updates, perform each of the updates via an adapter. Each\r\n   * \"update\" is a hash of properties with which to update an record. Each\r\n   * update must contain the primary key of the record to be updated.\r\n   *\r\n   * {@link Mapper#beforeUpdateMany} will be called before making the update.\r\n   * {@link Mapper#afterUpdateMany} will be called after making the update.\r\n   *\r\n   * @example\r\n   * PostMapper.updateMany([\r\n   *   { id: 1234, status: 'draft' },\r\n   *   { id: 2468, status: 'published', published_at: new Date() }\r\n   * ]).then((posts) => {\r\n   *   console.log(posts); // [...]\r\n   * });\r\n   *\r\n   * @fires Mapper#beforeUpdateMany\r\n   * @fires Mapper#afterUpdateMany\r\n   * @method Mapper#updateMany\r\n   * @param {Record[]} records Array up record updates.\r\n   * @param {object} [opts] Configuration options. Refer to the `updateMany`\r\n   * method of whatever adapter you're using for more configuration options.\r\n   * @param {boolean} [opts.adapter={@link Mapper#defaultAdapter}] Name of the\r\n   * adapter to use.\r\n   * @param {boolean} [opts.notify={@link Mapper#notify}] See {@link Mapper#notify}.\r\n   * @param {boolean} [opts.noValidate={@link Mapper#noValidate}] See {@link Mapper#noValidate}.\r\n   * @param {boolean} [opts.raw={@link Mapper#raw}] See {@link Mapper#raw}.\r\n   * @returns {Promise} Resolves with the updated records. Rejects if any of the\r\n   * records could be found.\r\n   * @since 3.0.0\r\n   * @tutorial [\"http://www.js-data.io/v3.0/docs/saving-data\",\"Saving data\"]\r\n   */\r\n  updateMany (records, opts) {\r\n    return this.crud('updateMany', records, opts)\r\n  },\r\n\r\n  /**\r\n   * Validate the given record or records according to this Mapper's\r\n   * {@link Schema}. If there are no validation errors then the return value\r\n   * will be `undefined`.\r\n   *\r\n   * @example\r\n   * import {Mapper, Schema} from 'js-data'\r\n   * const PersonSchema = new Schema({\r\n   *   properties: {\r\n   *     name: { type: 'string' },\r\n   *     id: { type: 'string' }\r\n   *   }\r\n   * });\r\n   * const PersonMapper = new Mapper({\r\n   *   name: 'person',\r\n   *   schema: PersonSchema\r\n   * });\r\n   * let errors = PersonMapper.validate({ name: 'John' });\r\n   * console.log(errors); // undefined\r\n   * errors = PersonMapper.validate({ name: 123 });\r\n   * console.log(errors); // [{ expected: 'one of (string)', actual: 'number', path: 'name' }]\r\n   *\r\n   * @method Mapper#validate\r\n   * @param {Object|Object[]} record The record or records to validate.\r\n   * @param {object} [opts] Configuration options. Passed to\r\n   * {@link Schema#validate}.\r\n   * @returns {Object[]} Array of errors or `undefined` if no errors.\r\n   * @since 3.0.0\r\n   */\r\n  validate (record, opts) {\r\n    opts || (opts = {})\r\n    const schema = this.getSchema()\r\n    if (!schema) {\r\n      return\r\n    }\r\n    const _opts = utils.pick(opts, ['existingOnly'])\r\n    if (utils.isArray(record)) {\r\n      const errors = record.map((_record) => schema.validate(_record, utils.pick(_opts, ['existingOnly'])))\r\n\r\n      return errors.some(Boolean) ? errors : undefined\r\n    }\r\n    return schema.validate(record, _opts)\r\n  },\r\n\r\n  /**\r\n   * Method used to wrap data returned by an adapter with this Mapper's\r\n   * {@link Mapper#recordClass}. This method is used by all of a Mapper's CRUD\r\n   * methods. The provided implementation of this method assumes that the `data`\r\n   * passed to it is a record or records that need to be wrapped with\r\n   * {@link Mapper#createRecord}. Override with care.\r\n   *\r\n   * Provided implementation of {@link Mapper#wrap}:\r\n   *\r\n   * ```\r\n   * function (data, opts) {\r\n   *   return this.createRecord(data, opts);\r\n   * }\r\n   * ```\r\n   *\r\n   * @example\r\n   * const PostMapper = new Mapper({\r\n   *   name: 'post',\r\n   *   // Override to customize behavior\r\n   *   wrap (data, opts) {\r\n   *     const originalWrap = this.constructor.prototype.wrap;\r\n   *     // Let's say \"GET /post\" doesn't return JSON quite like JSData expects,\r\n   *     // but the actual post records are nested under a \"posts\" field. So,\r\n   *     // we override Mapper#wrap to handle this special case.\r\n   *     if (opts.op === 'findAll') {\r\n   *       return originalWrap.call(this, data.posts, opts);\r\n   *     }\r\n   *     // Otherwise perform original behavior\r\n   *     return originalWrap.call(this, data, opts);\r\n   *   }\r\n   * });\r\n   *\r\n   * @method Mapper#wrap\r\n   * @param {Object|Object[]} data The record or records to be wrapped.\r\n   * @param {object} [opts] Configuration options. Passed to {@link Mapper#createRecord}.\r\n   * @returns {Record|Record[]} The wrapped record or records.\r\n   * @since 3.0.0\r\n   */\r\n  wrap (data, opts) {\r\n    return this.createRecord(data, opts)\r\n  },\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  defineRelations () {\r\n    // Setup the mapper's relations, including generating Mapper#relationList\r\n    // and Mapper#relationFields\r\n    utils.forOwn(this.relations, (group, type) => {\r\n      utils.forOwn(group, (relations, _name) => {\r\n        if (utils.isObject(relations)) {\r\n          relations = [relations]\r\n        }\r\n        relations.forEach((def) => {\r\n          const relatedMapper = this.datastore.getMapperByName(_name) || _name\r\n          def.getRelation = () => this.datastore.getMapper(_name)\r\n\r\n          if (typeof Relation[type] !== 'function') {\r\n            throw utils.err(DOMAIN, 'defineRelations')(400, 'relation type (hasOne, hasMany, etc)', type, true)\r\n          }\r\n\r\n          this[type](relatedMapper, def)\r\n        })\r\n      })\r\n    })\r\n  }\r\n})\r\n\r\n/**\r\n * Create a subclass of this Mapper:\r\n *\r\n * @example <caption>Mapper.extend</caption>\r\n * const JSData = require('js-data');\r\n * const { Mapper } = JSData;\r\n * console.log('Using JSData v' + JSData.version.full);\r\n *\r\n * // Extend the class using ES2015 class syntax.\r\n * class CustomMapperClass extends Mapper {\r\n *   foo () { return 'bar'; }\r\n *   static beep () { return 'boop'; }\r\n * };\r\n * const customMapper = new CustomMapperClass();\r\n * console.log(customMapper.foo());\r\n * console.log(CustomMapperClass.beep());\r\n *\r\n * // Extend the class using alternate method.\r\n * const OtherMapperClass = Mapper.extend({\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * });\r\n * const otherMapper = new OtherMapperClass();\r\n * console.log(otherMapper.foo());\r\n * console.log(OtherMapperClass.beep());\r\n *\r\n * // Extend the class, providing a custom constructor.\r\n * function AnotherMapperClass () {\r\n *   Mapper.call(this);\r\n *   this.created_at = new Date().getTime();\r\n * }\r\n * Mapper.extend({\r\n *   constructor: AnotherMapperClass,\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * })\r\n * const anotherMapper = new AnotherMapperClass();\r\n * console.log(anotherMapper.created_at);\r\n * console.log(anotherMapper.foo());\r\n * console.log(AnotherMapperClass.beep());\r\n *\r\n * @method Mapper.extend\r\n * @param {object} [props={}] Properties to add to the prototype of the\r\n * subclass.\r\n * @param {object} [props.constructor] Provide a custom constructor function\r\n * to be used as the subclass itself.\r\n * @param {object} [classProps={}] Static properties to add to the subclass.\r\n * @returns {Constructor} Subclass of this Mapper class.\r\n * @since 3.0.0\r\n */\r\n","import utils from './utils'\r\nimport Component from './Component'\r\nimport Mapper from './Mapper'\r\n\r\nconst DOMAIN = 'Container'\r\n\r\nexport const proxiedMapperMethods = [\r\n  /**\r\n   * Wrapper for {@link Mapper#count}.\r\n   *\r\n   * @example\r\n   * // Get the number of published blog posts\r\n   * import { Container } from 'js-data';\r\n   * import RethinkDBAdapter from 'js-data-rethinkdb';\r\n   * const store = new Container();\r\n   * store.registerAdapter('rethinkdb', new RethinkDBAdapter(), { default: true });\r\n   * store.defineMapper('post');\r\n   *\r\n   * store.count('post', { status: 'published' }).then((numPublished) => {\r\n   *   console.log(numPublished); // e.g. 45\r\n   * });\r\n   *\r\n   * @method Container#count\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {object} [query] See {@link Mapper#count}.\r\n   * @param {object} [opts] See {@link Mapper#count}.\r\n   * @returns {Promise} See {@link Mapper#count}.\r\n   * @see Mapper#count\r\n   * @since 3.0.0\r\n   */\r\n  'count',\r\n\r\n  /**\r\n   * Fired during {@link Container#create}. See\r\n   * {@link Container~beforeCreateListener} for how to listen for this event.\r\n   *\r\n   * @event Container#beforeCreate\r\n   * @see Container~beforeCreateListener\r\n   * @see Container#create\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Container#event:beforeCreate} event.\r\n   *\r\n   * @example\r\n   * function onBeforeCreate (mapperName, props, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeCreate', onBeforeCreate);\r\n   *\r\n   * @callback Container~beforeCreateListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#beforeCreate}.\r\n   * @param {object} props The `props` argument received by {@link Mapper#beforeCreate}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeCreate}.\r\n   * @see Container#event:beforeCreate\r\n   * @see Container#create\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link Container#create}. See\r\n   * {@link Container~afterCreateListener} for how to listen for this event.\r\n   *\r\n   * @event Container#afterCreate\r\n   * @see Container~afterCreateListener\r\n   * @see Container#create\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Container#event:afterCreate} event.\r\n   *\r\n   * @example\r\n   * function onAfterCreate (mapperName, props, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterCreate', onAfterCreate);\r\n   *\r\n   * @callback Container~afterCreateListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#afterCreate}.\r\n   * @param {object} props The `props` argument received by {@link Mapper#afterCreate}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterCreate}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterCreate}.\r\n   * @see Container#event:afterCreate\r\n   * @see Container#create\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Wrapper for {@link Mapper#create}.\r\n   *\r\n   * @example\r\n   * // Create and save a new blog post\r\n   * import { Container } from 'js-data';\r\n   * import RethinkDBAdapter from 'js-data-rethinkdb';\r\n   * const store = new Container();\r\n   * store.registerAdapter('rethinkdb', new RethinkDBAdapter(), { default: true });\r\n   * store.defineMapper('post');\r\n   *\r\n   * store.create('post', {\r\n   *   title: 'Modeling your data',\r\n   *   status: 'draft'\r\n   * }).then((post) => {\r\n   *   console.log(post); // { id: 1234, status: 'draft', ... }\r\n   * });\r\n   *\r\n   * @fires Container#beforeCreate\r\n   * @fires Container#afterCreate\r\n   * @method Container#create\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {object} props See {@link Mapper#create}.\r\n   * @param {object} [opts] See {@link Mapper#create}.\r\n   * @returns {Promise} See {@link Mapper#create}.\r\n   * @see Mapper#create\r\n   * @since 3.0.0\r\n   */\r\n  'create',\r\n\r\n  /**\r\n   * Fired during {@link Container#createMany}. See\r\n   * {@link Container~beforeCreateManyListener} for how to listen for this event.\r\n   *\r\n   * @event Container#beforeCreateMany\r\n   * @see Container~beforeCreateManyListener\r\n   * @see Container#createMany\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Container#event:beforeCreateMany} event.\r\n   *\r\n   * @example\r\n   * function onBeforeCreateMany (mapperName, records, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeCreateMany', onBeforeCreateMany);\r\n   *\r\n   * @callback Container~beforeCreateManyListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#beforeCreateMany}.\r\n   * @param {object} records The `records` argument received by {@link Mapper#beforeCreateMany}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeCreateMany}.\r\n   * @see Container#event:beforeCreateMany\r\n   * @see Container#createMany\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link Container#createMany}. See\r\n   * {@link Container~afterCreateManyListener} for how to listen for this event.\r\n   *\r\n   * @event Container#afterCreateMany\r\n   * @see Container~afterCreateManyListener\r\n   * @see Container#createMany\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Container#event:afterCreateMany} event.\r\n   *\r\n   * @example\r\n   * function onAfterCreateMany (mapperName, records, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterCreateMany', onAfterCreateMany);\r\n   *\r\n   * @callback Container~afterCreateManyListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#afterCreateMany}.\r\n   * @param {object} records The `records` argument received by {@link Mapper#afterCreateMany}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterCreateMany}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterCreateMany}.\r\n   * @see Container#event:afterCreateMany\r\n   * @see Container#createMany\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Wrapper for {@link Mapper#createMany}.\r\n   *\r\n   * @example\r\n   * // Create and save several new blog posts\r\n   * import { Container } from 'js-data';\r\n   * import RethinkDBAdapter from 'js-data-rethinkdb';\r\n   * const store = new Container();\r\n   * store.registerAdapter('rethinkdb', new RethinkDBAdapter(), { default: true });\r\n   * store.defineMapper('post');\r\n   *\r\n   * store.createMany('post', [{\r\n   *   title: 'Modeling your data',\r\n   *   status: 'draft'\r\n   * }, {\r\n   *   title: 'Reading data',\r\n   *   status: 'draft'\r\n   * }]).then((posts) => {\r\n   *   console.log(posts[0]); // { id: 1234, status: 'draft', ... }\r\n   *   console.log(posts[1]); // { id: 1235, status: 'draft', ... }\r\n   * });\r\n   *\r\n   * @fires Container#beforeCreateMany\r\n   * @fires Container#afterCreateMany\r\n   * @method Container#createMany\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {Record[]} records See {@link Mapper#createMany}.\r\n   * @param {object} [opts] See {@link Mapper#createMany}.\r\n   * @returns {Promise} See {@link Mapper#createMany}.\r\n   * @see Mapper#createMany\r\n   * @since 3.0.0\r\n   */\r\n  'createMany',\r\n\r\n  /**\r\n   * Wrapper for {@link Mapper#createRecord}.\r\n   *\r\n   * __Note:__ This method does __not__ interact with any adapter, and does\r\n   * __not__ save any data. It only creates new objects in memory.\r\n   *\r\n   * @example\r\n   * // Create empty unsaved record instance\r\n   * import { Container } from 'js-data';\r\n   * const store = new Container();\r\n   * store.defineMapper('post');\r\n   * const post = PostMapper.createRecord();\r\n   *\r\n   * @method Container#createRecord\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {Object|Object[]} props See {@link Mapper#createRecord}.\r\n   * @param {object} [opts] See {@link Mapper#createRecord}.\r\n   * @returns {Promise} See {@link Mapper#createRecord}.\r\n   * @see Mapper#createRecord\r\n   * @since 3.0.0\r\n   */\r\n  'createRecord',\r\n\r\n  /**\r\n   * Fired during {@link Container#destroy}. See\r\n   * {@link Container~beforeDestroyListener} for how to listen for this event.\r\n   *\r\n   * @event Container#beforeDestroy\r\n   * @see Container~beforeDestroyListener\r\n   * @see Container#destroy\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Container#event:beforeDestroy} event.\r\n   *\r\n   * @example\r\n   * function onBeforeDestroy (mapperName, id, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeDestroy', onBeforeDestroy);\r\n   *\r\n   * @callback Container~beforeDestroyListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#beforeDestroy}.\r\n   * @param {string|number} id The `id` argument received by {@link Mapper#beforeDestroy}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeDestroy}.\r\n   * @see Container#event:beforeDestroy\r\n   * @see Container#destroy\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link Container#destroy}. See\r\n   * {@link Container~afterDestroyListener} for how to listen for this event.\r\n   *\r\n   * @event Container#afterDestroy\r\n   * @see Container~afterDestroyListener\r\n   * @see Container#destroy\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Container#event:afterDestroy} event.\r\n   *\r\n   * @example\r\n   * function onAfterDestroy (mapperName, id, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterDestroy', onAfterDestroy);\r\n   *\r\n   * @callback Container~afterDestroyListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#afterDestroy}.\r\n   * @param {string|number} id The `id` argument received by {@link Mapper#afterDestroy}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterDestroy}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterDestroy}.\r\n   * @see Container#event:afterDestroy\r\n   * @see Container#destroy\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Wrapper for {@link Mapper#destroy}.\r\n   *\r\n   * @example\r\n   * // Destroy a specific blog post\r\n   * import { Container } from 'js-data';\r\n   * import RethinkDBAdapter from 'js-data-rethinkdb';\r\n   * const store = new Container();\r\n   * store.registerAdapter('rethinkdb', new RethinkDBAdapter(), { default: true });\r\n   * store.defineMapper('post');\r\n   *\r\n   * store.destroy('post', 1234).then(() => {\r\n   *   // Blog post #1234 has been destroyed\r\n   * });\r\n   *\r\n   * @fires Container#beforeDestroy\r\n   * @fires Container#afterDestroy\r\n   * @method Container#destroy\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {(string|number)} id See {@link Mapper#destroy}.\r\n   * @param {object} [opts] See {@link Mapper#destroy}.\r\n   * @returns {Promise} See {@link Mapper#destroy}.\r\n   * @see Mapper#destroy\r\n   * @since 3.0.0\r\n   */\r\n  'destroy',\r\n\r\n  /**\r\n   * Fired during {@link Container#destroyAll}. See\r\n   * {@link Container~beforeDestroyAllListener} for how to listen for this event.\r\n   *\r\n   * @event Container#beforeDestroyAll\r\n   * @see Container~beforeDestroyAllListener\r\n   * @see Container#destroyAll\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Container#event:beforeDestroyAll} event.\r\n   *\r\n   * @example\r\n   * function onBeforeDestroyAll (mapperName, query, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeDestroyAll', onBeforeDestroyAll);\r\n   *\r\n   * @callback Container~beforeDestroyAllListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#beforeDestroyAll}.\r\n   * @param {object} query The `query` argument received by {@link Mapper#beforeDestroyAll}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeDestroyAll}.\r\n   * @see Container#event:beforeDestroyAll\r\n   * @see Container#destroyAll\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link Container#destroyAll}. See\r\n   * {@link Container~afterDestroyAllListener} for how to listen for this event.\r\n   *\r\n   * @event Container#afterDestroyAll\r\n   * @see Container~afterDestroyAllListener\r\n   * @see Container#destroyAll\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Container#event:afterDestroyAll} event.\r\n   *\r\n   * @example\r\n   * function onAfterDestroyAll (mapperName, query, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterDestroyAll', onAfterDestroyAll);\r\n   *\r\n   * @callback Container~afterDestroyAllListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#afterDestroyAll}.\r\n   * @param {object} query The `query` argument received by {@link Mapper#afterDestroyAll}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterDestroyAll}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterDestroyAll}.\r\n   * @see Container#event:afterDestroyAll\r\n   * @see Container#destroyAll\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Wrapper for {@link Mapper#destroyAll}.\r\n   *\r\n   * @example\r\n   * // Destroy all \"draft\" blog posts\r\n   * import { Container } from 'js-data';\r\n   * import RethinkDBAdapter from 'js-data-rethinkdb';\r\n   * const store = new Container();\r\n   * store.registerAdapter('rethinkdb', new RethinkDBAdapter(), { default: true });\r\n   * store.defineMapper('post');\r\n   *\r\n   * store.destroyAll('post', { status: 'draft' }).then(() => {\r\n   *   // All \"draft\" blog posts have been destroyed\r\n   * });\r\n   *\r\n   * @fires Container#beforeDestroyAll\r\n   * @fires Container#afterDestroyAll\r\n   * @method Container#destroyAll\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {object} [query] See {@link Mapper#destroyAll}.\r\n   * @param {object} [opts] See {@link Mapper#destroyAll}.\r\n   * @returns {Promise} See {@link Mapper#destroyAll}.\r\n   * @see Mapper#destroyAll\r\n   * @since 3.0.0\r\n   */\r\n  'destroyAll',\r\n\r\n  /**\r\n   * Fired during {@link Container#find}. See\r\n   * {@link Container~beforeFindListener} for how to listen for this event.\r\n   *\r\n   * @event Container#beforeFind\r\n   * @see Container~beforeFindListener\r\n   * @see Container#find\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Container#event:beforeFind} event.\r\n   *\r\n   * @example\r\n   * function onBeforeFind (mapperName, id, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeFind', onBeforeFind);\r\n   *\r\n   * @callback Container~beforeFindListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#beforeFind}.\r\n   * @param {string|number} id The `id` argument received by {@link Mapper#beforeFind}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeFind}.\r\n   * @see Container#event:beforeFind\r\n   * @see Container#find\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link Container#find}. See\r\n   * {@link Container~afterFindListener} for how to listen for this event.\r\n   *\r\n   * @event Container#afterFind\r\n   * @see Container~afterFindListener\r\n   * @see Container#find\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Container#event:afterFind} event.\r\n   *\r\n   * @example\r\n   * function onAfterFind (mapperName, id, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterFind', onAfterFind);\r\n   *\r\n   * @callback Container~afterFindListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#afterFind}.\r\n   * @param {string|number} id The `id` argument received by {@link Mapper#afterFind}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterFind}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterFind}.\r\n   * @see Container#event:afterFind\r\n   * @see Container#find\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Wrapper for {@link Mapper#find}.\r\n   *\r\n   * @example\r\n   * import { Container } from 'js-data';\r\n   * import RethinkDBAdapter from 'js-data-rethinkdb';\r\n   * const store = new Container();\r\n   * store.registerAdapter('rethinkdb', new RethinkDBAdapter(), { default: true });\r\n   * store.defineMapper('post');\r\n   *\r\n   * store.find('post', 1).then((post) => {\r\n   *   console.log(post) // { id: 1, ...}\r\n   * });\r\n   *\r\n   * @fires Container#beforeFind\r\n   * @fires Container#afterFind\r\n   * @method Container#find\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {(string|number)} id See {@link Mapper#find}.\r\n   * @param {object} [opts] See {@link Mapper#find}.\r\n   * @returns {Promise} See {@link Mapper#find}.\r\n   * @see Mapper#find\r\n   * @since 3.0.0\r\n   */\r\n  'find',\r\n\r\n  /**\r\n   * Fired during {@link Container#findAll}. See\r\n   * {@link Container~beforeFindAllListener} for how to listen for this event.\r\n   *\r\n   * @event Container#beforeFindAll\r\n   * @see Container~beforeFindAllListener\r\n   * @see Container#findAll\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Container#event:beforeFindAll} event.\r\n   *\r\n   * @example\r\n   * function onBeforeFindAll (mapperName, query, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeFindAll', onBeforeFindAll);\r\n   *\r\n   * @callback Container~beforeFindAllListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#beforeFindAll}.\r\n   * @param {object} query The `query` argument received by {@link Mapper#beforeFindAll}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeFindAll}.\r\n   * @see Container#event:beforeFindAll\r\n   * @see Container#findAll\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link Container#findAll}. See\r\n   * {@link Container~afterFindAllListener} for how to listen for this event.\r\n   *\r\n   * @event Container#afterFindAll\r\n   * @see Container~afterFindAllListener\r\n   * @see Container#findAll\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Container#event:afterFindAll} event.\r\n   *\r\n   * @example\r\n   * function onAfterFindAll (mapperName, query, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterFindAll', onAfterFindAll);\r\n   *\r\n   * @callback Container~afterFindAllListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#afterFindAll}.\r\n   * @param {object} query The `query` argument received by {@link Mapper#afterFindAll}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterFindAll}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterFindAll}.\r\n   * @see Container#event:afterFindAll\r\n   * @see Container#findAll\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Wrapper for {@link Mapper#createRecord}.\r\n   *\r\n   * @example\r\n   * // Find all \"published\" blog posts\r\n   * import { Container } from 'js-data';\r\n   * import RethinkDBAdapter from 'js-data-rethinkdb';\r\n   * const store = new Container();\r\n   * store.registerAdapter('rethinkdb', new RethinkDBAdapter(), { default: true });\r\n   * store.defineMapper('post');\r\n   *\r\n   * store.findAll('post', { status: 'published' }).then((posts) => {\r\n   *   console.log(posts); // [{ id: 1, ...}, ...]\r\n   * });\r\n   *\r\n   * @fires Container#beforeFindAll\r\n   * @fires Container#afterFindAll\r\n   * @method Container#findAll\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {object} [query] See {@link Mapper#findAll}.\r\n   * @param {object} [opts] See {@link Mapper#findAll}.\r\n   * @returns {Promise} See {@link Mapper#findAll}.\r\n   * @see Mapper#findAll\r\n   * @since 3.0.0\r\n   */\r\n  'findAll',\r\n\r\n  /**\r\n   * Wrapper for {@link Mapper#getSchema}.\r\n   *\r\n   * @method Container#getSchema\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @returns {Schema} See {@link Mapper#getSchema}.\r\n   * @see Mapper#getSchema\r\n   * @since 3.0.0\r\n   */\r\n  'getSchema',\r\n\r\n  /**\r\n   * Wrapper for {@link Mapper#is}.\r\n   *\r\n   * @example\r\n   * import { Container } from 'js-data';\r\n   * const store = new Container();\r\n   * store.defineMapper('post');\r\n   * const post = store.createRecord();\r\n   *\r\n   * console.log(store.is('post', post)); // true\r\n   * // Equivalent to what's above\r\n   * console.log(post instanceof store.getMapper('post').recordClass); // true\r\n   *\r\n   * @method Container#is\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {Object|Record} record See {@link Mapper#is}.\r\n   * @returns {boolean} See {@link Mapper#is}.\r\n   * @see Mapper#is\r\n   * @since 3.0.0\r\n   */\r\n  'is',\r\n\r\n  /**\r\n   * Wrapper for {@link Mapper#sum}.\r\n   *\r\n   * @example\r\n   * import { Container } from 'js-data';\r\n   * import RethinkDBAdapter from 'js-data-rethinkdb';\r\n   * const store = new Container();\r\n   * store.registerAdapter('rethinkdb', new RethinkDBAdapter(), { default: true });\r\n   * store.defineMapper('purchase_order');\r\n   *\r\n   * store.sum('purchase_order', 'amount', { status: 'paid' }).then((amountPaid) => {\r\n   *   console.log(amountPaid); // e.g. 451125.34\r\n   * });\r\n   *\r\n   * @method Container#sum\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {string} field See {@link Mapper#sum}.\r\n   * @param {object} [query] See {@link Mapper#sum}.\r\n   * @param {object} [opts] See {@link Mapper#sum}.\r\n   * @returns {Promise} See {@link Mapper#sum}.\r\n   * @see Mapper#sum\r\n   * @since 3.0.0\r\n   */\r\n  'sum',\r\n\r\n  /**\r\n   * Wrapper for {@link Mapper#toJSON}.\r\n   *\r\n   * @example\r\n   * import { Container } from 'js-data';\r\n   * import RethinkDBAdapter from 'js-data-rethinkdb';\r\n   * const store = new Container();\r\n   * store.registerAdapter('rethinkdb', new RethinkDBAdapter(), { default: true });\r\n   * store.defineMapper('person', {\r\n   *   schema: {\r\n   *     properties: {\r\n   *       name: { type: 'string' },\r\n   *       id: { type: 'string' }\r\n   *     }\r\n   *   }\r\n   * });\r\n   * const person = store.createRecord('person', { id: 1, name: 'John', foo: 'bar' });\r\n   * // \"foo\" is stripped by toJSON()\r\n   * console.log(store.toJSON('person', person)); // {\"id\":1,\"name\":\"John\"}\r\n   *\r\n   * store.defineMapper('personRelaxed', {\r\n   *   schema: {\r\n   *     properties: {\r\n   *       name: { type: 'string' },\r\n   *       id: { type: 'string' }\r\n   *     },\r\n   *     additionalProperties: true\r\n   *   }\r\n   * });\r\n   * const person2 = store.createRecord('personRelaxed', { id: 1, name: 'John', foo: 'bar' });\r\n   * // \"foo\" is not stripped by toJSON\r\n   * console.log(store.toJSON('personRelaxed', person2)); // {\"id\":1,\"name\":\"John\",\"foo\":\"bar\"}\r\n   *\r\n   * @method Container#toJSON\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {Record|Record[]} records See {@link Mapper#toJSON}.\r\n   * @param {object} [opts] See {@link Mapper#toJSON}.\r\n   * @returns {Object|Object[]} See {@link Mapper#toJSON}.\r\n   * @see Mapper#toJSON\r\n   * @since 3.0.0\r\n   */\r\n  'toJSON',\r\n\r\n  /**\r\n   * Fired during {@link Container#update}. See\r\n   * {@link Container~beforeUpdateListener} for how to listen for this event.\r\n   *\r\n   * @event Container#beforeUpdate\r\n   * @see Container~beforeUpdateListener\r\n   * @see Container#update\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Container#event:beforeUpdate} event.\r\n   *\r\n   * @example\r\n   * function onBeforeUpdate (mapperName, id, props, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeUpdate', onBeforeUpdate);\r\n   *\r\n   * @callback Container~beforeUpdateListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#beforeUpdate}.\r\n   * @param {string|number} id The `id` argument received by {@link Mapper#beforeUpdate}.\r\n   * @param {object} props The `props` argument received by {@link Mapper#beforeUpdate}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeUpdate}.\r\n   * @see Container#event:beforeUpdate\r\n   * @see Container#update\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link Container#update}. See\r\n   * {@link Container~afterUpdateListener} for how to listen for this event.\r\n   *\r\n   * @event Container#afterUpdate\r\n   * @see Container~afterUpdateListener\r\n   * @see Container#update\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Container#event:afterUpdate} event.\r\n   *\r\n   * @example\r\n   * function onAfterUpdate (mapperName, id, props, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterUpdate', onAfterUpdate);\r\n   *\r\n   * @callback Container~afterUpdateListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#afterUpdate}.\r\n   * @param {string|number} id The `id` argument received by {@link Mapper#afterUpdate}.\r\n   * @param {object} props The `props` argument received by {@link Mapper#afterUpdate}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterUpdate}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterUpdate}.\r\n   * @see Container#event:afterUpdate\r\n   * @see Container#update\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Wrapper for {@link Mapper#update}.\r\n   *\r\n   * @example\r\n   * import { Container } from 'js-data';\r\n   * import RethinkDBAdapter from 'js-data-rethinkdb';\r\n   * const store = new Container();\r\n   * store.registerAdapter('rethinkdb', new RethinkDBAdapter(), { default: true });\r\n   * store.defineMapper('post');\r\n   *\r\n   * store.update('post', 1234, {\r\n   *   status: 'published',\r\n   *   published_at: new Date()\r\n   * }).then((post) => {\r\n   *   console.log(post); // { id: 1234, status: 'published', ... }\r\n   * });\r\n   *\r\n   * @fires Container#beforeUpdate\r\n   * @fires Container#afterUpdate\r\n   * @method Container#update\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {(string|number)} id See {@link Mapper#update}.\r\n   * @param {object} record See {@link Mapper#update}.\r\n   * @param {object} [opts] See {@link Mapper#update}.\r\n   * @returns {Promise} See {@link Mapper#update}.\r\n   * @see Mapper#update\r\n   * @since 3.0.0\r\n   * @tutorial [\"http://www.js-data.io/v3.0/docs/saving-data\",\"Saving data\"]\r\n   */\r\n  'update',\r\n\r\n  /**\r\n   * Fired during {@link Container#updateAll}. See\r\n   * {@link Container~beforeUpdateAllListener} for how to listen for this event.\r\n   *\r\n   * @event Container#beforeUpdateAll\r\n   * @see Container~beforeUpdateAllListener\r\n   * @see Container#updateAll\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Container#event:beforeUpdateAll} event.\r\n   *\r\n   * @example\r\n   * function onBeforeUpdateAll (mapperName, props, query, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeUpdateAll', onBeforeUpdateAll);\r\n   *\r\n   * @callback Container~beforeUpdateAllListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#beforeUpdateAll}.\r\n   * @param {object} props The `props` argument received by {@link Mapper#beforeUpdateAll}.\r\n   * @param {object} query The `query` argument received by {@link Mapper#beforeUpdateAll}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeUpdateAll}.\r\n   * @see Container#event:beforeUpdateAll\r\n   * @see Container#updateAll\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link Container#updateAll}. See\r\n   * {@link Container~afterUpdateAllListener} for how to listen for this event.\r\n   *\r\n   * @event Container#afterUpdateAll\r\n   * @see Container~afterUpdateAllListener\r\n   * @see Container#updateAll\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Container#event:afterUpdateAll} event.\r\n   *\r\n   * @example\r\n   * function onAfterUpdateAll (mapperName, props, query, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterUpdateAll', onAfterUpdateAll);\r\n   *\r\n   * @callback Container~afterUpdateAllListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#afterUpdateAll}.\r\n   * @param {object} props The `props` argument received by {@link Mapper#afterUpdateAll}.\r\n   * @param {object} query The `query` argument received by {@link Mapper#afterUpdateAll}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterUpdateAll}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterUpdateAll}.\r\n   * @see Container#event:afterUpdateAll\r\n   * @see Container#updateAll\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Wrapper for {@link Mapper#updateAll}.\r\n   *\r\n   * @example\r\n   * // Turn all of John's blog posts into drafts.\r\n   * import { Container } from 'js-data';\r\n   * import RethinkDBAdapter from 'js-data-rethinkdb';\r\n   * const store = new Container();\r\n   * store.registerAdapter('rethinkdb', new RethinkDBAdapter(), { default: true });\r\n   * store.defineMapper('post');\r\n   *\r\n   * const update = { status: draft: published_at: null };\r\n   * const query = { userId: 1234 };\r\n   * store.updateAll('post', update, query).then((posts) => {\r\n   *   console.log(posts); // [...]\r\n   * });\r\n   *\r\n   * @fires Container#beforeUpdateAll\r\n   * @fires Container#afterUpdateAll\r\n   * @method Container#updateAll\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {object} update See {@link Mapper#updateAll}.\r\n   * @param {object} [query] See {@link Mapper#updateAll}.\r\n   * @param {object} [opts] See {@link Mapper#updateAll}.\r\n   * @returns {Promise} See {@link Mapper#updateAll}.\r\n   * @see Mapper#updateAll\r\n   * @since 3.0.0\r\n   */\r\n  'updateAll',\r\n\r\n  /**\r\n   * Fired during {@link Container#updateMany}. See\r\n   * {@link Container~beforeUpdateManyListener} for how to listen for this event.\r\n   *\r\n   * @event Container#beforeUpdateMany\r\n   * @see Container~beforeUpdateManyListener\r\n   * @see Container#updateMany\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Container#event:beforeUpdateMany} event.\r\n   *\r\n   * @example\r\n   * function onBeforeUpdateMany (mapperName, records, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeUpdateMany', onBeforeUpdateMany);\r\n   *\r\n   * @callback Container~beforeUpdateManyListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#beforeUpdateMany}.\r\n   * @param {object} records The `records` argument received by {@link Mapper#beforeUpdateMany}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeUpdateMany}.\r\n   * @see Container#event:beforeUpdateMany\r\n   * @see Container#updateMany\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link Container#updateMany}. See\r\n   * {@link Container~afterUpdateManyListener} for how to listen for this event.\r\n   *\r\n   * @event Container#afterUpdateMany\r\n   * @see Container~afterUpdateManyListener\r\n   * @see Container#updateMany\r\n   */\r\n  /**\r\n   * Callback signature for the {@link Container#event:afterUpdateMany} event.\r\n   *\r\n   * @example\r\n   * function onAfterUpdateMany (mapperName, records, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterUpdateMany', onAfterUpdateMany);\r\n   *\r\n   * @callback Container~afterUpdateManyListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#afterUpdateMany}.\r\n   * @param {object} records The `records` argument received by {@link Mapper#afterUpdateMany}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterUpdateMany}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterUpdateMany}.\r\n   * @see Container#event:afterUpdateMany\r\n   * @see Container#updateMany\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Wrapper for {@link Mapper#updateMany}.\r\n   *\r\n   * @example\r\n   * import { Container } from 'js-data';\r\n   * import RethinkDBAdapter from 'js-data-rethinkdb';\r\n   * const store = new Container();\r\n   * store.registerAdapter('rethinkdb', new RethinkDBAdapter(), { default: true });\r\n   * store.defineMapper('post');\r\n   *\r\n   * store.updateMany('post', [\r\n   *   { id: 1234, status: 'draft' },\r\n   *   { id: 2468, status: 'published', published_at: new Date() }\r\n   * ]).then((posts) => {\r\n   *   console.log(posts); // [...]\r\n   * });\r\n   *\r\n   * @fires Container#beforeUpdateMany\r\n   * @fires Container#afterUpdateMany\r\n   * @method Container#updateMany\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {(Object[]|Record[])} records See {@link Mapper#updateMany}.\r\n   * @param {object} [opts] See {@link Mapper#updateMany}.\r\n   * @returns {Promise} See {@link Mapper#updateMany}.\r\n   * @see Mapper#updateMany\r\n   * @since 3.0.0\r\n   */\r\n  'updateMany',\r\n\r\n  /**\r\n   * Wrapper for {@link Mapper#validate}.\r\n   *\r\n   * @example\r\n   * import { Container } from 'js-data';\r\n   * const store = new Container();\r\n   * store.defineMapper('post', {\r\n   *   schema: {\r\n   *     properties: {\r\n   *       name: { type: 'string' },\r\n   *       id: { type: 'string' }\r\n   *     }\r\n   *   }\r\n   * });\r\n   * let errors = store.validate('post', { name: 'John' });\r\n   * console.log(errors); // undefined\r\n   * errors = store.validate('post', { name: 123 });\r\n   * console.log(errors); // [{ expected: 'one of (string)', actual: 'number', path: 'name' }]\r\n   *\r\n   * @method Container#validate\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {(Object[]|Record[])} records See {@link Mapper#validate}.\r\n   * @param {object} [opts] See {@link Mapper#validate}.\r\n   * @returns {Promise} See {@link Mapper#validate}.\r\n   * @see Mapper#validate\r\n   * @since 3.0.0\r\n   */\r\n  'validate'\r\n]\r\n\r\n/**\r\n * The `Container` class is a place to define and store {@link Mapper} instances.\r\n *\r\n * `Container` makes it easy to manage your Mappers. Without a container, you\r\n * need to manage Mappers yourself, including resolving circular dependencies\r\n * among relations. All Mappers in a container share the same adapters, so you\r\n * don't have to register adapters for every single Mapper.\r\n *\r\n * @example <caption>Container#constructor</caption>\r\n * // import { Container } from 'js-data';\r\n * const JSData = require('js-data');\r\n * const {Container} = JSData;\r\n * console.log('Using JSData v' + JSData.version.full);\r\n *\r\n * const store = new Container();\r\n *\r\n * @class Container\r\n * @extends Component\r\n * @param {object} [opts] Configuration options.\r\n * @param {boolean} [opts.debug=false] See {@link Component#debug}.\r\n * @param {Constructor} [opts.mapperClass] See {@link Container#mapperClass}.\r\n * @param {object} [opts.mapperDefaults] See {@link Container#mapperDefaults}.\r\n * @since 3.0.0\r\n */\r\nexport function Container (opts) {\r\n  utils.classCallCheck(this, Container)\r\n  Component.call(this)\r\n  opts || (opts = {})\r\n\r\n  Object.defineProperties(this, {\r\n    /**\r\n     * The adapters registered with this Container, which are also shared by all\r\n     * Mappers in this Container.\r\n     *\r\n     * @name Container#_adapters\r\n     * @see Container#registerAdapter\r\n     * @since 3.0.0\r\n     * @type {Object}\r\n     */\r\n    _adapters: {\r\n      value: {}\r\n    },\r\n\r\n    /**\r\n     * The the mappers in this container\r\n     *\r\n     * @name Container#_mappers\r\n     * @see Mapper\r\n     * @since 3.0.0\r\n     * @type {Object}\r\n     */\r\n    _mappers: {\r\n      value: {}\r\n    },\r\n\r\n    /**\r\n     * Constructor function to use in {@link Container#defineMapper} to create new\r\n     * {@link Mapper} instances. {@link Container#mapperClass} should extend\r\n     * {@link Mapper}. By default {@link Mapper} is used to instantiate Mappers.\r\n     *\r\n     * @example <caption>Container#mapperClass</caption>\r\n     * // import { Container, Mapper } from 'js-data';\r\n     * const JSData = require('js-data');\r\n     * const { Container, Mapper } = JSData;\r\n     * console.log('Using JSData v' + JSData.version.full);\r\n     *\r\n     * class MyMapperClass extends Mapper {\r\n     *   foo () { return 'bar' }\r\n     * }\r\n     * const store = new Container({\r\n     *   mapperClass: MyMapperClass\r\n     * });\r\n     * store.defineMapper('user');\r\n     * console.log(store.getMapper('user').foo());\r\n     *\r\n     * @name Container#mapperClass\r\n     * @see Mapper\r\n     * @since 3.0.0\r\n     * @type {Constructor}\r\n     */\r\n    mapperClass: {\r\n      value: undefined,\r\n      writable: true\r\n    }\r\n  })\r\n\r\n  // Apply options provided by the user\r\n  utils.fillIn(this, opts)\r\n\r\n  /**\r\n   * Defaults options to pass to {@link Container#mapperClass} when creating a\r\n   * new {@link Mapper}.\r\n   *\r\n   * @example <caption>Container#mapperDefaults</caption>\r\n   * // import { Container } from 'js-data';\r\n   * const JSData = require('js-data');\r\n   * const { Container } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new Container({\r\n   *   mapperDefaults: {\r\n   *     idAttribute: '_id'\r\n   *   }\r\n   * });\r\n   * store.defineMapper('user');\r\n   * console.log(store.getMapper('user').idAttribute);\r\n   *\r\n   * @default {}\r\n   * @name Container#mapperDefaults\r\n   * @since 3.0.0\r\n   * @type {Object}\r\n   */\r\n  this.mapperDefaults = this.mapperDefaults || {}\r\n\r\n  // Use the Mapper class if the user didn't provide a mapperClass\r\n  this.mapperClass || (this.mapperClass = Mapper)\r\n}\r\n\r\nconst props = {\r\n  constructor: Container,\r\n\r\n  /**\r\n   * Register a new event listener on this Container.\r\n   *\r\n   * Proxy for {@link Component#on}. If an event was emitted by a {@link Mapper}\r\n   * in the Container, then the name of the {@link Mapper} will be prepended to\r\n   * the arugments passed to the listener.\r\n   *\r\n   * @example <caption>Container#on</caption>\r\n   * // import { Container } from 'js-data';\r\n   * const JSData = require('js-data');\r\n   * const { Container } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new Container();\r\n   * store.on('foo', function (...args) { console.log(args.join(':')) });\r\n   * store.defineMapper('user');\r\n   * store.emit('foo', 'arg1', 'arg2');\r\n   * store.getMapper('user').emit('foo', 'arg1', 'arg2');\r\n   *\r\n   * @method Container#on\r\n   * @param {string} event Name of event to subsribe to.\r\n   * @param {Function} listener Listener function to handle the event.\r\n   * @param {*} [ctx] Optional content in which to invoke the listener.\r\n   * @since 3.0.0\r\n   */\r\n\r\n  /**\r\n   * Used to bind to events emitted by mappers in this container.\r\n   *\r\n   * @method Container#_onMapperEvent\r\n   * @param {string} name Name of the mapper that emitted the event.\r\n   * @param {...*} [args] Args See {@link Mapper#emit}.\r\n   * @private\r\n   * @since 3.0.0\r\n   */\r\n  _onMapperEvent (name, ...args) {\r\n    const type = args.shift()\r\n    this.emit(type, name, ...args)\r\n  },\r\n\r\n  /**\r\n   * Return a container scoped to a particular mapper.\r\n   *\r\n   * @example <caption>Container#as</caption>\r\n   * // import { Container } from 'js-data';\r\n   * const JSData = require('js-data');\r\n   * const { Container } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new Container();\r\n   * const UserMapper = store.defineMapper('user');\r\n   * const UserStore = store.as('user');\r\n   *\r\n   * const user1 = store.createRecord('user', { name: 'John' });\r\n   * const user2 = UserStore.createRecord({ name: 'John' });\r\n   * const user3 = UserMapper.createRecord({ name: 'John' });\r\n   * console.log(user1 === user2);\r\n   * console.log(user2 === user3);\r\n   * console.log(user1 === user3);\r\n   *\r\n   * @method Container#as\r\n   * @param {string} name Name of the {@link Mapper}.\r\n   * @returns {Object} A container scoped to a particular mapper.\r\n   * @since 3.0.0\r\n   */\r\n  as (name) {\r\n    const props = {}\r\n    const original = this\r\n    proxiedMapperMethods.forEach(function (method) {\r\n      props[method] = {\r\n        writable: true,\r\n        value (...args) {\r\n          return original[method](name, ...args)\r\n        }\r\n      }\r\n    })\r\n    props.getMapper = {\r\n      writable: true,\r\n      value () {\r\n        return original.getMapper(name)\r\n      }\r\n    }\r\n    return Object.create(this, props)\r\n  },\r\n\r\n  /**\r\n   * Create a new mapper and register it in this container.\r\n   *\r\n   * @example <caption>Container#defineMapper</caption>\r\n   * // import { Container } from 'js-data';\r\n   * const JSData = require('js-data');\r\n   * const { Container } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new Container({\r\n   *   mapperDefaults: { foo: 'bar' }\r\n   * });\r\n   * // Container#defineMapper returns a direct reference to the newly created\r\n   * // Mapper.\r\n   * const UserMapper = store.defineMapper('user');\r\n   * console.log(UserMapper === store.getMapper('user'));\r\n   * console.log(UserMapper === store.as('user').getMapper());\r\n   * console.log(UserMapper.foo);\r\n   *\r\n   * @method Container#defineMapper\r\n   * @param {string} name Name under which to register the new {@link Mapper}.\r\n   * {@link Mapper#name} will be set to this value.\r\n   * @param {object} [opts] Configuration options. Passed to\r\n   * {@link Container#mapperClass} when creating the new {@link Mapper}.\r\n   * @returns {Mapper} The newly created instance of {@link Mapper}.\r\n   * @see Container#as\r\n   * @since 3.0.0\r\n   */\r\n  defineMapper (name, opts) {\r\n    // For backwards compatibility with defineResource\r\n    if (utils.isObject(name)) {\r\n      opts = name\r\n      name = opts.name\r\n    }\r\n    if (!utils.isString(name)) {\r\n      throw utils.err(`${DOMAIN}#defineMapper`, 'name')(400, 'string', name)\r\n    }\r\n\r\n    // Default values for arguments\r\n    opts || (opts = {})\r\n    // Set Mapper#name\r\n    opts.name = name\r\n    opts.relations || (opts.relations = {})\r\n\r\n    // Check if the user is overriding the datastore's default mapperClass\r\n    const mapperClass = opts.mapperClass || this.mapperClass\r\n    delete opts.mapperClass\r\n\r\n    // Apply the datastore's defaults to the options going into the mapper\r\n    utils.fillIn(opts, this.mapperDefaults)\r\n\r\n    // Instantiate a mapper\r\n    const mapper = this._mappers[name] = new mapperClass(opts) // eslint-disable-line\r\n    mapper.relations || (mapper.relations = {})\r\n    // Make sure the mapper's name is set\r\n    mapper.name = name\r\n    // All mappers in this datastore will share adapters\r\n    mapper._adapters = this.getAdapters()\r\n\r\n    mapper.datastore = this\r\n\r\n    mapper.on('all', (...args) => this._onMapperEvent(name, ...args))\r\n    mapper.defineRelations()\r\n\r\n    return mapper\r\n  },\r\n\r\n  defineResource (name, opts) {\r\n    console.warn('DEPRECATED: defineResource is deprecated, use defineMapper instead')\r\n    return this.defineMapper(name, opts)\r\n  },\r\n\r\n  /**\r\n   * Return the registered adapter with the given name or the default adapter if\r\n   * no name is provided.\r\n   *\r\n   * @method Container#getAdapter\r\n   * @param {string} [name] The name of the adapter to retrieve.\r\n   * @returns {Adapter} The adapter.\r\n   * @since 3.0.0\r\n   */\r\n  getAdapter (name) {\r\n    const adapter = this.getAdapterName(name)\r\n    if (!adapter) {\r\n      throw utils.err(`${DOMAIN}#getAdapter`, 'name')(400, 'string', name)\r\n    }\r\n    return this.getAdapters()[adapter]\r\n  },\r\n\r\n  /**\r\n   * Return the name of a registered adapter based on the given name or options,\r\n   * or the name of the default adapter if no name provided.\r\n   *\r\n   * @method Container#getAdapterName\r\n   * @param {(Object|string)} [opts] The name of an adapter or options, if any.\r\n   * @returns {string} The name of the adapter.\r\n   * @since 3.0.0\r\n   */\r\n  getAdapterName (opts) {\r\n    opts || (opts = {})\r\n    if (utils.isString(opts)) {\r\n      opts = { adapter: opts }\r\n    }\r\n    return opts.adapter || this.mapperDefaults.defaultAdapter\r\n  },\r\n\r\n  /**\r\n   * Return the registered adapters of this container.\r\n   *\r\n   * @method Container#getAdapters\r\n   * @returns {Adapter}\r\n   * @since 3.0.0\r\n   */\r\n  getAdapters () {\r\n    return this._adapters\r\n  },\r\n\r\n  /**\r\n   * Return the mapper registered under the specified name.\r\n   *\r\n   * @example <caption>Container#getMapper</caption>\r\n   * // import { Container } from 'js-data';\r\n   * const JSData = require('js-data');\r\n   * const { Container } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new Container();\r\n   * // Container#defineMapper returns a direct reference to the newly created\r\n   * // Mapper.\r\n   * const UserMapper = store.defineMapper('user');\r\n   * console.log(UserMapper === store.getMapper('user'));\r\n   * console.log(UserMapper === store.as('user').getMapper());\r\n   * store.getMapper('profile'); // throws Error, there is no mapper with name \"profile\"\r\n   *\r\n   * @method Container#getMapper\r\n   * @param {string} name {@link Mapper#name}.\r\n   * @returns {Mapper}\r\n   * @since 3.0.0\r\n   */\r\n  getMapper (name) {\r\n    const mapper = this.getMapperByName(name)\r\n    if (!mapper) {\r\n      throw utils.err(`${DOMAIN}#getMapper`, name)(404, 'mapper')\r\n    }\r\n    return mapper\r\n  },\r\n\r\n  /**\r\n   * Return the mapper registered under the specified name.\r\n   * Doesn't throw error if mapper doesn't exist.\r\n   *\r\n   * @example <caption>Container#getMapperByName</caption>\r\n   * // import { Container } from 'js-data';\r\n   * const JSData = require('js-data');\r\n   * const { Container } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new Container();\r\n   * // Container#defineMapper returns a direct reference to the newly created\r\n   * // Mapper.\r\n   * const UserMapper = store.defineMapper('user');\r\n   * console.log(UserMapper === store.getMapper('user'));\r\n   * console.log(UserMapper === store.as('user').getMapper());\r\n   * console.log(store.getMapper('profile')); // Does NOT throw an error\r\n   *\r\n   * @method Container#getMapperByName\r\n   * @param {string} name {@link Mapper#name}.\r\n   * @returns {Mapper}\r\n   * @since 3.0.0\r\n   */\r\n  getMapperByName (name) {\r\n    return this._mappers[name]\r\n  },\r\n\r\n  /**\r\n   * Register an adapter on this container under the given name. Adapters\r\n   * registered on a container are shared by all mappers in the container.\r\n   *\r\n   * @example\r\n   * import { Container } from 'js-data';\r\n   * import { RethinkDBAdapter } from 'js-data-rethinkdb';\r\n   * const store = new Container();\r\n   * store.registerAdapter('rethinkdb', new RethinkDBAdapter(), { default: true });\r\n   *\r\n   * @method Container#registerAdapter\r\n   * @param {string} name The name of the adapter to register.\r\n   * @param {Adapter} adapter The adapter to register.\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {boolean} [opts.default=false] Whether to make the adapter the\r\n   * default adapter for all Mappers in this container.\r\n   * @since 3.0.0\r\n   * @tutorial [\"http://www.js-data.io/v3.0/docs/connecting-to-a-data-source\",\"Connecting to a data source\"]\r\n   */\r\n  registerAdapter (name, adapter, opts) {\r\n    opts || (opts = {})\r\n    this.getAdapters()[name] = adapter\r\n    // Optionally make it the default adapter for the target.\r\n    if (opts === true || opts.default) {\r\n      this.mapperDefaults.defaultAdapter = name\r\n      utils.forOwn(this._mappers, function (mapper) {\r\n        mapper.defaultAdapter = name\r\n      })\r\n    }\r\n  }\r\n}\r\n\r\nproxiedMapperMethods.forEach(function (method) {\r\n  props[method] = function (name, ...args) {\r\n    return this.getMapper(name)[method](...args)\r\n  }\r\n})\r\n\r\nComponent.extend(props)\r\n\r\n/**\r\n * Create a subclass of this Container:\r\n * @example <caption>Container.extend</caption>\r\n * const JSData = require('js-data');\r\n * const { Container } = JSData;\r\n * console.log('Using JSData v' + JSData.version.full);\r\n *\r\n * // Extend the class using ES2015 class syntax.\r\n * class CustomContainerClass extends Container {\r\n *   foo () { return 'bar' }\r\n *   static beep () { return 'boop' }\r\n * }\r\n * const customContainer = new CustomContainerClass();\r\n * console.log(customContainer.foo());\r\n * console.log(CustomContainerClass.beep());\r\n *\r\n * // Extend the class using alternate method.\r\n * const OtherContainerClass = Container.extend({\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * });\r\n * const otherContainer = new OtherContainerClass();\r\n * console.log(otherContainer.foo());\r\n * console.log(OtherContainerClass.beep());\r\n *\r\n * // Extend the class, providing a custom constructor.\r\n * function AnotherContainerClass () {\r\n *   Container.call(this);\r\n *   this.created_at = new Date().getTime();\r\n * }\r\n * Container.extend({\r\n *   constructor: AnotherContainerClass,\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * })\r\n * const anotherContainer = new AnotherContainerClass();\r\n * console.log(anotherContainer.created_at);\r\n * console.log(anotherContainer.foo());\r\n * console.log(AnotherContainerClass.beep());\r\n *\r\n * @method Container.extend\r\n * @param {object} [props={}] Properties to add to the prototype of the\r\n * subclass.\r\n * @param {object} [props.constructor] Provide a custom constructor function\r\n * to be used as the subclass itself.\r\n * @param {object} [classProps={}] Static properties to add to the subclass.\r\n * @returns {Constructor} Subclass of this Container class.\r\n * @since 3.0.0\r\n */\r\n","import utils from './utils'\r\n\r\nimport {\r\n  belongsToType,\r\n  hasManyType,\r\n  hasOneType\r\n} from './decorators'\r\nimport { proxiedMapperMethods, Container } from './Container'\r\nimport Collection from './Collection'\r\n\r\nconst DOMAIN = 'SimpleStore'\r\nconst proxiedCollectionMethods = [\r\n  /**\r\n   * Wrapper for {@link Collection#add}.\r\n   *\r\n   * @example <caption>SimpleStore#add</caption>\r\n   * const JSData = require('js-data');\r\n   * const { SimpleStore } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new SimpleStore();\r\n   * store.defineMapper('book');\r\n   *\r\n   * // Add one book to the in-memory store:\r\n   * store.add('book', { id: 1, title: 'Respect your Data' });\r\n   * // Add multiple books to the in-memory store:\r\n   * store.add('book', [\r\n   *   { id: 2, title: 'Easy data recipes' },\r\n   *   { id: 3, title: 'Active Record 101' }\r\n   * ]);\r\n   *\r\n   * @fires SimpleStore#add\r\n   * @method SimpleStore#add\r\n   * @param {(string|number)} name Name of the {@link Mapper} to target.\r\n   * @param {(Object|Object[]|Record|Record[])} data See {@link Collection#add}.\r\n   * @param {object} [opts] Configuration options. See {@link Collection#add}.\r\n   * @returns {(Object|Object[]|Record|Record[])} See {@link Collection#add}.\r\n   * @see Collection#add\r\n   * @see Collection#add\r\n   * @since 3.0.0\r\n   */\r\n  'add',\r\n\r\n  /**\r\n   * Wrapper for {@link Collection#between}.\r\n   *\r\n   * @example\r\n   * // Get all users ages 18 to 30\r\n   * const users = store.between('user', 18, 30, { index: 'age' });\r\n   *\r\n   * @example\r\n   * // Same as above\r\n   * const users = store.between('user', [18], [30], { index: 'age' });\r\n   *\r\n   * @method SimpleStore#between\r\n   * @param {(string|number)} name Name of the {@link Mapper} to target.\r\n   * @param {array} leftKeys See {@link Collection#between}.\r\n   * @param {array} rightKeys See {@link Collection#between}.\r\n   * @param {object} [opts] Configuration options. See {@link Collection#between}.\r\n   * @returns {Object[]|Record[]} See {@link Collection#between}.\r\n   * @see Collection#between\r\n   * @see Collection#between\r\n   * @since 3.0.0\r\n   */\r\n  'between',\r\n\r\n  /**\r\n   * Wrapper for {@link Collection#createIndex}.\r\n   *\r\n   * @example\r\n   * // Index users by age\r\n   * store.createIndex('user', 'age');\r\n   *\r\n   * @example\r\n   * // Index users by status and role\r\n   * store.createIndex('user', 'statusAndRole', ['status', 'role']);\r\n   *\r\n   * @method SimpleStore#createIndex\r\n   * @param {(string|number)} name Name of the {@link Mapper} to target.\r\n   * @param {string} name See {@link Collection#createIndex}.\r\n   * @param {string[]} [fieldList] See {@link Collection#createIndex}.\r\n   * @see Collection#createIndex\r\n   * @see Collection#createIndex\r\n   * @since 3.0.0\r\n   */\r\n  'createIndex',\r\n\r\n  /**\r\n   * Wrapper for {@link Collection#filter}.\r\n   *\r\n   * @example <caption>SimpleStore#filter</caption>\r\n   * const JSData = require('js-data');\r\n   * const { SimpleStore } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new SimpleStore();\r\n   * store.defineMapper('post');\r\n   * store.add('post', [\r\n   *   { id: 1, status: 'draft', created_at_timestamp: new Date().getTime() }\r\n   * ]);\r\n   *\r\n   * // Get the draft posts created less than three months ago\r\n   * let posts = store.filter('post', {\r\n   *   where: {\r\n   *     status: {\r\n   *       '==': 'draft'\r\n   *     },\r\n   *     created_at_timestamp: {\r\n   *       '>=': (new Date().getTime() - (1000 \\* 60 \\* 60 \\* 24 \\* 30 \\* 3)) // 3 months ago\r\n   *     }\r\n   *   }\r\n   * });\r\n   * console.log(posts);\r\n   *\r\n   * // Use a custom filter function\r\n   * posts = store.filter('post', function (post) { return post.id % 2 === 0 });\r\n   *\r\n   * @method SimpleStore#filter\r\n   * @param {(string|number)} name Name of the {@link Mapper} to target.\r\n   * @param {(Object|Function)} [queryOrFn={}] See {@link Collection#filter}.\r\n   * @param {object} [thisArg] See {@link Collection#filter}.\r\n   * @returns {Array} See {@link Collection#filter}.\r\n   * @see Collection#filter\r\n   * @see Collection#filter\r\n   * @since 3.0.0\r\n   */\r\n  'filter',\r\n\r\n  /**\r\n   * Wrapper for {@link Collection#get}.\r\n   *\r\n   * @example <caption>SimpleStore#get</caption>\r\n   * const JSData = require('js-data');\r\n   * const { SimpleStore } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new SimpleStore();\r\n   * store.defineMapper('post');\r\n   * store.add('post', [\r\n   *   { id: 1, status: 'draft', created_at_timestamp: new Date().getTime() }\r\n   * ]);\r\n   *\r\n   * console.log(store.get('post', 1)); // {...}\r\n   * console.log(store.get('post', 2)); // undefined\r\n   *\r\n   * @method SimpleStore#get\r\n   * @param {(string|number)} name Name of the {@link Mapper} to target.\r\n   * @param {(string|number)} id See {@link Collection#get}.\r\n   * @returns {(Object|Record)} See {@link Collection#get}.\r\n   * @see Collection#get\r\n   * @see Collection#get\r\n   * @since 3.0.0\r\n   */\r\n  'get',\r\n\r\n  /**\r\n   * Wrapper for {@link Collection#getAll}.\r\n   *\r\n   * @example\r\n   * // Get the posts where \"status\" is \"draft\" or \"inReview\"\r\n   * const posts = store.getAll('post', 'draft', 'inReview', { index: 'status' });\r\n   *\r\n   * @example\r\n   * // Same as above\r\n   * const posts = store.getAll('post', ['draft'], ['inReview'], { index: 'status' });\r\n   *\r\n   * @method SimpleStore#getAll\r\n   * @param {(string|number)} name Name of the {@link Mapper} to target.\r\n   * @param {...Array} [keyList] See {@link Collection#getAll}.\r\n   * @param {object} [opts] See {@link Collection#getAll}.\r\n   * @returns {Array} See {@link Collection#getAll}.\r\n   * @see Collection#getAll\r\n   * @see Collection#getAll\r\n   * @since 3.0.0\r\n   */\r\n  'getAll',\r\n\r\n  /**\r\n   * Wrapper for {@link Collection#prune}.\r\n   *\r\n   * @method SimpleStore#prune\r\n   * @param {object} [opts] See {@link Collection#prune}.\r\n   * @returns {Array} See {@link Collection#prune}.\r\n   * @see Collection#prune\r\n   * @see Collection#prune\r\n   * @since 3.0.0\r\n   */\r\n  'prune',\r\n\r\n  /**\r\n   * Wrapper for {@link Collection#query}.\r\n   *\r\n   * @example\r\n   * // Grab page 2 of users between ages 18 and 30\r\n   * store.query('user')\r\n   *   .between(18, 30, { index: 'age' }) // between ages 18 and 30\r\n   *   .skip(10) // second page\r\n   *   .limit(10) // page size\r\n   *   .run();\r\n   *\r\n   * @method SimpleStore#query\r\n   * @param {(string|number)} name Name of the {@link Mapper} to target.\r\n   * @returns {Query} See {@link Collection#query}.\r\n   * @see Collection#query\r\n   * @see Collection#query\r\n   * @since 3.0.0\r\n   */\r\n  'query',\r\n\r\n  /**\r\n   * Wrapper for {@link Collection#toJSON}.\r\n   *\r\n   * @example\r\n   * store.defineMapper('post', {\r\n   *   schema: {\r\n   *     properties: {\r\n   *       id: { type: 'number' },\r\n   *       title: { type: 'string' }\r\n   *     }\r\n   *   }\r\n   * });\r\n   * store.add('post', [\r\n   *   { id: 1, status: 'published', title: 'Respect your Data' },\r\n   *   { id: 2, status: 'draft', title: 'Connecting to a data source' }\r\n   * ]);\r\n   * console.log(store.toJSON('post'));\r\n   * const draftsJSON = store.query('post')\r\n   *   .filter({ status: 'draft' })\r\n   *   .mapCall('toJSON')\r\n   *   .run();\r\n   *\r\n   * @method SimpleStore#toJSON\r\n   * @param {(string|number)} name Name of the {@link Mapper} to target.\r\n   * @param {object} [opts] See {@link Collection#toJSON}.\r\n   * @returns {Array} See {@link Collection#toJSON}.\r\n   * @see Collection#toJSON\r\n   * @see Collection#toJSON\r\n   * @since 3.0.0\r\n   */\r\n  'toJSON',\r\n\r\n  /**\r\n   * Wrapper for {@link Collection#unsaved}.\r\n   *\r\n   * @method SimpleStore#unsaved\r\n   * @returns {Array} See {@link Collection#unsaved}.\r\n   * @see Collection#unsaved\r\n   * @see Collection#unsaved\r\n   * @since 3.0.0\r\n   */\r\n  'unsaved'\r\n]\r\nconst ownMethodsForScoping = [\r\n  'addToCache',\r\n  'cachedFind',\r\n  'cachedFindAll',\r\n  'cacheFind',\r\n  'cacheFindAll',\r\n  'hashQuery'\r\n]\r\n\r\nconst cachedFn = function (name, hashOrId, opts) {\r\n  const cached = this._completedQueries[name][hashOrId]\r\n  if (utils.isFunction(cached)) {\r\n    return cached(name, hashOrId, opts)\r\n  }\r\n  return cached\r\n}\r\n\r\nconst SIMPLESTORE_DEFAULTS = {\r\n  /**\r\n   * Whether to use the pending query if a `find` request for the specified\r\n   * record is currently underway. Can be set to `true`, `false`, or to a\r\n   * function that returns `true` or `false`.\r\n   *\r\n   * @default true\r\n   * @name SimpleStore#usePendingFind\r\n   * @since 3.0.0\r\n   * @type {boolean|Function}\r\n   */\r\n  usePendingFind: true,\r\n\r\n  /**\r\n   * Whether to use the pending query if a `findAll` request for the given query\r\n   * is currently underway. Can be set to `true`, `false`, or to a function that\r\n   * returns `true` or `false`.\r\n   *\r\n   * @default true\r\n   * @name SimpleStore#usePendingFindAll\r\n   * @since 3.0.0\r\n   * @type {boolean|Function}\r\n   */\r\n  usePendingFindAll: true\r\n}\r\n\r\n/**\r\n * The `SimpleStore` class is an extension of {@link Container}. Not only does\r\n * `SimpleStore` manage mappers, but also collections. `SimpleStore` implements the\r\n * asynchronous {@link Mapper} methods, such as {@link Mapper#find} and\r\n * {@link Mapper#create}. If you use the asynchronous `SimpleStore` methods\r\n * instead of calling them directly on the mappers, then the results of the\r\n * method calls will be inserted into the store's collections. You can think of\r\n * a `SimpleStore` as an [Identity Map](https://en.wikipedia.org/wiki/Identity_map_pattern)\r\n * for the [ORM](https://en.wikipedia.org/wiki/Object-relational_mapping)\r\n * (the Mappers).\r\n *\r\n * ```javascript\r\n * import { SimpleStore } from 'js-data';\r\n * ```\r\n *\r\n * @example\r\n * import { SimpleStore } from 'js-data';\r\n * import { HttpAdapter } from 'js-data-http';\r\n * const store = new SimpleStore();\r\n *\r\n * // SimpleStore#defineMapper returns a direct reference to the newly created\r\n * // Mapper.\r\n * const UserMapper = store.defineMapper('user');\r\n *\r\n * // SimpleStore#as returns the store scoped to a particular Mapper.\r\n * const UserStore = store.as('user');\r\n *\r\n * // Call \"find\" on \"UserMapper\" (Stateless ORM)\r\n * UserMapper.find(1).then((user) => {\r\n *   // retrieved a \"user\" record via the http adapter, but that's it\r\n *\r\n *   // Call \"find\" on \"store\" targeting \"user\" (Stateful SimpleStore)\r\n *   return store.find('user', 1); // same as \"UserStore.find(1)\"\r\n * }).then((user) => {\r\n *   // not only was a \"user\" record retrieved, but it was added to the\r\n *   // store's \"user\" collection\r\n *   const cachedUser = store.getCollection('user').get(1);\r\n *   console.log(user === cachedUser); // true\r\n * });\r\n *\r\n * @class SimpleStore\r\n * @extends Container\r\n * @param {object} [opts] Configuration options. See {@link Container}.\r\n * @param {boolean} [opts.collectionClass={@link Collection}] See {@link SimpleStore#collectionClass}.\r\n * @param {boolean} [opts.debug=false] See {@link Component#debug}.\r\n * @param {boolean|Function} [opts.usePendingFind=true] See {@link SimpleStore#usePendingFind}.\r\n * @param {boolean|Function} [opts.usePendingFindAll=true] See {@link SimpleStore#usePendingFindAll}.\r\n * @returns {SimpleStore}\r\n * @see Container\r\n * @since 3.0.0\r\n * @tutorial [\"http://www.js-data.io/v3.0/docs/components-of-jsdata#SimpleStore\",\"Components of JSData: SimpleStore\"]\r\n * @tutorial [\"http://www.js-data.io/v3.0/docs/working-with-the-SimpleStore\",\"Working with the SimpleStore\"]\r\n * @tutorial [\"http://www.js-data.io/v3.0/docs/jsdata-and-the-browser\",\"Notes on using JSData in the Browser\"]\r\n */\r\nfunction SimpleStore (opts) {\r\n  utils.classCallCheck(this, SimpleStore)\r\n\r\n  opts || (opts = {})\r\n  // Fill in any missing options with the defaults\r\n  utils.fillIn(opts, SIMPLESTORE_DEFAULTS)\r\n  Container.call(this, opts)\r\n\r\n  this.collectionClass = this.collectionClass || Collection\r\n  this._collections = {}\r\n  this._pendingQueries = {}\r\n  this._completedQueries = {}\r\n}\r\n\r\nconst props = {\r\n  constructor: SimpleStore,\r\n\r\n  /**\r\n   * Internal method used to handle Mapper responses.\r\n   *\r\n   * @method SimpleStore#_end\r\n   * @private\r\n   * @param {string} name Name of the {@link Collection} to which to\r\n   * add the data.\r\n   * @param {object} result The result from a Mapper.\r\n   * @param {object} [opts] Configuration options.\r\n   * @returns {(Object|Array)} Result.\r\n   */\r\n  _end (name, result, opts) {\r\n    let data = opts.raw ? result.data : result\r\n    if (data && utils.isFunction(this.addToCache)) {\r\n      data = this.addToCache(name, data, opts)\r\n      if (opts.raw) {\r\n        result.data = data\r\n      } else {\r\n        result = data\r\n      }\r\n    }\r\n    return result\r\n  },\r\n\r\n  /**\r\n   * Register a new event listener on this SimpleStore.\r\n   *\r\n   * Proxy for {@link Container#on}. If an event was emitted by a Mapper or\r\n   * Collection in the SimpleStore, then the name of the Mapper or Collection will\r\n   * be prepended to the arugments passed to the provided event handler.\r\n   *\r\n   * @example\r\n   * // Listen for all \"afterCreate\" events in a SimpleStore\r\n   * store.on('afterCreate', (mapperName, props, opts, result) => {\r\n   *   console.log(mapperName); // \"post\"\r\n   *   console.log(props.id); // undefined\r\n   *   console.log(result.id); // 1234\r\n   * });\r\n   * store.create('post', { title: 'Modeling your data' }).then((post) => {\r\n   *   console.log(post.id); // 1234\r\n   * });\r\n   *\r\n   * @example\r\n   * // Listen for the \"add\" event on a collection\r\n   * store.on('add', (mapperName, records) => {\r\n   *   console.log(records); // [...]\r\n   * });\r\n   *\r\n   * @example\r\n   * // Listen for \"change\" events on a record\r\n   * store.on('change', (mapperName, record, changes) => {\r\n   *   console.log(changes); // { changed: { title: 'Modeling your data' } }\r\n   * });\r\n   * post.title = 'Modeling your data';\r\n   *\r\n   * @method SimpleStore#on\r\n   * @param {string} event Name of event to subsribe to.\r\n   * @param {Function} listener Listener function to handle the event.\r\n   * @param {*} [ctx] Optional content in which to invoke the listener.\r\n   */\r\n\r\n  /**\r\n   * Used to bind to events emitted by collections in this store.\r\n   *\r\n   * @method SimpleStore#_onCollectionEvent\r\n   * @private\r\n   * @param {string} name Name of the collection that emitted the event.\r\n   * @param {...*} [args] Args passed to {@link Collection#emit}.\r\n   */\r\n  _onCollectionEvent (name, ...args) {\r\n    const type = args.shift()\r\n    this.emit(type, name, ...args)\r\n  },\r\n\r\n  /**\r\n   * This method takes the data received from {@link SimpleStore#find},\r\n   * {@link SimpleStore#findAll}, {@link SimpleStore#update}, etc., and adds the\r\n   * data to the store. _You don't need to call this method directly._\r\n   *\r\n   * If you're using the http adapter and your response data is in an unexpected\r\n   * format, you may need to override this method so the right data gets added\r\n   * to the store.\r\n   *\r\n   * @example\r\n   * const store = new SimpleStore({\r\n   *   addToCache (mapperName, data, opts) {\r\n   *     // Let's say for a particular Resource, response data is in a weird format\r\n   *     if (name === 'comment') {\r\n   *       // Re-assign the variable to add the correct records into the stores\r\n   *       data = data.items;\r\n   *     }\r\n   *     // Now perform default behavior\r\n   *     return SimpleStore.prototype.addToCache.call(this, mapperName, data, opts);\r\n   *   }\r\n   * });\r\n   *\r\n   * @example\r\n   * // Extend using ES2015 class syntax.\r\n   * class MyStore extends SimpleStore {\r\n   *   addToCache (mapperName, data, opts) {\r\n   *     // Let's say for a particular Resource, response data is in a weird format\r\n   *     if (name === 'comment') {\r\n   *       // Re-assign the variable to add the correct records into the stores\r\n   *       data = data.items;\r\n   *     }\r\n   *     // Now perform default behavior\r\n   *     return super.addToCache(mapperName, data, opts);\r\n   *   }\r\n   * }\r\n   * const store = new MyStore();\r\n   *\r\n   * @method SimpleStore#addToCache\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {*} data Data from which data should be selected for add.\r\n   * @param {object} [opts] Configuration options.\r\n   */\r\n  addToCache (name, data, opts) {\r\n    return this.getCollection(name).add(data, opts)\r\n  },\r\n\r\n  /**\r\n   * Return the store scoped to a particular mapper/collection pair.\r\n   *\r\n   * @example <caption>SimpleStore.as</caption>\r\n   * const JSData = require('js-data');\r\n   * const { SimpleStore } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new SimpleStore();\r\n   * const UserMapper = store.defineMapper('user');\r\n   * const UserStore = store.as('user');\r\n   *\r\n   * const user1 = store.createRecord('user', { name: 'John' });\r\n   * const user2 = UserStore.createRecord({ name: 'John' });\r\n   * const user3 = UserMapper.createRecord({ name: 'John' });\r\n   * console.log(user1 === user2);\r\n   * console.log(user2 === user3);\r\n   * console.log(user1 === user3);\r\n   *\r\n   * @method SimpleStore#as\r\n   * @param {string} name Name of the {@link Mapper}.\r\n   * @returns {Object} The store, scoped to a particular Mapper/Collection pair.\r\n   * @since 3.0.0\r\n   */\r\n  as (name) {\r\n    const props = {}\r\n    const original = this\r\n    const methods = ownMethodsForScoping\r\n      .concat(proxiedMapperMethods)\r\n      .concat(proxiedCollectionMethods)\r\n\r\n    methods.forEach(function (method) {\r\n      props[method] = {\r\n        writable: true,\r\n        value (...args) {\r\n          return original[method](name, ...args)\r\n        }\r\n      }\r\n    })\r\n    props.getMapper = {\r\n      writable: true,\r\n      value () {\r\n        return original.getMapper(name)\r\n      }\r\n    }\r\n    props.getCollection = {\r\n      writable: true,\r\n      value () {\r\n        return original.getCollection(name)\r\n      }\r\n    }\r\n    return Object.create(this, props)\r\n  },\r\n\r\n  /**\r\n   * Retrieve a cached `find` result, if any. This method is called during\r\n   * {@link SimpleStore#find} to determine if {@link Mapper#find} needs to be\r\n   * called. If this method returns `undefined` then {@link Mapper#find} will\r\n   * be called. Otherwise {@link SimpleStore#find} will immediately resolve with\r\n   * the return value of this method.\r\n   *\r\n   * When using {@link SimpleStore} in the browser, you can override this method\r\n   * to implement your own cache-busting strategy.\r\n   *\r\n   * @example\r\n   * const store = new SimpleStore({\r\n   *   cachedFind (mapperName, id, opts) {\r\n   *     // Let's say for a particular Resource, we always want to pull fresh from the server\r\n   *     if (mapperName === 'schedule') {\r\n   *       // Return undefined to trigger a Mapper#find call\r\n   *       return;\r\n   *     }\r\n   *     // Otherwise perform default behavior\r\n   *     return SimpleStore.prototype.cachedFind.call(this, mapperName, id, opts);\r\n   *   }\r\n   * });\r\n   *\r\n   * @example\r\n   * // Extend using ES2015 class syntax.\r\n   * class MyStore extends SimpleStore {\r\n   *   cachedFind (mapperName, id, opts) {\r\n   *     // Let's say for a particular Resource, we always want to pull fresh from the server\r\n   *     if (mapperName === 'schedule') {\r\n   *       // Return undefined to trigger a Mapper#find call\r\n   *       return;\r\n   *     }\r\n   *     // Otherwise perform default behavior\r\n   *     return super.cachedFind(mapperName, id, opts);\r\n   *   }\r\n   * }\r\n   * const store = new MyStore();\r\n   *\r\n   * @method SimpleStore#cachedFind\r\n   * @param {string} name The `name` argument passed to {@link SimpleStore#find}.\r\n   * @param {(string|number)} id The `id` argument passed to {@link SimpleStore#find}.\r\n   * @param {object} opts The `opts` argument passed to {@link SimpleStore#find}.\r\n   * @since 3.0.0\r\n   */\r\n  cachedFind: cachedFn,\r\n\r\n  /**\r\n   * Retrieve a cached `findAll` result, if any. This method is called during\r\n   * {@link SimpleStore#findAll} to determine if {@link Mapper#findAll} needs to be\r\n   * called. If this method returns `undefined` then {@link Mapper#findAll} will\r\n   * be called. Otherwise {@link SimpleStore#findAll} will immediately resolve with\r\n   * the return value of this method.\r\n   *\r\n   * When using {@link SimpleStore} in the browser, you can override this method\r\n   * to implement your own cache-busting strategy.\r\n   *\r\n   * @example\r\n   * const store = new SimpleStore({\r\n   *   cachedFindAll (mapperName, hash, opts) {\r\n   *     // Let's say for a particular Resource, we always want to pull fresh from the server\r\n   *     if (mapperName === 'schedule') {\r\n   *       // Return undefined to trigger a Mapper#findAll call\r\n   *       return undefined;\r\n   *     }\r\n   *     // Otherwise perform default behavior\r\n   *     return SimpleStore.prototype.cachedFindAll.call(this, mapperName, hash, opts);\r\n   *   }\r\n   * });\r\n   *\r\n   * @example\r\n   * // Extend using ES2015 class syntax.\r\n   * class MyStore extends SimpleStore {\r\n   *   cachedFindAll (mapperName, hash, opts) {\r\n   *     // Let's say for a particular Resource, we always want to pull fresh from the server\r\n   *     if (mapperName === 'schedule') {\r\n   *       // Return undefined to trigger a Mapper#findAll call\r\n   *       return undefined;\r\n   *     }\r\n   *     // Otherwise perform default behavior\r\n   *     return super.cachedFindAll(mapperName, hash, opts);\r\n   *   }\r\n   * }\r\n   * const store = new MyStore();\r\n   *\r\n   * @method SimpleStore#cachedFindAll\r\n   * @param {string} name The `name` argument passed to {@link SimpleStore#findAll}.\r\n   * @param {string} hash The result of calling {@link SimpleStore#hashQuery} on\r\n   * the `query` argument passed to {@link SimpleStore#findAll}.\r\n   * @param {object} opts The `opts` argument passed to {@link SimpleStore#findAll}.\r\n   * @since 3.0.0\r\n   */\r\n  cachedFindAll: cachedFn,\r\n\r\n  /**\r\n   * Mark a {@link Mapper#find} result as cached by adding an entry to\r\n   * {@link SimpleStore#_completedQueries}. By default, once a `find` entry is\r\n   * added it means subsequent calls to the same Resource with the same `id`\r\n   * argument will immediately resolve with the result of calling\r\n   * {@link SimpleStore#get} instead of delegating to {@link Mapper#find}.\r\n   *\r\n   * As part of implementing your own caching strategy, you may choose to\r\n   * override this method.\r\n   *\r\n   * @example\r\n   * const store = new SimpleStore({\r\n   *   cacheFind (mapperName, data, id, opts) {\r\n   *     // Let's say for a particular Resource, we always want to pull fresh from the server\r\n   *     if (mapperName === 'schedule') {\r\n   *       // Return without saving an entry to SimpleStore#_completedQueries\r\n   *       return;\r\n   *     }\r\n   *     // Otherwise perform default behavior\r\n   *     return SimpleStore.prototype.cacheFind.call(this, mapperName, data, id, opts);\r\n   *   }\r\n   * });\r\n   *\r\n   * @example\r\n   * // Extend using ES2015 class syntax.\r\n   * class MyStore extends SimpleStore {\r\n   *   cacheFind (mapperName, data, id, opts) {\r\n   *     // Let's say for a particular Resource, we always want to pull fresh from the server\r\n   *     if (mapperName === 'schedule') {\r\n   *       // Return without saving an entry to SimpleStore#_completedQueries\r\n   *       return;\r\n   *     }\r\n   *     // Otherwise perform default behavior\r\n   *     return super.cacheFind(mapperName, data, id, opts);\r\n   *   }\r\n   * }\r\n   * const store = new MyStore();\r\n   *\r\n   * @method SimpleStore#cacheFind\r\n   * @param {string} name The `name` argument passed to {@link SimpleStore#find}.\r\n   * @param {*} data The result to cache.\r\n   * @param {(string|number)} id The `id` argument passed to {@link SimpleStore#find}.\r\n   * @param {object} opts The `opts` argument passed to {@link SimpleStore#find}.\r\n   * @since 3.0.0\r\n   */\r\n  cacheFind (name, data, id, opts) {\r\n    this._completedQueries[name][id] = (name, id, opts) => this.get(name, id)\r\n  },\r\n\r\n  /**\r\n   * Mark a {@link Mapper#findAll} result as cached by adding an entry to\r\n   * {@link SimpleStore#_completedQueries}. By default, once a `findAll` entry is\r\n   * added it means subsequent calls to the same Resource with the same `query`\r\n   * argument will immediately resolve with the result of calling\r\n   * {@link SimpleStore#filter} instead of delegating to {@link Mapper#findAll}.\r\n   *\r\n   * As part of implementing your own caching strategy, you may choose to\r\n   * override this method.\r\n   *\r\n   * @example\r\n   * const store = new SimpleStore({\r\n   *   cachedFindAll (mapperName, data, hash, opts) {\r\n   *     // Let's say for a particular Resource, we always want to pull fresh from the server\r\n   *     if (mapperName === 'schedule') {\r\n   *       // Return without saving an entry to SimpleStore#_completedQueries\r\n   *       return;\r\n   *     }\r\n   *     // Otherwise perform default behavior.\r\n   *     return SimpleStore.prototype.cachedFindAll.call(this, mapperName, data, hash, opts);\r\n   *   }\r\n   * });\r\n   *\r\n   * @example\r\n   * // Extend using ES2015 class syntax.\r\n   * class MyStore extends SimpleStore {\r\n   *   cachedFindAll (mapperName, data, hash, opts) {\r\n   *     // Let's say for a particular Resource, we always want to pull fresh from the server\r\n   *     if (mapperName === 'schedule') {\r\n   *       // Return without saving an entry to SimpleStore#_completedQueries\r\n   *       return;\r\n   *     }\r\n   *     // Otherwise perform default behavior.\r\n   *     return super.cachedFindAll(mapperName, data, hash, opts);\r\n   *   }\r\n   * }\r\n   * const store = new MyStore();\r\n   *\r\n   * @method SimpleStore#cacheFindAll\r\n   * @param {string} name The `name` argument passed to {@link SimpleStore#findAll}.\r\n   * @param {*} data The result to cache.\r\n   * @param {string} hash The result of calling {@link SimpleStore#hashQuery} on\r\n   * the `query` argument passed to {@link SimpleStore#findAll}.\r\n   * @param {object} opts The `opts` argument passed to {@link SimpleStore#findAll}.\r\n   * @since 3.0.0\r\n   */\r\n  cacheFindAll (name, data, hash, opts) {\r\n    this._completedQueries[name][hash] = (name, hash, opts) => this.filter(name, utils.fromJson(hash))\r\n  },\r\n\r\n  /**\r\n   * Remove __all__ records from the in-memory store and reset\r\n   * {@link SimpleStore#_completedQueries}.\r\n   *\r\n   * @method SimpleStore#clear\r\n   * @returns {Object} Object containing all records that were in the store.\r\n   * @see SimpleStore#remove\r\n   * @see SimpleStore#removeAll\r\n   * @since 3.0.0\r\n   */\r\n  clear () {\r\n    const removed = {}\r\n    utils.forOwn(this._collections, (collection, name) => {\r\n      removed[name] = collection.removeAll()\r\n      this._completedQueries[name] = {}\r\n    })\r\n    return removed\r\n  },\r\n\r\n  /**\r\n   * Fired during {@link SimpleStore#create}. See\r\n   * {@link SimpleStore~beforeCreateListener} for how to listen for this event.\r\n   *\r\n   * @event SimpleStore#beforeCreate\r\n   * @see SimpleStore~beforeCreateListener\r\n   * @see SimpleStore#create\r\n   */\r\n  /**\r\n   * Callback signature for the {@link SimpleStore#event:beforeCreate} event.\r\n   *\r\n   * @example\r\n   * function onBeforeCreate (mapperName, props, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeCreate', onBeforeCreate);\r\n   *\r\n   * @callback SimpleStore~beforeCreateListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#beforeCreate}.\r\n   * @param {object} props The `props` argument received by {@link Mapper#beforeCreate}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeCreate}.\r\n   * @see SimpleStore#event:beforeCreate\r\n   * @see SimpleStore#create\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link SimpleStore#create}. See\r\n   * {@link SimpleStore~afterCreateListener} for how to listen for this event.\r\n   *\r\n   * @event SimpleStore#afterCreate\r\n   * @see SimpleStore~afterCreateListener\r\n   * @see SimpleStore#create\r\n   */\r\n  /**\r\n   * Callback signature for the {@link SimpleStore#event:afterCreate} event.\r\n   *\r\n   * @example\r\n   * function onAfterCreate (mapperName, props, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterCreate', onAfterCreate);\r\n   *\r\n   * @callback SimpleStore~afterCreateListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#afterCreate}.\r\n   * @param {object} props The `props` argument received by {@link Mapper#afterCreate}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterCreate}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterCreate}.\r\n   * @see SimpleStore#event:afterCreate\r\n   * @see SimpleStore#create\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Wrapper for {@link Mapper#create}. Adds the created record to the store.\r\n   *\r\n   * @example\r\n   * import { SimpleStore } from 'js-data';\r\n   * import { HttpAdapter } from 'js-data-http';\r\n   *\r\n   * const store = new SimpleStore();\r\n   * store.registerAdapter('http', new HttpAdapter(), { default: true });\r\n   *\r\n   * store.defineMapper('book');\r\n   *\r\n   * // Since this example uses the http adapter, we'll get something like:\r\n   * //\r\n   * //   POST /book {\"author_id\":1234,...}\r\n   * store.create('book', {\r\n   *   author_id: 1234,\r\n   *   edition: 'First Edition',\r\n   *   title: 'Respect your Data'\r\n   * }).then((book) => {\r\n   *   console.log(book.id); // 120392\r\n   *   console.log(book.title); // \"Respect your Data\"\r\n   * });\r\n   *\r\n   * @fires SimpleStore#beforeCreate\r\n   * @fires SimpleStore#afterCreate\r\n   * @fires SimpleStore#add\r\n   * @method SimpleStore#create\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {object} record Passed to {@link Mapper#create}.\r\n   * @param {object} [opts] Passed to {@link Mapper#create}. See\r\n   * {@link Mapper#create} for more configuration options.\r\n   * @returns {Promise} Resolves with the result of the create.\r\n   * @since 3.0.0\r\n   */\r\n  create (name, record, opts) {\r\n    opts || (opts = {})\r\n    return Container.prototype.create.call(this, name, record, opts)\r\n      .then((result) => this._end(name, result, opts))\r\n  },\r\n\r\n  /**\r\n   * Fired during {@link SimpleStore#createMany}. See\r\n   * {@link SimpleStore~beforeCreateManyListener} for how to listen for this event.\r\n   *\r\n   * @event SimpleStore#beforeCreateMany\r\n   * @see SimpleStore~beforeCreateManyListener\r\n   * @see SimpleStore#createMany\r\n   */\r\n  /**\r\n   * Callback signature for the {@link SimpleStore#event:beforeCreateMany} event.\r\n   *\r\n   * @example\r\n   * function onBeforeCreateMany (mapperName, records, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeCreateMany', onBeforeCreateMany);\r\n   *\r\n   * @callback SimpleStore~beforeCreateManyListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#beforeCreateMany}.\r\n   * @param {object} records The `records` argument received by {@link Mapper#beforeCreateMany}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeCreateMany}.\r\n   * @see SimpleStore#event:beforeCreateMany\r\n   * @see SimpleStore#createMany\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link SimpleStore#createMany}. See\r\n   * {@link SimpleStore~afterCreateManyListener} for how to listen for this event.\r\n   *\r\n   * @event SimpleStore#afterCreateMany\r\n   * @see SimpleStore~afterCreateManyListener\r\n   * @see SimpleStore#createMany\r\n   */\r\n  /**\r\n   * Callback signature for the {@link SimpleStore#event:afterCreateMany} event.\r\n   *\r\n   * @example\r\n   * function onAfterCreateMany (mapperName, records, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterCreateMany', onAfterCreateMany);\r\n   *\r\n   * @callback SimpleStore~afterCreateManyListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#afterCreateMany}.\r\n   * @param {object} records The `records` argument received by {@link Mapper#afterCreateMany}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterCreateMany}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterCreateMany}.\r\n   * @see SimpleStore#event:afterCreateMany\r\n   * @see SimpleStore#createMany\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Wrapper for {@link Mapper#createMany}. Adds the created records to the\r\n   * store.\r\n   *\r\n   * @example\r\n   * import { SimpleStore } from 'js-data';\r\n   * import { HttpAdapter } from 'js-data-http';\r\n   *\r\n   * const store = new SimpleStore();\r\n   * store.registerAdapter('http', new HttpAdapter(), { default: true });\r\n   *\r\n   * store.defineMapper('book');\r\n   *\r\n   * // Since this example uses the http adapter, we'll get something like:\r\n   * //\r\n   * //   POST /book [{\"author_id\":1234,...},{...}]\r\n   * store.createMany('book', [{\r\n   *   author_id: 1234,\r\n   *   edition: 'First Edition',\r\n   *   title: 'Respect your Data'\r\n   * }, {\r\n   *   author_id: 1234,\r\n   *   edition: 'Second Edition',\r\n   *   title: 'Respect your Data'\r\n   * }]).then((books) => {\r\n   *   console.log(books[0].id); // 142394\r\n   *   console.log(books[0].title); // \"Respect your Data\"\r\n   * });\r\n   *\r\n   * @fires SimpleStore#beforeCreateMany\r\n   * @fires SimpleStore#afterCreateMany\r\n   * @fires SimpleStore#add\r\n   * @method SimpleStore#createMany\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {array} records Passed to {@link Mapper#createMany}.\r\n   * @param {object} [opts] Passed to {@link Mapper#createMany}. See\r\n   * {@link Mapper#createMany} for more configuration options.\r\n   * @returns {Promise} Resolves with the result of the create.\r\n   * @since 3.0.0\r\n   */\r\n  createMany (name, records, opts) {\r\n    opts || (opts = {})\r\n    return Container.prototype.createMany.call(this, name, records, opts)\r\n      .then((result) => this._end(name, result, opts))\r\n  },\r\n\r\n  defineMapper (name, opts) {\r\n    const self = this\r\n    const mapper = Container.prototype.defineMapper.call(self, name, opts)\r\n    self._pendingQueries[name] = {}\r\n    self._completedQueries[name] = {}\r\n    mapper.relationList || Object.defineProperty(mapper, 'relationList', { value: [] })\r\n\r\n    const collectionOpts = {\r\n      // Make sure the collection has somewhere to store \"added\" timestamps\r\n      _added: {},\r\n      // Give the collection a reference to this SimpleStore\r\n      datastore: self,\r\n      // The mapper tied to the collection\r\n      mapper\r\n    }\r\n\r\n    if (opts && ('onConflict' in opts)) {\r\n      collectionOpts.onConflict = opts.onConflict\r\n    }\r\n\r\n    // The SimpleStore uses a subclass of Collection that is \"SimpleStore-aware\"\r\n    const collection = self._collections[name] = new self.collectionClass(null, collectionOpts)  // eslint-disable-line\r\n\r\n    const schema = mapper.schema || {}\r\n    const properties = schema.properties || {}\r\n    // TODO: Make it possible index nested properties?\r\n    utils.forOwn(properties, function (opts, prop) {\r\n      if (opts.indexed) {\r\n        collection.createIndex(prop)\r\n      }\r\n    })\r\n\r\n    // Create a secondary index on the \"added\" timestamps of records in the\r\n    // collection\r\n    collection.createIndex('addedTimestamps', ['$'], {\r\n      fieldGetter (obj) {\r\n        return collection._added[collection.recordId(obj)]\r\n      }\r\n    })\r\n\r\n    collection.on('all', function (...args) {\r\n      self._onCollectionEvent(name, ...args)\r\n    })\r\n\r\n    return mapper\r\n  },\r\n\r\n  /**\r\n   * Fired during {@link SimpleStore#destroy}. See\r\n   * {@link SimpleStore~beforeDestroyListener} for how to listen for this event.\r\n   *\r\n   * @event SimpleStore#beforeDestroy\r\n   * @see SimpleStore~beforeDestroyListener\r\n   * @see SimpleStore#destroy\r\n   */\r\n  /**\r\n   * Callback signature for the {@link SimpleStore#event:beforeDestroy} event.\r\n   *\r\n   * @example\r\n   * function onBeforeDestroy (mapperName, id, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeDestroy', onBeforeDestroy);\r\n   *\r\n   * @callback SimpleStore~beforeDestroyListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#beforeDestroy}.\r\n   * @param {string|number} id The `id` argument received by {@link Mapper#beforeDestroy}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeDestroy}.\r\n   * @see SimpleStore#event:beforeDestroy\r\n   * @see SimpleStore#destroy\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link SimpleStore#destroy}. See\r\n   * {@link SimpleStore~afterDestroyListener} for how to listen for this event.\r\n   *\r\n   * @event SimpleStore#afterDestroy\r\n   * @see SimpleStore~afterDestroyListener\r\n   * @see SimpleStore#destroy\r\n   */\r\n  /**\r\n   * Callback signature for the {@link SimpleStore#event:afterDestroy} event.\r\n   *\r\n   * @example\r\n   * function onAfterDestroy (mapperName, id, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterDestroy', onAfterDestroy);\r\n   *\r\n   * @callback SimpleStore~afterDestroyListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#afterDestroy}.\r\n   * @param {string|number} id The `id` argument received by {@link Mapper#afterDestroy}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterDestroy}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterDestroy}.\r\n   * @see SimpleStore#event:afterDestroy\r\n   * @see SimpleStore#destroy\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Wrapper for {@link Mapper#destroy}. Removes any destroyed record from the\r\n   * in-memory store. Clears out any {@link SimpleStore#_completedQueries} entries\r\n   * associated with the provided `id`.\r\n   *\r\n   * @example\r\n   * import { SimpleStore } from 'js-data';\r\n   * import { HttpAdapter } from 'js-data-http';\r\n   *\r\n   * const store = new SimpleStore();\r\n   * store.registerAdapter('http', new HttpAdapter(), { default: true });\r\n   *\r\n   * store.defineMapper('book');\r\n   *\r\n   * store.add('book', { id: 1234, title: 'Data Management is Hard' });\r\n   *\r\n   * // Since this example uses the http adapter, we'll get something like:\r\n   * //\r\n   * //   DELETE /book/1234\r\n   * store.destroy('book', 1234).then(() => {\r\n   *   // The book record is no longer in the in-memory store\r\n   *   console.log(store.get('book', 1234)); // undefined\r\n   *\r\n   *   return store.find('book', 1234);\r\n   * }).then((book) {\r\n   *   // The book was deleted from the database too\r\n   *   console.log(book); // undefined\r\n   * });\r\n   *\r\n   * @fires SimpleStore#beforeDestroy\r\n   * @fires SimpleStore#afterDestroy\r\n   * @fires SimpleStore#remove\r\n   * @method SimpleStore#destroy\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {(string|number)} id Passed to {@link Mapper#destroy}.\r\n   * @param {object} [opts] Passed to {@link Mapper#destroy}. See\r\n   * {@link Mapper#destroy} for more configuration options.\r\n   * @returns {Promise} Resolves when the destroy operation completes.\r\n   * @since 3.0.0\r\n   */\r\n  destroy (name, id, opts) {\r\n    opts || (opts = {})\r\n    return Container.prototype.destroy.call(this, name, id, opts).then((result) => {\r\n      const record = this.getCollection(name).remove(id, opts)\r\n\r\n      if (opts.raw) {\r\n        result.data = record\r\n      } else {\r\n        result = record\r\n      }\r\n      delete this._pendingQueries[name][id]\r\n      delete this._completedQueries[name][id]\r\n      return result\r\n    })\r\n  },\r\n\r\n  /**\r\n   * Fired during {@link SimpleStore#destroyAll}. See\r\n   * {@link SimpleStore~beforeDestroyAllListener} for how to listen for this event.\r\n   *\r\n   * @event SimpleStore#beforeDestroyAll\r\n   * @see SimpleStore~beforeDestroyAllListener\r\n   * @see SimpleStore#destroyAll\r\n   */\r\n  /**\r\n   * Callback signature for the {@link SimpleStore#event:beforeDestroyAll} event.\r\n   *\r\n   * @example\r\n   * function onBeforeDestroyAll (mapperName, query, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeDestroyAll', onBeforeDestroyAll);\r\n   *\r\n   * @callback SimpleStore~beforeDestroyAllListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#beforeDestroyAll}.\r\n   * @param {object} query The `query` argument received by {@link Mapper#beforeDestroyAll}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeDestroyAll}.\r\n   * @see SimpleStore#event:beforeDestroyAll\r\n   * @see SimpleStore#destroyAll\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link SimpleStore#destroyAll}. See\r\n   * {@link SimpleStore~afterDestroyAllListener} for how to listen for this event.\r\n   *\r\n   * @event SimpleStore#afterDestroyAll\r\n   * @see SimpleStore~afterDestroyAllListener\r\n   * @see SimpleStore#destroyAll\r\n   */\r\n  /**\r\n   * Callback signature for the {@link SimpleStore#event:afterDestroyAll} event.\r\n   *\r\n   * @example\r\n   * function onAfterDestroyAll (mapperName, query, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterDestroyAll', onAfterDestroyAll);\r\n   *\r\n   * @callback SimpleStore~afterDestroyAllListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#afterDestroyAll}.\r\n   * @param {object} query The `query` argument received by {@link Mapper#afterDestroyAll}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterDestroyAll}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterDestroyAll}.\r\n   * @see SimpleStore#event:afterDestroyAll\r\n   * @see SimpleStore#destroyAll\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Wrapper for {@link Mapper#destroyAll}. Removes any destroyed records from\r\n   * the in-memory store.\r\n   *\r\n   * @example\r\n   * import { SimpleStore } from 'js-data';\r\n   * import { HttpAdapter } from 'js-data-http';\r\n   *\r\n   * const store = new SimpleStore();\r\n   * store.registerAdapter('http', new HttpAdapter(), { default: true });\r\n   *\r\n   * store.defineMapper('book');\r\n   *\r\n   * store.add('book', { id: 1234, title: 'Data Management is Hard' });\r\n   *\r\n   * // Since this example uses the http adapter, we'll get something like:\r\n   * //\r\n   * //   DELETE /book/1234\r\n   * store.destroy('book', 1234).then(() => {\r\n   *   // The book record is gone from the in-memory store\r\n   *   console.log(store.get('book', 1234)); // undefined\r\n   *   return store.find('book', 1234);\r\n   * }).then((book) {\r\n   *   // The book was deleted from the database too\r\n   *   console.log(book); // undefined\r\n   * });\r\n   *\r\n   * @fires SimpleStore#beforeDestroyAll\r\n   * @fires SimpleStore#afterDestroyAll\r\n   * @fires SimpleStore#remove\r\n   * @method SimpleStore#destroyAll\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {object} [query] Passed to {@link Mapper#destroyAll}.\r\n   * @param {object} [opts] Passed to {@link Mapper#destroyAll}. See\r\n   * {@link Mapper#destroyAll} for more configuration options.\r\n   * @returns {Promise} Resolves when the delete completes.\r\n   * @since 3.0.0\r\n   */\r\n  destroyAll (name, query, opts) {\r\n    opts || (opts = {})\r\n    return Container.prototype.destroyAll.call(this, name, query, opts).then((result) => {\r\n      const records = this.getCollection(name).removeAll(query, opts)\r\n\r\n      if (opts.raw) {\r\n        result.data = records\r\n      } else {\r\n        result = records\r\n      }\r\n      const hash = this.hashQuery(name, query, opts)\r\n      delete this._pendingQueries[name][hash]\r\n      delete this._completedQueries[name][hash]\r\n      return result\r\n    })\r\n  },\r\n\r\n  eject (name, id, opts) {\r\n    console.warn('DEPRECATED: \"eject\" is deprecated, use \"remove\" instead')\r\n    return this.remove(name, id, opts)\r\n  },\r\n\r\n  ejectAll (name, query, opts) {\r\n    console.warn('DEPRECATED: \"ejectAll\" is deprecated, use \"removeAll\" instead')\r\n    return this.removeAll(name, query, opts)\r\n  },\r\n\r\n  /**\r\n   * Fired during {@link SimpleStore#find}. See\r\n   * {@link SimpleStore~beforeFindListener} for how to listen for this event.\r\n   *\r\n   * @event SimpleStore#beforeFind\r\n   * @see SimpleStore~beforeFindListener\r\n   * @see SimpleStore#find\r\n   */\r\n  /**\r\n   * Callback signature for the {@link SimpleStore#event:beforeFind} event.\r\n   *\r\n   * @example\r\n   * function onBeforeFind (mapperName, id, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeFind', onBeforeFind);\r\n   *\r\n   * @callback SimpleStore~beforeFindListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#beforeFind}.\r\n   * @param {string|number} id The `id` argument received by {@link Mapper#beforeFind}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeFind}.\r\n   * @see SimpleStore#event:beforeFind\r\n   * @see SimpleStore#find\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link SimpleStore#find}. See\r\n   * {@link SimpleStore~afterFindListener} for how to listen for this event.\r\n   *\r\n   * @event SimpleStore#afterFind\r\n   * @see SimpleStore~afterFindListener\r\n   * @see SimpleStore#find\r\n   */\r\n  /**\r\n   * Callback signature for the {@link SimpleStore#event:afterFind} event.\r\n   *\r\n   * @example\r\n   * function onAfterFind (mapperName, id, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterFind', onAfterFind);\r\n   *\r\n   * @callback SimpleStore~afterFindListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#afterFind}.\r\n   * @param {string|number} id The `id` argument received by {@link Mapper#afterFind}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterFind}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterFind}.\r\n   * @see SimpleStore#event:afterFind\r\n   * @see SimpleStore#find\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Wrapper for {@link Mapper#find}. Adds any found record to the store.\r\n   *\r\n   * @example\r\n   * import { SimpleStore } from 'js-data';\r\n   * import { HttpAdapter } from 'js-data-http';\r\n   *\r\n   * const store = new SimpleStore();\r\n   * store.registerAdapter('http', new HttpAdapter(), { default: true });\r\n   *\r\n   * store.defineMapper('book');\r\n   *\r\n   * // Since this example uses the http adapter, we'll get something like:\r\n   * //\r\n   * //   GET /book/1234\r\n   * store.find('book', 1234).then((book) => {\r\n   *   // The book record is now in the in-memory store\r\n   *   console.log(store.get('book', 1234) === book); // true\r\n   * });\r\n   *\r\n   * @fires SimpleStore#beforeFind\r\n   * @fires SimpleStore#afterFind\r\n   * @fires SimpleStore#add\r\n   * @method SimpleStore#find\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {(string|number)} id Passed to {@link Mapper#find}.\r\n   * @param {object} [opts] Passed to {@link Mapper#find}.\r\n   * @param {boolean} [opts.force] Bypass cacheFind\r\n   * @param {boolean|Function} [opts.usePendingFind] See {@link SimpleStore#usePendingFind}\r\n   * @returns {Promise} Resolves with the result, if any.\r\n   * @since 3.0.0\r\n   */\r\n  find (name, id, opts) {\r\n    opts || (opts = {})\r\n    const mapper = this.getMapper(name)\r\n    const pendingQuery = this._pendingQueries[name][id]\r\n    const usePendingFind = opts.usePendingFind === undefined ? this.usePendingFind : opts.usePendingFind\r\n    utils._(opts, mapper)\r\n\r\n    if (pendingQuery && (utils.isFunction(usePendingFind) ? usePendingFind.call(this, name, id, opts) : usePendingFind)) {\r\n      return pendingQuery\r\n    }\r\n    const item = this.cachedFind(name, id, opts)\r\n\r\n    if (opts.force || !item) {\r\n      const promise = this._pendingQueries[name][id] = Container.prototype.find.call(this, name, id, opts)\r\n      return promise\r\n        .then((result) => {\r\n          delete this._pendingQueries[name][id]\r\n          result = this._end(name, result, opts)\r\n          this.cacheFind(name, result, id, opts)\r\n          return result\r\n        }, (err) => {\r\n          delete this._pendingQueries[name][id]\r\n          return utils.reject(err)\r\n        })\r\n    }\r\n\r\n    return utils.resolve(item)\r\n  },\r\n\r\n  /**\r\n   * Fired during {@link SimpleStore#findAll}. See\r\n   * {@link SimpleStore~beforeFindAllListener} for how to listen for this event.\r\n   *\r\n   * @event SimpleStore#beforeFindAll\r\n   * @see SimpleStore~beforeFindAllListener\r\n   * @see SimpleStore#findAll\r\n   */\r\n  /**\r\n   * Callback signature for the {@link SimpleStore#event:beforeFindAll} event.\r\n   *\r\n   * @example\r\n   * function onBeforeFindAll (mapperName, query, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeFindAll', onBeforeFindAll);\r\n   *\r\n   * @callback SimpleStore~beforeFindAllListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#beforeFindAll}.\r\n   * @param {object} query The `query` argument received by {@link Mapper#beforeFindAll}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeFindAll}.\r\n   * @see SimpleStore#event:beforeFindAll\r\n   * @see SimpleStore#findAll\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link SimpleStore#findAll}. See\r\n   * {@link SimpleStore~afterFindAllListener} for how to listen for this event.\r\n   *\r\n   * @event SimpleStore#afterFindAll\r\n   * @see SimpleStore~afterFindAllListener\r\n   * @see SimpleStore#findAll\r\n   */\r\n  /**\r\n   * Callback signature for the {@link SimpleStore#event:afterFindAll} event.\r\n   *\r\n   * @example\r\n   * function onAfterFindAll (mapperName, query, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterFindAll', onAfterFindAll);\r\n   *\r\n   * @callback SimpleStore~afterFindAllListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#afterFindAll}.\r\n   * @param {object} query The `query` argument received by {@link Mapper#afterFindAll}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterFindAll}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterFindAll}.\r\n   * @see SimpleStore#event:afterFindAll\r\n   * @see SimpleStore#findAll\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Wrapper for {@link Mapper#findAll}. Adds any found records to the store.\r\n   *\r\n   * @example\r\n   * import { SimpleStore } from 'js-data';\r\n   * import { HttpAdapter } from 'js-data-http';\r\n   *\r\n   * const store = new SimpleStore();\r\n   * store.registerAdapter('http', new HttpAdapter(), { default: true });\r\n   *\r\n   * store.defineMapper('movie');\r\n   *\r\n   * // Since this example uses the http adapter, we'll get something like:\r\n   * //\r\n   * //   GET /movie?rating=PG\r\n   * store.find('movie', { rating: 'PG' }).then((movies) => {\r\n   *   // The movie records are now in the in-memory store\r\n   *   console.log(store.filter('movie'));\r\n   * });\r\n   *\r\n   * @fires SimpleStore#beforeFindAll\r\n   * @fires SimpleStore#afterFindAll\r\n   * @fires SimpleStore#add\r\n   * @method SimpleStore#findAll\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {object} [query] Passed to {@link Mapper.findAll}.\r\n   * @param {object} [opts] Passed to {@link Mapper.findAll}.\r\n   * @param {boolean} [opts.force] Bypass cacheFindAll\r\n   * @param {boolean|Function} [opts.usePendingFindAll] See {@link SimpleStore#usePendingFindAll}\r\n   * @returns {Promise} Resolves with the result, if any.\r\n   * @since 3.0.0\r\n   */\r\n  findAll (name, query, opts) {\r\n    opts || (opts = {})\r\n    const mapper = this.getMapper(name)\r\n    const hash = this.hashQuery(name, query, opts)\r\n    const pendingQuery = this._pendingQueries[name][hash]\r\n    const usePendingFindAll = opts.usePendingFindAll === undefined ? this.usePendingFindAll : opts.usePendingFindAll\r\n    utils._(opts, mapper)\r\n\r\n    if (pendingQuery && (utils.isFunction(usePendingFindAll) ? usePendingFindAll.call(this, name, query, opts) : usePendingFindAll)) {\r\n      return pendingQuery\r\n    }\r\n\r\n    const items = this.cachedFindAll(name, hash, opts)\r\n\r\n    if (opts.force || !items) {\r\n      const promise = this._pendingQueries[name][hash] = Container.prototype.findAll.call(this, name, query, opts)\r\n      return promise\r\n        .then((result) => {\r\n          delete this._pendingQueries[name][hash]\r\n          result = this._end(name, result, opts)\r\n          this.cacheFindAll(name, result, hash, opts)\r\n          return result\r\n        }, (err) => {\r\n          delete this._pendingQueries[name][hash]\r\n          return utils.reject(err)\r\n        })\r\n    }\r\n\r\n    return utils.resolve(items)\r\n  },\r\n\r\n  /**\r\n   * Return the {@link Collection} with the given name, if for some\r\n   * reason you need a direct reference to the collection.\r\n   *\r\n   * @method SimpleStore#getCollection\r\n   * @param {string} name Name of the {@link Collection} to retrieve.\r\n   * @returns {Collection}\r\n   * @since 3.0.0\r\n   * @throws {Error} Thrown if the specified {@link Collection} does not\r\n   * exist.\r\n   */\r\n  getCollection (name) {\r\n    const collection = this._collections[name]\r\n    if (!collection) {\r\n      throw utils.err(`${DOMAIN}#getCollection`, name)(404, 'collection')\r\n    }\r\n    return collection\r\n  },\r\n\r\n  /**\r\n   * Hashing function used to cache {@link SimpleStore#find} and\r\n   * {@link SimpleStore#findAll} requests. This method simply JSONifies the\r\n   * `query` argument passed to {@link SimpleStore#find} or\r\n   * {@link SimpleStore#findAll}.\r\n   *\r\n   * Override this method for custom hashing behavior.\r\n   * @method SimpleStore#hashQuery\r\n   * @param {string} name The `name` argument passed to {@link SimpleStore#find}\r\n   * or {@link SimpleStore#findAll}.\r\n   * @param {object} query The `query` argument passed to {@link SimpleStore#find}\r\n   * or {@link SimpleStore#findAll}.\r\n   * @returns {string} The JSONified `query`.\r\n   * @since 3.0.0\r\n   */\r\n  hashQuery (name, query, opts) {\r\n    return utils.toJson(query || {})\r\n  },\r\n\r\n  inject (name, records, opts) {\r\n    console.warn('DEPRECATED: \"inject\" is deprecated, use \"add\" instead')\r\n    return this.add(name, records, opts)\r\n  },\r\n\r\n  /**\r\n   * Wrapper for {@link Collection#remove}. Removes the specified\r\n   * {@link Record} from the store.\r\n   *\r\n   * @example <caption>SimpleStore#remove</caption>\r\n   * const JSData = require('js-data');\r\n   * const { SimpleStore } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new SimpleStore();\r\n   * store.defineMapper('book');\r\n   * console.log(store.getAll('book').length);\r\n   * store.add('book', { id: 1234 });\r\n   * console.log(store.getAll('book').length);\r\n   * store.remove('book', 1234);\r\n   * console.log(store.getAll('book').length);\r\n   *\r\n   * @fires SimpleStore#remove\r\n   * @method SimpleStore#remove\r\n   * @param {string} name The name of the {@link Collection} to target.\r\n   * @param {string|number} id The primary key of the {@link Record} to remove.\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {string[]} [opts.with] Relations of the {@link Record} to also\r\n   * remove from the store.\r\n   * @returns {Record} The removed {@link Record}, if any.\r\n   * @see Collection#add\r\n   * @see Collection#add\r\n   * @since 3.0.0\r\n   */\r\n  remove (name, id, opts) {\r\n    const record = this.getCollection(name).remove(id, opts)\r\n    if (record) {\r\n      this.removeRelated(name, [record], opts)\r\n    }\r\n    return record\r\n  },\r\n\r\n  /**\r\n   * Wrapper for {@link Collection#removeAll}. Removes the selected\r\n   * {@link Record}s from the store.\r\n   *\r\n   * @example <caption>SimpleStore#removeAll</caption>\r\n   * const JSData = require('js-data');\r\n   * const { SimpleStore } = JSData;\r\n   * console.log('Using JSData v' + JSData.version.full);\r\n   *\r\n   * const store = new SimpleStore();\r\n   * store.defineMapper('movie');\r\n   * console.log(store.getAll('movie').length);\r\n   * store.add('movie', [{ id: 3, rating: 'R' }, { id: 4, rating: 'PG-13' });\r\n   * console.log(store.getAll('movie').length);\r\n   * store.removeAll('movie', { rating: 'R' });\r\n   * console.log(store.getAll('movie').length);\r\n   *\r\n   * @fires SimpleStore#remove\r\n   * @method SimpleStore#removeAll\r\n   * @param {string} name The name of the {@link Collection} to target.\r\n   * @param {object} [query={}] Selection query. See {@link query}.\r\n   * @param {object} [query.where] See {@link query.where}.\r\n   * @param {number} [query.offset] See {@link query.offset}.\r\n   * @param {number} [query.limit] See {@link query.limit}.\r\n   * @param {string|Array[]} [query.orderBy] See {@link query.orderBy}.\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {string[]} [opts.with] Relations of the {@link Record} to also\r\n   * remove from the store.\r\n   * @returns {Record} The removed {@link Record}s, if any.\r\n   * @see Collection#add\r\n   * @see Collection#add\r\n   * @since 3.0.0\r\n   */\r\n  removeAll (name, query, opts) {\r\n    if (!query || !Object.keys(query).length) {\r\n      this._completedQueries[name] = {}\r\n    } else {\r\n      this._completedQueries[name][this.hashQuery(name, query, opts)] = undefined\r\n    }\r\n    const records = this.getCollection(name).removeAll(query, opts)\r\n    if (records.length) {\r\n      this.removeRelated(name, records, opts)\r\n    }\r\n    return records\r\n  },\r\n\r\n  /**\r\n   * Remove from the store {@link Record}s that are related to the provided\r\n   * {@link Record}(s).\r\n   *\r\n   * @fires SimpleStore#remove\r\n   * @method SimpleStore#removeRelated\r\n   * @param {string} name The name of the {@link Collection} to target.\r\n   * @param {Record|Record[]} records {@link Record}s whose relations are to be\r\n   * removed.\r\n   * @param {object} [opts] Configuration options.\r\n   * @param {string[]} [opts.with] Relations of the {@link Record}(s) to remove\r\n   * from the store.\r\n   * @since 3.0.0\r\n   */\r\n  removeRelated (name, records, opts) {\r\n    if (!utils.isArray(records)) {\r\n      records = [records]\r\n    }\r\n    utils.forEachRelation(this.getMapper(name), opts, (def, optsCopy) => {\r\n      records.forEach((record) => {\r\n        let relatedData\r\n        let query\r\n        if (def.foreignKey && (def.type === hasOneType || def.type === hasManyType)) {\r\n          query = { [def.foreignKey]: def.getForeignKey(record) }\r\n        } else if (def.type === hasManyType && def.localKeys) {\r\n          query = {\r\n            where: {\r\n              [def.getRelation().idAttribute]: {\r\n                in: utils.get(record, def.localKeys)\r\n              }\r\n            }\r\n          }\r\n        } else if (def.type === hasManyType && def.foreignKeys) {\r\n          query = {\r\n            where: {\r\n              [def.foreignKeys]: {\r\n                contains: def.getForeignKey(record)\r\n              }\r\n            }\r\n          }\r\n        } else if (def.type === belongsToType) {\r\n          relatedData = this.remove(def.relation, def.getForeignKey(record), optsCopy)\r\n        }\r\n        if (query) {\r\n          relatedData = this.removeAll(def.relation, query, optsCopy)\r\n        }\r\n        if (relatedData) {\r\n          if (utils.isArray(relatedData) && !relatedData.length) {\r\n            return\r\n          }\r\n          if (def.type === hasOneType) {\r\n            relatedData = relatedData[0]\r\n          }\r\n          def.setLocalField(record, relatedData)\r\n        }\r\n      })\r\n    })\r\n  },\r\n\r\n  /**\r\n   * Fired during {@link SimpleStore#update}. See\r\n   * {@link SimpleStore~beforeUpdateListener} for how to listen for this event.\r\n   *\r\n   * @event SimpleStore#beforeUpdate\r\n   * @see SimpleStore~beforeUpdateListener\r\n   * @see SimpleStore#update\r\n   */\r\n  /**\r\n   * Callback signature for the {@link SimpleStore#event:beforeUpdate} event.\r\n   *\r\n   * @example\r\n   * function onBeforeUpdate (mapperName, id, props, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeUpdate', onBeforeUpdate);\r\n   *\r\n   * @callback SimpleStore~beforeUpdateListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#beforeUpdate}.\r\n   * @param {string|number} id The `id` argument received by {@link Mapper#beforeUpdate}.\r\n   * @param {object} props The `props` argument received by {@link Mapper#beforeUpdate}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeUpdate}.\r\n   * @see SimpleStore#event:beforeUpdate\r\n   * @see SimpleStore#update\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link SimpleStore#update}. See\r\n   * {@link SimpleStore~afterUpdateListener} for how to listen for this event.\r\n   *\r\n   * @event SimpleStore#afterUpdate\r\n   * @see SimpleStore~afterUpdateListener\r\n   * @see SimpleStore#update\r\n   */\r\n  /**\r\n   * Callback signature for the {@link SimpleStore#event:afterUpdate} event.\r\n   *\r\n   * @example\r\n   * function onAfterUpdate (mapperName, id, props, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterUpdate', onAfterUpdate);\r\n   *\r\n   * @callback SimpleStore~afterUpdateListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#afterUpdate}.\r\n   * @param {string|number} id The `id` argument received by {@link Mapper#afterUpdate}.\r\n   * @param {object} props The `props` argument received by {@link Mapper#afterUpdate}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterUpdate}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterUpdate}.\r\n   * @see SimpleStore#event:afterUpdate\r\n   * @see SimpleStore#update\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Wrapper for {@link Mapper#update}. Adds the updated {@link Record} to the\r\n   * store.\r\n   *\r\n   * @example\r\n   * import { SimpleStore } from 'js-data';\r\n   * import { HttpAdapter } from 'js-data-http';\r\n   *\r\n   * const store = new SimpleStore();\r\n   * store.registerAdapter('http', new HttpAdapter(), { default: true });\r\n   *\r\n   * store.defineMapper('post');\r\n   *\r\n   * // Since this example uses the http adapter, we'll get something like:\r\n   * //\r\n   * //   PUT /post/1234 {\"status\":\"published\"}\r\n   * store.update('post', 1, { status: 'published' }).then((post) => {\r\n   *   // The post record has also been updated in the in-memory store\r\n   *   console.log(store.get('post', 1234));\r\n   * });\r\n   *\r\n   * @fires SimpleStore#beforeUpdate\r\n   * @fires SimpleStore#afterUpdate\r\n   * @fires SimpleStore#add\r\n   * @method SimpleStore#update\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {(string|number)} id Passed to {@link Mapper#update}.\r\n   * @param {object} record Passed to {@link Mapper#update}.\r\n   * @param {object} [opts] Passed to {@link Mapper#update}. See\r\n   * {@link Mapper#update} for more configuration options.\r\n   * @returns {Promise} Resolves with the result of the update.\r\n   * @since 3.0.0\r\n   */\r\n  update (name, id, record, opts) {\r\n    opts || (opts = {})\r\n    return Container.prototype.update.call(this, name, id, record, opts)\r\n      .then((result) => this._end(name, result, opts))\r\n  },\r\n\r\n  /**\r\n   * Fired during {@link SimpleStore#updateAll}. See\r\n   * {@link SimpleStore~beforeUpdateAllListener} for how to listen for this event.\r\n   *\r\n   * @event SimpleStore#beforeUpdateAll\r\n   * @see SimpleStore~beforeUpdateAllListener\r\n   * @see SimpleStore#updateAll\r\n   */\r\n  /**\r\n   * Callback signature for the {@link SimpleStore#event:beforeUpdateAll} event.\r\n   *\r\n   * @example\r\n   * function onBeforeUpdateAll (mapperName, props, query, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeUpdateAll', onBeforeUpdateAll);\r\n   *\r\n   * @callback SimpleStore~beforeUpdateAllListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#beforeUpdateAll}.\r\n   * @param {object} props The `props` argument received by {@link Mapper#beforeUpdateAll}.\r\n   * @param {object} query The `query` argument received by {@link Mapper#beforeUpdateAll}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeUpdateAll}.\r\n   * @see SimpleStore#event:beforeUpdateAll\r\n   * @see SimpleStore#updateAll\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link SimpleStore#updateAll}. See\r\n   * {@link SimpleStore~afterUpdateAllListener} for how to listen for this event.\r\n   *\r\n   * @event SimpleStore#afterUpdateAll\r\n   * @see SimpleStore~afterUpdateAllListener\r\n   * @see SimpleStore#updateAll\r\n   */\r\n  /**\r\n   * Callback signature for the {@link SimpleStore#event:afterUpdateAll} event.\r\n   *\r\n   * @example\r\n   * function onAfterUpdateAll (mapperName, props, query, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterUpdateAll', onAfterUpdateAll);\r\n   *\r\n   * @callback SimpleStore~afterUpdateAllListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#afterUpdateAll}.\r\n   * @param {object} props The `props` argument received by {@link Mapper#afterUpdateAll}.\r\n   * @param {object} query The `query` argument received by {@link Mapper#afterUpdateAll}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterUpdateAll}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterUpdateAll}.\r\n   * @see SimpleStore#event:afterUpdateAll\r\n   * @see SimpleStore#updateAll\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Wrapper for {@link Mapper#updateAll}. Adds the updated {@link Record}s to\r\n   * the store.\r\n   *\r\n   * @example\r\n   * import { SimpleStore } from 'js-data';\r\n   * import { HttpAdapter } from 'js-data-http';\r\n   *\r\n   * const store = new SimpleStore();\r\n   * store.registerAdapter('http', new HttpAdapter(), { default: true });\r\n   *\r\n   * store.defineMapper('post');\r\n   *\r\n   * // Since this example uses the http adapter, we'll get something like:\r\n   * //\r\n   * //   PUT /post?author_id=1234 {\"status\":\"published\"}\r\n   * store.updateAll('post', { author_id: 1234 }, { status: 'published' }).then((posts) => {\r\n   *   // The post records have also been updated in the in-memory store\r\n   *   console.log(store.filter('posts', { author_id: 1234 }));\r\n   * });\r\n   *\r\n   * @fires SimpleStore#beforeUpdateAll\r\n   * @fires SimpleStore#afterUpdateAll\r\n   * @fires SimpleStore#add\r\n   * @method SimpleStore#updateAll\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {object} props Passed to {@link Mapper#updateAll}.\r\n   * @param {object} [query] Passed to {@link Mapper#updateAll}.\r\n   * @param {object} [opts] Passed to {@link Mapper#updateAll}. See\r\n   * {@link Mapper#updateAll} for more configuration options.\r\n   * @returns {Promise} Resolves with the result of the update.\r\n   * @since 3.0.0\r\n   */\r\n  updateAll (name, props, query, opts) {\r\n    opts || (opts = {})\r\n    return Container.prototype.updateAll.call(this, name, props, query, opts)\r\n      .then((result) => this._end(name, result, opts))\r\n  },\r\n\r\n  /**\r\n   * Fired during {@link SimpleStore#updateMany}. See\r\n   * {@link SimpleStore~beforeUpdateManyListener} for how to listen for this event.\r\n   *\r\n   * @event SimpleStore#beforeUpdateMany\r\n   * @see SimpleStore~beforeUpdateManyListener\r\n   * @see SimpleStore#updateMany\r\n   */\r\n  /**\r\n   * Callback signature for the {@link SimpleStore#event:beforeUpdateMany} event.\r\n   *\r\n   * @example\r\n   * function onBeforeUpdateMany (mapperName, records, opts) {\r\n   *   // do something\r\n   * }\r\n   * store.on('beforeUpdateMany', onBeforeUpdateMany);\r\n   *\r\n   * @callback SimpleStore~beforeUpdateManyListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#beforeUpdateMany}.\r\n   * @param {object} records The `records` argument received by {@link Mapper#beforeUpdateMany}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#beforeUpdateMany}.\r\n   * @see SimpleStore#event:beforeUpdateMany\r\n   * @see SimpleStore#updateMany\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Fired during {@link SimpleStore#updateMany}. See\r\n   * {@link SimpleStore~afterUpdateManyListener} for how to listen for this event.\r\n   *\r\n   * @event SimpleStore#afterUpdateMany\r\n   * @see SimpleStore~afterUpdateManyListener\r\n   * @see SimpleStore#updateMany\r\n   */\r\n  /**\r\n   * Callback signature for the {@link SimpleStore#event:afterUpdateMany} event.\r\n   *\r\n   * @example\r\n   * function onAfterUpdateMany (mapperName, records, opts, result) {\r\n   *   // do something\r\n   * }\r\n   * store.on('afterUpdateMany', onAfterUpdateMany);\r\n   *\r\n   * @callback SimpleStore~afterUpdateManyListener\r\n   * @param {string} name The `name` argument received by {@link Mapper#afterUpdateMany}.\r\n   * @param {object} records The `records` argument received by {@link Mapper#afterUpdateMany}.\r\n   * @param {object} opts The `opts` argument received by {@link Mapper#afterUpdateMany}.\r\n   * @param {object} result The `result` argument received by {@link Mapper#afterUpdateMany}.\r\n   * @see SimpleStore#event:afterUpdateMany\r\n   * @see SimpleStore#updateMany\r\n   * @since 3.0.0\r\n   */\r\n  /**\r\n   * Wrapper for {@link Mapper#updateMany}. Adds the updated {@link Record}s to\r\n   * the store.\r\n   *\r\n   * @example\r\n   * import { SimpleStore } from 'js-data';\r\n   * import { HttpAdapter } from 'js-data-http';\r\n   *\r\n   * const store = new SimpleStore();\r\n   * store.registerAdapter('http', new HttpAdapter(), { default: true });\r\n   *\r\n   * store.defineMapper('post');\r\n   *\r\n   * // Since this example uses the http adapter, we'll get something like:\r\n   * //\r\n   * //   PUT /post [{\"id\":3,status\":\"published\"},{\"id\":4,status\":\"published\"}]\r\n   * store.updateMany('post', [\r\n   *   { id: 3, status: 'published' },\r\n   *   { id: 4, status: 'published' }\r\n   * ]).then((posts) => {\r\n   *   // The post records have also been updated in the in-memory store\r\n   *   console.log(store.getAll('post', 3, 4));\r\n   * });\r\n   *\r\n   * @fires SimpleStore#beforeUpdateMany\r\n   * @fires SimpleStore#afterUpdateMany\r\n   * @fires SimpleStore#add\r\n   * @method SimpleStore#updateMany\r\n   * @param {string} name Name of the {@link Mapper} to target.\r\n   * @param {(Object[]|Record[])} records Passed to {@link Mapper#updateMany}.\r\n   * @param {object} [opts] Passed to {@link Mapper#updateMany}. See\r\n   * {@link Mapper#updateMany} for more configuration options.\r\n   * @returns {Promise} Resolves with the result of the update.\r\n   * @since 3.0.0\r\n   */\r\n  updateMany (name, records, opts) {\r\n    opts || (opts = {})\r\n    return Container.prototype.updateMany.call(this, name, records, opts)\r\n      .then((result) => this._end(name, result, opts))\r\n  }\r\n}\r\n\r\nproxiedCollectionMethods.forEach(function (method) {\r\n  props[method] = function (name, ...args) {\r\n    return this.getCollection(name)[method](...args)\r\n  }\r\n})\r\n\r\nexport default Container.extend(props)\r\n\r\n/**\r\n * Fired when a record changes. Only works for records that have tracked fields.\r\n * See {@link SimpleStore~changeListener} on how to listen for this event.\r\n *\r\n * @event SimpleStore#change\r\n * @see SimpleStore~changeListener\r\n */\r\n\r\n/**\r\n * Callback signature for the {@link SimpleStore#event:change} event.\r\n *\r\n * @example\r\n * function onChange (mapperName, record, changes) {\r\n *   // do something\r\n * }\r\n * store.on('change', onChange);\r\n *\r\n * @callback SimpleStore~changeListener\r\n * @param {string} name The name of the associated {@link Mapper}.\r\n * @param {Record} record The Record that changed.\r\n * @param {object} changes The changes.\r\n * @see SimpleStore#event:change\r\n * @since 3.0.0\r\n */\r\n\r\n/**\r\n * Fired when one or more records are added to the in-memory store. See\r\n * {@link SimpleStore~addListener} on how to listen for this event.\r\n *\r\n * @event SimpleStore#add\r\n * @see SimpleStore~addListener\r\n * @see SimpleStore#event:add\r\n * @see SimpleStore#add\r\n * @see SimpleStore#create\r\n * @see SimpleStore#createMany\r\n * @see SimpleStore#find\r\n * @see SimpleStore#findAll\r\n * @see SimpleStore#update\r\n * @see SimpleStore#updateAll\r\n * @see SimpleStore#updateMany\r\n */\r\n\r\n/**\r\n * Callback signature for the {@link SimpleStore#event:add} event.\r\n *\r\n * @example\r\n * function onAdd (mapperName, recordOrRecords) {\r\n *   // do something\r\n * }\r\n * store.on('add', onAdd);\r\n *\r\n * @callback SimpleStore~addListener\r\n * @param {string} name The name of the associated {@link Mapper}.\r\n * @param {Record|Record[]} The Record or Records that were added.\r\n * @see SimpleStore#event:add\r\n * @see SimpleStore#add\r\n * @see SimpleStore#create\r\n * @see SimpleStore#createMany\r\n * @see SimpleStore#find\r\n * @see SimpleStore#findAll\r\n * @see SimpleStore#update\r\n * @see SimpleStore#updateAll\r\n * @see SimpleStore#updateMany\r\n * @since 3.0.0\r\n */\r\n\r\n/**\r\n * Fired when one or more records are removed from the in-memory store. See\r\n * {@link SimpleStore~removeListener} for how to listen for this event.\r\n *\r\n * @event SimpleStore#remove\r\n * @see SimpleStore~removeListener\r\n * @see SimpleStore#event:remove\r\n * @see SimpleStore#clear\r\n * @see SimpleStore#destroy\r\n * @see SimpleStore#destroyAll\r\n * @see SimpleStore#remove\r\n * @see SimpleStore#removeAll\r\n */\r\n\r\n/**\r\n * Callback signature for the {@link SimpleStore#event:remove} event.\r\n *\r\n * @example\r\n * function onRemove (mapperName, recordsOrRecords) {\r\n *   // do something\r\n * }\r\n * store.on('remove', onRemove);\r\n *\r\n * @callback SimpleStore~removeListener\r\n * @param {string} name The name of the associated {@link Mapper}.\r\n * @param {Record|Record[]} Record or Records that were removed.\r\n * @see SimpleStore#event:remove\r\n * @see SimpleStore#clear\r\n * @see SimpleStore#destroy\r\n * @see SimpleStore#destroyAll\r\n * @see SimpleStore#remove\r\n * @see SimpleStore#removeAll\r\n * @since 3.0.0\r\n */\r\n\r\n/**\r\n * Create a subclass of this SimpleStore:\r\n * @example <caption>SimpleStore.extend</caption>\r\n * const JSData = require('js-data');\r\n * const { SimpleStore } = JSData;\r\n * console.log('Using JSData v' + JSData.version.full);\r\n *\r\n * // Extend the class using ES2015 class syntax.\r\n * class CustomSimpleStoreClass extends SimpleStore {\r\n *   foo () { return 'bar'; }\r\n *   static beep () { return 'boop'; }\r\n * }\r\n * const customSimpleStore = new CustomSimpleStoreClass();\r\n * console.log(customSimpleStore.foo());\r\n * console.log(CustomSimpleStoreClass.beep());\r\n *\r\n * // Extend the class using alternate method.\r\n * const OtherSimpleStoreClass = SimpleStore.extend({\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * })\r\n * const otherSimpleStore = new OtherSimpleStoreClass();\r\n * console.log(otherSimpleStore.foo());\r\n * console.log(OtherSimpleStoreClass.beep());\r\n *\r\n * // Extend the class, providing a custom constructor.\r\n * function AnotherSimpleStoreClass () {\r\n *   SimpleStore.call(this)\r\n *   this.created_at = new Date().getTime()\r\n * }\r\n * SimpleStore.extend({\r\n *   constructor: AnotherSimpleStoreClass,\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * })\r\n * const anotherSimpleStore = new AnotherSimpleStoreClass();\r\n * console.log(anotherSimpleStore.created_at);\r\n * console.log(anotherSimpleStore.foo());\r\n * console.log(AnotherSimpleStoreClass.beep());\r\n *\r\n * @method SimpleStore.extend\r\n * @param {object} [props={}] Properties to add to the prototype of the\r\n * subclass.\r\n * @param {object} [props.constructor] Provide a custom constructor function\r\n * to be used as the subclass itself.\r\n * @param {object} [classProps={}] Static properties to add to the subclass.\r\n * @returns {Constructor} Subclass of this SimpleStore class.\r\n * @since 3.0.0\r\n */\r\n","import utils from './utils'\r\nimport './decorators'\r\nimport Collection from './Collection'\r\n\r\nconst DOMAIN = 'LinkedCollection'\r\n\r\n/**\r\n * Extends {@link Collection}. Used by a {@link DataStore} to implement an\r\n * Identity Map.\r\n *\r\n * ```javascript\r\n * import {LinkedCollection} from 'js-data'\r\n * ```\r\n *\r\n * @class LinkedCollection\r\n * @extends Collection\r\n * @param {array} [records] Initial set of records to insert into the\r\n * collection. See {@link Collection}.\r\n * @param {object} [opts] Configuration options. See {@link Collection}.\r\n * @returns {Mapper}\r\n */\r\nfunction LinkedCollection (records, opts) {\r\n  utils.classCallCheck(this, LinkedCollection)\r\n  // Make sure this collection has somewhere to store \"added\" timestamps\r\n  Object.defineProperties(this, {\r\n    _added: {\r\n      value: {}\r\n    },\r\n    datastore: {\r\n      writable: true,\r\n      value: undefined\r\n    }\r\n  })\r\n\r\n  Collection.call(this, records, opts)\r\n\r\n  // Make sure this collection has a reference to a datastore\r\n  if (!this.datastore) {\r\n    throw utils.err(`new ${DOMAIN}`, 'opts.datastore')(400, 'DataStore', this.datastore)\r\n  }\r\n}\r\n\r\nexport default Collection.extend({\r\n  constructor: LinkedCollection,\r\n\r\n  _addMeta (record, timestamp) {\r\n    // Track when this record was added\r\n    this._added[this.recordId(record)] = timestamp\r\n\r\n    if (utils.isFunction(record._set)) {\r\n      record._set('$', timestamp)\r\n    }\r\n  },\r\n\r\n  _clearMeta (record) {\r\n    delete this._added[this.recordId(record)]\r\n    if (utils.isFunction(record._set)) {\r\n      record._set('$') // unset\r\n    }\r\n  },\r\n\r\n  _onRecordEvent (...args) {\r\n    Collection.prototype._onRecordEvent.apply(this, args)\r\n    const event = args[0]\r\n    // This is a very brute force method\r\n    // Lots of room for optimization\r\n    if (utils.isString(event) && event.indexOf('change') === 0) {\r\n      this.updateIndexes(args[1])\r\n    }\r\n  },\r\n\r\n  add (records, opts) {\r\n    const mapper = this.mapper\r\n    const timestamp = new Date().getTime()\r\n    const singular = utils.isObject(records) && !utils.isArray(records)\r\n\r\n    if (singular) {\r\n      records = [records]\r\n    }\r\n    records = Collection.prototype.add.call(this, records, opts)\r\n\r\n    if (mapper.relationList.length && records.length) {\r\n      // Check the currently visited record for relations that need to be\r\n      // inserted into their respective collections.\r\n      mapper.relationList.forEach(function (def) {\r\n        def.addLinkedRecords(records)\r\n      })\r\n    }\r\n\r\n    records.forEach((record) => this._addMeta(record, timestamp))\r\n\r\n    return singular ? records[0] : records\r\n  },\r\n\r\n  remove (idOrRecord, opts) {\r\n    const mapper = this.mapper\r\n    const record = Collection.prototype.remove.call(this, idOrRecord, opts)\r\n    if (record) {\r\n      this._clearMeta(record)\r\n    }\r\n\r\n    if (mapper.relationList.length && record) {\r\n      mapper.relationList.forEach(function (def) {\r\n        def.removeLinkedRecords(mapper, [record])\r\n      })\r\n    }\r\n\r\n    return record\r\n  },\r\n\r\n  removeAll (query, opts) {\r\n    const mapper = this.mapper\r\n    const records = Collection.prototype.removeAll.call(this, query, opts)\r\n    records.forEach(this._clearMeta, this)\r\n\r\n    if (mapper.relationList.length && records.length) {\r\n      mapper.relationList.forEach(function (def) {\r\n        def.removeLinkedRecords(mapper, records)\r\n      })\r\n    }\r\n\r\n    return records\r\n  }\r\n})\r\n\r\n/**\r\n * Create a subclass of this LinkedCollection:\r\n *\r\n * @example <caption>LinkedCollection.extend</caption>\r\n * const JSData = require('js-data');\r\n * const { LinkedCollection } = JSData;\r\n * console.log('Using JSData v' + JSData.version.full);\r\n *\r\n * // Extend the class using ES2015 class syntax.\r\n * class CustomLinkedCollectionClass extends LinkedCollection {\r\n *   foo () { return 'bar'; }\r\n *   static beep () { return 'boop'; }\r\n * }\r\n * const customLinkedCollection = new CustomLinkedCollectionClass();\r\n * console.log(customLinkedCollection.foo());\r\n * console.log(CustomLinkedCollectionClass.beep());\r\n *\r\n * // Extend the class using alternate method.\r\n * const OtherLinkedCollectionClass = LinkedCollection.extend({\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * });\r\n * const otherLinkedCollection = new OtherLinkedCollectionClass();\r\n * console.log(otherLinkedCollection.foo());\r\n * console.log(OtherLinkedCollectionClass.beep());\r\n *\r\n * // Extend the class, providing a custom constructor.\r\n * function AnotherLinkedCollectionClass () {\r\n *   LinkedCollection.call(this);\r\n *   this.created_at = new Date().getTime();\r\n * }\r\n * LinkedCollection.extend({\r\n *   constructor: AnotherLinkedCollectionClass,\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * });\r\n * const anotherLinkedCollection = new AnotherLinkedCollectionClass();\r\n * console.log(anotherLinkedCollection.created_at);\r\n * console.log(anotherLinkedCollection.foo());\r\n * console.log(AnotherLinkedCollectionClass.beep());\r\n *\r\n * @method LinkedCollection.extend\r\n * @param {object} [props={}] Properties to add to the prototype of the\r\n * subclass.\r\n * @param {object} [props.constructor] Provide a custom constructor function\r\n * to be used as the subclass itself.\r\n * @param {object} [classProps={}] Static properties to add to the subclass.\r\n * @returns {Constructor} Subclass of this LinkedCollection class.\r\n * @since 3.0.0\r\n */\r\n","import utils, { safeSetLink, safeSetProp } from './utils'\r\n\r\nimport {\r\n  belongsToType,\r\n  hasManyType,\r\n  hasOneType\r\n} from './decorators'\r\nimport SimpleStore from './SimpleStore'\r\nimport LinkedCollection from './LinkedCollection'\r\n\r\nconst DATASTORE_DEFAULTS = {\r\n  /**\r\n   * Whether in-memory relations should be unlinked from records after they are\r\n   * destroyed.\r\n   *\r\n   * @default true\r\n   * @name DataStore#unlinkOnDestroy\r\n   * @since 3.0.0\r\n   * @type {boolean}\r\n   */\r\n  unlinkOnDestroy: true\r\n}\r\n\r\n/**\r\n * The `DataStore` class is an extension of {@link SimpleStore}. Not only does\r\n * `DataStore` manage mappers and store data in collections, it uses the\r\n * {@link LinkedCollection} class to link related records together in memory.\r\n *\r\n * ```javascript\r\n * import { DataStore } from 'js-data';\r\n * ```\r\n *\r\n * @example\r\n * import { DataStore } from 'js-data';\r\n * import HttpAdapter from 'js-data-http';\r\n * const store = new DataStore();\r\n *\r\n * // DataStore#defineMapper returns a direct reference to the newly created\r\n * // Mapper.\r\n * const UserMapper = store.defineMapper('user');\r\n *\r\n * // DataStore#as returns the store scoped to a particular Mapper.\r\n * const UserStore = store.as('user');\r\n *\r\n * // Call \"find\" on \"UserMapper\" (Stateless ORM)\r\n * UserMapper.find(1).then((user) => {\r\n *   // retrieved a \"user\" record via the http adapter, but that's it\r\n *\r\n *   // Call \"find\" on \"store\" targeting \"user\" (Stateful DataStore)\r\n *   return store.find('user', 1); // same as \"UserStore.find(1)\"\r\n * }).then((user) => {\r\n *   // not only was a \"user\" record retrieved, but it was added to the\r\n *   // store's \"user\" collection\r\n *   const cachedUser = store.getCollection('user').get(1);\r\n *   console.log(user === cachedUser); // true\r\n * });\r\n *\r\n * @class DataStore\r\n * @extends SimpleStore\r\n * @param {object} [opts] Configuration options. See {@link SimpleStore}.\r\n * @param {boolean} [opts.collectionClass={@link LinkedCollection}] See {@link DataStore#collectionClass}.\r\n * @param {boolean} [opts.debug=false] See {@link Component#debug}.\r\n * @param {boolean} [opts.unlinkOnDestroy=true] See {@link DataStore#unlinkOnDestroy}.\r\n * @param {boolean|Function} [opts.usePendingFind=true] See {@link DataStore#usePendingFind}.\r\n * @param {boolean|Function} [opts.usePendingFindAll=true] See {@link DataStore#usePendingFindAll}.\r\n * @returns {DataStore}\r\n * @see SimpleStore\r\n * @since 3.0.0\r\n * @tutorial [\"http://www.js-data.io/v3.0/docs/components-of-jsdata#datastore\",\"Components of JSData: DataStore\"]\r\n * @tutorial [\"http://www.js-data.io/v3.0/docs/working-with-the-datastore\",\"Working with the DataStore\"]\r\n * @tutorial [\"http://www.js-data.io/v3.0/docs/jsdata-and-the-browser\",\"Notes on using JSData in the Browser\"]\r\n */\r\nfunction DataStore (opts) {\r\n  utils.classCallCheck(this, DataStore)\r\n\r\n  opts || (opts = {})\r\n  // Fill in any missing options with the defaults\r\n  utils.fillIn(opts, DATASTORE_DEFAULTS)\r\n  opts.collectionClass || (opts.collectionClass = LinkedCollection)\r\n  SimpleStore.call(this, opts)\r\n}\r\n\r\nconst props = {\r\n  constructor: DataStore,\r\n\r\n  defineMapper (name, opts) {\r\n    // Complexity of this method is beyond simply using => functions to bind context\r\n    const self = this\r\n    const mapper = SimpleStore.prototype.defineMapper.call(self, name, opts)\r\n    const idAttribute = mapper.idAttribute\r\n    const collection = this.getCollection(name)\r\n\r\n    mapper.relationList.forEach(function (def) {\r\n      const relation = def.relation\r\n      const localField = def.localField\r\n      const path = `links.${localField}`\r\n      const foreignKey = def.foreignKey\r\n      const type = def.type\r\n      const updateOpts = { index: foreignKey }\r\n      let descriptor\r\n\r\n      const getter = function () { return this._get(path) }\r\n\r\n      if (type === belongsToType) {\r\n        if (!collection.indexes[foreignKey]) {\r\n          collection.createIndex(foreignKey)\r\n        }\r\n\r\n        descriptor = {\r\n          get: getter,\r\n          // e.g. profile.user = someUser\r\n          // or comment.post = somePost\r\n          set (record) {\r\n            // e.g. const otherUser = profile.user\r\n            const currentParent = this._get(path)\r\n            // e.g. profile.user === someUser\r\n            if (record === currentParent) {\r\n              return currentParent\r\n            }\r\n            const id = utils.get(this, idAttribute)\r\n            const inverseDef = def.getInverse(mapper)\r\n\r\n            // e.g. profile.user !== someUser\r\n            // or comment.post !== somePost\r\n            if (currentParent && inverseDef) {\r\n              this.removeInverseRelation(currentParent, id, inverseDef, idAttribute)\r\n            }\r\n            if (record) {\r\n              // e.g. profile.user = someUser\r\n              const relatedIdAttribute = def.getRelation().idAttribute\r\n              const relatedId = utils.get(record, relatedIdAttribute)\r\n\r\n              // Prefer store record\r\n              if (relatedId !== undefined && this._get('$')) {\r\n                record = self.get(relation, relatedId) || record\r\n              }\r\n\r\n              // Set locals\r\n              // e.g. profile.user = someUser\r\n              // or comment.post = somePost\r\n              safeSetLink(this, localField, record)\r\n              safeSetProp(this, foreignKey, relatedId)\r\n              collection.updateIndex(this, updateOpts)\r\n\r\n              if (inverseDef) {\r\n                this.setupInverseRelation(record, id, inverseDef, idAttribute)\r\n              }\r\n            } else {\r\n              // Unset in-memory link only\r\n              // e.g. profile.user = undefined\r\n              // or comment.post = undefined\r\n              safeSetLink(this, localField, undefined)\r\n            }\r\n            return record\r\n          }\r\n        }\r\n\r\n        let foreignKeyDescriptor = Object.getOwnPropertyDescriptor(mapper.recordClass.prototype, foreignKey)\r\n        if (!foreignKeyDescriptor) {\r\n          foreignKeyDescriptor = {\r\n            enumerable: true\r\n          }\r\n        }\r\n        const originalGet = foreignKeyDescriptor.get\r\n        foreignKeyDescriptor.get = function () {\r\n          if (originalGet) {\r\n            return originalGet.call(this)\r\n          }\r\n          return this._get(`props.${foreignKey}`)\r\n        }\r\n        const originalSet = foreignKeyDescriptor.set\r\n        foreignKeyDescriptor.set = function (value) {\r\n          if (originalSet) {\r\n            originalSet.call(this, value)\r\n          }\r\n          const currentParent = utils.get(this, localField)\r\n          const id = utils.get(this, idAttribute)\r\n          const inverseDef = def.getInverse(mapper)\r\n          const currentParentId = currentParent ? utils.get(currentParent, def.getRelation().idAttribute) : undefined\r\n\r\n          if (inverseDef && currentParent && currentParentId !== undefined && currentParentId !== value) {\r\n            if (inverseDef.type === hasOneType) {\r\n              safeSetLink(currentParent, inverseDef.localField, undefined)\r\n            } else if (inverseDef.type === hasManyType) {\r\n              const children = utils.get(currentParent, inverseDef.localField)\r\n              if (id === undefined) {\r\n                utils.remove(children, (child) => child === this)\r\n              } else {\r\n                utils.remove(children, (child) => child === this || id === utils.get(child, idAttribute))\r\n              }\r\n            }\r\n          }\r\n\r\n          safeSetProp(this, foreignKey, value)\r\n          collection.updateIndex(this, updateOpts)\r\n\r\n          if ((value === undefined || value === null)) {\r\n            if (currentParentId !== undefined) {\r\n              // Unset locals\r\n              utils.set(this, localField, undefined)\r\n            }\r\n          } else if (this._get('$')) {\r\n            const storeRecord = self.get(relation, value)\r\n            if (storeRecord) {\r\n              utils.set(this, localField, storeRecord)\r\n            }\r\n          }\r\n        }\r\n        Object.defineProperty(mapper.recordClass.prototype, foreignKey, foreignKeyDescriptor)\r\n      } else if (type === hasManyType) {\r\n        const localKeys = def.localKeys\r\n        const foreignKeys = def.foreignKeys\r\n\r\n        // TODO: Handle case when belongsTo relation isn't ever defined\r\n        if (self._collections[relation] && foreignKey && !self.getCollection(relation).indexes[foreignKey]) {\r\n          self.getCollection(relation).createIndex(foreignKey)\r\n        }\r\n\r\n        descriptor = {\r\n          get () {\r\n            const current = getter.call(this)\r\n            if (!current) {\r\n              this._set(path, [])\r\n            }\r\n            return getter.call(this)\r\n          },\r\n          // e.g. post.comments = someComments\r\n          // or user.groups = someGroups\r\n          // or group.users = someUsers\r\n          set (records) {\r\n            if (records && !utils.isArray(records)) {\r\n              records = [records]\r\n            }\r\n            const id = utils.get(this, idAttribute)\r\n            const relatedIdAttribute = def.getRelation().idAttribute\r\n            const inverseDef = def.getInverse(mapper)\r\n            const inverseLocalField = inverseDef.localField\r\n            const current = this._get(path) || []\r\n            const toLink = []\r\n            const toLinkIds = {}\r\n\r\n            if (records) {\r\n              records.forEach((record) => {\r\n                // e.g. comment.id\r\n                const relatedId = utils.get(record, relatedIdAttribute)\r\n                const currentParent = utils.get(record, inverseLocalField)\r\n                if (currentParent && currentParent !== this) {\r\n                  const currentChildrenOfParent = utils.get(currentParent, localField)\r\n                  // e.g. somePost.comments.remove(comment)\r\n                  if (relatedId === undefined) {\r\n                    utils.remove(currentChildrenOfParent, (child) => child === record)\r\n                  } else {\r\n                    utils.remove(currentChildrenOfParent, (child) => child === record || relatedId === utils.get(child, relatedIdAttribute))\r\n                  }\r\n                }\r\n                if (relatedId !== undefined) {\r\n                  if (this._get('$')) {\r\n                    // Prefer store record\r\n                    record = self.get(relation, relatedId) || record\r\n                  }\r\n                  // e.g. toLinkIds[comment.id] = comment\r\n                  toLinkIds[relatedId] = record\r\n                }\r\n                toLink.push(record)\r\n              })\r\n            }\r\n\r\n            // e.g. post.comments = someComments\r\n            if (foreignKey) {\r\n              current.forEach((record) => {\r\n                // e.g. comment.id\r\n                const relatedId = utils.get(record, relatedIdAttribute)\r\n                if ((relatedId === undefined && toLink.indexOf(record) === -1) || (relatedId !== undefined && !(relatedId in toLinkIds))) {\r\n                  // Update (unset) inverse relation\r\n                  if (records) {\r\n                    // e.g. comment.post_id = undefined\r\n                    safeSetProp(record, foreignKey, undefined)\r\n                    // e.g. CommentCollection.updateIndex(comment, { index: 'post_id' })\r\n                    self.getCollection(relation).updateIndex(record, updateOpts)\r\n                  }\r\n                  // e.g. comment.post = undefined\r\n                  safeSetLink(record, inverseLocalField, undefined)\r\n                }\r\n              })\r\n              toLink.forEach((record) => {\r\n                // Update (set) inverse relation\r\n                // e.g. comment.post_id = post.id\r\n                safeSetProp(record, foreignKey, id)\r\n                // e.g. CommentCollection.updateIndex(comment, { index: 'post_id' })\r\n                self.getCollection(relation).updateIndex(record, updateOpts)\r\n                // e.g. comment.post = post\r\n                safeSetLink(record, inverseLocalField, this)\r\n              })\r\n            } else if (localKeys) {\r\n              // Update locals\r\n              // e.g. group.users = someUsers\r\n              // Update (set) inverse relation\r\n              const ids = toLink.map((child) => utils.get(child, relatedIdAttribute)).filter((id) => id !== undefined)\r\n              // e.g. group.user_ids = [1,2,3,...]\r\n              utils.set(this, localKeys, ids)\r\n              // Update (unset) inverse relation\r\n              if (inverseDef.foreignKeys) {\r\n                current.forEach((child) => {\r\n                  const relatedId = utils.get(child, relatedIdAttribute)\r\n                  if ((relatedId === undefined && toLink.indexOf(child) === -1) || (relatedId !== undefined && !(relatedId in toLinkIds))) {\r\n                    // Update inverse relation\r\n                    // safeSetLink(child, inverseLocalField, undefined)\r\n                    const parents = utils.get(child, inverseLocalField) || []\r\n                    // e.g. someUser.groups.remove(group)\r\n                    if (id === undefined) {\r\n                      utils.remove(parents, (parent) => parent === this)\r\n                    } else {\r\n                      utils.remove(parents, (parent) => parent === this || id === utils.get(parent, idAttribute))\r\n                    }\r\n                  }\r\n                })\r\n                toLink.forEach((child) => {\r\n                  // Update (set) inverse relation\r\n                  const parents = utils.get(child, inverseLocalField)\r\n                  // e.g. someUser.groups.push(group)\r\n                  if (id === undefined) {\r\n                    utils.noDupeAdd(parents, this, (parent) => parent === this)\r\n                  } else {\r\n                    utils.noDupeAdd(parents, this, (parent) => parent === this || id === utils.get(parent, idAttribute))\r\n                  }\r\n                })\r\n              }\r\n            } else if (foreignKeys) {\r\n              // e.g. user.groups = someGroups\r\n              // Update (unset) inverse relation\r\n              current.forEach((parent) => {\r\n                const ids = utils.get(parent, foreignKeys) || []\r\n                // e.g. someGroup.user_ids.remove(user.id)\r\n                utils.remove(ids, (_key) => id === _key)\r\n                const children = utils.get(parent, inverseLocalField)\r\n                // e.g. someGroup.users.remove(user)\r\n                if (id === undefined) {\r\n                  utils.remove(children, (child) => child === this)\r\n                } else {\r\n                  utils.remove(children, (child) => child === this || id === utils.get(child, idAttribute))\r\n                }\r\n              })\r\n              // Update (set) inverse relation\r\n              toLink.forEach((parent) => {\r\n                const ids = utils.get(parent, foreignKeys) || []\r\n                utils.noDupeAdd(ids, id, (_key) => id === _key)\r\n                const children = utils.get(parent, inverseLocalField)\r\n                if (id === undefined) {\r\n                  utils.noDupeAdd(children, this, (child) => child === this)\r\n                } else {\r\n                  utils.noDupeAdd(children, this, (child) => child === this || id === utils.get(child, idAttribute))\r\n                }\r\n              })\r\n            }\r\n\r\n            this._set(path, toLink)\r\n            return toLink\r\n          }\r\n        }\r\n      } else if (type === hasOneType) {\r\n        // TODO: Handle case when belongsTo relation isn't ever defined\r\n        if (self._collections[relation] && foreignKey && !self.getCollection(relation).indexes[foreignKey]) {\r\n          self.getCollection(relation).createIndex(foreignKey)\r\n        }\r\n        descriptor = {\r\n          get: getter,\r\n          // e.g. user.profile = someProfile\r\n          set (record) {\r\n            const current = this._get(path)\r\n            if (record === current) {\r\n              return current\r\n            }\r\n            const inverseLocalField = def.getInverse(mapper).localField\r\n            // Update (unset) inverse relation\r\n            if (current) {\r\n              safeSetProp(current, foreignKey, undefined)\r\n              self.getCollection(relation).updateIndex(current, updateOpts)\r\n              safeSetLink(current, inverseLocalField, undefined)\r\n            }\r\n            if (record) {\r\n              const relatedId = utils.get(record, def.getRelation().idAttribute)\r\n              // Prefer store record\r\n              if (relatedId !== undefined) {\r\n                record = self.get(relation, relatedId) || record\r\n              }\r\n\r\n              // Set locals\r\n              safeSetLink(this, localField, record)\r\n\r\n              // Update (set) inverse relation\r\n              safeSetProp(record, foreignKey, utils.get(this, idAttribute))\r\n              self.getCollection(relation).updateIndex(record, updateOpts)\r\n              safeSetLink(record, inverseLocalField, this)\r\n            } else {\r\n              // Unset locals\r\n              safeSetLink(this, localField, undefined)\r\n            }\r\n            return record\r\n          }\r\n        }\r\n      }\r\n\r\n      if (descriptor) {\r\n        descriptor.enumerable = def.enumerable === undefined ? false : def.enumerable\r\n        if (def.get) {\r\n          const origGet = descriptor.get\r\n          descriptor.get = function () {\r\n            return def.get(def, this, (...args) => origGet.apply(this, args))\r\n          }\r\n        }\r\n        if (def.set) {\r\n          const origSet = descriptor.set\r\n          descriptor.set = function (related) {\r\n            return def.set(def, this, related, (value) => origSet.call(this, value === undefined ? related : value))\r\n          }\r\n        }\r\n        Object.defineProperty(mapper.recordClass.prototype, localField, descriptor)\r\n      }\r\n    })\r\n\r\n    return mapper\r\n  },\r\n\r\n  destroy (name, id, opts) {\r\n    opts || (opts = {})\r\n    return SimpleStore.prototype.destroy.call(this, name, id, opts).then((result) => {\r\n      let record\r\n      if (opts.raw) {\r\n        record = result.data\r\n      } else {\r\n        record = result\r\n      }\r\n\r\n      if (record && this.unlinkOnDestroy) {\r\n        const _opts = utils.plainCopy(opts)\r\n        _opts.withAll = true\r\n        utils.forEachRelation(this.getMapper(name), _opts, (def) => {\r\n          utils.set(record, def.localField, undefined)\r\n        })\r\n      }\r\n      return result\r\n    })\r\n  },\r\n\r\n  destroyAll (name, query, opts) {\r\n    opts || (opts = {})\r\n    return SimpleStore.prototype.destroyAll.call(this, name, query, opts).then((result) => {\r\n      let records\r\n      if (opts.raw) {\r\n        records = result.data\r\n      } else {\r\n        records = result\r\n      }\r\n\r\n      if (records && records.length && this.unlinkOnDestroy) {\r\n        const _opts = utils.plainCopy(opts)\r\n        _opts.withAll = true\r\n        utils.forEachRelation(this.getMapper(name), _opts, (def) => {\r\n          records.forEach((record) => {\r\n            utils.set(record, def.localField, undefined)\r\n          })\r\n        })\r\n      }\r\n      return result\r\n    })\r\n  }\r\n}\r\n\r\nexport default SimpleStore.extend(props)\r\n\r\n/**\r\n * Create a subclass of this DataStore:\r\n * @example <caption>DataStore.extend</caption>\r\n * const JSData = require('js-data');\r\n * const { DataStore } = JSData;\r\n * console.log('Using JSData v' + JSData.version.full);\r\n *\r\n * // Extend the class using ES2015 class syntax.\r\n * class CustomDataStoreClass extends DataStore {\r\n *   foo () { return 'bar'; }\r\n *   static beep () { return 'boop'; }\r\n * }\r\n * const customDataStore = new CustomDataStoreClass();\r\n * console.log(customDataStore.foo());\r\n * console.log(CustomDataStoreClass.beep());\r\n *\r\n * // Extend the class using alternate method.\r\n * const OtherDataStoreClass = DataStore.extend({\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * });\r\n * const otherDataStore = new OtherDataStoreClass();\r\n * console.log(otherDataStore.foo());\r\n * console.log(OtherDataStoreClass.beep());\r\n *\r\n * // Extend the class, providing a custom constructor.\r\n * function AnotherDataStoreClass () {\r\n *   DataStore.call(this);\r\n *   this.created_at = new Date().getTime();\r\n * }\r\n * DataStore.extend({\r\n *   constructor: AnotherDataStoreClass,\r\n *   foo () { return 'bar'; }\r\n * }, {\r\n *   beep () { return 'boop'; }\r\n * });\r\n * const anotherDataStore = new AnotherDataStoreClass();\r\n * console.log(anotherDataStore.created_at);\r\n * console.log(anotherDataStore.foo());\r\n * console.log(AnotherDataStoreClass.beep());\r\n *\r\n * @method DataStore.extend\r\n * @param {object} [props={}] Properties to add to the prototype of the\r\n * subclass.\r\n * @param {object} [props.constructor] Provide a custom constructor function\r\n * to be used as the subclass itself.\r\n * @param {object} [classProps={}] Static properties to add to the subclass.\r\n * @returns {Constructor} Subclass of this DataStore class.\r\n * @since 3.0.0\r\n */\r\n","/**\r\n * Registered as `js-data` in NPM and Bower.\r\n *\r\n * Also available from CDN.JS and JSDelivr.\r\n *\r\n * @module js-data\r\n *\r\n * @example <caption>Install from NPM</caption>\r\n * npm i --save js-data@beta\r\n * @example <caption>Install from Bower</caption>\r\n * bower i --save js-data@3.0.0-beta.1\r\n * @example <caption>Install from CDN.JS</caption>\r\n * <script src=\"https://cdnjs.cloudflare.com/ajax/libs/js-data/3.0.0-beta.1/js-data.min.js\"></script>\r\n * @example <caption>Install from JSDelivr</caption>\r\n * <script src=\"https://cdn.jsdelivr.net/js-data/3.0.0-beta.1/js-data.min.js\"></script>\r\n * @example <caption>Load into your app via script tag</caption>\r\n * <script src=\"/path/to/js-data.min.js\"></script>\r\n * <script>\r\n *   console.log(JSData.version.full); // \"3.0.0-beta.1\"\r\n * </script>\r\n * @example <caption>Load into your app via CommonJS</caption>\r\n * var JSData = require('js-data');\r\n * @example <caption>Load into your app via ES2015 Modules</caption>\r\n * import * as JSData from 'js-data';\r\n * @example <caption>Load into your app via AMD</caption>\r\n * define('myApp', ['js-data'], function (JSData) { ... });\r\n */\r\n\r\n/**\r\n * JSData's utility methods.\r\n *\r\n * @example\r\n * import { utils } from 'js-data';\r\n * console.log(utils.isString('foo')); // true\r\n *\r\n * @name module:js-data.utils\r\n * @property {Function} Promise See {@link utils.Promise}.\r\n * @see utils\r\n * @since 3.0.0\r\n * @type {Object}\r\n */\r\nimport utils from './utils'\r\n\r\n/**\r\n * JSData's {@link Collection} class.\r\n *\r\n * @example\r\n * import { Collection } from 'js-data';\r\n * const collection = new Collection();\r\n *\r\n * @name module:js-data.Collection\r\n * @see Collection\r\n * @since 3.0.0\r\n * @tutorial [\"http://www.js-data.io/v3.0/docs/components-of-jsdata#collection\",\"Components of JSData: Collection\"]\r\n * @type {Constructor}\r\n */\r\nimport Collection from './Collection'\r\n\r\n/**\r\n * JSData's {@link Component} class. Most components in JSData extend this\r\n * class.\r\n *\r\n * @example\r\n * import { Component } from 'js-data';\r\n * // Make a custom component.\r\n * const MyComponent = Component.extend({\r\n *   myMethod (someArg) { ... }\r\n * });\r\n *\r\n * @name module:js-data.Component\r\n * @see Component\r\n * @since 3.0.0\r\n * @type {Constructor}\r\n */\r\nimport Component from './Component'\r\n\r\n/**\r\n * JSData's {@link Container} class. Defines and manages {@link Mapper}s. Used\r\n * in Node.js and in the browser, though in the browser you may want to use\r\n * {@link DataStore} instead.\r\n *\r\n * @example\r\n * import { Container } from 'js-data';\r\n * const store = new Container();\r\n *\r\n * @name module:js-data.Container\r\n * @see Container\r\n * @since 3.0.0\r\n * @tutorial [\"http://www.js-data.io/v3.0/docs/components-of-jsdata#container\",\"Components of JSData: Container\"]\r\n * @type {Constructor}\r\n */\r\nimport { Container } from './Container'\r\n\r\n/**\r\n * JSData's {@link DataStore} class. Primarily for use in the browser. In\r\n * Node.js you probably want to use {@link Container} instead.\r\n *\r\n * @example\r\n * import { DataStore } from 'js-data';\r\n * const store = new DataStore();\r\n *\r\n * @name module:js-data.DataStore\r\n * @see DataStore\r\n * @since 3.0.0\r\n * @tutorial [\"http://www.js-data.io/v3.0/docs/components-of-jsdata#datastore\",\"Components of JSData: DataStore\"]\r\n * @type {Constructor}\r\n */\r\nimport DataStore from './DataStore'\r\n\r\n/**\r\n * JSData's {@link Index} class, based on [mindex]{@link https://github.com/internalfx/mindex}.\r\n *\r\n * @name module:js-data.Index\r\n * @see Index\r\n * @since 3.0.0\r\n * @type {Constructor}\r\n */\r\nimport Index from '../lib/mindex/index'\r\n\r\n/**\r\n * JSData's {@link LinkedCollection} class. Used by the {@link DataStore}\r\n * component. If you need to create a collection manually, you should probably\r\n * use the {@link Collection} class.\r\n *\r\n * @name module:js-data.LinkedCollection\r\n * @see DataStore\r\n * @see LinkedCollection\r\n * @since 3.0.0\r\n * @type {Constructor}\r\n */\r\nimport LinkedCollection from './LinkedCollection'\r\n\r\n/**\r\n * JSData's {@link Mapper} class. The core of the ORM.\r\n *\r\n * @example <caption>Recommended use</caption>\r\n * import { Container } from 'js-data';\r\n * const store = new Container();\r\n * store.defineMapper('user');\r\n *\r\n * @example <caption>Create Mapper manually</caption>\r\n * import { Mapper } from 'js-data';\r\n * const UserMapper = new Mapper({ name: 'user' });\r\n *\r\n * @name module:js-data.Mapper\r\n * @see Container\r\n * @see Mapper\r\n * @since 3.0.0\r\n * @tutorial [\"http://www.js-data.io/v3.0/docs/modeling-your-data\",\"Modeling your data\"]\r\n * @tutorial [\"http://www.js-data.io/v3.0/docs/components-of-jsdata#mapper\",\"Components of JSData: Mapper\"]\r\n * @type {Constructor}\r\n */\r\nimport Mapper from './Mapper'\r\n\r\n/**\r\n * JSData's {@link Query} class. Used by the {@link Collection} component.\r\n *\r\n * @name module:js-data.Query\r\n * @see Query\r\n * @since 3.0.0\r\n * @type {Constructor}\r\n */\r\nimport Query from './Query'\r\n\r\n/**\r\n * JSData's {@link Record} class.\r\n *\r\n * @example\r\n * import { Container } from 'js-data';\r\n * const store = new Container();\r\n * store.defineMapper('user');\r\n * const user = store.createRecord('user');\r\n *\r\n * @name module:js-data.Record\r\n * @see Record\r\n * @since 3.0.0\r\n * @tutorial [\"http://www.js-data.io/v3.0/docs/components-of-jsdata#record\",\"Components of JSData: Record\"]\r\n * @type {Constructor}\r\n */\r\nimport Record from './Record'\r\n\r\n/**\r\n * JSData's {@link Schema} class. Implements http://json-schema.org/draft-04.\r\n *\r\n * @example\r\n * import { Container, Schema } from 'js-data';\r\n * const userSchema = new Schema({\r\n *   properties: {\r\n *     id: { type: 'string' },\r\n *     name: { type: 'string' }\r\n *   }\r\n * });\r\n * const store = new Container();\r\n * store.defineMapper('user', {\r\n *   schema: userSchema\r\n * });\r\n *\r\n * @name module:js-data.Schema\r\n * @see Schema\r\n * @see http://json-schema.org/\r\n * @since 3.0.0\r\n * @tutorial [\"http://www.js-data.io/v3.0/docs/components-of-jsdata#schema\",\"Components of JSData: schema\"]\r\n * @tutorial [\"http://www.js-data.io/v3.0/docs/schemas\",\"JSData's Schema Syntax\"]\r\n * @type {Constructor}\r\n */\r\nimport Schema from './Schema'\r\n\r\n/**\r\n * JSData's {@link Settable} class.\r\n *\r\n * @example\r\n * import { Settable } from 'js-data';\r\n * const obj = new Settable();\r\n * obj.set('secret', 'value');\r\n * console.log(JSON.stringify(obj)); // {}\r\n *\r\n * @name module:js-data.Settable\r\n * @see Settable\r\n * @since 3.0.0\r\n * @type {Constructor}\r\n */\r\nimport Settable from './Settable'\r\n\r\n/**\r\n * JSData's {@link SimpleStore} class. Primarily for use in the browser. In\r\n * Node.js you probably want to use {@link Container} instead.\r\n *\r\n * @example\r\n * import { SimpleStore } from 'js-data';\r\n * const store = new SimpleStore();\r\n *\r\n * @name module:js-data.SimpleStore\r\n * @see SimpleStore\r\n * @since 3.0.0\r\n * @tutorial [\"http://www.js-data.io/v3.0/docs/components-of-jsdata#SimpleStore\",\"Components of JSData: SimpleStore\"]\r\n * @type {Constructor}\r\n */\r\nimport SimpleStore from './SimpleStore'\r\n\r\n/**\r\n * Describes the version of this `JSData` object.\r\n *\r\n * @example\r\n * console.log(JSData.version.full); // \"3.0.0-beta.1\"\r\n *\r\n * @name version\r\n * @memberof module:js-data\r\n * @property {string} full The full semver value.\r\n * @property {number} major The major version number.\r\n * @property {number} minor The minor version number.\r\n * @property {number} patch The patch version number.\r\n * @property {(string|boolean)} alpha The alpha version value, otherwise `false`\r\n * if the current version is not alpha.\r\n * @property {(string|boolean)} beta The beta version value, otherwise `false`\r\n * if the current version is not beta.\r\n * @since 2.0.0\r\n * @type {Object}\r\n */\r\nexport const version = '<%= version %>'\r\n\r\nexport * from './decorators'\r\n\r\nexport {\r\n  Collection,\r\n  Component,\r\n  Container,\r\n  DataStore,\r\n  Index,\r\n  LinkedCollection,\r\n  Mapper,\r\n  Query,\r\n  Record,\r\n  Schema,\r\n  Settable,\r\n  SimpleStore,\r\n  utils\r\n}\r\n"],"names":["DOMAIN","INFINITY","MAX_INTEGER","BOOL_TAG","DATE_TAG","FUNC_TAG","NUMBER_TAG","OBJECT_TAG","REGEXP_TAG","STRING_TAG","objToString","Object","prototype","toString","PATH","ERRORS","arguments","toInteger","value","sign","remainder","toStr","call","isPlainObject","constructor","mkdirP","object","path","parts","split","forEach","key","utils","Promise","_","dest","src","forOwn","undefined","isFunction","indexOf","_forRelation","opts","def","fn","thisArg","relationName","relation","containedName","index","with","_getIndex","localField","withAll","optsCopy","fillIn","getRelation","slice","_activeWith","splice","i","length","substr","list","_relation","isObject","addHiddenPropsToTarget","target","props","map","keys","propName","descriptor","getOwnPropertyDescriptor","enumerable","defineProperties","areDifferent","newObject","oldObject","diff","diffObjects","diffCount","added","removed","changed","classCallCheck","instance","ctor","err","name","copy","from","to","stackFrom","stackTo","blacklist","plain","isArray","isDate","Date","getTime","isRegExp","RegExp","source","match","lastIndex","create","getPrototypeOf","push","result","hasOwnProperty","isBlacklisted","deepFillIn","existing","deepMixIn","equalsFn","ignore","deepEqual","newKeys","filter","oldKeys","oldValue","newValue","equal","a","b","domain","code","prefix","message","apply","Array","Error","eventify","getter","setter","_events","emit","events","args","type","shift","listeners","f","c","all","unshift","off","func","on","extend","classProps","superClass","subClass","configurable","writable","obj","setPrototypeOf","strictEs6Class","__proto__","defineProperty","findIndex","array","record","forEachRelation","mapper","relationList","len","fromJson","json","isString","JSON","parse","get","prop","last","pop","getSuper","isCtor","__super__","intersection","array1","array2","item","matches","test","isBoolean","isInteger","isNull","isNumber","isSorN","isUndefined","logify","dbg","log","level","debug","toUpperCase","console","noDupeAdd","omit","_props","pick","reduce","plainCopy","reject","remove","resolve","set","_path","exec","_equal","toJson","stringify","unset","getDefaultLocale","navigator","userAgent","safeSetProp","field","_set","safeSetLink","Settable","_get","_unset","Component","_listeners","INDEX_ERR","reserved","limit","offset","orderBy","skip","sort","where","escapeRegExp","percentRegExp","underscoreRegExp","escape","pattern","replace","Query","collection","data","_applyWhereFromObject","fields","ops","predicates","clause","expr","op","_applyWhereFromArray","groups","_where","prev","parser","group","isOr","_testObjectGroup","keep","first","charAt","evaluate","_testArrayGroup","between","leftKeys","rightKeys","getIndex","compare","locale","cA","cB","temp","isNumeric","collator","Intl","Collator","sensitivity","numeric","n","predicate","like","query","getData","forEachFn","keyList","getAll","concat","flags","num","Math","min","mapFn","mapCall","funcName","run","isectEmpty","isectNotEmpty","in","notIn","contains","notContains","belongsToType","hasManyType","hasOneType","Relation","relatedMapper","options","TYPE_NAME","validateOptions","canAutoAddLinks","add","relatedCollection","datastore","getCollection","related","DOMAIN_ERR","foreignKey","localKey","assignTo","relationFields","canFindLinkFor","getForeignKey","idAttribute","setForeignKey","relatedRecord","_setForeignKey","relatedRecords","getLocalField","setLocalField","relatedData","getInverse","inverse","findInverseRelation","isInversedTo","addLinkedRecords","records","linkRecord","isEmptyLinks","findExistingLinksFor","removeLinkedRecords","relatedId","unsaved","findExistingLinksByForeignKey","id","ensureLinkedDataHasProperType","relationData","is","createRecord","isRequiresParentId","isRequiresChildId","createChildRecord","createLinked","then","BelongsToRelation","createParentRecord","HasManyRelation","localKeys","foreignKeys","hasForeignKeys","recordId","ids","findExistingLinksByLocalKeys","findExistingLinksByForeignKeys","foreignIdField","createMany","HasOneRelation","RelationType","belongsTo","hasMany","hasOne","superMethod","store","bind","creatingPath","noValidatePath","keepChangeHistoryPath","previousPath","Record","noValidate","keepChangeHistory","validateOnSet","toJSON","_mapper","afterLoadRelations","beforeLoadRelations","changeHistory","changes","commit","destroy","hasChanges","quickHasChanges","isNew","isValid","validate","removeInverseRelation","currentParent","inverseDef","children","child","setupInverseRelation","loadRelations","relations","adapter","getAdapterName","tasks","task","raw","load","previous","revert","preserve","save","postProcess","changesOnly","silent","hashCode","insertAt","removeAt","binarySearch","lo","hi","compared","mid","found","Index","fieldList","fieldGetter","isIndex","values","pos","dataLocation","newIndex","results","order","visitAll","cb","leftInclusive","rightInclusive","_between","leftKey","rightKey","currKey","peek","clear","insertRecord","removeRecord","isUnique","j","updateRecord","COLLECTION_DEFAULTS","commitOnMerge","emitRecordEvents","onConflict","Collection","queryClass","indexes","_onRecordEvent","beforeAdd","singular","existingNoValidate","updateIndexes","afterAdd","afterRemove","afterRemoveAll","beforeRemove","beforeRemoveAll","createIndex","instances","prune","removeAll","Ctor","initialValue","idOrRecord","queryOrRecords","updateIndex","types","boolean","integer","null","number","string","segmentToString","segment","str","makePath","segments","makeError","actual","expected","addError","errors","maxLengthCommon","keyword","schema","max","minLengthCommon","validationKeywords","allOf","allErrors","_schema","anyOf","validated","dependencies","enum","possibleValues","join","items","checkingTuple","maximum","exclusiveMaximum","maxItems","maxLength","maxProperties","minimum","exclusiveMinimum","minItems","minLength","minProperties","multipleOf","not","oneOf","properties","additionalProperties","patternProperties","toValidate","undef","origProp","required","existingOnly","prevProp","validType","_type","validator","typeGroupValidators","uniqueItems","runOps","ANY_OPS","ARRAY_OPS","NUMERIC_OPS","OBJECT_OPS","STRING_OPS","validateAny","ctx","shouldPop","extends","changingPath","changedPath","changeHistoryPath","eventIdPath","silentPath","validationFailureMsg","Schema","definition","_definition","validationKeyword","unsetter","track","makeDescriptor","applyDefaults","hasSet","default","orig","keyPath","originalGet","error","current","changing","clearTimeout","setTimeout","changeRecord","timestamp","originalSet","_copy","applyDefaultsHooks","validatingHooks","makeNotify","getSchema","toProcess","originalExistingOnly","notify","notify2","LIFECYCLE_METHODS","count","defaults","destroyAll","find","findAll","sum","update","adapterArgs","beforeAssign","updateAll","updateMany","MAPPER_DEFAULTS","_adapters","applySchema","defaultAdapter","Mapper","lifecycleMethods","recordClass","methods","isPrototypeOf","afterCount","afterCreate","afterCreateMany","afterDestroy","afterDestroyAll","afterFind","afterFindAll","afterSum","afterUpdate","afterUpdateAll","afterUpdateMany","beforeCreate","beforeCreateMany","beforeCount","beforeDestroy","beforeDestroyAll","beforeFind","beforeFindAll","beforeSum","beforeUpdate","beforeUpdateAll","beforeUpdateMany","_end","_data","wrap","crud","originalRecord","parentRelationMap","adapterResponse","_runHook","_createParentRecordIfRequired","relationMap","_invokeAdapterMethod","createdProps","_createOrAssignChildRecordIfRequired","originalProps","_commitChanges","recordOrRecords","newValues","createInstance","context","parent","originalRecords","belongsToRelationData","Boolean","createdRecordsData","belongsToData","createdRecordData","RecordCtor","method","config","upper","before","after","_value","getAdapter","_opts","assign","_result","getAdapters","registerAdapter","hookName","hookArgs","defaultValueIndex","overridenResult","propsOrRecords","conversionOptions","pass","_record","some","defineRelations","_name","getMapperByName","getMapper","proxiedMapperMethods","Container","_mappers","mapperClass","mapperDefaults","_onMapperEvent","as","original","defineMapper","defineResource","warn","proxiedCollectionMethods","ownMethodsForScoping","cachedFn","hashOrId","cached","_completedQueries","SIMPLESTORE_DEFAULTS","usePendingFind","usePendingFindAll","SimpleStore","collectionClass","_collections","_pendingQueries","addToCache","_onCollectionEvent","cachedFind","cachedFindAll","cacheFind","cacheFindAll","hash","self","collectionOpts","_added","indexed","hashQuery","eject","ejectAll","pendingQuery","force","promise","inject","removeRelated","LinkedCollection","_addMeta","_clearMeta","event","DATASTORE_DEFAULTS","unlinkOnDestroy","DataStore","updateOpts","relatedIdAttribute","foreignKeyDescriptor","currentParentId","storeRecord","inverseLocalField","toLink","toLinkIds","currentChildrenOfParent","parents","_key","origGet","origSet","version"],"mappings":"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"}